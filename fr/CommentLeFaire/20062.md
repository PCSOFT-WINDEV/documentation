
## Comment faire une requête SQL avec une formule de calcul ? 
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>
Pour effectuer un calcul sur des données provenant d'un fichier de données, il est possible d'effectuer ces calculs directement par programmation en WLangage en lisant le contenu du fichier de données.

Un moyen plus efficace pour effectuer des calculs sur des données d'un fichier consiste à utiliser une requête SQL.

Nous allons voir comment effectuer un calcul en utilisant : 

- [Méthode 1 : une requête SQL réalisée à l'aide de l'éditeur de requêtes](#NOTE2_1).

- [Méthode 2 : une requête réalisée par programmation](#NOTE3_1). 




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Requête SQL avec un calcul
<a name="requete_sql_avec_calcul_ELTTEXTE000159"></a>
Cette requête permet d'effectuer un calcul sur les enregistrements d'un fichier de données. 

Dans cet exemple, nous calculons la valeur d'une ligne de commande en fonction d'un prix unitaire, de la quantité commandée et d'une remise.

Les différentes étapes pour créer cette requête SQL avec un calcul sont les suivantes : 

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- Dans la fenêtre qui s'affiche, cliquez sur "Requêtes". 

	- L'assistant de création d'une requête se lance.




2. Choisissez de créer une requête de sélection (option "Sélection (SELECT)"). 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0001.gif&type=thumb)

	Passez à l'étape suivante de l'assistant.

3. La fenêtre de description de la requête s'affiche.

4. Donnez un nom et un libellé à la requête : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0002.gif&type=thumb)


5. Dans la zone de gauche de la fenêtre de description, choisissez les rubriques du fichier de données à manipuler. Dans notre exemple, le fichier de données est le fichier LIGNECDE et les rubriques sont NumLigneCde et Référence. 

6. Double-cliquez sur les noms des rubriques pour les ajouter dans la liste des rubriques de la requête : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0003.gif)


7. Pour effectuer le calcul de la ligne, dans la partie gauche de l'éditeur, en bas, cliquez sur le bouton "Rubrique calculée"  
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0004.gif)


8. Dans le menu qui s'affiche, sélectionnez "Nouvelle rubrique calculée". La fenêtre de création de la rubrique calculée s'affiche. 

9. Donnez un nom et un libellé à la rubrique calculée. 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0005.gif&type=thumb)


10. Saisissez la formule. Il est possible de taper le code directement dans la zone de code SQL. Pour intégrer une rubrique, cliquez sur son nom dans la liste à gauche : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0006.gif&type=thumb)


11. Validez. La fenêtre de description de la requête est mise à jour. La rubrique calculée est affichée dans la liste des rubriques prises en compte : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0007.gif)


12. Validez la fenêtre de description de la requête. La requête apparaît sous l'éditeur : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0008.gif)


13. Enregistrez la requête (Ctrl + S). 

14. Visualisez le code SQL en appuyant sur la touche F2 : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0009.gif)


15. Testez la requête (GO dans les boutons d'accès rapide). 

16. La requête peut être exécutée dans le programme à l'aide de la fonction [HExécuteRequête](../WDLang4/3044080.md).




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Requête SQL avec un calcul en programmation
<a name="requete_sql_avec_calcul_programmation_ELTTEXTE000183"></a>
Les requêtes SQL peuvent être écrites directement par programmation dans le code WLangage. Pour cela, il faut : 

1. Créer une variable de type [Source de données](../WDLang4/1514053.md) pour représenter la requête en exécution. 

2. Créer une variable de type chaîne de caractères pour contenir le code SQL de la requête et écrire le code SQL dans cette variable. 

3. Exécuter la requête SQL à l'aide de la fonction [HExécuteRequêteSQL](../WDLang4/3044084.md).

4. Parcourir le résultat à l'aide des fonctions HLITXXX.




Exemple de code


```wl
Src1 est une Source de Données
sCodeSQL est une chaîne

// Produits avec le prix TTC ...
sCodeSQL = [
SELECT 
	PRODUIT.Reference AS Reference,	
	PRODUIT.Libprod AS Libprod,	
	PRODUIT.Prixht AS Prixht,	
	PRODUIT.Prixht * (1 + PRODUIT.Tauxtva / 100) AS TTC
FROM 
	PRODUIT
]


HExécuteRequêteSQL(Src1, hRequêteDéfaut, sCodeSQL)
POUR TOUT Src1
	TRACE(Src1.Reference, Src1.Libprod, Src1.TTC)

FIN
```






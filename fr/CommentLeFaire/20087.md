
## Comment ajouter un paiement sécurisé dans un site WEBDEV ?


**Sommaire**

[Importation des éléments nécessaires](#importation_des_elements_necessaires_ELTTEXTE000382)

[Modification de la page "retourboutique"](#modification_page_retourboutique_ELTTEXTE000406)

[Ajout du code de localisation de la base du composant](#ajout_code_localisation_base_composant_ELTTEXTE000430)

[Personnalisation de la page de paiement](#personnalisation_page_paiement_ELTTEXTE000454)

[#Le lien "Payer"](#lien_payer_ELTPARAGRAPHE000138)

[#Les autres liens : où mettre le code qui enregistre le paiement ?](#les_autres_liens_mettre_code_qui_enregistre_paiement_ELTPARAGRAPHE000212)

[Test du paiement](#test_paiement_ELTTEXTE000490)

[Les éléments à déployer pour le paiement](#les_elements_deployer_pour_paiement_ELTTEXTE000514)

[Problèmes les plus fréquents](#problemes_les_plus_frequents_ELTTEXTE000538)

[#Erreur  : La page de retour n'a pas renvoyé le résultat attendu](#erreur_page_retour_pas_renvoye_resultat_attendu_ELTPARAGRAPHE000265)

[#Après déploiement, un message indique : "Commande à mettre en attente avec intervention humaine nécessaire"](#apres_deploiement_message_indique_commande_mettre_attente_avec_intervention_humaine_necessaire_ELTPARAGRAPHE000301)

[#Comment activer les log (WLOG) et les lire ?](#comment_activer_les_log_wlog_les_lire_ELTPARAGRAPHE000330)

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Importation des éléments nécessaires
<a name="importation_des_elements_necessaires_ELTTEXTE000382"></a>


1. Ouvrez votre projet WEBDEV. 

2. Importez le composant externe "WW_PaiementSecurise". 

	- Sous le volet "Projet", dans le groupe "Projet", déroulez "Importer" et sélectionnez "Un composant externe .. A partir d'un fichier". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0001.gif&type=thumb)


	- Indiquez le chemin du fichier WDI voulu. Dans notre cas, ce fichier correspond à "PaiementSecurise.wdi" présent dans le sous-répertoire de WEBDEV : "\\Composants\\Composants exemples\\WW_PaiementSecurise\\Exe\\Composant".  

- La fenêtre de description du composant apparaît. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0002.gif)
Fermez cette fenêtre. 

3. Afin d'avoir une base pour intégrer le paiement sécurisé, nous vous proposons d'importer également 2 pages spécifiques dans votre projet : 

	- Sous le volet "Projet", dans le groupe "Projet", déroulez "Importer" et sélectionnez "Des éléments WEBDEV et leurs dépendances". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0003.gif&type=thumb)


	- Sélectionnez le répertoire d'importation. Ce répertoire correspond au répertoire du composant WW_Paiement_sécurise présent dans le sous-répertoire de WEBDEV : "Composants\\Composants exemples\\WW_PaiementSecurise"

- La liste des pages s'affiche. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0004.gif)

4. Recompilez le projet pour prendre en compte ces pages : sous le volet "Projet", dans le groupe "Projet", déroulez "Recompiler et synchroniser" et sélectionnez "Recompiler le projet et générer les pages HTML". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0005.gif&type=thumb)





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Modification de la page "retourboutique"
<a name="modification_page_retourboutique_ELTTEXTE000406"></a>


1. Ouvrez la page "retourboutique" sous l'éditeur. 

2. Cette page contient un champ Page interne "PI_RETOUR". 

3. Affichez la fenêtre de description du champ Page interne "PI_RETOUR". 

4. Dans l'onglet "Général", modifiez la page interne liée au champ : remplacez "PI_Payback" par "PaiementSécurisé.PI_Payback". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0006.gif&type=thumb)


5. Enregistrez la page (![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ICO_Enregistrer.gif)). 

6. Enregistrez une copie de cette page avec un nom personnalisé : sous le volet "Accueil", dans le groupe "Général", déroulez "Enregistrer" et sélectionnez "Enregistrer sous". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0007.gif)


7. Dans la fenêtre qui s'affiche, indiquez le nouveau nom de la page et validez. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0008.gif)

	Remarque : Le fait de personnaliser cette page avec un nom spécifique accroît la sécurité du paiement. 

8. Assurez-vous que cette page ne soit pas référencée : 

	- Affichez la fenêtre de description de la page renommée. 

	- Dans l'onglet "Détail", l'option "Interdire le référencement" doit être cochée. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0009.gif&type=thumb)


	- Validez la fenêtre de description. 




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Ajout du code de localisation de la base du composant
<a name="ajout_code_localisation_base_composant_ELTTEXTE000430"></a>
Il est nécessaire d'ajouter **au début du code du projet** (par exemple dans l'événement "Initialisation du projet après connexion au site"), le code permettant au composant de localiser le fichier des paiements et de fixer son mot de passe qui vous est personnel. 

Ce code est le suivant : 

```wl
<BLOC Localisation du fichier pour le composant de paiement sécurisé>
	//Pour tracer sur le serveur éventuellement
	//dbgActiveLog(fRepDonnées()+["\"]+"paiementlog_[%Date%]_[%Heure%].wlog",LogTout)
		//Emplacement du fichier de paiement
		ParamètresDonnées(fRepDonnées() + "\Paiement", "mot de passe du ficher à personnaliser")
//		//ou utilisation d'une connexion, exemple :
//			gcnxBaseCS est une connexion
//			gcnxBaseCS..Provider=hAccèsHFClientServeur
//			gcnxBaseCS..Utilisateur="admin"
//			gcnxBaseCS..serveur="127.0.0.1"
//			gcnxBaseCS..BaseDeDonnées="mabase"
//                 ParamètresDonnées("Paiement","mot de passe du ficher à personnaliser", ...
//                          gcnxBaseCS, "MotDePasseConnexionBase")
<FIN>
```


<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Personnalisation de la page de paiement
<a name="personnalisation_page_paiement_ELTTEXTE000454"></a>


1. Ouvrez la page "PAGE_Paiement_Securise_xxx" où xxx correspond à la solution de paiement que vous désirez utiliser. Dans cet exemple, nous manipulons la page "PAGE_Paiement_Securise_ATOS.wwh"

2. Supprimez le bouton "Point d'interrogation" qui référence une page d'information qui n'a pas été importé dans ce projet. 

3. Uniquement pour ATOS : 

	- Supprimez le champ Image "IMG_BANQUE" dont l'image n'a pas été importé dans ce projet.

	- Supprimez le code qui affecte le champ "IMG_BANQUE" dans les déclarations globales de la page. 




4. Ajustez le type de la page en fonction du type de page souhaité dans votre projet : Session, AWP, mode Zoning, mode Responsive, ...<br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0010.gif&type=thumb)


5. Dans le cas de ATOS, assurez-vous que le lien "Payer" a bien comme destination l'iFrame "IFRM_PAIEMENT". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise%20-%20HC%20N%B0011.gif&type=thumb)






### Le lien "Payer"
<a name="lien_payer_ELTPARAGRAPHE000138"></a>Ce lien contient le code qui déclenche le lancement du paiement sécurisé. 

**1. Paramètres spécifique du compte de la banque**
Dans ce code, les paramètres du compte de la banque doivent être indiqués. En fonction de la solution de paiement choisie, ces informations sont différentes. 

Votre projet contient une page spécifique correspondant au paiement souhaité : dans le code de ce lien, vous trouvez un code adapté au type de paiement choisi. Ce code contient des commentaires explicatifs spécifiques aux paramètres requis.

***Exemple pour ATOS*** :

- Il faut indiquer un "code société" : 
	```txt
	MonPaiement:CodeSociété
	```


- Il faut également remplacer les fichiers présents dans le sous-répertoire du nom relatif à la solution de paiement sécurisé utilisée par les fichiers fournis par la banque. Dans cet exemple, les fichiers se trouvant dans le sous-répertoire "Mercanet" précédemment copiés : pathfile, parmcom.08258434141111, parmcom.mercanet et certif.fr.082584341411111




***Exemple pour Lyra (Systempay, Cyberplus, Spplus, Payzen, ...)*** :
Il faut indiquer : 

- un "identifiant de site" : MonPaiement:IdentifiantSite 

- un numéro de certificat MonPaiement:Certificat. 


Il s'agit de deux informations que l'on peut trouver le site de back-office, dans le paramétrage de la boutique, onglet "Certificats".

**2. Nom de la page de retour de "serveur à serveur" (aussi appelé IPN : Notification Instantanée de Paiement)**
Dans ce code, il faut également remplacer le nom de la page de retour de serveur à serveur par le nom de la page personnalisé précédemment. Par exemple : 

```txt
MonPaiement:PageRetourServeurÀServeur="nomdepagepersonnalisepourlesretours2s"
```
devient : 

```txt
MonPaiement:PageRetourServeurÀServeur="RETOUR_S2S_B6SH7ZEX"
```


Selon la solution de paiement choisie, il faut renseigner dans le back-office de la banque, l'URL à laquelle cette page sera accessible. Il s'agit d'une URL de cette forme : 

```txt
http://<domaine>/<Nom du site>_WEB/<Langue>/<Nom de la page>.awp
```


Exemple : 

- Utilisation d'une page de retour (nommée "RETOUR_S2S_B6SH7ZEX") pour un site WEBDEV qui a comme nom "shop" et qui est déployé sur un serveur avec le nom de domaine "www.mondomaine.fr" en français : 
	
	```txt
	http://www.mondomaine.fr/SHOP_WEB/FR/RETOUR_S2S_B6SH7ZEX.awp
	```


- Dans le site de back-office pour la solution Lyra, il faut aller dans le paramétrage de la boutique. Dans l'onglet "Configuration", partie "URL de retour", il faut ACTIVER l'option "URL de notification à la fin du paiement". 




**Attention** : il ne faut pas mettre votre code de gestion de fin de paiement dans ces pages. Votre code de gestion de fin paiement doit être présent dans "le lien de retour à la boutique" et "le lien de retour de serveur à serveur" (ce point sera abordé dans la suite de ce document). 

**3. Images des cartes pour ATOS**
Dans le cas de ATOS, il se peut que les images des cartes bancaires ne s'affichent pas. Dans ce cas : 

1. Ouvrez le code du lien "Payer". 

2. Ajoutez la ligne de code suivante après la déclaration de la variable MonPaiement : 
	
	```wl
	MonPaiement est un PaiementSécurisé(nBanque) // Ligne existante
	MonPaiement.RepertoireWebLogo = RépertoireWeb() + "/PaiementSecurise/FR/ATOS/"
	```





**4. Autres personnalisations**
Il est ici possible d'également personnaliser différentes informations, suivez ce qui est indiqué dans le commentaire du lien "Payer". 
En fonction des solutions de paiement, il est possible de : 

- spécifier les coordonnées de facturation.

- spécifier les coordonnées de livraison.

- préciser le contenu du panier.

- spécifier certains types de cartes bancaires.

- faire des abonnements.

- ...


La méthode "FormulaireParamètreAjoute" permet de modifier ou d'ajouter facilement des informations dans le formulaire envoyé à la banque.

Reportez-vous à la documentation du paiement choisi pour plus d'informations.


### Les autres liens : où mettre le code qui enregistre le paiement ? 
<a name="les_autres_liens_mettre_code_qui_enregistre_paiement_ELTPARAGRAPHE000212"></a>Deux autres liens sont présents dans la page : 

- Le lien "Retour à la boutique" : 
	Le code de ce lien est exécuté lorsque l'internaute a terminé son paiement, que ce soit avec succès ou non, lorsqu'il revient sur le site. 
	**Attention** : Certains internautes ne reviennent jamais au site marchand, suite à une erreur de manipulation ou une coupure de leur accès à Internet par exemple. Toutefois, en mode test, sur une machine non accessible par le serveur de la banque, c'est le seul code qui est exécuté.

- Le lien "Retour Serveur à Serveur" (aussi appelé "IPN" : Notification Instantanée de Paiement)
	Le code de ce lien exécuté lorsque l'internaute a validé son paiement sur le site de la banque avant même qu'il ne décide de revenir au site marchand ou non.
	**Attention** : Ce code est exécuté via un appel direct du serveur de la banque, donc en dehors de tout contexte, cookies, session, ... de l'internaute.
	En développement, en mode test, sur une machine non accessible par le serveur de la banque, ce code n'est pas exécuté.




**Où mettre le code qui enregistre le paiement ?**
Une des meilleures solutions est de mettre le code qui enregistre le paiement dans le code associé aux deux liens "Retour à la boutique" et "Retour Serveur à Serveur" mais avec des petites variantes.

- Dans le code du lien "Retour Serveur à Serveur" : dans ce code, il faut normalement enregistrer le paiement, mettre à jour la base de données et par exemple envoyer un email avec la facture. Mais en mode test, ce code ne s'exécute pas : la mise au point est complexe. 

- Dans le code du lien "Retour à la boutique" : il convient de vérifier que le retour de serveur à serveur a déjà bien été enregistré, sauf en mode test. Si ce n'est pas le cas, il faut enregistrer le paiement comme étant en anomalie et noter qu'il doit être vérifié. 
	Si vous avez besoin d'afficher des informations à l'internaute suite au paiement, continuer, ou si vous devez lui demander de nouvelles informations, c'est dans ce code que vous pourrez le faire.




<a name="NOTE6"></a>
<a name="NOTE6_1"></a>


## Test du paiement
<a name="test_paiement_ELTTEXTE000490"></a>
Pour tester le paiement, vous pouvez : 

- Lancer directement la page importée, 

- Ajouter un code qui va lancer la page importée et passer en paramètre à la page les éléments nécessaires : montant à payer, email du payeur, paiement de test ou réel, ...




**Qu'est-ce qui change une fois le site déployé ?**
Une fois le site déployé sur un serveur, le retour de serveur à serveur (IPN) doit s'exécuter en plus du retour à la boutique comme expliqué précédemment. Lorsque les tests seront validés, il faudra changer l'option indiquant l'utilisation d'un paiement de test pour spécifier que les paiements sont désormais réels.

<a name="NOTE6B"></a>
<a name="NOTE6B_1"></a>


## Les éléments à déployer pour le paiement
<a name="les_elements_deployer_pour_paiement_ELTTEXTE000514"></a>
Lors du déploiement, il faut **exclure** du déploiement les fichiers HFSQL "Transaction" qui contiennent les transactions de tests effectuées en local : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=CLF_Paiement_securise_Ato2.gif)


<a name="NOTE7"></a>
<a name="NOTE7_1"></a>


## Problèmes les plus fréquents
<a name="problemes_les_plus_frequents_ELTTEXTE000538"></a>


### Erreur  : La page de retour n'a pas renvoyé le résultat attendu
<a name="erreur_page_retour_pas_renvoye_resultat_attendu_ELTPARAGRAPHE000265"></a>Cette erreur peut apparaître essentiellement une fois le site déployé. Cela signifie que le composant a tenté d'accéder à la page de retour à la boutique ou à la page de retour de serveur à serveur et qu'il n'a pas réussi.

Les deux principales causes sont  :

- Cas 1 : Dans le code d'initialisation du projet, il y a un code qui force l'affichage d'une page spécifique d'une autre page si certains paramètres ne sont pas reçus. 

- Cas 2 : Les paramètres réseau du serveur ne lui permettent pas de se joindre lui-même. 




Pour savoir quoi faire : 

1. Testez cette URL dans votre navigateur : 
	
	```txt
	http://www.mondomaine.fr/MONSITE_WEB/FR/retourboutique.awp?TEST=O
	```

	en remplaçant  : 

	- "www.mondomaine.fr" par le nom ou l'adresse IP du site,

	- "MONSITE" par le nom du projet du site, 

	- "retourboutique" par le nom de la page de retour à la boutique puis par le nom de la page de retour de serveur à serveur. 




2. **Le test de cette URL doit afficher OK**

	- **Si le test affiche bien OK** : le problème est vraisemblablement lié à la configuration réseau du serveur (cas 2). Vous pouvez faire en sorte que le composant ne fasse pas ce test en activant la ligne de code suivante (qui doit déjà être présente mais en commentaire) : 
			
		```wl
		MonPaiement.IgnoreTestPageRetour = Vrai
		```


	- **Si le test affiche une autre page**, vous êtres vraisemblablement dans le cas 1 : il faut contrôler le code du projet et vérifier qu'aucun affichage d'une page n'est forcé (fonction [PageAffiche](../WDLang2/3058008.md)). Et par exemple, ne pas effectuer cette action en mode AWP (fonction [EnModeAWP](../WDLang1/3014031.md)). 

	- Si le test affiche une erreur, il faut rechercher l'origine de cette erreur. 

	- Si vous n'êtes pas dans les cas précédents, il faut activer des log (wlog) pour comprendre ce qu'il se passe. 








### Après déploiement, un message indique : "Commande à mettre en attente avec intervention humaine nécessaire"
<a name="apres_deploiement_message_indique_commande_mettre_attente_avec_intervention_humaine_necessaire_ELTPARAGRAPHE000301"></a>Ce message peut apparaître au moment du retour au site suite au paiement lorsque les informations reçues indiquent que le paiement a été validé mais que le retour de serveur à serveur n'a pas été enregistré. 

Le retour de serveur à serveur ne s'effectuant qu'en déploiement, ce message ne peut pas arriver en mode test.

Pour savoir quoi faire : 

1. Testez cette URL dans votre navigateur : 
	
	```txt
	http://www.mondomaine.fr/MONSITE_WEB/FR/pagederetourseserveuraserveurpersonnalmise.awp?TEST=O
	```
en remplaçant  : 

	- "www.mondomaine.fr" par le nom ou l'adresse IP du site,

	- "MONSITE" par le nom du projet du site,

	- "pagederetourseserveuraserveurpersonnalmise" par le nom de la page de retour puis par le nom de la page de serveur à serveur. 




2. Si le test affiche : 

	- une autre page, il faut contrôler le code du projet et voir s'il n'y a pas l'affichage d'une page qui est forcée dans certains cas (fonction [PageAffiche](../WDLang2/3058008.md)). Et par exemple, ne pas effectuer cette action en mode AWP (fonction [EnModeAWP](../WDLang1/3014031.md)). 

	- une erreur, il faut rechercher l'origine de cette erreur. 

	- OK ou si vous n'êtes pas dans les cas précédents, il faut consulter le log de la transaction dans la table "Transactions", rubrique "LogInfo". Ce log est aussi récupérable avec les fonctions **TransactionLog**, **TransactionLogSelonID** par programmation.








### Comment activer les log (WLOG) et les lire ?
<a name="comment_activer_les_log_wlog_les_lire_ELTPARAGRAPHE000330"></a>La création de log (WLog) est une fonctionnalité du WLangage qui permet d'enregistrer dans un fichier toutes les lignes de code qui s'exécutent dans un fichier WLOG avec plus ou moins de détails. Pour cela, il faut utiliser la fonction [dbgActiveLog](../WDLang1/1000017137.md). 

Si vous avez suivi les différentes étapes de ce document, dans le code du projet, il y a une ligne sur laquelle il suffit d'enlever les commentaires : 

```wl
dbgActiveLog(fRepDonnées()+["\"]+"paiementlog_[%Date%]_[%Heure%].wlog", LogTout)
```


En cas de difficulté, il faut : 

1. Activer les logs. 

2. Déployer le site (si le problème ne se produit qu'en déploiement). 

3. Refaire la manipulation qui provoque le problème.

4. Récupérer les fichiers WLOG pour les ouvrir avec WEBDEV.




**Attention** : WEBDEV ne montrera pas toutes informations présentent dans les fichiers WLOG : il ne montre que les informations de la configuration active du projet qui est ouvert sous l'éditeur.

- Si aucun projet n'est ouvert, vous ne verrez rien. 

- Si votre projet est ouvert, vous verrez les lignes de code exécutées par votre projet. 

- Si le projet du composant de paiement sécurisé est ouvert avec la configuration du composant activé, vous verrez les lignes de code exécutées par le composant.




Attention : Ne laissez pas en permanence les logs activés : cela risque de ralentir le site et d'encombrer rapidement l'espace disque. Pour ne pas avoir à recompiler le site pour activer les logs, vous pouvez conditionner l'activation à une information dans un fichier de paramétrage. Par exemple : 

```wl
SI Val(INILit("PARAMETRE", "WLOG", "0", fRepDonnées() + ["\"] + "param.ini")) = 1 ALORS
	dbgActiveLog(fRepDonnées() + ["\"] + "paiementlog_[%Date%]_[%Heure%].wlog", LogTout)		
FIN
```







## Robot de surveillance : Configuration des paramètres du robot
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000302"></a>
Depuis le moniteur, il est possible de modifier les options de configuration :

- du robot,

- du contre-robot,

- du moniteur.




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Configuration des paramètres du robot
<a name="configuration_des_parametres_robot_ELTTEXTE000326"></a>
Les paramètres du robot correspondent aux paramètres indiqués dans l'assistant de configuration du robot.

**Pour afficher les paramètres du robot** : 

1. Dans le menu, dans le groupe "Paramétrage", cliquez sur "Paramétrer" puis sélectionnez l'option "Paramètres du robot de surveillance".

2. La fenêtre qui s'affiche reprend les caractéristiques du robot :

	- Nom, machine, répertoire d'accès.

	- Options d'alerte. Ces options d'alerte sont configurables pour : 

		- alerte via WDBal, 

		- alerte via Email,

		- alerte via programme tiers, 


 En cas d'alerte par Email ou WDBal, il est possible de paramétrer le rapport envoyé. 




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Options d'alerte
<a name="options_alerte_ELTTEXTE000350"></a>


### Alerte par WDBal
<a name="alerte_par_wdbal_ELTPARAGRAPHE000042"></a>L'onglet "WDBal" permet de paramétrer l'envoi de rapport d'erreurs par la messagerie PC SOFT nommée WDBal. Pour utiliser ce mode de message d'alerte, la base de données des Centres de Contrôle doit être accessible depuis le poste où le robot est installé.


![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Param_robot%20-%20HC%20N%B0001.gif)


Si l'option d'envoi de messages par WDBal est activée (option "Envoi par WDBal activé" cochée), ce mode d'alerte sera utilisé par défaut pour tous les contrôles présents dans le moniteur. Il est ensuite possible pour chaque utilisateur de définir des paramètres spécifiques.

La section "Configuration de WDBal" permet de définir le mode d'accès aux données des Centres de Contrôle :

- En mode partage réseau : répertoire des fichiers de données.

- En mode HFSQL Client/Serveur : serveur utilisé, port et base de données, ainsi que l'utilisateur et le mot de passe. 



<a name="NOTE3_2"></a>


### Alerte par email
<a name="alerte_par_email_ELTPARAGRAPHE000062"></a>L'onglet "Email" permet de paramétrer l'envoi de rapport d'erreurs par email. Pour utiliser ce mode de message d'alerte, un serveur SMTP doit être accessible depuis le poste où le robot est installé.


![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Param_robot%20-%20HC%20N%B0002.gif)


Si l'option d'envoi de messages par email est activée (option "Envoi par Email activé" cochée), ce mode d'alerte sera utilisé par défaut pour tous les contrôles présents dans le moniteur. Il est ensuite possible pour chaque utilisateur de définir des paramètres spécifiques.

La section "Configuration de l'envoi d'emails" permet de définir les caractéristiques du serveur SMTP utilisé :

- Serveur et port SMTP. 

- Utilisateur et mot de passe associé pour utiliser le serveur SMTP.

- Sécurité utilisée. 



<a name="NOTE3_3"></a>


### Utilisation d'un programme tiers
<a name="utilisation_programme_tiers_ELTPARAGRAPHE000083"></a>L'onglet "Programme tiers" permet de : 

- paramétrer l'envoi du rapport d'erreurs à un programme spécifique. Ce programme tiers se chargera de traiter les messages d'alerte. 
	Pour utiliser ce mode de message d'alerte, indiquez le chemin de l'exécutable voulu. Cet exécutable doit être accessible depuis le poste d'installation du robot. 

- spécifier une Webhook. L'appel à la webhook sera réalisé après chaque exécution de tests, en passant en paramètre un fichier JSON. 
	Pour utiliser une webhook, il suffit de spécifier l'URL de la Webhook à appeler. 





![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Param_robot%20-%20HC%20N%B0003.gif)


**Envoi du rapport d'erreur à un programme tiers**
Dans ce mode d'envoi, le rapport d'erreur est un fichier XML. Le chemin du rapport d'erreur sera passé en ligne de commande au programme tiers et devra être traité par ce programme.

Le format du fichier XML est le suivant : 

```xml
<Test>
<NumeroTest>%1</NumeroTest>
<NomTest>%2</NomTest>
<CategorieTest>%3</CategorieTest>
<PrioriteTest>%4</PrioriteTest>
<SyntaxeTest>
%5
</SyntaxeTest>
<SolutionTest>
%6
</SolutionTest>
<DateErreur>%7</DateErreur>
<HeureErreur>%8</HeureErreur>
<MessageErreurPersonnel>
%9
</MessageErreurPersonnel>
<MessageErreur>
%10
</MessageErreur>
</Test>
<Test>
...
</Test>
```

Dans ce code :

- %1 = Numéro identifiant le test

- %2 = Nom du test

- %3 = Nom de la catégorie du test

- %4 = Priorité du test

- %5 = Syntaxe du test (paramètres associées)

- %6 = Solution proposée pour le test

- %7 = Date de l'erreur

- %8 = Heure de l'erreur

- %9 = Message d'erreur renseigné dans la fiche du test

- %10 = Message d'erreur renvoyé par le robot




Si l'option d'envoi de messages par programme tiers est activée (option "Envoi par programme tiers activé" cochée), ce mode d'alerte sera utilisé par défaut pour tous les contrôles présents dans le moniteur.

**Appel d'une webhook**
L'appel sera réalisé après chaque test exécuté, en passant en paramètre un fichier JSON. 

Le fichier JSON a le format suivant : 


```txt
{
  "RobotName": "Nom robot",
  "ControlName": "Nom du contrôle",
  "ControlCategory": "Nom de la catégorie",
  "Severity": "Niveau erreur"
  "ResponsibleList": "Responsable",
  "FirstError": "DateHeure de la première erreur",
  "ErrorMessage": "Message d'erreur",
  "IsError": 0/1
  "CustomError" : "Message personnalisé"
}
```


Les éléments présents dans le fichier JSON sont les suivants :

- RobotName : nom du robot de surveillance (utile si vous avez plusieurs robots dans votre organisation et si vous souhaitez tous les orienter vers la même webhook).

- ControlName : nom (libellé) du contrôle.

- ControlCategory : nom (libellé) de la catégorie du contrôle.

- Severity : niveau de gravité du contrôle. En version 26, ce paramètre vaut toujours "Erreur".

- ResponsibleList : liste des utilisateurs recevant les alertes de ce contrôle.

- FirstError : date et heure de la première erreur signalée. Ce membre est utile pour savoir depuis combien de temps un contrôle est en erreur.

- IsError : booléen indiquant si le contrôle est en erreur.

- ErrorMessage : message d'erreur du contrôle.

- CustomError : message de complément d'erreur (qui a été saisi dans les paramètres du contrôle, depuis le moniteur du robot).




Remarque : Si vous souhaitez réaliser une Webhook en WEBDEV : 

1. Créez un projet WEBDEV avec une page AWP vide. 

2. Dans la page AWP : 

	- Déclarez la structure d'export : 
			
		```wl
		// Structure d'export
		STWebHookExport est une Structure
			RobotName est une chaîne
			ControlName est une chaîne
			ControlCategory est une chaîne
			Severity est une chaîne
			ResponsibleList est une chaîne
			FirstError est une DateHeure
			ErrorMessage est une chaîne
			IsError est un booléen
			CustomError est une chaîne
		FIN
		
		gtabInfoWebhook est un tableau de STWebHookExport
		```


	- Récupérez et désérialisez les données avant de les utiliser : 
			
		```wl
		bufDonnéesPOST est un Buffer = PageParamètre(paramBuffer)
		Désérialise(gtabInfoWebhook,bufDonnéesPOST,psdJSON)
		```









- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WW_Statut_Liste.gif) ***Exemples didactiques (WEBDEV)*** : **WW_Statut_Liste** <br>Cet exemple est une implémentation très simple de la webhook mise à disposition par le robot de surveillance.<br>Il suffit d'indiquer l'URL de la page webhook de l'exemple comme webhook à appeler dans les paramètres du robot de surveillance puis de définir les catégories et les contrôles.<br>La page affichera toutes les 2 minutes l'état des contrôles.




<a name="NOTE3_4"></a>


### Paramétrage du rapport
<a name="parametrage_rapport_ELTPARAGRAPHE000168"></a>L'onglet "Paramétrage du rapport" permet de paramétrer le sujet du message envoyé (par email ou par WDBal).

![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Param_robot%20-%20HC%20N%B0004.gif)


- La section "Objet de l'email envoyé" permet de construire le titre du message. Des macros permettent d'obtenir des informations spécifiques (nom du robot, nombre de contrôles en erreur, ...).

- La section "Mode d'alerte" permet de choisir le mode d'alerte retenu : 

	- **Mode "Alerte continue"** (par défaut) : 
			Si un contrôle donné est en erreur plusieurs fois de suite (par exemple, si le serveur ne répond pas pendant plusieurs minutes), le robot enverra systématiquement une alerte pour chaque erreur.

	- **Mode "Panne/reprise"**
			Si un contrôle donné est en erreur plusieurs fois de suite (par exemple, si le serveur ne répond pas pendant plusieurs minutes), le robot effectue les opérations suivantes : 
			**1.** Le robot enverra une alerte lors de la première erreur détectée.
			**2.** Le robot enverra des alertes intermédiaires, toutes les xx minutes. Le délai entre chaque envoi est paramétrable.
			Il est également possible de n'envoyer aucun message intermédiaire.
			**3.** Le robot enverra un message lorsque le contrôle ne sera plus en erreur (par exemple si le serveur est redémarré).
			**Notes** :

		- Le mode "Panne/Reprise" s'applique à tous les contrôles (il n'est pas possible de préciser ce mode pour un contrôle en particulier).

		- Si ce mode est activé et que le robot surveille des éléments sensibles, il est conseillé d'envoyer des messages intermédiaires.

		- Exemple de déroulement : 
						

| Temps | Etat du contrôle | Mode Alerte continue | Mode Panne/Reprise |
| --- | --- | --- | --- |
| Instant T | Contrôle en erreur | Alerte envoyée | Alerte envoyée |
| Instant T+1 | Contrôle en erreur | Alerte envoyée | Aucune alerte envoyée |
| Instant T+2 | Contrôle en erreur | Alerte envoyée | Aucune alerte envoyée |
| Instant T+3 | Contrôle en erreur | Alerte envoyée | Aucune alerte envoyée |
| Instant T+4 | Contrôle en erreur | Alerte envoyée | Aucune alerte envoyée |
| Instant T+5 | Contrôle correct | Aucune alerte envoyée | Alerte envoyée |









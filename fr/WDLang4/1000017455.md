


## hDescriptionSauvegarde (Type de variable)

***En anglais : hBackupDescription ***
				



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Le type **hDescriptionSauvegarde** permet de décrire une sauvegarde HFSQL Client/Serveur par programmation. 
Cette sauvegarde peut être immédiate ou planifiée. 
Les caractéristiques de cette sauvegarde peuvent être définies et modifiées à l'aide de différentes [propriétés WLangage](#NOTE0_1).

**Remarque** : Pour plus de détails sur la déclaration de ce type de variable et l'utilisation des propriétés WLangage, consultez [Déclaration d'une variable](../Motscles/1514032.md).


<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
// Description d'une sauvegarde immédiate
Sauvegarde_Doc est une hDescriptionSauvegarde
Sauvegarde_Doc.Description = "Sauvegarde Doc"
Sauvegarde_Doc.AvecIndex = Vrai
Sauvegarde_Doc.Jauge = "JAUGE_MaJauge"
Sauvegarde_Doc.Destination = "Doc/Sauvegarde"
Sauvegarde_Doc.Source = "Doc/*"
Sauvegarde_Doc.ProcédureAvant = "mabasededonnees:ColDoc.Vérif" 
Sauvegarde_Doc.ProcédureAprès = "mabasededonnees:ColDoc.VérifSauvegarde"
Sauvegarde_Doc.LimiteNombreSauvegarde = 5
// Enregistrement de la sauvegarde 
HSauvegarde(MaConnexion, Sauvegarde_Doc)
```
<a name="Exemple2"></a>

```wl
// Création d'une sauvegarde planifiée toutes les 5 minutes 
// avec une sauvegarde différentielle toutes les minutes
hSvg est une hDescriptionSauvegarde
hSvg.Activé = Vrai
hSvg.AvecIndex = Vrai
hSvg.Description = "Sauvegarde planifiée toutes les N minutes " + ...
	" avec une sauvegarde différentielle toutes les minutes sur la base de données " + ...
	 cnx.BaseDeDonnées + " créée le "+ DateVersChaîne(DateSys(), maskDateSystème) + ...
	" à " + HeureVersChaîne(HeureSys(), "HH:MM:SS:CC")
hSvg.Destination = "Sauvegarde_"+ cnx.BaseDeDonnées
hSvg.LimiteNombreSauvegarde = 2
hSvg.Source = cnx.BaseDeDonnées
hSvg.PlanificationComplète.Mois = "*"
hSvg.PlanificationComplète.JourDuMois = "*"
// Définition de la planification
dhDateHeureServeur est une DateHeure = HInfoServeur(cnx, hInfoDate)
dhDateHeureServeur.Minute++
hSvg.PlanificationComplète.Heure = dhDateHeureServeur.Heure
hSvg.PlanificationComplète.Minute = dhDateHeureServeur.Minute
hSvg.PlanificationComplète.JourDeLaSemaine = "*"
hSvg.PlanificationComplète.JourDuMoisOuDeLaSemaine = Faux
hSvg.PlanificationDifférentielle.Mois = "*"
hSvg.PlanificationDifférentielle.JourDuMois = "*"
hSvg.PlanificationDifférentielle.Heure = "*"
hSvg.PlanificationDifférentielle.Minute = "*"
hSvg.PlanificationDifférentielle.JourDeLaSemaine = "*"
hSvg.PlanificationDifférentielle.JourDuMoisOuDeLaSemaine = Faux

// Ajout de la sauvegarde planifiée
SI HAjouteSauvegardePlanifiée(cnx, hSvg) = Faux ALORS
	Erreur("Echec de la création de la sauvegarde planifiée", HErreurInfo(hErrComplet))
	RETOUR
FIN
```

<a name="XSYNTAXE"></a>
<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Propriétés WLangage utilisables avec le type hDescriptionSauvegarde
<a name="proprietes_wlangage_utilisables_avec_type_hdescriptionsauvegarde_ELTPARAGRAPHE000046"></a>Les propriétés suivantes peuvent être utilisées pour manipuler une variable de type **hDescriptionSauvegarde**.

| Nom | Type manipulé | Effet |
| --- | --- | --- |
| Activé | Booléen | Permet de gérer l'activation d'une sauvegarde planifiée :  <br><br>- <u><u><u><u>Vrai</u></u></u></u> si la planification de la sauvegarde est activée : la sauvegarde est réalisée selon la planification définie. <br><br>- <u><u><u><u>Faux</u></u></u></u> si la planification de la sauvegarde n'est pas activée : la sauvegarde n'est pas réalisée.<br><br><br> |
| AvecIndex | Booléen | <br><br>- <u><u><u><u>Vrai</u></u></u></u> si la sauvegarde des index doit être réalisée,<br><br>- <u><u><u><u>Faux</u></u></u></u> dans le cas contraire.<br><br><br>Cette propriété est optionnelle. <br>Par défaut, la sauvegarde des index est réalisée. |
| Compression | Constante de type Entier | Permet de compresser ou non le résultat de la sauvegarde. Cette propriété peut correspondre à une des constantes suivantes :<br><br>- *zipFormatAucun* : Aucune compression.<br><br>- *zipFormatZIP* : Compression au format Zip.<br><br><br> |
| Description | Chaîne de caractères | Description associée à la sauvegarde. <br>Cette propriété est optionnelle. <br>Par défaut, la description de la sauvegarde correspond à une chaîne vide (""). |
| Destination | Chaîne de caractères | Destination de la sauvegarde (Nom et destination de la sauvegarde). <br>La sauvegarde sera réalisée sur le serveur, dans un emplacement défini par ce nom. <br>Si ce nom correspond à un chemin relatif, la sauvegarde sera placée dans le sous-répertoire "Backup" du serveur HFSQL. <br>Pour spécifier :<br><br>- le répertoire du service Manta, il suffit d'utiliser la chaîne de caractères "%%EXE%%".<br><br>- l'année, il suffit d'utiliser la chaîne de caractères "%%ANNEE%%" (par exemple 2008).<br><br>- le mois sur 2 chiffres, il suffit d'utiliser la chaîne de caractères "%%MOIS%%" (par exemple 03).<br><br>- le jour, il suffit d'utiliser la chaîne de caractères "%%JOUR%%".<br><br>- l'heure, il suffit d'utiliser la chaîne de caractères "%%HEURE%%".<br><br>- les minutes, il suffit d'utiliser la chaîne de caractères "%%MINUTE%%".<br><br><br><br><br>Exemples : <br><br>- Pour stocker la sauvegarde dans un répertoire qui correspond à l'année, au jour, et à l'heure dans le sous-répertoire "Backup", utilisez : <br>	<br><pre><code>// Sauvegarde dans le répertoire 2021_21_13 <br>	Svg_Doc.Destination="%%ANNEE%%_%%JOUR%%_%%HEURE%%"</code></pre><br><br><br>- Pour stocker la sauvegarde dans un répertoire "Doc/Sauvegarde" au même niveau que le répertoire du service Manta, utilisez : <br>	<br><pre><code>Svg_Doc.Destination="%%EXE%%/Doc/Sauvegarde/%%ANNEE%%"</code></pre><br><br><br><br> |
| Identifiant | Entier | Identifiant de la sauvegarde. <br>**Cette propriété est disponible en lecture seulement**. |
| Jauge | Nom d'un champ | Nom du champ Jauge utilisé dans la fenêtre pour voir la progression de la phase d'initialisation de la sauvegarde (et non la progression de la sauvegarde). <br><br>Propriété optionnelle disponible uniquement en WINDEV. |
| LimiteNombreSauvegarde | Entier | Nombre maximum de sauvegardes du même type à réaliser. Si ce chiffre correspond à 0, il n'y a pas de limite. <br>Si le nombre de sauvegardes dépasse la valeur limite, certaines sauvegardes anciennes seront retirées du serveur.<br>Pour plus de détails, consultez le paragraphe ["Fonctionnement de la limite du nombre de sauvegardes"](#NOTE0_2). |
| PlanificationComplète | Variable de type [hPlanification](../WDLang4/1000018853.md) | Caractéristiques d'une sauvegarde complète. Cette propriété est obligatoire. |
| PlanificationDifférentielle | Variable de type [hPlanification](../WDLang4/1000018853.md) | Caractéristiques d'une sauvegarde différentielle. Il est possible de définir à la fois une sauvegarde complète et une sauvegarde différentielle. Il n'est pas possible de réaliser uniquement une sauvegarde différentielle.<br>Cette propriété est optionnelle. |
| ProcédureAprès | Chaîne de caractères | Nom de la procédure stockée utilisée après l'exécution de la sauvegarde.<br> Le nom de la procédure est de la forme : &lt;Nom de la base de données&gt;:&lt;Nom de la collection de procédures&gt;.&lt;Nom de la procédure stockée&gt;. <br><br>Cette propriété est optionnelle. <br>Si cette propriété n'est pas définie, aucune procédure n'est exécutée.<br><br>Pour plus de détails, consultez le paragraphe ["Paramètres de la procédure stockée appelée APRES la sauvegarde"](#Note0_4). |
| ProcédureAvant | Chaîne de caractères | Nom de la procédure stockée utilisée avant l'exécution de la sauvegarde.<br> Le nom de la procédure est de la forme : &lt;Nom de la base de données&gt;:&lt;Nom de la collection de procédures&gt;.&lt;Nom de la procédure stockée&gt;. <br><br>Cette propriété est optionnelle. <br>Si cette propriété n'est pas définie, aucune procédure n'est exécutée.<br><br>Pour plus de détails, consultez le paragraphe ["Paramètres de la procédure stockée appelée AVANT la sauvegarde"](#Note0_3). |
| Source (\*) | Chaîne de caractères | Filtre utilisé pour définir les données à sauvegarder. Les valeurs possibles sont :<br><br>- \* : Sauvegarde toutes les bases de données du serveur, les journaux, les bases de données systèmes (utilisateurs, groupes, droits).<br><br>- Nom de la base de données/\* : Sauvegarde toute la base de données : fichiers, liaisons, procédures stockées, triggers.<br><br>- Nom de la base de données/Nom Fichier1 : Sauvegarde le fichier &lt;Nom Fichier1&gt; de la base de données &lt;Nom de la base de données&gt;.<br><br>- Nom de la base de données 1/Nom Fichier1 + TAB + Nom de la base de données 2/Nom Fichier2 + ... : Liste d'éléments à sauvegarder. Le séparateur utilisé peut être la tabulation (TAB) ou le point virgule (";").<br><br>- *System* : Sauvegarde les bases de données systèmes (utilisateurs, groupes, droits).<br><br><br>Cette propriété est obligatoire. |
| Utilisateur | Chaîne de caractères | Utilisateur qui a créé la sauvegarde.<br>**Cette propriété est disponible en lecture seulement**. |
| WebhookAprès | Chaîne de caractères | URL d'un service REST qui sera déclenché après la sauvegarde et la procédure spécifiée avec la propriété **ProcédureAprès** (si elle existe). <br><br>Une requête de type POST sera effectuée sur l'URL fournie. L'URL reçoit un contenu de type 'application/json' correspondant aux informations sur la sauvegarde effectuée. Par exemple : <br><pre><code>{<br>	"identifier" : "283",<br>	"destination" : "c:\backup\283\monbackup.zip",<br>	"state" : "completed"<br>}</code></pre><br>où : <br><br>- "identifier" correspond à l'identifiant de la sauvegarde. <br><br>- "destination" correspond à la destination de la sauvegarde. <br><br>- "state" correspond à l'état de la sauvegarde. Différents états sont possibles : 'completed', 'canceled' ou 'error'.<br><br><br> |





Les propriétés suivies du caractère (\*) sont obligatoires.
<a name="NOTE0_2"></a>


### Fonctionnement de la limite du nombre de sauvegardes (propriété LimiteNombreSauvegarde)
<a name="fonctionnement_limite_nombre_sauvegardes_propriete_limitenombresauvegarde_ELTPARAGRAPHE000282"></a>Lorsque la limite du nombre de sauvegardes est activée (**LimiteNombreSauvegarde** différent de 0)  :

1. Avant la sauvegarde : Recherche des anciennes sauvegardes similaires (même source et même destination). Si ces sauvegardes sont en erreur, les fichiers de la sauvegarde seront effacés du disque (mais la sauvegarde restera présente dans l'historique des sauvegardes).

2. Exécution de la "Procédure Avant".

3. Sauvegarde.

4. Exécution de la "Procédure Après".

5. Si le nombre de sauvegardes similaires (même source et même destination) effectuées avec succès est supérieur à la valeur de la limite alors le serveur va supprimer certaines de ces sauvegardes et les retirer de l'historique. Cette suppression se fait en commençant par la sauvegarde la plus ancienne jusqu'à ce que le nombre de sauvegardes soit égal à la valeur demandée.




**Remarque** : Il est possible d'utiliser cette propriété pour mettre en place un système de sauvegarde spécifique. Par exemple :

- Une sauvegarde tous les jours, avec conservation des 7 dernières.

- Une sauvegarde toutes les semaines avec conservation des 4 dernières.

- Une sauvegarde tous les mois avec conservation des 6 dernières.



<a name="Note0_3"></a>


### Paramètres de la procédure stockée appelée AVANT la sauvegarde
<a name="parametres_procedure_stockee_appelee_avant_sauvegarde_ELTPARAGRAPHE000301"></a>La procédure stockée appelée AVANT la sauvegarde peut prendre des paramètres. Cette procédure est de la forme : 

```txt
PROCEDURE <Nom de la procédure>(<Données à sauvegarder>, ...
		<Destination de la sauvegarde>, <Description>)
```
Ces paramètres sont optionnels. Ils vous permettront de manipuler les indications suivantes dans le code de la procédure stockée :

- ***&lt;Données à sauvegarder&gt;*** : Chaîne de caractères correspondant aux informations à sauvegarder. Correspond à la propriété **Source**. Les valeurs possibles sont les suivantes :
	


|   |   |
| --- | --- |
| *\** | Sauvegarde toutes les bases de données du serveur, les journaux, les bases de données systèmes (utilisateurs, groupes, droits). |
| *Nom de la base de données 1/Nom Fichier1 + TAB + Nom de la base de données 2/Nom Fichier2 + ...* | Liste d'éléments à sauvegarder. Le séparateur utilisé peut être la tabulation (TAB) ou le point virgule (";"). |
| *Nom de la base de données/\** | Sauvegarde toute la base de données : fichiers, liaisons, procédures stockées, triggers. |
| *Nom de la base de données/Nom Fichier1* | Sauvegarde le fichier &lt;Nom Fichier1&gt; de la base de données &lt;Nom de la base de données&gt;. |
| *System* | Sauvegarde les bases de données systèmes (utilisateurs, groupes, droits). |



- ***&lt;Destination de la sauvegarde&gt;*** : Nom et destination de la sauvegarde. Correspond à la propriété **Destination**. La sauvegarde sera réalisée sur le serveur, dans un emplacement défini par ce nom. Si ce nom correspond à un chemin relatif, la sauvegarde sera placée dans le sous-répertoire "Backup" du serveur HFSQL. Pour spécifier :

	- le répertoire du service Manta, il suffit d'utiliser la chaîne de caractères "%%EXE%%".

	- l'année, il suffit d'utiliser la chaîne de caractères "%%ANNEE%%" (par exemple 2008).

	- le mois sur 2 chiffres, il suffit d'utiliser la chaîne de caractères "%%MOIS%%" (par exemple 03).

	- le jour, il suffit d'utiliser la chaîne de caractères "%%JOUR%%".

	- l'heure, il suffit d'utiliser la chaîne de caractères "%%HEURE%%".

	- les minutes, il suffit d'utiliser la chaîne de caractères "%%MINUTE%%".




- ***&lt;Description&gt;*** : Description de la sauvegarde. Correspond à la propriété **Description**.



<a name="Note0_4"></a>


### Paramètres de la procédure stockée appelée APRES la sauvegarde
<a name="parametres_procedure_stockee_appelee_apres_sauvegarde_ELTPARAGRAPHE000345"></a>La procédure stockée appelée APRES la sauvegarde peut prendre des paramètres. Cette procédure est de la forme : 

```txt
PROCEDURE <Nom de la procédure>(<Données à sauvegarder>, <Destination de la sauvegarde>, ...
			<Description>, <Etat>, <Message d'erreur>)
```
Ces paramètres sont optionnels. Ils vous permettront de manipuler les indications suivantes dans le code de la procédure stockée :

- ***&lt;Données à sauvegarder&gt;*** : Chaîne de caractères correspondant aux informations à sauvegarder. Correspond à la propriété **Source**. Les valeurs possibles sont les suivantes :
	


|   |   |
| --- | --- |
| *\** | Sauvegarde toutes les bases de données du serveur, les journaux, les bases de données systèmes (utilisateurs, groupes, droits). |
| *Nom de la base de données 1/Nom Fichier1 + TAB + Nom de la base de données 2/Nom Fichier2 + ...* | Liste d'éléments à sauvegarder. Le séparateur utilisé peut être la tabulation (TAB) ou le point virgule (";"). |
| *Nom de la base de données/\** | Sauvegarde toute la base de données : fichiers, liaisons, procédures stockées, triggers. |
| *Nom de la base de données/Nom Fichier1* | Sauvegarde le fichier &lt;Nom Fichier1&gt; de la base de données &lt;Nom de la base de données&gt;. |
| *System* | Sauvegarde les bases de données systèmes (utilisateurs, groupes, droits). |



- ***&lt;Destination de la sauvegarde&gt;*** : Nom et destination de la sauvegarde. Correspond à la propriété **Destination**. La sauvegarde sera réalisée sur le serveur, dans un emplacement défini par ce nom. Si ce nom correspond à un chemin relatif, la sauvegarde sera placée dans le sous-répertoire "Backup" du serveur HFSQL. Pour spécifier :

	- le répertoire du service Manta, il suffit d'utiliser la chaîne de caractères "%%EXE%%".

	- l'année, il suffit d'utiliser la chaîne de caractères "%%ANNEE%%" (par exemple 2008).

	- le mois sur 2 chiffres, il suffit d'utiliser la chaîne de caractères "%%MOIS%%" (par exemple 03).

	- le jour, il suffit d'utiliser la chaîne de caractères "%%JOUR%%".

	- l'heure, il suffit d'utiliser la chaîne de caractères "%%HEURE%%".

	- les minutes, il suffit d'utiliser la chaîne de caractères "%%MINUTE%%".




- ***&lt;Description&gt;*** : Description de la sauvegarde. Correspond à la propriété **Description**.

- ***&lt;Etat&gt;*** :  entier (ou constante de type Entier) permettant de connaître l'état de la sauvegarde :
	


|   |   |   |
| --- | --- | --- |
| *hSvgAnnulée* | 2 | Sauvegarde annulée |
| *hSvgEnCours* | 0 | Sauvegarde en cours |
| *hSvgErreur* | 3 | Erreur lors de la sauvegarde |
| *hSvgTerminée* | 1 | Sauvegarde terminée |



- ***&lt;Message d'erreur&gt;*** : Message d'erreur s'il existe sous forme de chaîne de caractères.



<a name="NOTE0_5"></a>


### Fonctions utilisant les variables de type hDescriptionSauvegarde : 
<a name="fonctions_utilisant_les_variables_type_hdescriptionsauvegarde_ELTPARAGRAPHE000417"></a>


|   |   |
| --- | --- |
| [HAjouteSauvegardePlanifiée](../WDLang4/1000018866.md) | Ajoute une planification de sauvegarde complète (avec ou sans sauvegarde différentielle) sur le serveur défini par la connexion. |
| [HListeSauvegardePlanifiée](../WDLang4/1000018868.md) | Liste les sauvegardes complètes et différentielles qui ont été planifiées sur un serveur HFSQL Client/Serveur. |
| [HModifieSauvegardePlanifiée](../WDLang4/1000018932.md) | Modifie une planification de sauvegarde. |
| [HSauvegarde](../WDLang4/1000017081.md) | Réalise la sauvegarde du contenu d'un serveur HFSQL : toutes les bases de données du serveur, une ou plusieurs bases de données, un ou plusieurs fichiers de données. |







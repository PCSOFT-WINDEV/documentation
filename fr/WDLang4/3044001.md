


## HTransactionAnnule (Fonction)

***En anglais : HTransactionCancel***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
**Si une transaction est en cours**, annule toutes les opérations effectuées sur les fichiers de données en transactions depuis le début de la transaction. Dans ce cas, la transaction est annulée sans interrompre l'exécution du programme.

**Si aucune transaction est en cours**, rétablit la cohérence de la base de données et annule la transaction qui a échoué (cas d'une coupure de courant par exemple). 
Remarque : Une transaction qui a échoué peut être annulée par n'importe quel programme.
Si le fichier de transaction n'est pas partagé, il est automatiquement détruit. Les enregistrements bloqués par les écritures effectuées durant la transaction sont débloqués.

**Remarque** : La fonction [HTransactionLibère](../WDLang4/3044016.md) transforme tous les enregistrements "en transaction" en enregistrements "normaux" si ces enregistrements n'appartiennent pas à une transaction actuellement en cours. 




<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
MaConnexion est une Connexion

// Début de la transaction sur les fichiers de données associés à la connexion MaConnexion
HTransactionDébut(MaConnexion)
Ajout_Commande()
QUAND EXCEPTION DANS
	// Ajout de la commande
	HAjoute(Commande) 
	// Validation de l'ajout
	HTransactionFin(MaConnexion)
FAIRE
	// Suppression des lignes de commandes
	HTransactionAnnule(MaConnexion)
FIN
```
<a name="Exemple2"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) 
```wl
// Début de la transaction sur les fichiers de données Commande et LigneCde
HTransactionDébut("C:\Temp\Transaction.trs", "Commande, LigneCde, -Client")
Ajout_Commande()
QUAND EXCEPTION DANS
	// Ajout de la commande
	HAjoute(Commande) 
	// Validation de l'ajout
	HTransactionFin()
FAIRE
	// Suppression des lignes de commandes
	HTransactionAnnule()
FIN
```
<a name="Exemple3"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) 
```wl
// Début de la transaction sur les fichiers de données Commande et LigneCde
HTransactionDébut("Commande,LigneCde,-Client")
Ajout_Commande()
QUAND EXCEPTION DANS
	// Ajout de la commande
	HAjoute(Commande)
	// Validation de l'ajout
	HTransactionFin() 
FAIRE
	// Suppression des lignes de commandes
	HTransactionAnnule() 
FIN
```

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

### Annuler une transaction en cours ou une transaction interrompue sur une connexion Client/Serveur

`<Résultat> = HTransactionAnnule(<Connexion>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur. 




**Attention** : 

- S'il y a une transaction en cours sur la connexion, elle est annulée. 

- S'il n'y a pas de transactions en cours, les transactions interrompues sont annulées pour la connexion spécifiée. 




**`<Connexion> : (Chaîne de caractères ou variable de type Connexion)`**

Connexion à manipuler. Cette connexion correspond : 

- soit au nom de la connexion définie sous l'éditeur d'analyses ou grâce aux fonctions [HDécritConnexion](../WDLang4/3044205.md) ou [HOuvreConnexion](../WDLang4/3044107.md).

- soit au nom d'une variable de type [Connexion](../WDLang4/1514073.md).


Si ce paramètre correspond à la constante *hAccèsHF7*, la transaction est annulée sur les fichiers HFSQL Classic (ISAM).


<a name="SYNTAXE2"></a>

### Annuler une transaction en cours ou une transaction interrompue sur toutes les connexions (HFSQL Classic ou Client/Serveur)

`<Résultat> = HTransactionAnnule([<Fichier de transaction>])`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur. 


**Attention** : 

- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Si le paramètre &lt;Fichier de transaction&gt; n'est pas précisé, la transaction en cours est annulée.

- **Si il y a une transaction en cours**, TOUTES les transactions en cours sont annulées (transactions HFSQL Classic et/ou transactions HFSQL Client/Serveur).

- **Si il n'y a pas de transaction en cours**, TOUTES les transactions interrompues sont annulées (en HFSQL Classic et Client/Serveur).




**`<Fichier de transaction> : (Chaîne de caractères optionnelle)`**

![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Nom et chemin du fichier de transaction à annuler : 

- Ce paramètre doit être identique au nom indiqué dans la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou dans la fonction [HTransaction](../WDLang4/1000023384.md)).

- Si ce paramètre n'est pas précisé et qu'aucune transaction n'est en cours, le fichier des transactions par défaut est pris en compte. 

- Si une transaction est en cours, cette transaction est annulée et le nom du fichier de transactions n'est pas pris en compte.


![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png)![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) Ce paramètre n'est pas pris en compte.


<a name="SYNTAXE3"></a>

### Annuler une transaction interrompue sur une base de données Client/Serveur (à utiliser si aucune transaction n'est en cours)

`<Résultat> = HTransactionAnnule(<Connexion> , <Base de données>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur.


**Attention** : 

- Seules les transactions interrompues sur la base de données spécifiée sont annulées.

- Les transactions en cours ne sont pas annulées. 




**`<Connexion> : (Chaîne de caractères ou variable de type Connexion)`**

Connexion à manipuler. Cette connexion correspond : 

- soit au nom de la connexion définie sous l'éditeur d'analyses ou grâce aux fonctions [HDécritConnexion](../WDLang4/3044205.md) ou [HOuvreConnexion](../WDLang4/3044107.md).

- soit au nom d'une variable de type [Connexion](../WDLang4/1514073.md).


Si ce paramètre correspond à la constante *hAccèsHF7*, seules les transactions interrompues en mode HFSQL Classic sont annulées.

**`<Base de données> : (Chaîne de caractères)`**

Nom de la base de données concernée. Si ce paramètre correspond à une chaîne vide (""), une erreur est affichée.


<a name="SYNTAXE4"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) 
### Annuler une transaction (à utiliser si aucune transaction n'est en cours)

`<Résultat> = HTransactionAnnule(<Fichier de transaction> , <Connexion>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur. 




**Attention** : 

- Si le paramètre &lt;Fichier de transaction&gt; n'est pas précisé, la transaction en cours est annulée.

- S'il y a une transaction "générale" en cours, TOUTES les transactions en cours sont annulées (transactions HFSQL Classic et/ou transactions HFSQL Client/Serveur).

- S'il y a une transaction en cours sur la connexion, elle est annulée. 

- S'il n'y a pas de transaction en cours, seules les transactions interrompues pour la connexion spécifiée sont annulées.




**`<Fichier de transaction> : (Chaîne de caractères)`**

Nom et chemin du fichier de transaction à annuler. 
Ce paramètre doit être identique au nom indiqué dans la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou dans la fonction [HTransaction](../WDLang4/1000023384.md)).

**`<Connexion> : (Chaîne de caractères ou variable de type Connexion)`**

Connexion à manipuler. Cette connexion correspond : 

- soit au nom de la connexion définie sous l'éditeur d'analyses ou grâce aux fonctions [HDécritConnexion](../WDLang4/3044205.md) ou [HOuvreConnexion](../WDLang4/3044107.md).

- soit au nom d'une variable de type [Connexion](../WDLang4/1514073.md).


Si ce paramètre correspond à la constante *hAccèsHF7*, seules les transactions interrompues en mode HFSQL Classic sont annulées.


<a name="SYNTAXE5"></a>

### Annuler une transaction spécifique, liée à une connexion

`<Résultat> = HTransactionAnnule(<Connexion> , <Transaction à annuler>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur.


Attention : Seules les transactions interrompues sur la base de données spécifiée sont annulées.

**`<Connexion> : (Chaîne de caractères ou variable de type Connexion)`**

Connexion à manipuler. Cette connexion correspond : 

- soit au nom de la connexion définie sous l'éditeur d'analyses ou grâce aux fonctions [HDécritConnexion](../WDLang4/3044205.md) ou [HOuvreConnexion](../WDLang4/3044107.md).

- soit au nom d'une variable de type [Connexion](../WDLang4/1514073.md).


Si ce paramètre correspond à la constante *hAccèsHF7*, seule la transaction interrompue en mode HFSQL Classic est annulée.

**`<Transaction à annuler> : (Entier)`**

Identifiant de la transaction à annuler pour la connexion spécifiée. Cet identifiant peut être connu grâce à la fonction [HTransactionListe](../WDLang4/3044351.md).  



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Localisation et accès aux fichiers de données
<a name="localisation_acces_aux_fichiers_donnees_ELTPARAGRAPHE000367"></a>Avant d'appeler la fonction **HTransactionAnnule**, les fichiers de données manipulés par la transaction annulée doivent être :

- localisés (fonctions [HSubstRep](../WDLang4/3044028.md), [HChangeNom](../WDLang4/3044141.md), ...).

- accessibles (fonction [HPasse](../WDLang4/3044108.md), ...).



<a name="NOTE0_2"></a>


### Détection d'une erreur
<a name="detection_une_erreur_ELTPARAGRAPHE000391"></a>Lorsqu'une erreur est détectée par le programme (gestion des erreurs avec QUAND EXCEPTION par exemple), la fonction **HTransactionAnnule** permet de :

- remettre les fichiers de données dans leur état initial.

- annuler l'ensemble des opérations effectuées sur les fichiers de données depuis l'appel à la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou à la fonction [HTransaction](../WDLang4/1000023384.md)).



<a name="NOTE0_3"></a>


### Conseil : Rétablir la cohérence de la base de données
<a name="conseil_retablir_coherence_base_donnees_ELTPARAGRAPHE000412"></a>Si une panne (coupure de courant, re-démarrage du poste, ...) survient pendant une transaction, les fichiers de données risquent d'être incohérents : la transaction n'a été ni validée, ni abandonnée. Le fichier de transaction est toujours présent sur le poste.

Pour rétablir la cohérence de la base de données, il est conseillé de proposer dans votre application :

- soit une option permettant de maintenir la cohérence de la base de données. 
	Cette option peut par exemple appeler la fonction **HTransactionAnnule** ou les fonctions [HTransactionDébut](../WDLang4/3044002.md)/[HTransactionFin](../WDLang4/3044032.md).

- soit une gestion de l'erreur 70034 dans le code d'initialisation du projet grâce au mot-clé QUAND EXCEPTION.
	Ainsi, quand l'erreur 70034 surviendra, la cohérence de la base de données sera restaurée soit par la fonction **HTransactionAnnule**, soit par les fonctions [HTransactionDébut](../WDLang4/3044002.md)/[HTransactionFin](../WDLang4/3044032.md).




**Remarque** : cette opération peut être relativement longue (selon le nombre d'opérations effectuées en transaction).
<a name="NOTE0_4"></a>


### Cas d'erreurs
<a name="cas_erreurs_ELTPARAGRAPHE000450"></a>

- Imbrication de transactions : Il est impossible d'imbriquer les transactions (c'est-à-dire d'appeler la fonction [HTransactionDébut](../WDLang4/3044002.md) ou la fonction [HTransaction](../WDLang4/1000023384.md) dans une transaction). Dans ce cas, l'erreur 70031 est générée.

- Une erreur fatale est affichée dans les cas suivants : 

	- Une transaction est débutée sur toutes les connexions alors qu'il existe au moins une connexion en transaction. 

	- Une transaction sur une connexion est débutée après avoir commencé une transaction sur toutes les connexions. 

	- Une transaction sur toutes les connexions est débutée alors qu'il existe au moins une connexion dont le mode d'isolation n'est pas "Read Uncommitted".






<a name="NOTE0_5"></a>


### Transactions et contexte HFSQL indépendant
<a name="transactions_contexte_hfsql_independant_ELTPARAGRAPHE000472"></a>Lors de la copie de contexte, si une transaction est en cours sur le premier contexte, le nouveau contexte n'est pas en transaction. Il faut rappeler la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)) pour démarrer une transaction dans le nouveau contexte.
<a name="NOTE0_6"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) 

### OLE DB et Connecteurs Natifs
<a name="ole_connecteurs_natifs_ELTPARAGRAPHE000483"></a>Seules les syntaxes avec connexion sont prises en compte par les Connecteurs Natifs qui gèrent les transactions. Il est également possible d'utiliser la fonction [SQLTransaction](../WDLang4/3072029.md).

<a name="XComposante"></a>

## Composante :
wd280hf.dll


## HFSQL Client/Serveur : Tâches planifiées
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000245"></a>
Les tâches planifiées permettent de planifier des tâches automatiques. Il est possible de définir des tâches planifiées au niveau du serveur HFSQL. Ces tâches planifiées peuvent correspondre :

- soit à l'appel d'une procédure stockée,

- soit à la sauvegarde de la base.




L'appel d'une procédure stockée permet d'exécuter le code de votre choix, par exemple maintenance personnalisée, édition de statistiques, ...

Les tâches planifiées peuvent être gérées :

- soit dans le [Centre de Contrôle HFSQL](#NOTE2_1).

- soit par [programmation](#NOTE3_1).




Exécution de plusieurs tâches planifiées successivement : Si la tâche planifiée précédente n'est pas terminée, la nouvelle tâche planifiée ne s'exécute pas, et une notification est envoyée par le serveur. 







<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Tâches planifiées dans le Centre de Contrôle HFSQL
<a name="taches_planifiees_dans_centre_controle_hfsql_ELTTEXTE000275"></a>




### Créer une tâche planifiée
<a name="creer_une_tache_planifiee_ELTPARAGRAPHE000048"></a>Dans le Centre de Contrôle HFSQL, les tâches planifiées peuvent être définies au niveau du serveur.

Pour créer une tâche planifiée :

1. Connectez-vous si nécessaire à un serveur HFSQL. 

2. Double-cliquez sur le nom du serveur HFSQL dans l'arborescence. 

3. La partie droite du Centre de Contrôle affiche un onglet au nom du serveur. 

4. Cliquez sur l'onglet "Eléments planifiés". 

5. Dans le ruban, dans le groupe "Eléments planifiés", déroulez "Nouvelle planification" et sélectionnez "Planifier une tâche". 

6. Sélectionnez le mode d'exécution de la tâche : la tâche peut être exécutée : 

	- Périodiquement. L'assistant vous permet ensuite de définir la fréquence d'exécution de la tâche. 

	- et/ou à chaque démarrage du serveur HFSQL. Si cette option est sélectionnée, il est nécessaire d'indiquer si : 

		- la tâche est bloquante : dans ce cas, le serveur HFSQL sera inaccessible pendant l'exécution de la tâche. 

		- la tâche doit être exécutée en tâche de fond : dans ce cas, le serveur HFSQL pourra être utilisé dès son démarrage. 




7. Sélectionnez : 

	- la base de données contenant la procédure stockée à exécuter. 

	- la collection contenant la procédure stockée à exécuter. 

	- la procédure stockée à exécuter. 
			**Attention** : Pour qu'une procédure stockée lancée depuis une tâche planifiée accède aux données, il faut utiliser la fonction [HDéclareExterne](../WDLang4/3044204.md). Cette fonction permet de déclarer des sources de données qui seront utilisées dans les traitements de la procédure stockée. En effet, lorsqu'une procédure stockée est lancée depuis le centre de contrôle HFSQL, il n'y a pas d'analyse en cours et les données HFSQL Client/Serveur ne sont pas immédiatement accessibles. 
			Si la fonction [HDéclareExterne](../WDLang4/3044204.md) n'est pas utilisée dans le code de la procédure stockée, la procédure provoquera une erreur fatale, notée dans le journal des événements du système. 
			**Remarque** : lorsqu'une procédure stockée est lancée depuis une application WINDEV, WEBDEV ou WINDEV Mobile avec la fonction [HExécuteProcédure](../WDLang4/3044358.md), elle utilise l'analyse de l'application et peut donc utiliser directement des données HFSQL Client/Serveur.




8. Définissez la fréquence de la tâche : mois, jour, heure.

9. Donnez une description à votre tâche planifiée et validez.

10. La tâche planifiée apparaît dans le Centre de Contrôle HFSQL.  





<a name="NOTE2_2"></a>




### Supprimer une tâche planifiée
<a name="supprimer_une_tache_planifiee_ELTPARAGRAPHE000097"></a>Pour supprimer une tâche planifiée :

1. Connectez-vous si nécessaire à un serveur HFSQL. 

2. Double-cliquez sur le nom du serveur HFSQL dans l'arborescence. 

3. La partie droite du Centre de Contrôle affiche un onglet au nom du serveur. 

4. Cliquez sur l'onglet "Eléments planifiés". 

5. Sélectionnez la tâche planifiée à supprimer.

6. Dans le ruban, dans le groupe "Eléments planifiés", cliquez sur "Supprimer". 
	Vous pouvez également utiliser le menu contextuel de l'élément planifié (option "Supprimer"). 



<a name="NOTE2_3"></a>




### Modifier une tâche planifiée
<a name="modifier_une_tache_planifiee_ELTPARAGRAPHE000114"></a>Pour modifier une tâche planifiée :

1. Connectez-vous si nécessaire à un serveur HFSQL. 

2. Double-cliquez sur le nom du serveur HFSQL dans l'arborescence. 

3. La partie droite du Centre de Contrôle affiche un onglet au nom du serveur. 

4. Cliquez sur l'onglet "Eléments planifiés". 

5. Sélectionnez la tâche planifiée à modifier.

6. Dans le ruban, dans le groupe "Eléments planifiés", cliquez sur "Editer". 
	Vous pouvez également utiliser le menu contextuel de l'élément planifié (option "Editer"). 

7. Une fenêtre de description de l'élément planifié apparaît. Toutes les caractéristiques saisies dans l'assistant sont regroupées sur plusieurs onglets :

	- Onglet "Général" : Définit si la tâche est active et son type (sauvegarde ou procédure stockée).

	- Onglet "Planification" : Définit les options d'exécution de la tâche planifiée (mois, jour, heure, nombre d'exécutions, exécution au démarrage).

	- Onglets "Sauvegarde" : Ces deux onglets définissent les options prises en compte si la tâche planifiée correspond à une sauvegarde.




8. Validez.






<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Tâches planifiées par programmation
<a name="taches_planifiees_par_programmation_ELTTEXTE000311"></a>
La gestion des tâches planifiées par programmation est réalisée grâce au type avancé [hTâchePlanifiée](../WDLang4/1000017448.md) et à plusieurs fonctions WLangage.

Pour créer une tâche planifiée par programmation :

1. Créez une variable de type [hTâchePlanifiée](../WDLang4/1000017448.md). Spécifiez les différentes caractéristiques de la tâche planifiée grâce aux propriétés du type [hTâchePlanifiée](../WDLang4/1000017448.md).

2. Ajoutez la tâche planifiée grâce à la fonction [HAjouteTâche](../WDLang4/1000017091.md). 




**Le WLangage met également à votre disposition les fonctions suivantes pour gérer les tâches planifiées** : 



|   |   |
| --- | --- |
| [HAjouteTâche](../WDLang4/1000017091.md) | Ajoute une tâche planifiée sur le serveur défini par la connexion. |
| [HGèreTâche](../WDLang4/1000017113.md) | Active ou désactive une tâche planifiée d'un serveur HFSQL Client/Serveur. |
| [HInfoTâche](../WDLang4/1000017409.md) | Renvoie les caractéristiques d'une tâche planifiée dans une variable de type [hTâchePlanifiée](../WDLang4/1000017448.md). |
| [HListeTâche](../WDLang4/1000017092.md) | Liste les tâches planifiées d'un serveur HFSQL Client/Serveur pour une connexion donnée. |
| [HModifieTâche](../WDLang4/1000017374.md) | Modifie une tâche planifiée sur le serveur HFSQL défini par la connexion. |
| [HSupprimeTâche](../WDLang4/1000017093.md) | Supprime une tâche planifiée d'un serveur HFSQL Client/Serveur. |







<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Remarques
<a name="remarques_ELTTEXTE000382"></a>
Pour ajouter une tâche planifiée, il est nécessaire de posséder :

- le droit de gérer les tâches (constante ***hDroitGèreTâche***).

- le droit d'exécuter la commande liée à la tâche planifiée.




La tâche sera exécutée avec l'identité de l'utilisateur défini par la connexion.



<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Exemple d'utilisation de la fonction HDéclareExterne dans une procédure stockée
<a name="exemple_utilisation_fonction_hdeclareexterne_dans_une_procedure_stockee_ELTTEXTE000406"></a>
La procédure suivante déclare un fichier de données avec la fonction [HDéclareExterne](../WDLang4/3044204.md) afin de pouvoir l'utiliser dans une tâche planifiée :  


```wl
PROCEDURE NomDeLaProcédureStockée()

// Vérification de l'existence du fichier logique
SI PAS HFichierExiste(MaConnexion, CODEPOSTAUX) ALORS
	// Fichier non connu, il faut le déclarer
	// Attention, pour déclarer un nouveau fichier dans une procédure stockée HFSQL, il faut :
	//  - NE PAS utiliser de connexion : C'est la base en cours sur laquelle 
	//		se trouve la procédure stockée qui sera utilisée
	//  - NE PAS donner un chemin complet : Le fichier sera recherché dans la base en cours. 
	//		Il est possible d'indiquer un sous-répertoire de la base de données. 
	//  - donner le nom complet du fichier, extension comprise (.FIC)
	SI PAS HDéclareExterne("CODEPOSTAUX.FIC", "CODEPOSTAUX") ALORS
		// Erreur de déclaration du fichier
		RENVOYER HErreurInfo()
	FIN	
FIN

// Utilisation du fichier de données
// POUR TOUT CODEPOSTAUX 
//	//Traitement...
// FIN

// Traitement OK, sans erreur
RENVOYER ""
```


<a name="NOTE6"></a>
<a name="NOTE6_1"></a>


## Exemple de test d'une procédure stockée
<a name="exemple_test_une_procedure_stockee_ELTTEXTE000430"></a>
Le code suivant permet de tester une procédure stockée dans des conditions similaires à celles de son exécution dans une tâche planifiée :  


```wl
// Fermeture de l'analyse en cours (la tâche planifiée n'a pas d'analyse en cours)
HFermeAnalyse()


// Déclaration de la connexion à la base HFSQL 
// Cette base contient la procédure stockée
cnxProcedureStockeeHFSQL est une Connexion
cnxProcedureStockeeHFSQL..Provider = hAccèsHFClientServeur
cnxProcedureStockeeHFSQL..Utilisateur = "ADMIN"
cnxProcedureStockeeHFSQL..MotDePasse = ""
cnxProcedureStockeeHFSQL..Serveur = "NomServeur:4900"
cnxProcedureStockeeHFSQL..BaseDeDonnées = "NomBaseDeDonnées"


// Ouverture de la connexion à la base HFSQL
HOuvreConnexion(cnxProcedureStockeeHFSQL)
SI ErreurDétectée = Vrai ALORS
	Erreur("Echec de l'ouverture de la connexion à la base HFSQL", HErreurInfo())
	RETOUR
FIN

// Exécution de la procédure stockée HFSQL avec récupération de son résultat
sRes est une chaîne
sRes = HExécuteProcédure(cnxProcedureStockeeHFSQL, "NomDeLaProcédureStockée")

// Exploitation du résultat
...
```








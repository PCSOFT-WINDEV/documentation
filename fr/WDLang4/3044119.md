


## HPrépareRequêteSQL (Fonction)

***En anglais : HPrepareSQLQuery***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Initialise une requête écrite en langage SQL et déclare cette requête au serveur de base de données pour optimiser les prochaines exécutions de cette requête. Cette requête n'est pas exécutée. La requête pourra ensuite être exécutée grâce à la fonction [HExécuteRequêteSQL](../WDLang4/3044084.md). Cette fonction peut aussi bien être utilisée avec requêtes avec ou sans bind.

Pour libérer les ressources de cette requête, utilisez la fonction [HAnnuleDéclaration](../WDLang4/3044174.md).

Cette fonction est conseillée lors de l'exécution successive d'une même requête en modifiant uniquement quelques paramètres de cette requête à chaque exécution. 


**Cette fonction est optionnelle et ne peut être utilisée que sur des bases de données Client/Serveur (actuellement disponible sur Oracle, Oracle Lite, Sybase et SQL Server)**. En SQL Server, le Connecteur Natif via OLE DB ou via ODBC peut être nécessaire.

**Pour les autres bases accédées par un Connecteur Natif, OLEDB ou ODBC, la fonction HPrépareRequêteSQL exécute la requête**.

Sur les bases de données HFSQL (HFSQL Classic ou Client/Serveur) ou sur les bases xBase, cette fonction ne peut pas être utilisée.

<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
// Exécution d'une même requête sous Oracle
// Déclaration d'une source de données
// Cette source de données correspond à la requête
Insert1 est une Source de Données
i est un entier
// Déclaration d'un des paramètres de la requête
// Le type de ce paramètre est un entier
Insert1.age = 0
// Préparation de la requête pour de multiples exécutions
HPrépareRequêteSQL(Insert1, ConnexionBase, ...
	hRequêteSansCorrection, "INSERT INTO PERSONE VALUES (:nom, :prenom, :age )")
// Boucle d'exécution de la requête
// Seuls quelques paramètres sont modifiés
POUR i = 1 A 10
	Insert1.nom = "Nom" + i
	Insert1.prenom = "Prenom" + i
	Insert1.age = i
	HExécuteRequêteSQL(Insert1)
FIN
```

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

`<Résultat> = HPrépareRequêteSQL(<Source de données> , <Connexion> , <Mode> , <Texte de la requête en SQL>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> si aucun problème n'a été rencontré, 

- <u><u><u><u>Faux</u></u></u></u> dans le cas contraire. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus d'informations sur le problème rencontré.




**`<Source de données> : (Source de données)`**

Nom de la variable de type Source de données correspondant à la requête à initialiser.

**`<Connexion> : (Chaîne de caractères ou variable de type Connexion)`**

Nom de la connexion utilisée pour exécuter la requête. Cette connexion correspond : 

- soit au nom de la connexion définie sous l'éditeur d'analyses ou grâce aux fonctions [HDécritConnexion](../WDLang4/3044205.md) ou [HOuvreConnexion](../WDLang4/3044107.md).

- soit au nom d'une variable de type [Connexion](../WDLang4/1514073.md).


Si ce paramètre ne correspond pas à une connexion existante, &lt;Résultat&gt; est à <u><u><u><u>Faux</u></u></u></u>.

**`<Mode> : (Constante de type Entier)`**




|   |   |
| --- | --- |
| *hRequêteSansCorrection* | Connecteur Natif uniquement : Aucune vérification n'est effectuée par le moteur HFSQL sur le texte de la requête. |



**`<Texte de la requête en SQL> : (Chaîne de caractères)`**

Texte de la requête SQL à exécuter.  



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Quand utiliser la fonction HPrépareRequêteSQL ? 
<a name="quand_utiliser_fonction_docparampagetitleshort_ELTPARAGRAPHE000110"></a>Dans certains cas, il peut être intéressant d'exécuter plusieurs fois une même requête en modifiant uniquement une (ou plusieurs) variable(s). Un cas courant consiste à exécuter plusieurs fois une requête d'insertion pour ajouter plusieurs enregistrements dans un fichiers.

Plusieurs solutions peuvent être mises en place :

1. Exécuter directement la requête (avec la fonction [HExécuteRequêteSQL](../WDLang4/3044084.md)) autant de fois que nécessaire en modifiant à chaque fois la ou les variable(s) voulue(s).

2. Préparer la requête à exécuter (fonction **HPrépareRequêteSQL**) ainsi que les différentes variables à modifier puis exécuter la requête autant de fois que nécessaire avec la fonction [HExécuteRequêteSQL](../WDLang4/3044084.md). Cette seconde solution est beaucoup plus rapide et optimise le temps de parcours du résultat de la requête (cas d'une requête de sélection).


![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) **SQL Server : Limite** : La fonction **HPrépareRequêteSQL** ne peut pas être utilisée pour préparer une procédure stockée qui renvoie des enregistrements. Il est nécessaire d'utiliser la fonction [HExécuteRequêteSQL](../WDLang4/3044084.md).
<a name="NOTE0_2"></a>


### Comment utiliser la fonction HPrépareRequêteSQL ? 
<a name="comment_utiliser_fonction_docparampagetitleshort_ELTPARAGRAPHE000146"></a>Pour préparer et exécuter une requête plusieurs fois, il faut :

1. Déclarer une source de données. Cette source de données contiendra le résultat de la requête SQL.

2. Déclarer les différentes variables de la requête. 
	Par défaut, les variables sont de type chaîne. Il est possible de préciser leur type en utilisant la propriété [Type](../Proprietes/2510131.md) sur la variable.

3. Préparer la requête avec la fonction **HPrépareRequêteSQL**.

4. Indiquer la valeur du ou des différents paramètres à prendre en compte et exécuter la requête à l'aide de la fonction [HExécuteRequêteSQL](../WDLang4/3044084.md). Seul le nom de la source de données correspondant à la requête doit être spécifié.




Cette dernière étape doit être répétée autant de fois que nécessaire.

**Remarques** :

- La fonction **HPrépareRequêteSQL** doit être utilisée avec :

	- le nom de la connexion,

	- la constante **hRequêteSansCorrection**. 




- Les variables déclarées doivent être identiques à celles utilisées. Dans le cas contraire, une erreur WLangage est affichée.

- Dans l'appel à la procédure stockée, il est nécessaire d'utiliser la syntaxe spécifique à la base de données utilisée, y compris pour la syntaxe des paramètres. 
	Ainsi, pour Oracle, les paramètres sont spécifiés avec la syntaxe **:NomParam**. Attention : le caractère ":" doit être suivi d'au moins une lettre (la syntaxe :1 est interdite). 
	Pour SQL Server, les paramètres sont spécifiés avec la notation **@NomParam**.
	Il est possible d'utiliser plusieurs fois le même paramètre. Dans ce cas, la variable correspondante sera ré-utilisée.



<a name="NOTE0_3"></a>


### Condition sur une clé composée dans une requête SQL
<a name="condition_sur_une_cle_composee_dans_une_requete_sql_ELTPARAGRAPHE000194"></a>Pour définir une condition sur une clé composée dans une requête SQL, **il faut préciser les conditions de chacune des composantes de la clé**.

Il ne faut pas tenter d'affecter directement la clé composée avec une valeur (en effet, les clés composées sont enregistrées sous forme de valeur binaire).

Exemple : La clé composée des rubriques NOM et PRENOM (rubrique NOMPRENOM) :

```sql
SELECT UnFichier.UneRubrique, UnFichier.UneRubrique1
FROM UnFichier
WHERE UnFichier.Nom = "Dupont" AND UnFichier.Prenom = "Florence"
```

<a name="NOTE0_4"></a>


### Limitations
<a name="limitations_ELTPARAGRAPHE000208"></a>Cette fonction n'est pas disponible lors de l'utilisation d'une base de données via .

<a name="XComposante"></a>

## Composante :
wd280hf.dll

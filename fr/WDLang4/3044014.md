
## HSynchroniseRéplica (Fonction)

***En anglais : HSynchronizeReplica***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Synchronise le réplica maître et le réplica abonné : les opérations effectuées sur un des réplicas sont transférées dans l'autre réplica.

**Cette fonction est utilisable aussi bien lors d'une réplication journalée (entre des fichiers de données HFSQL) que lors d'une réplication universelle.**

**Remarques** :

- Dans le cas d'une réplication journalée, seuls les fichiers de données présents dans l'analyse avec l'option "Gérer la réplication pour ce fichier" seront pris en compte.

- ![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Seule la réplication universelle fonctionne avec des fichiers de données HFSQL Client/Serveur.

- ![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Seule la réplication universelle est disponible. 





	<B><B><B>Avertissement</B></B></B>

	A partir de la version <B><B><B>17</B></B></B>,  les fichiers de la réplication créés avec une application/site en version 17 ou supérieure ne pourront pas être manipulés avec une application/site en version 16 ou inférieure.
Les applications/sites en version 17 ou supérieure continuent de manipuler les fichiers de réplication créés avec une application/site en version 16 ou inférieure. 








<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple
<a class="notetitle" target="_blank" href="$DOC$=1000003044014&name=hsynchronisereplica_fonction&product=WD">Voir des exemples supplémentaires</a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png) 
```wl
// Application "Saisie de Commande" par des VRP
// Bouton "[Rentrer les commandes dans la Base]"
// (la base est sur "X:\CORPDATA")
HSynchroniseRéplica("X:\CORPDATA", "C:\ABONNE", rplVersMaître)
```
<a name="Exemple2"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png) 
```wl
// Application "Catalogue" par des VRP
// Bouton "[Récupérer les nouvelles références]"
// (la base est sur "X:\CORPDATA")
HSynchroniseRéplica("X:\CORPDATA", "", rplVersAbonné)
```
<a name="Exemple3"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png) 
```wl
// A Montpellier : Préparation de l'envoi des messages à Paris
HCréeRéplicaTransportable("P:\MSG\MSG.RPM", "Paris", "c:\temp\MsgMPL.WDZ")
// Envoi du fichier (par FTP par exemple)
FTPEnvoie(NumConnexion, "c:\temp\MsgMPL.WDZ", ...
			"FTP.PCSOFT_PARIS.FR\MSG\MsgMPL.WDZ") 
----------------
// A Paris : Récupération des messages de Montpellier
HSynchroniseRéplica("Z:\MSG", "\\FTPSERVEUR\MSG\MsgMPL.WDZ", rplVersMaître)
```

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

### Synchronisation avec gestion de conflit automatique

`<Résultat> = HSynchroniseRéplica(<Réplica maître> , <Réplica abonné> , <Sens de la réplication> [, <Gestion des conflits>])`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> si l'opération a réussi, 

- <u><u><u><u>Faux</u></u></u></u> sinon.




**`<Réplica maître> : (Chaîne de caractères)`**

Localisation du réplica maître. Ce paramètre peut correspondre selon le sens et le type de la réplication :

- au chemin du fichier de réplication (fichier xxxx.RPM) de la base maître.

- au nom de fichier transportable créé avec la fonction [HCréeRéplicaTransportable](../WDLang4/3044209.md). 

- à une chaîne vide (""). Les fichiers de données en cours sont considérés comme étant la base maître. Le fichier correspondant au réplica maître (.RPM) est recherché soit dans le répertoire de réplication spécifié dans l'analyse (par défaut, sous-répertoire RPL des fichiers de données), soit dans le répertoire spécifié avec la fonction [HChangeRepRpl](../WDLang4/3044236.md).




En général, ce chemin correspond soit au chemin complet d'un fichier présent sur un répertoire réseau, soit au chemin d'un réplica transportable (clé USB, attachement email, fichier récupéré par FTP).
Pour plus de détails, consultez [les remarques](#NOTE0_1).

**`<Réplica abonné> : (Chaîne de caractères)`**

Localisation du réplica abonné. Ce paramètre peut correspondre selon le sens et le type de réplication :

- au chemin du fichier de réplication (fichier xxxx.RPL) de la base abonnée.

- au nom de fichier transportable créé avec la fonction [HCréeRéplicaTransportable](../WDLang4/3044209.md)

- à une chaîne vide (""). Les fichiers de données en cours sont considérés comme étant la base abonnée. Le fichier correspondant au réplica abonné (.RPL) est recherché soit dans le répertoire de réplication spécifié dans l'analyse (par défaut, sous-répertoire RPL des fichiers de données), soit dans le répertoire spécifié avec la fonction [HChangeRepRpl](../WDLang4/3044236.md).




En général, ce chemin correspond soit au chemin complet d'un fichier présent sur un répertoire réseau, soit au chemin d'un réplica transportable (clé USB, attachement email, fichier récupéré par FTP).
Pour plus de détails, consultez [les remarques](#NOTE0_1).

**`<Sens de la réplication> : (Constante de type entier)`**

Sens dans lequel la réplication doit être effectuée :


|   |   |
| --- | --- |
| *rplBidirectionnel* | Mise à jour de la base de données maître ET de la base de données abonnée.<br><br>**Réplication universelle** : la réplication bidirectionnelle n'est pas disponible. |
| *rplVersAbonné* | Mise à jour de la base de données abonnée en fonction de la base de données maître.<br><br>&lt;Réplica Maître&gt; correspond au réplica transportable crée depuis la base maître, &lt;Réplica Abonné&gt; correspond au réplica abonné |
| *rplVersMaitre* | Mise à jour de la base de données maître en fonction de la base de données abonnée.<br><br>&lt;Réplica Maître&gt; correspond au réplica maître, &lt;Réplica Abonné&gt; correspond au réplica transportable créé depuis la base abonnée. |



**`<Gestion des conflits> : (Constante optionnelle de type Entier)`**

Constante indiquant le mode de gestion des conflits :


|   |   |
| --- | --- |
| *rplAbonnePrioritaire* | Les données présentes dans la base de données abonnée sont prioritaires lors de la réplication. |
| *rplMaitrePrioritaire*<br>(Valeur par défaut) | Les données présentes dans la base de données maître sont prioritaires lors de la réplication. |
| *rplPlusRécentPrioritaire* | Les données les plus récentes sont prioritaires. Attention, les données les plus récentes sont évaluées par rapport à l'heure sur le poste abonné. |





**Attention : Par défaut, le maître est prioritaire** : dans le cas d'une réplication abonné vers maître, les données du maître ne seront pas mises à jour. Pensez à utiliser une autre constante (*rplPlusRécentPrioritaire* par exemple).


<a name="SYNTAXE2"></a>

### Synchronisation avec gestion de conflit personnalisée (procédure WLangage)

`<Résultat> = HSynchroniseRéplica(<Réplica maître> , <Réplica abonné> , <Sens de la réplication> [, <Procédure de filtre>])`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> si l'opération a réussi, 

- <u><u><u><u>Faux</u></u></u></u> sinon.




**`<Réplica maître> : (Chaîne de caractères)`**

Localisation du réplica maître. Ce paramètre peut correspondre selon le sens et le type de la réplication :

- au chemin du fichier de réplication (fichier xxxx.RPM) de la base maître.

- au nom de fichier transportable créé avec la fonction [HCréeRéplicaTransportable](../WDLang4/3044209.md).

- à une chaîne vide (""). Les fichiers de données en cours sont considérés comme étant la base maître. Le fichier correspondant au réplica maître (.RPM) est recherché soit dans le répertoire de réplication spécifié dans l'analyse (par défaut, sous-répertoire RPL des fichiers de données), soit dans le répertoire spécifié avec la fonction [HChangeRepRpl](../WDLang4/3044236.md).




En général, ce chemin correspond au chemin complet d'un fichier présent sur un répertoire réseau, soit d'un chemin d'un réplica transportable (clé USB, attachement email, fichier récupéré par FTP).
Pour plus de détails, consultez les notes.

**`<Réplica abonné> : (Chaîne de caractères)`**

Localisation du réplica abonné. Ce paramètre peut correspondre selon le sens et le type de réplication :

- au chemin du fichier de réplication (fichier xxxx.RPL) de la base abonnée.

- au nom de fichier transportable créé avec la fonction [HCréeRéplicaTransportable](../WDLang4/3044209.md)

- à une chaîne vide (""). Les fichiers de données en cours sont considérés comme étant la base abonnée. Le fichier correspondant au réplica abonné (.RPL) est recherché soit dans le répertoire de réplication spécifié dans l'analyse (par défaut, sous-répertoire RPL des fichiers de données), soit dans le répertoire spécifié avec la fonction [HChangeRepRpl](../WDLang4/3044236.md).




En général, ce chemin correspond au chemin complet d'un fichier présent sur un répertoire réseau, soit d'un chemin d'un réplica transportable (clé USB, attachement email, fichier récupéré par FTP).
Pour plus de détails, consultez [les remarques](#NOTE0_1).

**`<Sens de la réplication> : (Constante de type entier)`**

Sens dans lequel la réplication doit être effectuée :


|   |   |
| --- | --- |
| *rplBidirectionnel* | Mise à jour de la base de données maître ET de la base de données abonnée.<br><br>**Réplication universelle** : la réplication bidirectionnelle n'est pas disponible. |
| *rplVersAbonné* | Mise à jour de la base de données abonnée en fonction de la base de données maître.<br><br>&lt;Réplica Maître&gt; correspond au réplica maître, &lt;Réplica Abonné&gt; correspond au réplica transportable créé depuis la base abonnée. |
| *rplVersMaître* | Mise à jour de la base de données maître en fonction de la base de données abonnée.<br><br>&lt;Réplica Maître&gt; correspond au réplica transportable crée depuis la base maître, &lt;Réplica Abonné&gt; correspond au réplica abonné |



**`<Procédure de filtre> : (Nom de procédure optionnel)`**

Nom d'une procédure WLangage existant dans le projet WINDEV ou WEBDEV (ce nom doit être entouré par des guillemets). Vous devez créer cette procédure dans votre application. Cette procédure n'attend aucun paramètre. 
Cette procédure est appelée avant chaque opération réalisée sur le fichier destination. Plusieurs variables sont utilisables dans cette procédure. 
Si cette procédure renvoie <u><u><u><u>Faux</u></u></u></u>, l'opération n'est pas effectuée. Cette procédure permet par exemple :

- de filtrer les enregistrements à ne pas répliquer.

- de gérer les cas de conflits, en réglant les valeurs avant qu'une erreur de doublons n'apparaisse.




Pour plus de détails, consultez l'exemple de **HSynchroniseRéplica**.



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) 

### Quels fichiers de données peuvent être répliqués ? 
<a name="quels_fichiers_donnees_peuvent_etre_repliques_ELTPARAGRAPHE000271"></a>La synchronisation peut être effectuée :

- soit entre deux bases de données reliées par le réseau.

- soit entre une base de données et un réplica transportable (créé par la fonction [HCréeRéplicaTransportable](../WDLang4/3044209.md)).




Il n'est pas possible de réaliser une réplication vers un réplica transportable. Il est nécessaire de créer un réplica transportable avec la base de données et répliquer à partir de la base de données distante.

**Attention** : **Si vous effectuez une mise à jour automatique de vos fichiers de données**, il est nécessaire de synchroniser tous les réplicas avant cette opération. En effet, dans le cas contraire, toutes les modifications effectuées depuis la dernière synchronisation et la modification automatique seront perdues.
<a name="NOTE0_2"></a>


### Paramètres de la synchronisation
<a name="parametres_synchronisation_ELTPARAGRAPHE000288"></a>Le tableau ci-dessous présente les différentes combinaisons de paramètres à utiliser en fonction du type et du sens de réplication :

| Sens de réplication | Paramètre &lt;Réplica Maître&gt; | Paramètre &lt;Réplica Abonné&gt; | Paramètre &lt;Sens de la réplication&gt; |
| --- | --- | --- | --- |
| **Réplication du maître vers l'abonné**<br>Cette réplication est effectuée sur le poste abonné | Nom du réplica transportable (\*.RPA) créé depuis le maître, avec son éventuel chemin | Nom du réplica abonné (\*.RPL), avec son éventuel chemin. | *rplVersAbonné* |
| **Réplication de l'abonné vers le maître**<br>Cette réplication est effectuée sur le poste maître | Nom du réplica maître (\*.RPM), avec son éventuel chemin. | Nom du réplica transportable (\*.RPA) créé depuis l'abonné, avec son éventuel chemin. | *rplVersMaître* |




<a name="NOTE0_3"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png) 

### Blocage d'enregistrements pendant la réplication journalée
<a name="blocage_enregistrements_pendant_replication_journalee_ELTPARAGRAPHE000327"></a>Pendant la réplication, le fichier JournalOpération.Fic est bloqué : il est impossible d'écrire, de modifier ou d'enregistrer des enregistrements dans les fichiers journalés de la base de données destination.
<a name="NOTE0_4"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png) 

### Erreurs de doublons et/ou d'intégrité
<a name="erreurs_doublons_etou_integrite_ELTPARAGRAPHE000336"></a>En cas d'erreur de doublons ou d'intégrité, le [mécanisme standard de gestion automatique des erreurs](../WDLang4/3044188.md) est déclenché. Si le moteur HFSQL renvoie une erreur, la réplication est interrompue : seule une partie des données est alors répliquée.

Réplication universelle : Si une erreur d'intégrité se produit lors de la réplication, la réplication continuera mais la fonction renvoie <u><u><u><u>Faux</u></u></u></u>.

Pour avoir le détail des erreurs, il est nécessaire de parcourir les sous-erreurs HFSQL avec la fonction [HErreur](../WDLang4/3044088.md) (avec les constantes *hSousErrPremier* et *hSousErrSuivant*) puis d'utiliser la fonction [HErreurInfo](../WDLang4/3044071.md).
<a name="NOTE0_5"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) 

### Variables automatiquement initialisées dans la procédure WLangage
<a name="variables_automatiquement_initialisees_dans_procedure_wlangage_ELTPARAGRAPHE000362"></a>

| Variable | Type | Description et valeur |
| --- | --- | --- |
| RPL.Fichier | Chaîne de caractères | Nom du fichier dont les données vont être répliquées |
| RPL.Opération | Constante de type Entier | Opération HFSQL qui va être répliquée :<br><br>- **rplHAjoute** : réplication d'un ajout<br><br>- **rplHModifie** : réplication d'une modification<br><br>- **rplHSupprime** : réplication d'une suppression<br><br><br> |
| RPL.Conflit | Constante de type Entier | Indique si un conflit est détecté lors de la réplication. Les valeurs possibles sont les suivantes :<br><br>- **rplPasDeConflit** : aucun conflit n'a été détecté<br><br>- **rplConflitModification** : Enregistrement a été modifié à la fois sur le réplica source et sur le réplica destination<br><br>- **rplConflitSuppression** : Enregistrement supprimé sur le réplica destination et modifié ou supprimé sur le réplica source.<br><br><br>Pour forcer la réplication en cas de conflit, initialisez la variable RPL.Conflit avec la constante *rplPasDeConflit*.<br><br>Dans le cas contraire, la réplication sera effectuée uniquement si le conflit est un conflit de modification et si les données à répliquer proviennent de la base de données maître. |
| RPL.Sens | Constante de type Entier | Indique le sens de la réplication (utile lors d'une réplication bi-directionnelle) :<br><br>- **rplVersAbonné** : réplication du maître vers l'abonné<br><br>- **rplVersMaître** : réplication de l'abonné vers le maître<br><br><br> |
| RPL.NumOpération | Entier | Numéro de l'opération en cours. Cette valeur est comprise entre 1 et RPL.MaxOpération. Cette variable permet de gérer simplement une jauge de progression. |
| RPL.MaxOpération | Entier | Nombre total d'opérations à répliquer. Cette variable permet de gérer simplement une jauge de progression. |
| RPL.AliasSource | Chaîne de caractères | Nom de l'alias Source du fichier répliqué (RPL.Fichier). Ce fichier contient les valeurs des rubriques qui vont être copiées (fonction [HModifie](../WDLang4/3044042.md)) ou ajoutées (fonction [HAjoute](../WDLang4/3044147.md)) dans le fichier en cours de réplication. |
| RPL.AliasDestination | Chaîne de caractères | Nom de l'alias Destination du fichier répliqué (RPL.Fichier). Ce fichier contient les valeurs des rubriques avant la copie ou la suppression dans le fichier en cours de réplication. |




<a name="NOTE0_6"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png)![Hyper File 5.5](https://doc.pcsoft.fr/ext/images/fr/HF55.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) 

### Exemple : Répliquer les données même si un conflit est intervenu (utilisation d'une procédure WLangage) : 
<a name="exemple_repliquer_les_donnees_meme_conflit_est_intervenu_utilisation_une_procedure_wlangage_ELTPARAGRAPHE000447"></a>Cet exemple permet de forcer la réplication des données même si un conflit de modification intervient. Il suffit de forcer la valeur de la variable **RPL.Conflit** avec la constante *rplPasDeConflit*.


```wl
SI RPL.Conflit = rplConflitModification ALORS
	RPL.Conflit = rplPasDeConflit
	RENVOYER Vrai
FIN
```



### Réplication et fonction EspaceSignificatif
<a name="replication_fonction_espacesignificatif_ELTPARAGRAPHE000661"></a>La réplication est incompatible avec l'utilisation de la fonction [EspaceSignificatif](../WDLang4/3044142.md) dans le code de l'application cliente. Cette fonction change le comportement de HFSQL. L'utilisation de cette fonction dans l'application cliente peut affecter l'efficacité de la réplication.

Depuis la version 21 update 3 (version 210065), les fonctions de synchronisation (réplication universelle programmée ou assistée) renvoient une erreur à l'application cliente si la fonction [EspaceSignificatif](../WDLang4/3044142.md) a été appliquée pour l'un au moins des fichiers répliqués. 


### Durée de vie du réplica transportable
<a name="duree_vie_replica_transportable_ELTPARAGRAPHE000457"></a>Le réplica est détruit à la fin de la réplication en cas de réussite. En effet, rejouer le réplica engendre des erreurs (par exemple, un ajout donne une erreur de doublon). Le réplica utilise le fichier .syn qui lui aussi est détruit (un autre fichier .syn le remplace avec les informations inutiles purgées). 

Un réplica "transportable" est déplacé (copié) entre le maître et l'abonné ou entre l'abonné et le maître. Pour conserver une archive, il suffit de conserver le fichier source (celui créé par la fonction [HCréeRéplicaTransportable](../WDLang4/3044209.md)). 




### Réplication et filtre
<a name="replication_filtre_ELTPARAGRAPHE000468"></a>Lors du parcours des données à répliquer, la réplication tient compte des filtres positionnés par la fonction [HFiltre](../WDLang4/3044100.md). 

Ainsi, dans le cas d'une réplication universelle programmée sans serveur de réplication, il est possible d'utiliser la fonction [HFiltre](../WDLang4/3044100.md) pour limiter les données à synchroniser. 

A l'inverse, dans le cas d'une réplication effectuée via un serveur de réplication, il faut veiller à désactiver tous les filtres avant d'effectuer la réplication avec la fonction **HSynchroniseRéplica**. 

Remarque : La fonction [HFerme](../WDLang4/3044073.md) permet de supprimer tous les filtres définis par la fonction [HFiltre](../WDLang4/3044100.md) sur un fichier de données.



<a name="XComposante"></a>

## Composante :
wd280rpl.dll


## Transactions : Sécurisez vos traitements sur des fichiers de données HFSQL 
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000652"></a>
Ce chapitre aborde les sujets suivants :

- [Présentation des transactions : Qu'est-ce qu'une transaction, utiliser les transactions selon ses besoins, etc.](../WDLang4/3044335.md)

- [Principe : gestion des transactions sur des fichiers HFSQL et cas particuliers.](../WDLang4/3044335.md)

- [Manipuler les transactions par programmation.](#NOTE2_1)

- [Gestion des cas particuliers (panne de courant, rétablir la cohérence de la base de données, etc).](#NOTE4_1)

- [Gestion avancée : les fichiers créés lors d'une transaction, gestion de l'identifiant du poste.](#NOTE5_1)




![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) La gestion des transactions est disponible uniquement pour les bases de données HFSQL Client/Serveur. 





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Manipuler les transactions par programmation
<a name="manipuler_les_transactions_par_programmation_ELTTEXTE000682"></a>




### Mettre en place la gestion des transactions
<a name="mettre_place_gestion_des_transactions_ELTPARAGRAPHE000044"></a>

1. Si vos fichiers de données sont protégés par mot de passe, ouvrez tous les fichiers de données utilisés pendant la transaction avant le début de la transaction ou spécifiez les différents mots de passe à l'aide de la fonction [HPasse](../WDLang4/3044108.md).
	Si vos fichiers de données ne sont pas protégés par mot de passe, les fichiers de données manipulés après la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)) seront automatiquement mis en transaction.

2. Commencez la transaction avec la fonction [HTransactionDébut](../WDLang4/3044002.md) ou avec la fonction [HTransaction](../WDLang4/1000023384.md).

3. Effectuez vos opérations. Toutes les opérations d'écriture sur les fichiers de données en transaction sont automatiquement enregistrées dans le fichier de transaction. Attention : les traitements réalisés sont relativement plus lents (puisque chaque opération est enregistrée dans un fichier de données spécifique).

4. Annulez si nécessaire les opérations réalisées pendant la transaction (fonction [HTransactionAnnule](../WDLang4/3044001.md)).

5. Spécifiez la fin de la transaction avec la fonction [HTransactionFin](../WDLang4/3044032.md) : la transaction est validée.




**Remarques** : 

- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Le mode d'isolation des transactions est le mode "**READ UNCOMMITED**". 

- ![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Le mode d'isolation des transactions est défini avec la fonction [HTransactionIsolation](../WDLang4/1000020926.md). Le mode d'isolation par défaut est le mode "**READ UNCOMMITED**". 

- Les transactions ne sont pas disponibles sur des fichiers de données Hyper File 5.5.



<a name="NOTE2_2"></a>




### Tableau récapitulatif des fonctions WLangage utilisées (pour une base de données HFSQL ISAM ou Client/Serveur)
<a name="tableau_recapitulatif_des_fonctions_wlangage_utilisees_pour_une_base_donnees_hfsql_isam_clientserveur_ELTPARAGRAPHE000092"></a>

| Fonctionnalités | Fonction WLangage |
| --- | --- |
| Activer ou non la gestion des transactions <br>(la gestion des transactions est active par défaut). | [HGèreTransaction](../WDLang4/3044066.md) |
| ![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Définir le mode d'isolation. | [HTransactionIsolation](../WDLang4/1000020926.md) |
| Débuter la transaction. | [HTransactionDébut](../WDLang4/3044002.md) ou [HTransaction](../WDLang4/1000023384.md) |
| Valider la transaction. | [HTransactionFin](../WDLang4/3044032.md) |
| Annuler la transaction en cours | [HTransactionAnnule](../WDLang4/3044001.md) |
| Annuler une transaction qui a échoué (panne de courant). | <br><br>- [HTransactionAnnule](../WDLang4/3044001.md)<br><br>- [HTransactionDébut](../WDLang4/3044002.md)/[HTransactionFin](../WDLang4/3044032.md)<br><br>- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Outil [WDTRANS](../WDTrans/3524005.md) (ou [WDOptimiseur](../WDOptimiseur/3519002.md)).<br><br>- ![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Centre de Contrôle HFSQL.<br><br><br> |
| Savoir si une transaction a été interrompue (la transaction n'a été ni validée, ni annulée). Cas de panne de courant. | [HTransactionInterrompue](../WDLang4/3044026.md) |
| Si un enregistrement du fichier de données spécifié est considéré comme étant en transaction, mais n'appartient à aucune transaction en cours, il est automatiquement libéré. | [HTransactionLibère](../WDLang4/3044016.md) |
| Savoir si une transaction est en cours. | [HTransactionEnCours](../WDLang4/1000025274.md) |







<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Manipuler les enregistrements lors d'une transaction : les règles à suivre
<a name="manipuler_les_enregistrements_lors_une_transaction_les_regles_suivre_ELTTEXTE000712"></a>


### Utiliser des Transactions courtes
<a name="utiliser_des_transactions_courtes_ELTPARAGRAPHE000183"></a>Les enregistrements manipulés pendant la transaction sont automatiquement bloqués en écriture, pour empêcher d'autres postes de modifier les données concernées et donc pour sécuriser la transaction.

Dans une application en réseau, si un autre utilisateur tente de modifier un enregistrement en transaction, la gestion automatique des blocages laissera la possibilité à cet utilisateur d'annuler ou de retenter l'opération.

Il est donc nécessaire que la transaction soit la plus courte possible, pour éviter tout blocage des utilisateurs.
<a name="NOTE3_2"></a>




### Bloquer les enregistrements en lecture
<a name="bloquer_les_enregistrements_lecture_ELTPARAGRAPHE000195"></a>Toutes les modifications effectuées pendant une transaction sont visibles par tous les postes (sur un réseau par exemple) avant la fin de la transaction. Il est donc possible que les autres postes lisent des données dont la durée de vie est limitée (si la transaction est annulée par [HTransactionAnnule](../WDLang4/3044001.md) par exemple).

**Il est donc fortement conseillé de bloquer les enregistrements concernés en lecture.**


<a name="NOTE3_3"></a>


### Effectuer une seule transaction à la fois
<a name="effectuer_une_seule_transaction_fois_ELTPARAGRAPHE000208"></a>Une application ne doit effectuer qu'une seule transaction à la fois. Il ne faut pas effectuer des transactions dans des threads simultanés ou dans des contextes HFSQL indépendants.


<a name="NOTE3_4"></a>


### Aucune interface utilisateur (fenêtre, état, page,...) ne doit être utilisée entre le début et la fin d'une transaction.
<a name="aucune_interface_utilisateur_fenetre_etat_page_doit_etre_utilisee_entre_debut_fin_une_transaction_ELTPARAGRAPHE000216"></a>Toutes les opérations de transaction doivent être réalisées **dans un même traitement** : la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)) et la fonction [HTransactionAnnule](../WDLang4/3044001.md) doivent être appelées depuis le même traitement ou événement : code de clic d'un champ Bouton, ...

Pour annuler une transaction à l'aide d'un bouton, utilisez un champ Bouton de type "Validation automatique" sur une courte durée. Vous éviterez ainsi d'éventuelles interactions avec les données manipulées depuis d'autres postes du réseau.


<a name="NOTE3_5"></a>


### L'annulation d'une transaction peut parfois échouer car l'annulation d'une transaction peut provoquer des violations de contraintes d'intégrité et/ou de doublon. 
<a name="annulation_une_transaction_peut_parfois_echouer_car_annulation_une_transaction_peut_provoquer_des_violations_contraintes_integrite_etou_doublon_ELTPARAGRAPHE000235"></a>

**Exemple 1 : Violation des contraintes de doublons**

- *Un fichier de données manipulé par une transaction contient une clé unique*.

- Un poste A effectue une transaction pendant laquelle un enregistrement de ce fichier de données est supprimé.

- *Dans le même temps, un poste B ajoute un nouvel enregistrement dans le même fichier de données avec la même valeur de clé unique que l'enregistrement supprimé par le poste A.*

- **L'annulation de la transaction à cet instant provoquera une erreur de doublon sur la clé unique**.




**Solution 1** : Retentez l'annulation de la transaction avec l'outil [WDTrans](../WDTrans/3524005.md) (ou [WDOptimiseur](../WDOptimiseur/3519002.md)). Cet outil permet notamment d'ignorer les erreurs de doublons et/ou d'intégrité (options "Débrancher la gestion de l'intégrité" et "Débrancher la gestion des doublons" dans l'assistant d'annulation de transactions).

**Solution 2** : Utilisez la fonction [HGèreDoublon](../WDLang4/3044057.md) avant d'annuler la transaction. Cette fonction permet d'ignorer temporairement la gestion des doublons. Dans ce cas, n'oubliez pas de rebrancher la gestion des doublons en positionnant le paramètre à <u><u><u><u>Vrai</u></u></u></u> après l'annulation de la transaction.
Vous devrez alors vérifier les enregistrements erronés et les modifier en conséquence

**Exemple 2 : Violation des contraintes d'intégrité**

- *Un fichier de données CLIENT manipulé est relié à un autre fichier de données COMMANDES (liaison sur une clé)*

- *Un poste A effectue une transaction pendant laquelle un enregistrement est ajouté dans le fichier de données CLIENT*.

- *Dans le même temps, un poste B ajoute un nouvel enregistrement dans le fichier de données COMMANDES relié à l'enregistrement ajouté dans le fichier de données CLIENT.*

- L'annulation de la transaction à cet instant provoquera une erreur d'intégrité, car l'enregistrement ajouté dans le fichier de données COMMANDES n'aura plus de liaison avec l'enregistrement supprimé dans le fichier de données CLIENT (l'ajout dans le fichier de données CLIENT aura été annulé).




**Solution 1** : Retentez l'annulation de la transaction avec l'outil [WDTrans](../WDTrans/3524005.md) (ou [WDOptimiseur](../WDOptimiseur/3519002.md)). Cet outil permet notamment d'ignorer les erreurs de doublons et/ou d'intégrité (cochez les options "Débrancher la gestion de l'intégrité" et "Débrancher la gestion des doublons" dans l'assistant d'annulation de transactions).

**Solution 2** : Utilisez la fonction [HGèreIntégrité](../WDLang4/3044058.md) avant d'annuler la transaction. Cette fonction permet d'ignorer temporairement les erreurs d'intégrité (en positionnant le paramètre à <u><u><u><u>Faux</u></u></u></u>). Dans ce cas, n'oubliez pas de rebrancher la gestion de l'intégrité en positionnant le paramètre à <u><u><u><u>Vrai</u></u></u></u> après l'annulation de la transaction.
Vous devrez alors vérifier les enregistrements erronés et les modifier en conséquence.

**Conseil** : **Prévoyez ce genre de conflits dans vos programmes et lors de la création des fichiers de données sous l'éditeur d'analyses**. 

- Si vous utilisez des clés uniques de type identifiant automatique, les erreurs de doublons ne surviendront pas.

- Si vous manipulez les clés uniques vous-mêmes (vous n'utilisez pas d'identifiants automatiques), prévoyez une valeur **unique** pour tous les postes lors d'ajouts (fonction [HAjoute](../WDLang4/3044147.md)) ou lors de modifications (fonction [HModifie](../WDLang4/3044042.md)) d'enregistrements.
	**Rappel** : Par défaut, pour chaque enregistrement posant problème, le moteur HFSQL propose [la gestion assistée des erreurs](../WDLang4/3044188.md) : une fenêtre permet de corriger les conflits de doublons.





<a name="NOTE3_6"></a>




### Erreurs spécifiques à la gestion des transactions
<a name="erreurs_specifiques_gestion_des_transactions_ELTPARAGRAPHE000314"></a>

- **70031 : Opération non autorisée en transaction**
	Vous utilisez une fonction non autorisée pendant une transaction. Par exemple, la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)) est utilisée en cours de transaction.

- **70034 : La dernière transaction a échoué**
	Vous tentez d'utiliser un enregistrement appartenant à une transaction qui a échoué (panne de courant, ...). Le programme est relancé sans avoir annulé la transaction. Dans ce cas, il est conseillé d'annuler la transaction qui a échoué (voir ci-dessous).

- **74020 : Le mot de passe du fichier de Transaction ne correspond pas au mot de passe du fichier d'origine**
	Le fichier de données (en mode HFSQL Client/Serveur) et le fichier de transaction n'utilisent pas le même mot de passe.

- **70032 : Problème de mode d'insolation**
	Cette erreur peut survenir dans les cas suivants : 

	- Vous tentez d'utiliser la fonction [HTransactionIsolation](../WDLang4/1000020926.md) sur des fichiers de données qui ne sont pas au format Client/Serveur. 

	- Vous tentez d'utiliser un mode d'isolation alors que la transaction n'est pas effectuée sur une connexion. 

	- Vous tentez d'utiliser la fonction [HTransactionIsolation](../WDLang4/1000020926.md) alors que la transaction a déjà été débutée avec la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)). 







<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Gestion des cas particuliers
<a name="gestion_des_cas_particuliers_ELTTEXTE000766"></a>




### Panne de courant
<a name="panne_courant_ELTPARAGRAPHE000359"></a>Si une panne (coupure de courant, re-démarrage du poste, ...) survient pendant une transaction, les fichiers de données risquent d'être incohérents : la transaction n'a été ni validée, ni abandonnée. Le fichier de transaction est toujours présent sur le poste.

Dans ce cas, la cohérence de la base de données sera restaurée :

- Soit au premier appel de la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou de la fonction [HTransaction](../WDLang4/1000023384.md)).

- Soit avec la fonction [HTransactionAnnule](../WDLang4/3044001.md).

- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Soit avec l'outil redistribuable [WDTrans](../WDTrans/3524005.md) (ou [WDOptimiseur](../WDOptimiseur/3519002.md)) pour une base ISAM.

- ![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Soit avec le Centre de Contrôle HFSQL pour une base HFSQL Client/Serveur.




**Attention** : La restauration de la cohérence de la base peut être relativement longue.

Remarque : Pour savoir si la restauration de la cohérence de la base est nécessaire, testez le résultat de la fonction [HTransactionInterrompue](../WDLang4/3044026.md) dans le code d'initialisation du projet (par exemple).


<a name="NOTE4_2"></a>




### Conseil : rétablir la cohérence de la base de données
<a name="conseil_retablir_coherence_base_donnees_ELTPARAGRAPHE000401"></a>Pour rétablir la cohérence de la base de données, les opérations conseillées sont les suivantes :

1. Testez le résultat de la fonction [HTransactionInterrompue](../WDLang4/3044026.md) dans le code d'initialisation du projet par exemple.

2. Si la transaction a été interrompue, effectuez une des opérations suivantes pour rétablir la cohérence de la base de données :

	- Appel de la fonction [HTransactionAnnule](../WDLang4/3044001.md).

	- Appel des fonctions [HTransactionDébut](../WDLang4/3044002.md)/[HTransactionFin](../WDLang4/3044032.md).

	- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Lancement de l'outil [WDTrans](../WDTrans/3524005.md) (ou [WDOptimiseur](../WDOptimiseur/3519002.md)) pour une base ISAM. 

	- ![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Lancement du Centre de Contrôle HFSQL pour une base HFSQL Client/Serveur.







Exemple :



```wl
SI HTransactionInterrompue() = Vrai ALORS 
	SI Confirmer("La transaction effectuée par le poste " + h.trsPoste + ...
		" a été interrompue. " + ...
		 "Voulez-vous rétablir la cohérence des fichiers de données ?") = Vrai ALORS
		// Annule les transactions interrompues
		 SI HTransactionAnnule() = Faux ALORS
			 Erreur("Impossible d'annuler la transaction")
		 FIN
	FIN
FIN
```


**Autre solution** : Il est également possible de gérer l'erreur 70034 dans l'événement "Initialisation" du projet grâce au mot-clé QUAND EXCEPTION. Ainsi, quand l'erreur 70034 surviendra, la cohérence de la base de données sera restaurée soit par la fonction [HTransactionAnnule](../WDLang4/3044001.md), soit par les fonctions [HTransactionDébut](../WDLang4/3044002.md)/[HTransactionFin](../WDLang4/3044032.md).

**Remarque** : Après une coupure de courant, il est conseillé de ré-indexer les fichiers de données de l'application.


<a name="NOTE4_3"></a>




### Erreur lors de l'utilisation du programme
<a name="erreur_lors_utilisation_programme_ELTPARAGRAPHE000457"></a>Lorsque l'exécution de l'application est arrêtée à cause d'une erreur programme (division par zéro par exemple), la transaction en cours est automatiquement annulée.


<a name="NOTE4_4"></a>




### Suppression du journal de transaction
<a name="suppression_journal_transaction_ELTPARAGRAPHE000466"></a>Le journal de transaction est un fichier HFSQL créé et présent uniquement le temps de la transaction. **Il ne faut pas supprimer ce fichier pendant la transaction sous peine d'incohérence de la base de données**. 


<a name="NOTE4_5"></a>




### Différences de comportement entre des transactions ISAM et Client/Serveur
<a name="differences_comportement_entre_des_transactions_isam_clientserveur_ELTPARAGRAPHE000475"></a>

|   | Comportement en HFSQL Classic | Comportement en HFSQL Client/Serveur |
| --- | --- | --- |
| Création d'un fichier de données pendant une transaction (fonction [HCréation](../WDLang4/3044255.md)). |   | Si la transaction est annulée, le fichier de données redevient vide. |
| Fermeture d'un fichier de données pendant une transaction (fonction [HFerme](../WDLang4/3044073.md)). | La transaction est interrompue. | La transaction n'est pas annulée. |
| Déblocage d'un enregistrement/fichier de données pendant une transaction. | Le blocage des transactions est annulé.<br>La transaction est interrompue. | Déblocage d'un enregistrement/fichier de données<br>La transaction n'est pas annulée. |
| Exécution d'une requête de type INSERT/UPDATE. | La transaction est interrompue. | La transaction n'est pas annulée. |





<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Gestion avancée
<a name="gestion_avancee_ELTTEXTE000814"></a>




### Transaction : Les fichiers créés
<a name="transaction_les_fichiers_crees_ELTPARAGRAPHE000521"></a>Lors de la mise en place des transactions, deux types de fichiers HFSQL sont créés :

- ** le journal des opérations en transaction** : Fichier temporaire au format HFSQL contenant les différentes opérations réalisées sur les fichiers de l'application pris en compte par la transaction. Ce fichier est créé par la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou par la fonction [HTransaction](../WDLang4/1000023384.md)). Par défaut, son nom est &lt;Nom du projet&gt;_$TRS_OPERATION.TRS. Ce nom est modifiable avec la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou avec la fonction [HTransaction](../WDLang4/1000023384.md)).
	![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Ce fichier s'appelle TRSOPERATION.TRS.

- **le journal des valeurs** : Fichier temporaire associé à chaque fichier de données pris en compte par la transaction. Ce fichier a pour nom &lt;Nom du fichier de données&gt;_$$_TRSVAL.TRX. Ce fichier contient pour chaque opération réalisée dans la transaction :

	- soit le contenu de l'enregistrement avant l'opération (lors d'une suppression par exemple)

	- soit le contenu de l'enregistrement après l'opération (lors d'un ajout par exemple)
			![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Ce fichier s'appelle &lt;Nom du fichier de données&gt;.TRX.





Ces fichiers peuvent être manipulés avec les outils [WDTRANS](../WDTrans/3524005.md) ou [WDOptimiseur](../WDOptimiseur/3519002.md).
![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) **En HFSQL Client/Serveur, un fichier supplémentaire est créé** : TRSOperationInfoClient.TRS. 
Ce fichier contient les informations uniques permettant d'identifier la transaction (nom de client, poste, ...).
<a name="NOTE5_2"></a>




### Identifiant du poste réalisant la transaction
<a name="identifiant_poste_realisant_transaction_ELTPARAGRAPHE000568"></a>Par défaut, le poste est identifié par un numéro unique interne et par le nom du poste (nom défini sous Windows).

Pour identifier simplement le poste effectuant les opérations en transaction, la fonction [HPoste](../WDLang4/3044111.md) permet de définir un identifiant spécifique au poste. Cet identifiant remplace le nom du poste. Cet identifiant est enregistré dans le journal des opérations en transaction et peut être consulté avec [WDTRANS](../WDTrans/3524005.md).

![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) L'identifiant du poste est composé du :

- Nom de l'ordinateur et son adresse IP.

- Nom de l'application, c'est-à-dire NomExécutable(NomProjet). 





<a name="NOTE5_3"></a>




### Transactions et contexte HFSQL indépendant
<a name="transactions_contexte_hfsql_independant_ELTPARAGRAPHE000592"></a>Lors de la copie de contexte, si une transaction est en cours sur le premier contexte, le nouveau contexte n'est pas en transaction. Il faut rappeler la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)) pour démarrer une transaction dans le nouveau contexte.




- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDTransaction.gif) ***Exemples didactiques (WINDEV)*** : **WD Transaction** <br>Ce programme réalisé avec WINDEV est basé sur une analyse simplifiée du type COMMANDE, LIGNECOMMANDE, STOCK. Il illustre le fonctionnement des transactions lors du passage d'une commande.



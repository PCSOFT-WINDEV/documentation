
## Transactions en mode HFSQL Client/Serveur
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000222"></a>
Pour conserver une compatibilité maximale entre les applications HFSQL Classic (monoposte ou réseau) et les applications HFSQL Client/Serveur, le mécanisme des transactions en mode HFSQL Client/Serveur est proche du fonctionnement en mode HFSQL Classic.

Cette page d'aide présente uniquement les différences de fonctionnement.

Pour plus de détails sur les transactions, consultez [Les transactions](../WDLang4/3044335.md).

![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Les transactions peuvent être utilisées uniquement avec des fichiers de données HFSQL Client/Serveur.



<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principe
<a name="principe_ELTTEXTE000252"></a>


### Principe des transactions sur des fichiers HFSQL Client/Serveur et HFSQL Classic
<a name="principe_des_transactions_sur_des_fichiers_hfsql_clientserveur_hfsql_classic_ELTPARAGRAPHE000031"></a>Chaque opération d'écriture effectuée lors d'une transaction est mémorisée dans un fichier des transactions. A tout moment, il est possible d'annuler la transaction : toutes les opérations effectuées depuis le début de la transaction seront annulées. 

La transaction est automatiquement annulée :

- lors d'une erreur fatale du programme (suivie d'une fermeture de l'application).

- lors de l'appel de la fonction [FinProgramme](../WDLang1/3013033.md).

- lors de l'arrêt du mode test depuis l'éditeur.

- lors d'une panne de courant ou d'un arrêt brusque de l'application.

- lors de la perte ou de la fermeture de la connexion par le client.

- lors du redémarrage du serveur. Attention : la transaction n'est pas annulée si la transaction porte sur un fichier avec mot de passe sécurisé. La transaction sera annulée à la prochaine ouverture du fichier de données.





**Isolation des transactions**
Le moteur HFSQL propose d'isoler les transactions : les modifications effectuées dans une transaction en cours sont isolées de celles faites dans les autres transactions conduites simultanément, jusqu'à ce qu'elle soit validée. 

Plusieurs modes d'isolation sont disponibles : 

- "READ UNCOMMITTED" : Lecture des données non validées (mode par défaut).  

- "READ COMMITTED" : Lecture des données validées. 

- "REPEATABLE READ" : Transactions photographiées




Pour plus de détails sur ces différents modes et leur mise en place, consultez [Isolation des transactions](../WDLang4/1000017316.md). 

<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Gestion avancée
<a name="gestion_avancee_ELTTEXTE000282"></a>


### Fichiers créés par une transaction
<a name="fichiers_crees_par_une_transaction_ELTPARAGRAPHE000071"></a>Lors de la mise en place des transactions, plusieurs types de fichiers HFSQL sont créés : 

- **le journal des opérations en transaction** : Fichier au format HFSQL contenant les différentes opérations réalisées sur les fichiers de l'application pris en compte par la transaction. Ce fichier est créé par la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou par la fonction [HTransaction](../WDLang4/1000023384.md)). Son nom est TRSOPERATION.TRS.

- **le journal d'identification** : Fichier contenant des informations uniques permettant d'identifier la transaction (nom de client, poste, ...). Ce fichier a pour nom TRSOperationInfoClient.TRS.

- **le journal des valeurs** : Fichier associé à chaque fichier de données pris en compte par la transaction. Ce fichier s'appelle &lt;NomFichier&gt;.TRX. Ce fichier contient pour chaque opération réalisée dans la transaction :

	- soit le contenu de l'enregistrement avant l'opération (lors d'une suppression par exemple).

	- soit le contenu de l'enregistrement après l'opération (lors d'un ajout par exemple).








<a name="NOTE3_2"></a>


### Organisation des fichiers sur le serveur
<a name="organisation_des_fichiers_sur_serveur_ELTPARAGRAPHE000092"></a>


|   |   |
| --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Transactions_CS.gif) | **1. Répertoire __TRS**<br>Ce répertoire contient :<br><br>- Le journal des opérations en transaction.<br><br>- Le journal d'identification<br><br>- Pour chaque fichier de données en transaction de chaque base de données, le fichier des valeurs correspondant. L'arborescence utilisée correspond à l'arborescence des fichiers de données associés à la base.<br><br><br>**Par exemple**, si le fichier Commande de DonneesApplicationA est mis en transaction, le sous-répertoire __TRS\\DonneesApplicationA contiendra le fichier Commande.TRX.<br>**Autre exemple** : si le fichier Client de DonneesApplicationB est mis en transaction, le sous-répertoire __TRS\\DonneesApplicationB\\Client contiendra le fichier Client.TRX.<br>**2. Répertoire de la base de données** DonneesApplicationA<br>**3. Répertoire de la base de données** DonneesApplicationB |

 



<a name="NOTE3_3"></a>


### Identifiant du poste réalisant la transaction
<a name="identifiant_poste_realisant_transaction_ELTPARAGRAPHE000119"></a>L'identification du poste réalisant la transaction se fait de la même façon en HFSQL Classic et en HFSQL Client/Serveur : par défaut, le poste est identifié par un numéro unique interne et par le nom du poste (nom défini sous Windows). 

Pour identifier simplement le poste effectuant les opérations en transactions, la fonction [HPoste](../WDLang4/3044111.md) permet de définir un identifiant spécifique au poste. Cet identifiant remplace le nom du poste. Cet identifiant est enregistré dans le journal des opérations en transaction et peut être consulté avec le centre de contrôle HFSQL.

Le client est identifié par :  

- la fonction [HPoste](../WDLang4/3044111.md) (identique à HFSQL Classic).

- Nom de l'ordinateur et son adresse IP. 

- Nom de l'application c'est-à-dire NomExécutable (NomProjet).




Ces informations peuvent être récupérées en cas d'interruption de la transaction par la fonction [HTransactionInterrompue](../WDLang4/3044026.md). 


<a name="NOTE3_4"></a>


### Erreurs spécifiques à la gestion des transactions en mode HFSQL Client/Serveur
<a name="erreurs_specifiques_gestion_des_transactions_mode_hfsql_clientserveur_ELTPARAGRAPHE000146"></a>**74020 : Le mot de passe du fichier de Transaction ne correspond pas au mot de passe du fichier d'origine** 
Le fichier de données (en mode HFSQL Client/Serveur) et le fichier de transaction n'utilisent pas le même mot de passe. 

**70032 : Problème de mode d'isolation**
Cette erreur peut survenir dans les cas suivants : 

- Vous tentez d'utiliser la fonction [HTransactionIsolation](../WDLang4/1000020926.md) sur des fichiers de données qui ne sont pas au format Client/Serveur. 

- Vous tentez d'utiliser un mode d'isolation alors que la transaction n'est pas effectuée sur une connexion. 

- Vous tentez d'utiliser la fonction [HTransactionIsolation](../WDLang4/1000020926.md) alors que la transaction a déjà été débutée avec la fonction [HTransactionDébut](../WDLang4/3044002.md) (ou la fonction [HTransaction](../WDLang4/1000023384.md)). 







- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDTransaction.gif) ***Exemples didactiques (WINDEV)*** : **WD Transaction** <br>Ce programme réalisé avec WINDEV est basé sur une analyse simplifiée du type COMMANDE, LIGNECOMMANDE, STOCK. Il illustre le fonctionnement des transactions lors du passage d'une commande.



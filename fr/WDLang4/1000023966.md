


## &lt;Variable Connexion&gt;.TransactionAnnule (Fonction)

***En anglais : &lt;Connection variable&gt;.TransactionCancel***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
**Si une transaction est en cours**, annule toutes les opérations effectuées sur les fichiers de données en transactions depuis le début de la transaction. Dans ce cas, la transaction est annulée sans interrompre l'exécution du programme.

**Si aucune transaction est en cours**, rétablit la cohérence de la base de données et annule la transaction qui a échoué (cas d'une coupure de courant par exemple). 
Remarque : Une transaction qui a échoué peut être annulée par n'importe quel programme.
Si le fichier de transaction n'est pas partagé, il est automatiquement détruit. Les enregistrements bloqués par les écritures effectuées durant la transaction sont débloqués.

**Remarque** : La fonction [&lt;Source&gt;.TransactionLibère](../WDLang4/1000025074.md) transforme tous les enregistrements "en transaction" en enregistrements "normaux" si ces enregistrements n'appartiennent pas à une transaction actuellement en cours. 




<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
MaConnexion est une Connexion

// Début de la transaction sur les fichiers de données associés à la connexion MaConnexion
MaConnexion.TransactionDébut()
Ajout_Commande()
QUAND EXCEPTION DANS
	// Ajout de la commande
	Commande.Ajoute() 
	// Validation de l'ajout
	MaConnexion.TransactionFin()
FAIRE
	// Suppression des lignes de commandes
	MaConnexion.TransactionAnnule()
FIN
```
<a name="Exemple2"></a>
<a name="Exemple3"></a>

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

### Annuler une transaction en cours ou une transaction interrompue sur une connexion Client/Serveur

`<Résultat> = <Connexion>.TransactionAnnule()`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur. 




**Attention** : 

- S'il y a une transaction en cours sur la connexion, elle est annulée. 

- S'il n'y a pas de transactions en cours, les transactions interrompues sont annulées pour la connexion spécifiée.




**`<Connexion> : (Variable de type Connexion)`**

Nom de la variable de type [Connexion](../WDLang4/1514073.md) décrivant la connexion à manipuler.


<a name="SYNTAXE3"></a>

### Annuler une transaction interrompue sur une base de données Client/Serveur (à utiliser si aucune transaction n'est en cours)

`<Résultat> = <Connexion>.TransactionAnnule(<Base de données>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur.


**Attention** : 

- Seules les transactions interrompues sur la base de données spécifiée sont annulées.

- Les transactions en cours ne sont pas annulées.




**`<Connexion> : (Variable de type Connexion)`**

Nom de la variable de type [Connexion](../WDLang4/1514073.md) décrivant la connexion à manipuler.

**`<Base de données> : (Chaîne de caractères)`**

Nom de la base de données concernée. Si ce paramètre correspond à une chaîne vide (""), une erreur est affichée.


<a name="SYNTAXE5"></a>

### Annuler une transaction spécifique, liée à une connexion

`<Résultat> = <Connexion>.TransactionAnnule(<Transaction à annuler>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> la transaction a été annulée, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur.


Attention : Seules les transactions interrompues sur la base de données spécifiée sont annulées.

**`<Connexion> : (Variable de type Connexion)`**

Nom de la variable de type [Connexion](../WDLang4/1514073.md) décrivant la connexion à manipuler.

**`<Transaction à annuler> : (Entier)`**

Identifiant de la transaction à annuler pour la connexion spécifiée. Cet identifiant peut être connu grâce à la fonction [&lt;Variable Connexion&gt;.TransactionListe](../WDLang4/1000022771.md).



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Localisation et accès aux fichiers de données
<a name="localisation_acces_aux_fichiers_donnees_ELTPARAGRAPHE000419"></a>Avant d'appeler la fonction **&lt;Variable Connexion&gt;.TransactionAnnule**, les fichiers de données manipulés par la transaction annulée doivent être :

- localisés (fonctions [HSubstRep](../WDLang4/3044028.md), [&lt;Source&gt;.ChangeNom](../WDLang4/1000024201.md), ...).

- accessibles (fonction [&lt;Source&gt;.MotDePasse](../WDLang4/1000025044.md), ...).



<a name="NOTE0_2"></a>


### Détection d'une erreur
<a name="detection_une_erreur_ELTPARAGRAPHE000448"></a>Lorsqu'une erreur est détectée par le programme (gestion des erreurs avec QUAND EXCEPTION par exemple), la fonction **&lt;Variable Connexion&gt;.TransactionAnnule** permet de :

- remettre les fichiers de données dans leur état initial.

- annuler l'ensemble des opérations effectuées sur les fichiers de données depuis l'appel à la fonction [&lt;Variable Connexion&gt;.TransactionDébut](../WDLang4/1000023967.md) (ou à la fonction [&lt;Variable Connexion&gt;.Transaction](../WDLang4/1000023965.md)).



<a name="NOTE0_3"></a>


### Conseil : Rétablir la cohérence de la base de données
<a name="conseil_retablir_coherence_base_donnees_ELTPARAGRAPHE000474"></a>Si une panne (coupure de courant, re-démarrage du poste, ...) survient pendant une transaction, les fichiers de données risquent d'être incohérents : la transaction n'a été ni validée, ni abandonnée. Le fichier de transaction est toujours présent sur le poste.

Pour rétablir la cohérence de la base de données, il est conseillé de proposer dans votre application :

- soit une option permettant de maintenir la cohérence de la base de données. 
	Cette option peut par exemple appeler la fonction **&lt;Variable Connexion&gt;.TransactionAnnule** ou les fonctions [&lt;Variable Connexion&gt;.TransactionDébut](../WDLang4/1000023967.md)/[&lt;Variable Connexion&gt;.TransactionFin](../WDLang4/1000023968.md).

- soit une gestion de l'erreur 70034 dans le code d'initialisation du projet grâce au mot-clé QUAND EXCEPTION.
	Ainsi, quand l'erreur 70034 surviendra, la cohérence de la base de données sera restaurée soit par la fonction **&lt;Variable Connexion&gt;.TransactionAnnule**, soit par les fonctions [&lt;Variable Connexion&gt;.TransactionDébut](../WDLang4/1000023967.md)/[&lt;Variable Connexion&gt;.TransactionFin](../WDLang4/1000023968.md).




**Remarque** : cette opération peut être relativement longue (selon le nombre d'opérations effectuées en transaction).
<a name="NOTE0_4"></a>


### Cas d'erreurs
<a name="cas_erreurs_ELTPARAGRAPHE000521"></a>

- Imbrication de transactions : Il est impossible d'imbriquer les transactions (c'est-à-dire d'appeler la fonction [&lt;Variable Connexion&gt;.TransactionDébut](../WDLang4/1000023967.md) ou la fonction [&lt;Variable Connexion&gt;.Transaction](../WDLang4/1000023965.md) dans une transaction). Dans ce cas, l'erreur 70031 est générée.

- Une erreur fatale est affichée dans les cas suivants : 

	- Une transaction est débutée sur toutes les connexions alors qu'il existe au moins une connexion en transaction. 

	- Une transaction sur une connexion est débutée après avoir commencé une transaction sur toutes les connexions. 

	- Une transaction sur toutes les connexions est débutée alors qu'il existe au moins une connexion dont le mode d'isolation n'est pas "Read Uncommitted".






<a name="NOTE0_5"></a>


### Transactions et contexte HFSQL indépendant
<a name="transactions_contexte_hfsql_independant_ELTPARAGRAPHE000548"></a>Lors de la copie de contexte, si une transaction est en cours sur le premier contexte, le nouveau contexte n'est pas en transaction. Il faut rappeler la fonction [&lt;Variable Connexion&gt;.TransactionDébut](../WDLang4/1000023967.md) (ou la fonction [&lt;Variable Connexion&gt;.Transaction](../WDLang4/1000023965.md)) pour démarrer une transaction dans le nouveau contexte.
<a name="NOTE0_6"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) 

### OLE DB et Connecteurs Natifs
<a name="ole_connecteurs_natifs_ELTPARAGRAPHE000572"></a>Seules les syntaxes avec connexion sont prises en compte par les Connecteurs Natifs qui gèrent les transactions. Il est également possible d'utiliser la fonction [SQLTransaction](../WDLang4/3072029.md).

<a name="XComposante"></a>

## Composante :
wd280hf.dll

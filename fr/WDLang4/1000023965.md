


## &lt;Variable Connexion&gt;.Transaction (Fonction)

***En anglais : &lt;Connection variable&gt;.Transaction***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Démarre une transaction sur les fichiers de données (HFSQL ou accédés via Connecteur Natif) et crée le fichier des transactions.

**Quelles sont les informations enregistrées dans le fichier des transactions ?** Chaque fois qu'une fonction WLangage effectue une modification sur un fichier de données ou d'index pendant la transaction, les anciennes valeurs de l'enregistrement et l'opération effectuée sont mémorisées dans le fichier des transactions.

![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png) Cette fonction propose deux modes de fonctionnement des transactions : 

- La transaction peut être démarrée sur une connexion : dans ce cas, seuls les fichiers de données associés à cette connexion sont mis en transaction. Ce mode est nécessaire pour gérer les [niveaux d'isolation des transactions](../WDLang4/1000017316.md). 

- La transaction peut être démarrée sur toutes les connexions HFSQL existantes ou à venir. Dans ce cas, la fonction **&lt;Variable Connexion&gt;.Transaction** démarre à la fois une transaction HFSQL Classic (ISAM) et une transaction HFSQL Client/Serveur.




**Remarque** : Cette fonction est équivalente à la fonction [&lt;Variable Connexion&gt;.TransactionDébut](../WDLang4/1000023967.md).
<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
MaConnexion1 est une Connexion

// Début de la transaction sur les fichiers de données associés à la connexion MaConnexion1
MaConnexion1.Transaction()
Ajout_Commande()
QUAND EXCEPTION DANS
	// Ajout de la commande
	Commande.Ajoute() 
	// Validation de l'ajout
	MaConnexion1.TransactionFin()
FAIRE
	// Suppression des lignes de commandes
	MaConnexion1.TransactionAnnule()
FIN
```
<a name="Exemple2"></a>

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

### Débuter une transaction Client/Serveur sur une connexion spécifique

`<Résultat> = <Connexion>.Transaction([<Liste des fichiers de données>])`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> si la transaction a débuté, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur.




**`<Connexion> : (Variable de type Connexion)`**

Nom de la variable de type [Connexion](../WDLang4/1514073.md) décrivant la connexion à manipuler.

**`<Liste des fichiers de données> : (Chaîne de caractères optionnelle)`**

Liste de noms logiques d'un ou de plusieurs fichiers de données à prendre en compte dans la transaction ou non (dans ce cas le nom du fichier de données est précédé du signe "-").


|   |   |
| --- | --- |
| **Si ce paramètre n'est pas précisé** | Tous les fichiers de données manipulés pendant la transaction seront pris en compte dans la transaction. |
| **Si tous les fichiers de données sont préfixés par le signe "-"**<br>Par exemple : "-Client, -Produit" | Tous les fichiers de données spécifiés dans la liste et manipulés pendant la transaction ne seront pas pris en compte par la transaction.<br>Tous les fichiers de données non précisés dans la liste seront pris en compte et manipulés durant la transaction. |
| **Si aucun fichier de données de la liste n'est préfixé par le signe "-"**<br>Par exemple : "Client, Produit" | Tous les fichiers de données spécifiés dans la liste et manipulés durant la transaction seront pris en compte dans la transaction. <br>Tous les fichiers de données non spécifiés et manipulés durant la transaction ne seront pas pris en compte dans la transaction. |
| **Si certains fichiers de données sont préfixés par "-" et d'autres non**<br>Par exemple : "-Client, Produit" (équivalent à "Produit") | Tous les fichiers de données dans la liste préfixés par "-" et manipulés durant la transaction ne seront pas pris en compte dans la transaction.<br>Tous les fichiers de données dans la liste non préfixés par "-" et manipulés durant la transaction seront pris en compte dans la transaction.<br>Les fichiers de données non mentionnés dans la liste seront exclus de la transaction. |


![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) Ce paramètre est ignoré. Tous les fichiers de données associés à la connexion sont en transaction sur le serveur natif.


<a name="SYNTAXE2"></a>

### Débuter une transaction Client/Serveur sur une connexion spécifique

`<Résultat> = <Connexion>.Transaction(<Fichier de transaction> , <Liste des fichiers de données>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> si la transaction a débuté, 

- <u><u><u><u>Faux</u></u></u></u> en cas de problème. La fonction [HErreurInfo](../WDLang4/3044071.md) permet d'obtenir plus de renseignements sur l'erreur.




**`<Connexion> : (Variable de type Connexion)`**

Nom de la variable de type [Connexion](../WDLang4/1514073.md) décrivant la connexion à utiliser. 

**`<Fichier de transaction> : (Chaîne de caractères)`**

![HFSQL Classic](https://doc.pcsoft.fr/ext/images/fr/HF.png) Nom complet du fichier de transaction (utilisé pour enregistrer les opérations réalisées en transaction). Ce fichier sera automatiquement détruit lors de l'utilisation des fonctions [&lt;Variable Connexion&gt;.TransactionFin](../WDLang4/1000023968.md) ou [&lt;Variable Connexion&gt;.TransactionAnnule](../WDLang4/1000023966.md). 
Si ce nom correspond à une chaîne vide, le fichier de transaction sera créé dans le répertoire des fichiers de données de l'application et aura pour nom : &lt;Nom Projet&gt;_$TRS_OPERATION.TRS.![HFSQL Client/Serveur](https://doc.pcsoft.fr/ext/images/fr/HFCS.png)![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) Ce paramètre n'est pas pris en compte. Ce paramètre est pris en compte uniquement pour les transactions HFSQL Classic (transactions ISAM).

**`<Liste des fichiers de données> : (Chaîne de caractères)`**

Liste de noms logiques d'un ou de plusieurs fichiers de données à prendre en compte dans la transaction ou non (dans ce cas le nom du fichier de données est précédé du signe "-").


|   |   |
| --- | --- |
| **Si ce paramètre n'est pas précisé** | Tous les fichiers de données manipulés pendant la transaction seront pris en compte dans la transaction. |
| **Si tous les fichiers de données sont préfixés par le signe "-"**<br>Par exemple : "-Client, -Produit" | Tous les fichiers de données spécifiés dans la liste et manipulés pendant la transaction ne seront pas pris en compte par la transaction.<br>Tous les fichiers de données non précisés dans la liste seront pris en compte et manipulés durant la transaction. |
| **Si aucun fichier de données de la liste n'est préfixé par le signe "-"**<br>Par exemple : "Client, Produit" | Tous les fichiers de données spécifiés dans la liste et manipulés durant la transaction seront pris en compte dans la transaction. <br>Tous les fichiers de données non spécifiés et manipulés durant la transaction ne seront pas pris en compte dans la transaction. |
| **Si certains fichiers de données sont préfixés par "-" et d'autres non**<br>Par exemple : "-Client, Produit" (équivalent à "Produit") | Tous les fichiers de données dans la liste préfixés par "-" et manipulés durant la transaction ne seront pas pris en compte dans la transaction.<br>Tous les fichiers de données dans la liste non préfixés par "-" et manipulés durant la transaction seront pris en compte dans la transaction.<br>Les fichiers de données non mentionnés dans la liste seront exclus de la transaction. |


![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) Ce paramètre est ignoré. Tous les fichiers de données associés à la connexion sont en transaction sur le serveur natif. 



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques
<a name="NOTE0_2"></a>


### Blocage des enregistrements
<a name="blocage_des_enregistrements_ELTPARAGRAPHE000427"></a>Les enregistrements ajoutés, modifiés ou supprimés dans une transaction sont bloqués en écriture.
<a name="NOTE0_3"></a>


### Cas d'erreurs
<a name="cas_erreurs_ELTPARAGRAPHE000437"></a>

- Imbrication de transactions : Il est impossible d'imbriquer les transactions (c'est-à-dire d'appeler la fonction **&lt;Variable Connexion&gt;.Transaction** dans une transaction). Dans ce cas, l'erreur 70031 est générée.

- Une erreur fatale est affichée dans les cas suivants : 

	- Une transaction est débutée sur toutes les connexions alors qu'il existe au moins une connexion en transaction. 

	- Une transaction sur une connexion est débutée après avoir commencé une transaction sur toutes les connexions. 

	- Une transaction sur toutes les connexions est débutée alors qu'il existe au moins une connexion dont le mode d'isolation n'est pas "Read Uncommitted".






<a name="NOTE0_4"></a>
<a name="NOTE0_5"></a>


### Manipulations d'enregistrements pendant une transaction
<a name="manipulations_enregistrements_pendant_une_transaction_ELTPARAGRAPHE000471"></a>Pendant une transaction, il est nécessaire de suivre certaines règles lors de la manipulation des enregistrements. Pour plus de détails, consultez [Transactions : Manipuler les enregistrements lors d'une transaction](../WDLang4/3044336.md).
<a name="NOTE0_6"></a>


### Transactions et contexte HFSQL indépendant
<a name="transactions_contexte_hfsql_independant_ELTPARAGRAPHE000484"></a>Lors de la copie de contexte, si une transaction est en cours sur le premier contexte, le nouveau contexte n'est pas en transaction. Il faut rappeler la fonction **&lt;Variable Connexion&gt;.Transaction** pour démarrer une transaction dans le nouveau contexte.
<a name="NOTE0_7"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png)![OLE DB](https://doc.pcsoft.fr/ext/images/fr/OLEDB.png)![Connecteurs Natifs (Accès Natifs)](https://doc.pcsoft.fr/ext/images/fr/AN.png) 

### OLE DB et Connecteurs Natifs
<a name="ole_connecteurs_natifs_ELTPARAGRAPHE000499"></a>Seules les syntaxes avec connexion sont prises en compte par les Connecteurs Natifs qui gèrent les transactions. Il est également possible d'utiliser la fonction [SQLTransaction](../WDLang4/3072029.md).

<a name="XComposante"></a>

## Composante :
wd280.dll




## Triggers serveur
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000313"></a>
Les triggers serveur sont des procédures stockées exécutées par le serveur avant ou après une action d'écriture effectuée sur un fichier de la base de données.

Comme pour les triggers classiques, deux types de triggers serveur sont disponibles : 

- Les triggers "AVANT" :
	Un trigger "AVANT" est appelé : 

	- *avant* l'exécution d'une fonction HFSQL ([HAjoute](../WDLang4/3044147.md), [HModifie](../WDLang4/3044042.md), [HSupprime](../WDLang4/3044018.md), ...).

	- *avant* l'exécution d'une fonction de gestion des champs Table fichier.
			Un trigger "AVANT" permet par exemple de vérifier la cohérence des données des rubriques d'un enregistrement. Avec ce type de trigger, il est possible d'initialiser une variable HFSQL pour annuler l'exécution de la fonction HFSQL associée. 




- Les triggers "APRÈS" :
	Un trigger "APRÈS" est appelé : 

	- *après* l'exécution d'une fonction HFSQL (sauf si le programme a été interrompu pendant l'exécution de cette fonction).

	- *après* l'exécution d'une fonction de gestion des champs Table fichier. 
			Un trigger "APRÈS" permet par exemple de gérer le traitement des erreurs.







**Caractéristiques des triggers serveur** : 

- Plusieurs triggers serveur peuvent être associés à un même fichier de données.

- Les triggers étant définis sur le serveur, ils sont pris en compte quelle que soit l'application cliente exécutée. La prise en compte d'un nouveau trigger défini sur le serveur est automatique.

- Les triggers serveur sont exécutés :

	- avec les fonctions [HAjoute](../WDLang4/3044147.md), [HSupprime](../WDLang4/3044018.md), [HModifie](../WDLang4/3044042.md), [HEcrit](../WDLang4/3044092.md), [HRaye](../WDLang4/3044121.md).

	- avec les fonctions [TableAjoute](../WDLang1/3074017.md), [TableAjouteLigne](../WDLang1/3074006.md), [TableSupprime](../WDLang1/3074032.md), [TableModifie](../WDLang1/3074019.md) qui utilisent implicitement les fonctions HFSQL.

	- avec les requêtes INSERT (trigger HAjoute), UPDATE (trigger HModifie) et DELETE (trigger HSupprime).







<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Création des triggers serveur sous l'analyse
<a name="creation_des_triggers_serveur_sous_analyse_ELTTEXTE000343"></a>


### Préalable
<a name="prealable_ELTPARAGRAPHE000085"></a>Pour créer un trigger serveur : 

- sous le volet "Analyse", dans le groupe "Création", déroulez "Nouveau" et sélectionnez "Trigger". 

- sélectionnez l'option "Nouveau trigger" du menu contextuel du volet ancrable "Analyse".

- affichez l'onglet "Triggers HF" de la fenêtre de description du fichier de données et cliquez sur le bouton "Créer un nouveau trigger".




Ces différentes options affichent la fenêtre de description du trigger serveur.

La fenêtre de description d'un trigger permet d'indiquer :

- dans l'onglet "Général" : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Triggers_Serveur%20-%20HC%20N%B0002.gif&type=thumb)


	- le nom du trigger.

- la procédure stockée WLangage qui est associée au trigger.

- le mode de déclenchement du trigger (AVANT ou APRES l'exécution des fonctions HFSQL).

- les fonctions HFSQL qui déclencheront le trigger.

- dans l'onglet "Général" : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Triggers_Serveur%20-%20HC%20N%B0003.gif&type=thumb)


	- les fichiers de données associés au trigger.




Remarque : Les triggers créés sont visibles :

- dans le volet de l'analyse.

- directement dans le graphe de l'analyse : si un trigger serveur est associé à un fichier de données, une icône spécifique apparaît : ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Triggers_Serveur%20-%20HC%20N%B0001.gif).



<a name="NOTE2_2"></a>


### Prise en compte des triggers serveur
<a name="prise_compte_des_triggers_serveur_ELTPARAGRAPHE000131"></a>Les triggers serveur créés dans l'analyse sont créés sur le serveur :

- lors de la création des fichiers de données (fonction [HCréation](../WDLang4/3044255.md) ou [HCréationSiInexistant](../WDLang4/3044254.md)).

- avec la fonction [HCréeTriggerServeur](../WDLang4/1000018986.md). Dans ce cas, il est également nécessaire de mettre à jour la procédure stockée correspondante avec la fonction [HMiseAJourCollection](../WDLang4/3044354.md). 

- si nécessaire lors de la modification automatique des fichiers de données.




Les triggers installés sur le serveur seront automatiquement pris en compte par les applications clientes.
<a name="NOTE2_3"></a>


### Procédure stockée liée au trigger
<a name="procedure_stockee_liee_trigger_ELTPARAGRAPHE000158"></a>Une procédure stockée de type trigger ne reçoit aucun paramètre. Toutefois, un certain nombre de variables d'état HFSQL est positionné avant chaque appel :


|   |   |
| --- | --- |
| *h.NomFichier* | Chaîne de caractères : Nom logique du fichier de données dont le trigger est activé. |
| *h.Action* | Caractère initialisé à "A" pour un trigger Avant, "P" pour un trigger après. |
| *h.FonctionTrigger* | Chaîne de caractères : Nom de la fonction HFSQL qui a déclenché le trigger. |
| *h.AFaire* | Pendant l'exécution d'un trigger avant :<br><br>- annulation de l'exécution de la fonction HFSQL en cours en affectant **"A"** à la variable d'état HFSQL : h.AFaire = "A". Dans ce cas, l'action n'est pas effectuée et la fonction (HAjoute, HModifie, ...) renvoie <u><u><u><u>Vrai</u></u></u></u> (pas d'erreur).<br><br>- annulation de l'exécution de la fonction HFSQL en cours en affectant **"E"** à la variable d'état HFSQL : h.AFaire = "E". Dans ce cas, l'action n'est pas effectuée et la fonction (HAjoute, HModifie, ...) renvoie <u><u><u><u>Faux</u></u></u></u>. Le message d'erreur est le suivant : "L'action sur le fichier XXX a été interrompue par le trigger".<br><br><br> |


**Remarques** : 

- Dans le cas où un trigger "AVANT" et un trigger "APRÈS" sont associés à une fonction HFSQL, si le trigger "AVANT" annule l'exécution de la fonction HFSQL (en positionnant h.AFaire à "A") le trigger "APRÈS" n'est pas déclenché.

- Le mot-clé [MonFichier](../Motscles/1511019.md) permet de connaître et de manipuler dans le code de la procédure stockée le nom du fichier de données sur lequel le trigger a été déclenché.




**Important** : Pour qu'une procédure stockée lancée depuis un trigger serveur accède aux données, il faut utiliser la fonction [HDéclareExterne](../WDLang4/3044204.md). Cette fonction permet de déclarer les sources de données qui seront utilisées dans les traitements de la procédure stockée. 
En effet, lorsqu'une procédure stockée est lancée par exemple depuis le Centre de Contrôle HFSQL, il n'y a pas d'analyse en cours : les données HFSQL Client/Serveur ne sont pas immédiatement accessibles. 
Si la fonction [HDéclareExterne](../WDLang4/3044204.md) n'est pas utilisée dans le code de la procédure stockée, la procédure provoquera une erreur fatale, notée dans le journal des événements du système.
<a name="NOTE2_4"></a>


### Tester une procédure stockée appelée par un trigger
<a name="tester_une_procedure_stockee_appelee_par_trigger_ELTPARAGRAPHE000214"></a>Pour tester une procédure stockée :

1. Sélectionnez la procédure stockée à tester dans le volet de l'analyse.

2. Sélectionnez l'option "Tester la procédure" dans le menu contextuel de la procédure stockée.

3. La fenêtre de saisie des paramètres de la procédure s'affiche. Dans cette fenêtre, il est possible de :

	- Saisir les paramètres de la procédure.

	- Lancer le test de la procédure.
			Remarque : cette fenêtre peut être utilisée pour relancer plusieurs fois l'exécution en modifiant les paramètres.




4. Lorsque le test de la procédure est lancé :

	- Si nécessaire une mise à jour de la procédure stockée sur le serveur est proposée.

	- La procédure est lancée sur le serveur.

	- La valeur de retour de la procédure est affichée si nécessaire.







**Remarques/limitations** : 

- Le port de débogage est le port 27281 par défaut. Il est nécessaire d'ouvrir ce port dans le firewall. Ce port peut être modifié dans le [fichier HFConf.ini](../WDLang4/3044345.md).

- Pour lancer le test d'une procédure stockée, il est nécessaire d'avoir le droit de débogage sur la base de données.

- Les traces utilisées dans les procédures stockées sont affichées dans le [volet de trace du débogueur](../Editeurs/2027028.md).

- Le code de la procédure stockée peut contenir des points d'arrêt : le débogueur sera alors lancé.

- Les éléments déployés sur le serveur sont utilisés lors du test.

- La fonction [EnModeTest](../WDLang1/3013011.md) renvoie <u><u><u><u>Vrai</u></u></u></u>.




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Manipulation des triggers serveur par programmation
<a name="manipulation_des_triggers_serveur_par_programmation_ELTTEXTE000385"></a>


### Les fonctions du WLangage
<a name="les_fonctions_wlangage_ELTPARAGRAPHE000259"></a>Plusieurs fonctions permettent de manipuler les triggers serveur :



|   |   |
| --- | --- |
| [HActiveTriggerServeur](../WDLang4/1000017034.md) | Ré-active un trigger serveur précédemment désactivé par la fonction [HDésactiveTriggerServeur](../WDLang4/1000017035.md). |
| [HCréeTriggerServeur](../WDLang4/1000018986.md) | Ajoute ou modifie un trigger serveur sur le serveur HFSQL. |
| [HDécritTriggerServeur](../WDLang4/1000017033.md) | Ajoute ou modifie un trigger serveur. |
| [HDésactiveTriggerServeur](../WDLang4/1000017035.md) | Désactive un trigger Serveur HFSQL Client/Serveur sur un serveur. |
| [HDétruitTriggerServeur](../WDLang4/1000017036.md) | Détruit un trigger serveur. |
| [HListeTriggerServeur](../WDLang4/1000017037.md) | Liste les différents triggers disponibles sur une connexion ou sur un des fichiers de la connexion. |
| [HTriggerEnregistrementAvant](../WDLang4/1000025873.md) | Récupère la valeur de l'enregistrement en cours avant l'exécution du ou des triggers. |



 
Ces fonctions sont des fonctions avancées.


- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDTriggerserveur.gif) ***Exemples didactiques (WINDEV)*** : **WD Trigger serveur** <br>Cet exemple permet de montrer comment utiliser des triggers serveur. <br>Les triggers serveur s'exécutent sur le serveur à chaque Ajout/Modification/Suppression d'enregistrement.



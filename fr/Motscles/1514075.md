


## Procédure interne
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Principe
<a name="principe_ELTTEXTE000263"></a>
De nombreuses fonctionnalités nécessitent une procédure appelée une ou plusieurs fois au travers d'une fonction du WLangage (également appelée "Callback"). Par exemple, les fonctions suivantes sont dans ce cas : [fListeFichier](../WDLang1/3036058.md), [ArbreListeFils](../WDLang1/3018016.md), [AlbumSélecteur](../WDLang3/1000020186.md) en iOS, ...

Il est nécessaire de créer une procédure pour ces fonctions, mais de nombreux inconvénients apparaissent :

- Perte de la localité du code : Il n'est pas possible de voir l'algorithme final dans son ensemble. Il est nécessaire de faire des aller-retour entre le code appelant et la procédure WLangage.

- Difficulté de partage d'informations avec la procédure WLangage : Il est en général nécessaire d'utiliser des variables globales (pour passer des paramètres à la callback ou récupérer les résultats).




Dans ce cas, les procédures internes permettent de simplifier l'écriture des fonctionnalités à callback et de simplifier les problèmes posés par l'utilisation d'une procédure classique.



<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Déclaration et appel des procédures internes
<a name="declaration_appel_des_procedures_internes_ELTTEXTE000287"></a>
La déclaration d'une procédure interne se fait directement dans le code d'un traitement existant (traitement associé à un champ, procédure de fenêtre, procédure globale ou méthode de classe, ...).

La syntaxe est la suivante : 

```txt
PROCEDURE INTERNE <Nom de la procédure>()
<Code de la procédure>
FIN
```
Remarques : 

- Les procédures internes doivent être déclarées dans le traitement dans lequel elles sont utilisées.

- L'assistance à la saisie des paramètres est activée : une bulle d'aide précisant le type du paramètre attendu est affichée lors de la saisie de l'appel de la procédure interne. 

- Le code du traitement situé avant et après le code de déclaration de la procédure interne est exécuté en séquence : le code de la procédure interne n'est pas exécuté.
	Exemple : 
	
	```wl
	// Code avant la procédure Interne : Ce code est exécuté. 
	PROCEDURE INTERNE MaProcédureInterne()
		// Code de la procédure interne. 
		// Ce code n'est pas exécuté. 
	FIN
	// Code après la procédure interne : Ce code est exécuté.
	```


- Il est possible d'appeler directement une procédure interne par son nom, comme pour une procédure classique. Cet appel peut être placé avant ou après la déclaration de la procédure interne. 
	Exemple : 
	
	```wl
	// Appel placé avant
	MaProcédureInterne()
	
	// Déclaration de la procédure interne
	PROCEDURE INTERNE MaProcédureInterne()
		// Code de la procédure interne exécuté lors de l'appel à MaProcédureInterne()
	FIN
	
	// Appel placé après
	MaProcédureInterne()
	```

	Il est ainsi possible d'obtenir un code plus simple à lire. 

- Les exceptions provoquées par les procédures internes peuvent être traitées à l'extérieur de la procédure interne.



![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) 

### Exemple
<a name="exemple_ELTPARAGRAPHE000081"></a>Le code suivant permet de lister tous les éléments fils d'un noeud d'un champ Arbre : 

```wl
// Liste les "fils" du noeud "Desserts" dans le champ Arbre "ARBRE_RecetteTV"
// La procédure "DérouleTout" est appelée
// pour chaque "fils" trouvé du noeud "Desserts"
Res = ArbreListeFils(ARBRE_RecetteTV, "Recettes" + TAB + "Desserts", DérouleTout)

PROCEDURE INTERNE DérouleTout(ARBRE_RecetteTV, CheminFils, FilsTrouvé, Niveau, Pointeur)
	// L'élément trouvé est-il une feuille ?
	SI ArbreTypeElement(ARBRE_RecetteTV, CheminFils + FilsTrouvé) = aFeuille ALORS
		RETOUR // Retour à la fonction ArbreListeFils
	SINON
		// L'élément trouvé est-il enroulé ?
		SI ArbreEtat(ARBRE_RecetteTV, CheminFils + FilsTrouvé) = aEnroule ALORS
			ArbreDéroule(ARBRE_RecetteTV, CheminFils + FilsTrouvé)
		FIN
	FIN
	// Enroule le champ Arbre
	ArbreEnroule(ARBRE_RecetteTV, "Recettes")
FIN
```


<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Caractéristiques des procédures internes
<a name="caracteristiques_des_procedures_internes_ELTTEXTE000317"></a>


### Utilisation en callback
<a name="utilisation_callback_ELTPARAGRAPHE000091"></a>La procédure interne peut être utilisée dans une fonction du WLangage qui attend une procédure WLangage en paramètre (comme [fListeFichier](../WDLang1/3036058.md), [ArbreListeFils](../WDLang1/3018016.md), ...).

Attention : Dans ce cas, le paramètre correspondant au nom de la procédure interne doit correspondre directement au nom de la procédure interne (le nom de la procédure ne doit pas être entre guillemets). 

**Ne pas faire** : 

```wl
// Liste les "fils" du noeud "Desserts" dans le champ Arbre "ARBRE_RecetteTV"
Res = ArbreListeFils(ARBRE_RecetteTV, "Recettes" + TAB + "Desserts", "DérouleTout")

PROCEDURE INTERNE DérouleTout(ARBRE_RecetteTV, CheminFils, FilsTrouvé, Niveau, Pointeur)
	...
FIN
```


**Faire** : 

```wl
// Liste les "fils" du noeud "Desserts" dans le champ Arbre "ARBRE_RecetteTV"
Res = ArbreListeFils(ARBRE_RecetteTV, "Recettes" + TAB + "Desserts", DérouleTout)

PROCEDURE INTERNE DérouleTout(ARBRE_RecetteTV, CheminFils, FilsTrouvé, Niveau, Pointeur)
	...
FIN
```



### Paramètre de type Procédure interne
<a name="parametre_type_procedure_interne_ELTPARAGRAPHE000110"></a>La procédure interne peut être utilisée comme paramètre dans une procédure. Dans ce cas le type du paramètre sera de type "Procédure".

Exemple : 

```wl
// Déclaration de la procédure interne
PROCEDURE INTERNE MaProcédureInterne()
	// code exécuté lors de l'appel de la procédure passée en paramètre
FIN

MonAutreProcédure(MaProcédureInterne)
```

```wl
PROCEDURE MonAutreProcédure(p est une procédure)

p()
```
![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Cette fonctionnalité n'est pas disponible.


### Accès aux variables depuis une procédure interne
<a name="acces_aux_variables_depuis_une_procedure_interne_ELTPARAGRAPHE000124"></a>Les variables déclarées dans le même traitement que la déclaration de la procédure interne peuvent être appelées dans la procédure interne. Il n'est plus nécessaire d'utiliser des variables globales. Ce concept est appelé "Closure". 

Exemple : 

```wl
sListeElément est une chaîne
sSéparateur est une chaîne = RC
ArbreListeFils(ARBRE_ChampArbre, "", MaProcédureInterne)

PROCEDURE INTERNE MaProcédureInterne(NomArbre, Branche)
	sListeElément += [sSéparateur] + Branche
FIN
```



### Imbrication de procédures internes
<a name="imbrication_procedures_internes_ELTPARAGRAPHE000132"></a>Les procédures internes peuvent être imbriquées. Chaque procédure interne peut accéder aux variables des procédures qui l'incluent.

Exemple : 

```wl
VariableExterne est un entier
Trace(VariableExterne)
MaProcédureInterne1()
PROCEDURE INTERNE MaProcédureInterne1()
	VariableInterne1 est un entier
	Trace(VariableExterne + VariableInterne1)
	MaProcédureInterne2()
	PROCEDURE INTERNE MaProcédureInterne2()
		VariableInterne2 est un entier
		Trace(VariableExterne + VariableInterne1 + VariableInterne2)
	FIN
FIN
```



### Procédures internes soeurs
<a name="procedures_internes_soeurs_ELTPARAGRAPHE000142"></a>Deux procédures internes présentes dans la même procédure peuvent s'appeler entre elles (procédures internes soeurs).

Exemple : 

```wl
PROCEDURE INTERNE MaProcédurePrincipale()

	PROCEDURE INTERNE MaProcédureInterne1()
		...
	FIN

	PROCEDURE INTERNE MaProcédureInterne2()
		...
		// Appel de la procédure soeur
		MaProcédureInterne1()
	FIN
FIN
```



### Appels récursifs
<a name="appels_recursifs_ELTPARAGRAPHE000151"></a>Une procédure interne peut s'appeler elle-même de façon récursive. 


### Paramètres nommés
<a name="parametres_nommes_ELTPARAGRAPHE000157"></a>Si une procédure interne possède des paramètres avec des valeurs par défaut, il est possible d'appeler la procédure interne en nommant ses paramètres. Deux syntaxes sont possibles : 

- Paramètres nommés monolignes,

- Paramètres nommés multilignes. 




Pour plus de détails, consultez [Paramètres nommés dans une procédure](../Motscles/1513007.md). 


### Compilation dynamique
<a name="compilation_dynamique_ELTPARAGRAPHE000171"></a>Il est possible d'utiliser une procédure interne dans un code compilé dynamiquement (avec la fonction [Compile](../WDLang1/3013015.md) par exemple). 

Exemple : 

```wl
lsCode est chaîne = [
// Code compilé dynamiquement
sListeElément est une chaîne
sSéparateur est une chaîne = RC
ArbreListeFils(ARBRE_ChampArbre, "", MaProcédureInterne)

PROCEDURE INTERNE MaProcédureInterne(NomArbre, Branche)
	sListeElément += [sSéparateur] + Branche
FIN

]

lsRésultat est chaîne

lsRésultat = Compile("MaProc",lsCode)
```



### Procédure interne et attributs d'extension
<a name="procedure_interne_attributs_extension_ELTPARAGRAPHE000182"></a>Les [attributs d'extensions](../Motscles/1511025.md) peuvent être utilisés avec les procédures internes. Par exemple, un traitement unique peut exécuter une procédure interne dans un thread secondaire pour ne pas être bloquant, puis appeler une seconde procédure dans le thread principal pour mettre à jour l'interface.

Exemple : 

```wl
// Code d'un bouton par exemple ...
ExécutionAsynchrone()

PROCÉDURE INTERNE ExécutionAsynchrone() <thread>
	
	// Ici exécution d'un traitement en tâche de fond
	// dans un thread secondaire (pas d'accès à l'interface)
	ThreadPause(5s)
		
	// Traitement terminé, rappel d'un traitement du thread principal 
	// donc autorisé à mettre à jour l'interface
	AprèsExécutionAsynchrone()
FIN

PROCÉDURE INTERNE AprèsExécutionAsynchrone() <thread principal>
	Trace("Terminé ...")
FIN
```


<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Cas particulier : Utilisation de procédures internes avec des fonctions asynchrones
<a name="cas_particulier_utilisation_procedures_internes_avec_des_fonctions_asynchrones_ELTTEXTE000389"></a>
Les procédures internes peuvent être utilisées comme "Callback" pour des fonctions asynchrones. 

ATTENTION : Dans ce cas, le code situé après l'appel de la fonction utilisant une procédure WLangage asynchrone sera exécuté AVANT le code de la procédure Interne. 

Exemple : Dans cet exemple pour WINDEV Mobile, le code situé après la fonction [AlbumSélecteur](../WDLang3/1000020186.md) sera exécuté AVANT la procédure interne. La procédure interne sera appelée lorsque l'utilisateur aura validé le sélecteur. 

```wl
AlbumSélecteur(albumImage, SélectionPhoto)
PROCEDURE INTERNE SélectionPhoto(sCheminImage)
	IMG_ChampImage = sCheminImage
FIN
// Code exécuté après la fonction AlbumSélecteur mais 
// AVANT le code de la procédure interne.
```


<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Limitations
<a name="limitations_ELTTEXTE000413"></a>


- Une procédure interne ne peut pas avoir le même nom que la ou les procédures qui la contiennent.

- Deux procédures internes de même niveau ne peuvent pas avoir le même nom, même si elles sont déclarées dans des blocs de code différents (SI ALORS SINON, ...).

- Les procédures internes ne sont pas disponibles en compilation dynamique. 

- Il n'est pas possible d'automatiser l'exécution d'une procédure interne. 

- La gestion automatique des erreurs n'est pas disponible sur les procédures internes.







## CertificatSigneChaîne (Fonction)

***En anglais : CertificateSignString***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Crée la signature d'une chaîne de caractères.


<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple
<a class="notetitle" target="_blank" href="$DOC$=1000020853&name=certificatsignechaine_fonction&product=WD">Voir des exemples supplémentaires</a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) 
```wl
// Signature de chaîne selon un certificat installé sur la machine 
// Attention : cette syntaxe utilise une variable de type Certificat. 
// Cette syntaxe n'est pas compatible avec la mise en conformité 
// des logiciels de caisse (Norme NF525).
// L'exemple correspondant à la norme NF525 est disponible dans 
// les exemples supplémentaires

MonCertificat est un Certificat

// Ouverture du sélecteur de certificat de Windows
MonCertificat = CertificatSélecteur()
// Annulation ou erreur
SI MonCertificat.Nom = "" ALORS
	RETOUR
FIN

// Teste la validité du certificat pour la signature
SI MonCertificat.ValidePourSignature = Faux ALORS
	Info("Le certificat sélectionné ne permet de pas de générer une signature.")
	RETOUR
FIN

// Récupération du buffer contenant la signature
bufSignature est un Buffer
bufSignature = CertificatSigneChaîne("Chaîne de caractères à signer", MonCertificat)

// Récupération du certificat contenu dans le buffer de la signature
MonCertificatExtrait est un Certificat
MonCertificatExtrait = CertificatExtrait(bufSignature)

// Gestion des erreurs
SI MonCertificatExtrait = Null ALORS
	RETOUR
FIN

// Ouverture de la fenêtre des propriétés du certificat
CertificatOuvrePropriétés(MonCertificatExtrait)
```

<a name="XSYNTAXE"></a>

## Syntaxe
<a name="SYNTAXE1"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) 
### Signer une chaîne à l'aide d'une variable de type Certificat

`<Résultat> = CertificatSigneChaîne(<Chaîne à signer> , <Certificat>)`
---

**`<Résultat> : (Buffer)`**

Signature de la chaîne (au format PKCS7 (DER)). Ce buffer pourra être ensuite utilisé par la fonction [CertificatVérifieChaîne](../WDLang1/1000019298.md) pour vérifier la correspondance entre la signature et la chaîne.

**`<Chaîne à signer> : (Chaîne de caractères Ansi ou Unicode ou Buffer)`**

Chaîne de caractères à signer.

**`<Certificat> : (Variable de type Certificat)`**

Nom de la variable de type [Certificat](../WDLang1/1000019287.md) contenant le certificat à utiliser pour signer la chaîne.


<a name="SYNTAXE2"></a>

### Signer une chaîne via une signature numérique

`<Résultat> = CertificatSigneChaîne(<Chaîne à signer> , <Fichier certificat> , <Mot de passe> , <Option>)`
---

**`<Résultat> : (Buffer)`**

Signature de la chaîne (au format demandé). Ce buffer pourra être ensuite utilisé par la fonction [CertificatVérifieChaîne](../WDLang1/1000019298.md) pour vérifier la correspondance entre la signature et la chaîne.

**`<Chaîne à signer> : (Chaîne de caractères Ansi ou Unicode ou Buffer)`**

Chaîne de caractères à signer.

**`<Fichier certificat> : (Chaîne de caractères ou Buffer)`**



- Chemin complet vers un fichier de type PKCS12 (.p12/.pfx) contenant la clé privée et les certificats. Ce fichier peut être intégré dans la librairie (fichier WDL) de l'application.

- Buffer contenant la clé privée et les certificats.
	Si la constante *certSignatureSeule* est utilisée, ce buffer peut contenir uniquement la clé privée.




**`<Mot de passe> : (Chaîne de caractères)`**

Mot de passe à utiliser pour décrypter le fichier de certificat si celui-ci est protégé par un mot de passe. 

**`<Option> : (Constante ou combinaison de constantes de type Entier)`**

Permet de spécifier : 

- l'algorithme de hachage utilisé (facultatif dans le cas d'une signature au format PKCS7) : 
	


|   |   |
| --- | --- |
| *certMD5* | Algorithme MD5. <br><br>Déconseillé car peu fiable. Ce type d'algorithme est interdit avec les signatures de type "elliptic curve". |
| *certSHA160* | Algorithme SHA1. |
| *certSHA256* | Algorithme SHA2. Le résultat produit est de 256 bits.  |
| *certSHA384* | Algorithme SHA-384. Le résultat produit est de 384 bits. <br><br>Ce type d'algorithme n'est pas supporté avec les signatures de type "DSA". |
| *certSHA512* | Algorithme SHA-512. Le résultat produit est de 512 bits.  <br><br>Ce type d'algorithme n'est pas supporté avec les signatures de type "DSA". |



- le format de la signature : 
	


|   |   |
| --- | --- |
| *certPKCS7AvecCertificat* | Conteneur au format PKCS7 (DER) contenant la signature et la chaîne des certificats. <br><br>**Remarque** : si cette constante est utilisée, l'algorithme de hachage est facultatif. S'il n'est pas précisé, un algorithme approprié sera automatiquement choisi. |
| *certPKCS7AvecCertificat* + *certPKCS7PEM* | Conteneur au format PKCS7 (PEM) contenant la signature et la chaîne des certificats.  <br><br>**Remarque** : si cette constante est utilisée, l'algorithme de hachage est facultatif. S'il n'est pas précisé, un algorithme approprié sera automatiquement choisi. |
| *certPKCS7Enveloppé* | Conteneur au format PKCS7 (DER) contenant la signature, la chaîne des certificats et les données signées. <br><br>**Remarque** : si cette constante est utilisée, l'algorithme de hachage est facultatif. S'il n'est pas précisé, un algorithme approprié sera automatiquement choisi. |
| *certPKCS7Enveloppé* + *certPKCS7PEM* | Conteneur au format PKCS7 (PEM) contenant la signature, la chaîne des certificats et les données signées. <br><br>**Remarque** : si cette constante est utilisée, l'algorithme de hachage est facultatif. S'il n'est pas précisé, un algorithme approprié sera automatiquement choisi. |
| *certPKCS7SansCertificat* | Conteneur au format PKCS7 (DER) contenant la signature. <br><br>**Remarque** : si cette constante est utilisée, l'algorithme de hachage est facultatif. S'il n'est pas précisé, un algorithme approprié sera automatiquement choisi.  |
| *certPKCS7SansCertificat* + *certPKCS7PEM* | Conteneur au format PKCS7 (PEM) contenant la signature.<br><br>**Remarque** : si cette constante est utilisée, l'algorithme de hachage est facultatif. S'il n'est pas précisé, un algorithme approprié sera automatiquement choisi.    |
| *certSignatureSeule* | La sortie contient uniquement la signature brute, sans conteneur. <br><br>Cette option est requise dans le cas d'une mise en conformité des logiciels de caisse (norme NF525). Avec cette option, seule la partie clé du fichier PFX est utilisée (la partie certificat qui contient la date n'est pas utilisée).<br><br>**Attention** : si cette constante est utilisée, il est nécessaire de préciser l'algorithme de hachage.   |




Remarque : L'algorithme de signature est déterminé par la clé privée (RSA, DSA, Elliptic curve). 



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Validité du certificat (syntaxe 1)
<a name="validite_certificat_syntaxe_1_ELTPARAGRAPHE000167"></a>Avant de signer une chaîne, il est conseillé de vérifier la validité du certificat (propriété **ValidePourSignature** de la variable de type [Certificat](../WDLang1/1000019287.md)). Cette propriété permet de savoir si le certificat possède une clé privée et toutes les caractéristiques requises pour effectuer une signature. Si cette propriété est à <u><u><u><u>Faux</u></u></u></u>, la fonction **CertificatSigneChaîne** renvoie une erreur. 
<a name="NOTE0_2"></a>

<a name="XComposante"></a>

## Classification Métier / UI :
Code métier
## Composante :
wd280std.dll

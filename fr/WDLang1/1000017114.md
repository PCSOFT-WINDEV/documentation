


## Créer un service avec WINDEV
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000358"></a>


### Qu'est-ce qu'un service ?
<a name="questce_quun_service_ELTPARAGRAPHE000011"></a>Un service est une forme spécifique d'application destinée à être exécutée sans intervention de l'utilisateur.
Un service peut être configuré pour démarrer automatiquement en même temps que le système d'exploitation et pour fonctionner en tâche de fond.
![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png) Les services sont également appelés daemons.
<a name="NOTE1_2"></a>


### Dans quels cas utiliser un service ?
<a name="dans_quels_cas_utiliser_service_ELTPARAGRAPHE000023"></a>Un service doit être utilisé pour permettre à une application de répondre à tout moment à une sollicitation externe (lecture sur une socket par exemple).
Si le service doit se contenter d'exécuter une tâche de façon répétée, il est préférable de faire une application standard et de lancer cette application dans une tâche planifiée.
<a name="NOTE1_3"></a>


### Différences entre un service et une application
<a name="differences_entre_service_une_application_ELTPARAGRAPHE000032"></a>

- Un service tourne toujours sous l'identité du même utilisateur (configuré lors de son installation) quel que soit l'utilisateur connecté à la machine.

- Un service ne peut pas avoir d'interaction directe avec l'utilisateur connecté. L'ouverture d'une fenêtre avec [Ouvre](../WDLang1/3038035.md) est possible (par exemple pour créer un traitement graphique sur des images), mais sa fermeture doit être systématique une fois le traitement effectué. De façon générale, il ne doit pas y avoir d'appel de fonction bloquante ([Info](../WDLang1/3021011.md), [Dialogue](../WDLang1/3021015.md), [Saisie](../WDLang1/3021016.md)...).

- Un service qui utilise une base de données HFSQL et plus généralement les fonctions H\* pour l'accès à une base de données doit gérer les conflits (doublons, intégrité, modification, ...) grâce à la fonction [HSurErreur](../WDLang4/3044017.md). Dans le cas contraire, le service pourra être bloqué en cas de conflit.

- ![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png) Un service peut fonctionner sous l'identité du système d'exploitation lui-même.

- ![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png) Un service n'est pas soumis à l'UAC ou à la virtualisation (à partir de Windows Vista).




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Création d'un service avec WINDEV
<a name="creation_service_avec_windev_ELTTEXTE000394"></a>


### Création d'un service
<a name="creation_service_ELTPARAGRAPHE000064"></a>WINDEV permet de créer un service : 

- soit à partir d'un nouveau projet.

- soit à partir d'un projet existant.




**Pour créer un service à partir d'un nouveau projet** : 

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif) parmi les boutons d'accès rapide. 

2. La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Projet".

3. L'assistant de création de projet se lance.

4. Sélectionnez le type de projet à créer : "Service Windows ou Linux". Passez à l'étape suivante de l'assistant. 

5. Sélectionnez le système d'exploitation du service (Windows ou Linux). Passez à l'étape suivante de l'assistant. 

6. Indiquez le mode d'exécution (32 bits ou 64 bits). 

7. Suivez ensuite les différentes étapes de l'assistant. 




**Pour créer un service à partir d'un projet existant**, il suffit d'ajouter une nouvelle configuration de projet : sous le volet "Projet", dans le groupe "Configuration de projet", déroulez "Nouvelle configuration". Il est possible de créer :

- une configuration de projet de type "Service Windows" (32 bits ou 64 bits).

- une configuration de projet de type "Daemon Linux" (32 bits ou 64 bits).


Pour plus de détails, consultez [Configuration de projet](../Editeurs/9000030.md). 

<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Développement d'un service
<a name="developpement_service_ELTTEXTE000418"></a>


### Programmation d'un service
<a name="programmation_service_ELTPARAGRAPHE000110"></a>Le projet créé dispose de deux événements supplémentaires pour gérer le service :

| Evénement | Effet |
| --- | --- |
| Exécution du service (appelé en boucle) | Cet événement est l'événement principal du service. Il est appelé en boucle quand le service est démarré (automatiquement au boot ou par un appel à la fonction [ServiceDémarre](../WDLang1/1000017110.md)).<br><br>Dans la majorité des cas, cet événement va se mettre en attente d'une sollicitation extérieure (par exemple en créant une socket et en appelant ensuite la fonction [SocketAttendConnexion](../WDLang3/3070006.md)) puis déclencher des actions en réponse à cette sollicitation.<br><br>Dans le cas des services qui exécutent des actions en continue, il convient d'appeler la fonction [ServiceTemporise](../WDLang1/1000018712.md) à chaque passage dans cet événement afin de ne pas consommer toutes les ressources processeur de la machine.<br><br>**Notes** : <br><br>- Lorsque du code doit être partagé entre un service et une application (par exemple une classe), il est possible de connaître le mode d'exécution grâce à la fonction [EnModeService](../WDLang1/1000018710.md).<br><br>- Si la fonction [SysDétecteSessionVerrouillée](../WDLang1/1000021185.md) est utilisée dans un service, utilisez la fonction [Multitâche](../WDLang1/3015004.md) dans le code d'exécution du service pour recevoir les messages Windows. <br>	<br>	<br><pre><code>Multitache(-1)</code></pre><br><br><br><br> |
| Arrêt du service | Cet événement est appelé automatiquement lorsque le service reçoit une demande d'arrêt (par un appel à la fonction [ServiceArrête](../WDLang1/1000017111.md) ou lors de l'arrêt de la machine).<br><br>Cet événement est appelé dans un thread différent de l'événement "Exécution du service".<br><br>Si l'événement principal est bloqué en attente sur une ressource (par exemple une socket), il appartient à l'événement "Arrêt du \* service" de détruire la ressource pour débloquer l'événement principal.<br><br>**Note** : A partir du début du processus d'arrêt du service, l'événement "Exécution du service" n'est plus appelé en boucle. |


**Remarques** : 

- Pour éditer les événements spécifiques d'un service : sous le volet "Accueil", dans le groupe "Général", déroulez ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_code.gif) et sélectionnez "Code du projet".

- Les événements spécifiques d'un service ne sont pas pris en compte par la [télémétrie](../WDLang1/1410086580.md) : il n'est pas possible d'utiliser les [fonctions de télémétrie](../WDLang1/1410086589.md) dans ces événements.




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Génération d'un service
<a name="generation_service_ELTTEXTE000442"></a>
Le service créé peut être généré en fonction de ses caractéristiques : 

- Service Windows 32 bits.

- Service Windows 64 bits.

- Daemon Linux 32 bits.

- Daemon Linux 64 bits.




Pour générer le service, sous le volet "Projet", dans le groupe "Génération", cliquez sur "Générer". L'assistant de génération correspondant à la configuration en cours sera automatiquement lancé.

L'assistant de génération : 

- du service Windows 32 bits ou 64 bits correspond à l'assistant de création de l'exécutable. Pour plus de détails, consultez [Création de l'exécutable](../Editeurs/2025002.md). 

- du service Linux 32 bits ou 64 bits correspond à l'assistant de création de l'exécutable Linux. Pour plus de détails, consultez [Création de l'exécutable Linux](../Editeurs/9000114.md). 




Remarque : Le téléchargement automatique du Framework WINDEV n'est pas disponible pour les services.

<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Création de l'installation d'un service Windows 32 ou 64 bits
<a name="creation_installation_service_windows_32_64_bits_ELTTEXTE000466"></a>


### Créer l'installation d'un service Windows 32 ou 64 bits
<a name="creer_installation_service_windows_32_64_bits_ELTPARAGRAPHE000234"></a>Pour créer l'installation d'un service Windows 32 ou 64 bits : 

1. Déroulez l'icône de génération parmi les boutons d'accès rapide et sélectionnez l'option "Créer la procédure d'installation du service".

2. La première partie de l'assistant vous guide dans la génération du service (voir paragraphe précédent). Si la configuration en cours est un service 32 bits, la génération est réalisée en 32 bits. Si la configuration en cours est un service 64 bits, la génération est réalisée en 64 bits.

3. Choisissez le mode d'installation :

	- Installation autonome : cette installation peut être exécutée directement sur le poste où le service doit être installé.

	- Installation en Push : cette installation permet de déployer le service à distance sur de nombreux postes connectés en réseau.




4. Indiquez le répertoire où sera installé par défaut le service. Passez à l'étape suivante. 

5. Choisissez les fichiers à installer ainsi que le mode d'installation du framework. 

6. Dans l'étape "Description du service", précisez :

	- Le nom du service (à utiliser en programmation dans les fonctions [ServiceDémarre](../WDLang1/1000017110.md) ou [ServiceInfo](../WDLang1/1000017103.md) par exemple).

	- Le nom complet du service (affiché dans la colonne "Nom" du gestionnaire de services).

	- La description du service (affiché dans la colonne "Description" du gestionnaire de services).


 Passez à l'étape suivante. 

7. Choisissez les paramètres de démarrage du service:

	- Automatique (par défaut)

	- Manuel

	- Désactivé.


 **Remarque** :  Il est possible de démarrer le service en mode différé. Cette fonctionnalité est disponible uniquement à partir de Windows Vista.

8. Sélectionnez le mode de gestion d'erreur en cas d'échec de démarrage du service :

	- Ignorer les erreurs.

	- Inscrire les erreurs dans le journal d'événements.

	- Inscrire les erreurs dans le journal d'événements et redémarrer la machine avec la dernière configuration valide.

	- Inscrire les erreurs dans le journal d'événements et redémarrer la machine.




9. Indiquez les paramètres de la ligne de commande à donner lors du démarrage du service. Passez à l'étape suivante. 

10. Indiquez les paramètres de gestion des erreurs du service. 
	Plusieurs défaillances successives peuvent être détectées. Pour chacune d'entre elles, sélectionnez le mode de gestion des erreurs parmi les possibilités suivantes :

	- Ne rien faire.

	- Redémarrer le service (par défaut).

	- Redémarrer la machine.

	- Exécuter un programme.




11. Passez à l'étape suivante. 

12. Indiquez le compte utilisateur sous lequel le service devra s'exécuter :

	- Compte système local (par défaut).

	- Compte service local.

	- Compte service réseau.

	- Compte utilisateur sélectionné parmi des comptes existants.


 **Remarque** :  Lorsque le service s'exécute avec le compte système local (par défaut), ce service n'a pas accès au réseau. Si les événements du service doivent accéder au réseau, il faut nécessairement indiquer pour son exécution le compte service réseau ou un utilisateur du domaine.

13. Passez à l'étape suivante. 

14. Choisissez les paramètres de gestion de l'accès aux bases de données.

15. Choisissez les modules complémentaires : licence, lisez-moi, outils optionnels, désinstallateur. 

16. Selon le mode d'installation choisi (autonome ou push), indiquez les options demandées. 




L'assistant va ensuite générer l'installation du service.

<a name="NOTE6"></a>
<a name="NOTE6_1"></a>


## Services créés avec les versions antérieures à WINDEV 15
<a name="services_crees_avec_les_versions_anterieures_windev_15_ELTTEXTE000490"></a>


### Services créés avec l'exemple "WD Service NT"
<a name="services_crees_avec_exemple_service_ELTPARAGRAPHE000299"></a>


|   |
| --- |
| Si vous aviez utilisé l'exemple "WDService NT" pour créer un service avec une version antérieure à WINDEV 15, vous pouvez le convertir en un service WINDEV de la façon suivante :<br><br>1. Ouvrez le projet dans WINDEV (version 15 ou supérieure).<br><br>2. Créez une nouvelle configuration de type "Service Windows".<br><br>3. Dans l'événement "Initialisation" du projet, appelez la procédure "InitService" de votre projet.<br><br>4. Dans l'événement "Exécution du service", appelez la procédure "Service" de votre projet.<br><br>5. Dans l'événement "Arrêt du service", appelez la procédure "FinService" de votre projet.<br><br><br> |




- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDService.gif) ***Exemples didactiques (WINDEV)*** : **WD Service** <br>Cet exemple illustre la création d'une application de type "service" avec WINDEV.<br><br>Résumé de l'exemple livré avec WINDEV :	<br>Un service est un programme résident qui peut fonctionner hors session Windows (démarrage de l'application avant le "Login" Windows).<br>Ce type d'application n'a généralement pas d'interface (pas de fenêtres)<br>Par exemple, un service peut être un automate de traitements (automatisation d'un traitement batch).<br>Cet exemple montre comment créer un programme de type 'Service' avec WINDEV.
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=LesfonctionsService.gif) ***Exemples unitaires (WINDEV)*** : **Les fonctions Service** <br>Utilisation des fonctions ServiceXXX pour : <br>- lister les services installés<br>- démarrer un service<br>- arrêter un service<br>- mettre en pause et relancer un service.<br><br>Les fonctions services sont disponibles pour le poste local et également sur un poste distant.<br>Note : Pour utiliser les services d'un poste distant, il est nécessaire de posséder les droits d'administrateur sur ce poste.





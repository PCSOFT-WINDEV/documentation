
## fMemOuvre (Fonction)

***En anglais : fMemOpen***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Ouvre une zone de mémoire partagée entre plusieurs applications.

Le contenu de la zone mémoire peut ensuite être manipulé par les fonctions [fPositionne](../WDLang1/3036039.md), [fLit](../WDLang1/3036048.md) et [fEcrit](../WDLang1/3036014.md).
<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
// Création/Ouverture d'une zone mémoire partagée entre applications (1ère application)
tabIDZone est un tableau associatif d'entiers
IDZone1 est un entier
IDZone1 = fMemOuvre("MaZonePartagée", 1024, partageGlobal, ...
		foLectureEcriture, ProcédureModification)
tabIDZone["MaZonePartagée"] = IDZone1
...
// Création/Ouverture d'une zone mémoire partagée 
// entre applications (2ème application) - 
// pas de callback
IDZone2 est un entier
IDZone2 = fMemOuvre("MaZonePartagée", 1024, partageGlobal)
// Ecriture dans la zone mémoire partagée
fEcrit(IDZone2, "Bonjour, je suis une application WINDEV !")
...
// L'écriture par la 2ème application déclenche 
// l'appel de la procédure dans la 1ère application
```

```wl
// -------------------------
// Procédure appelée à chaque modification de la zone mémoire partagée
PROCEDURE ProcédureModification(NomZoneNotif est une chaîne)
ChaîneModifiée est une chaîne
ChaîneModifiée = fLit(tabIDZone[NomZoneNotif], 1024)
Trace(ChaîneConstruit("La chaîne %1 a été écrite dans la zone %2", ChaîneModifiée, NomZoneNotif))
```


<a name="Exemple2"></a>


![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png) 
```wl
llMemHdl est un entier
sNomFic est une chaîne = fRépertoireTemp() + ["/"] + "ipc0"
fSauveTexte(sNomFic, "")
sNomZoneMem est une chaîne = Caract(3) + sNomFic
llMemHdl = fMemOuvre(sNomZoneMem, 1024, partageGlobal)

// Code C équivalent
// char * szNomZone = "/tmp/ipc0";
// int nTaille;
// int nMem;
// key_t nKey;
// int nAccess = 0666; 
// Ouverture en lecture/écriture

// nTaille = 1024;
// nKey = ftok(szNomZone, 3);
// nMem = shmget(nKey, nTaille, nAccess);
```

<a name="XSYNTAXE"></a>

## Syntaxe
<a name="SYNTAXE1"></a>

`<Résultat> = fMemOuvre(<Zone mémoire> , <Taille> [, <Partage> [, <Mode d'ouverture> [, <Procédure WLangage>]]])`
---

**`<Résultat> : (Entier)`**



- Identifiant de la zone mémoire.
	Cet identifiant peut être manipulé par les fonctions fxxx de la même façon qu'un identifiant de fichier externe renvoyé par [fOuvre](../WDLang1/3036036.md).

- -1 en cas d'erreur. 




**`<Zone mémoire> : (Chaîne de caractères)`**

Nom de la zone de mémoire partagée à créer ou à ouvrir. Ce nom doit être le même dans les différentes applications accédant à la zone.
Si la zone n'existe pas, elle est automatiquement créée.
![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png) Le nom de la zone mémoire doit être de la forme : 

```txt
Caract(<Val>) + <Nom fichier unix existant>
```

où &lt;Val&gt; est un entier de 1 à 127 qui correspond au second paramètre de l'API "C" ftok() (pour le cas où l'échange doit être réalisé avec un processus écrit en C). 

**`<Taille> : (Entier)`**

Taille minimale de la zone de mémoire partagée en octets.

- Si la zone existe déjà : 

	- si &lt;Taille&gt; vaut 0 : ce paramètre est ignoré et la taille de la zone peut être obtenue par la fonction [fTaille](../WDLang1/3036055.md).

	- si &lt;Taille&gt; est différent de 0 : 

		- si &lt;Taille&gt; est trop grand, la fonction fMemOuvre renvoie -1. 

		- la zone mémoire existante est ouverte avec une taille au moins égale au paramètre (la taille effective est déterminée par le système d'exploitation et peut être connue grâce à la fonction [fTaille](../WDLang1/3036055.md)).




- Si la zone n'existe pas, elle est créée avec une taille au moins égale au paramètre (la taille effective est déterminée par le système d'exploitation et peut être connue grâce à la fonction [fTaille](../WDLang1/3036055.md)).




**`<Partage> : (Constante optionnelle de type Entier)`**

Mode de partage de la zone entre les sessions utilisateurs :


|   |   |
| --- | --- |
| *partageGlobal* | La zone est partagée avec toutes les applications de toutes les sessions de la machine. |
| *partageUtilisateur*<br>(Valeur par défaut) | La zone est partagée avec toutes les applications de la session de l'utilisateur. |



**`<Mode d'ouverture> : (Constante optionnelle de type Entier)`**

Constantes permettant de définir le mode d'accès à la zone de mémoire partagée.


|   |   |
| --- | --- |
| *foEcriture* | Ouverture de la zone en "écriture seule". Il sera uniquement possible d'écrire dans cette zone. |
| *foLecture* | Ouverture de la zone en "lecture seule". Il sera uniquement possible de lire dans cette zone.<br><br>Si cette constante est utilisée, pour changer le mode d'ouverture de la zone mémoire, il est nécessaire de fermer la zone mémoire (fonction [fFerme](../WDLang1/3036027.md)) avant de la réouvrir avec un mode d'ouverture différent. |
| *foLectureEcriture*<br>(Valeur par défaut) | Ouverture de la zone en "lecture/écriture". Il sera possible de lire et de modifier cette zone. |
| *foUnicode* | Ouverture d'un fichier au format UNICODE. (Voir Notes pour plus de détails) |



**`<Procédure WLangage> : (Nom de procédure)`**

Nom de procédure WLangage ("callback") qui sera appelée automatiquement si la zone mémoire est modifiée par une autre application en WLangage.
Cette procédure est de la forme :

```txt
PROCEDURE <Nom de la procédure>(<Nom de la zone>)
```

Le paramètre de cette procédure est optionnel. Il doit être utilisé dans le cas où une unique callback est utilisée pour recevoir les notifications de plusieurs zones de mémoire partagées.
Le paramètre &lt;Nom de la zone&gt; sera préfixé par la chaîne "Global\\" si la zone a été créée avec la constante *partageGlobal* et par la chaîne "Local\\" si la zone a été créée avec la constante *partageUtilisateur*.



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques




### Gestion du mode de partage
<a name="gestion_mode_partage_ELTPARAGRAPHE000139"></a>Selon les versions des systèmes d'exploitation, le mode de partage diffère :

- Windows Vista et postérieur : le paramètre &lt;Partage&gt; de la fonction **fMemOuvre** est géré. Les services sont dans un espace différent des utilisateurs. Pour partager une zone mémoire entre un service et une application dans la session d'un utilisateur, il faut utiliser la constante *partageGlobal*.

- En Terminal Serveur : le paramètre &lt;Partage&gt; de la fonction **fMemOuvre** est géré. Chaque session ouverte sur le Terminal Serveur a un espace de mémoire différent. Des applications lancées dans la même session TSE peuvent partager une zone mémoire créée avec la constante *partageUtilisateur*. Des applications situées dans des sessions différentes peuvent partager une zone de mémoire partagée créée avec la constante *partageGlobal*.

- Windows : Pour accéder à une zone de mémoire *Globale* en écriture ou en lecture, il est nécessaire d'avoir les droits d'administrateur.



<a name="NOTE0_2"></a>
![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png) 

### Correspondance entre le nom fourni à fMemOuvre et l'ouverture en C
<a name="correspondance_entre_nom_fourni_fmemouvre_ouverture_ELTPARAGRAPHE000158"></a>Les deux exemples de code suivant montrent l'ouverture de la même zone mémoire (nommée "mazone" en WLangage et en C).


```wl
// Code en WLangage
IDZone est un entier
IDZone = fMemOuvre("mazone", 1024, partageGlobal)
```



```txt
// Code C équivalent
char * szNomZone = "mazone";
int nTaille;
int nMem;
key_t nKey;
int nAccess = 0666;	// Ouverture en lecture/écriture

nTaille = 1024;
nKey = ftok(szNomZone+sizeof(char),(int) szNomZone[0]);
nMem = shmget(nKey, nTaille , nAccess);
```





<a name="NOTE0_3"></a>


### Gestion des zones mémoires au format UNICODE
<a name="gestion_des_zones_memoires_format_unicode_ELTPARAGRAPHE000170"></a>La fonction **fMemOuvre** permet de lire et d'écrire des zones mémoires au format UNICODE "UTF-16" ou "little endian". En ouverture, la marque "Unicode courant" (FFFE) est automatiquement lue. En création, elle est automatiquement ajoutée.

**Remarque** : Le mécanisme de rappel automatique d'une procédure WLangage à chaque modification de la zone de mémoire par une autre application ne fonctionne que entre des applications en WLangage.
<a name="NOTE0_4"></a>


### Positionnement dans la zone de mémoire partagée
<a name="positionnement_dans_zone_memoire_partagee_ELTPARAGRAPHE000182"></a>A l'ouverture d'une zone de mémoire partagée, la position en cours correspond au premier octet de la zone. 

Cette position peut être modifiée par la fonction [fPositionne](../WDLang1/3036039.md).
<a name="NOTE0_5"></a>


### Fermeture de la zone de mémoire partagée
<a name="fermeture_zone_memoire_partagee_ELTPARAGRAPHE000194"></a>Lorsque l'application n'a plus besoin d'accéder à la zone de mémoire partagée, l'accès peut être fermé à l'aide de la fonction [fFerme](../WDLang1/3036027.md). La zone est effectivement détruite une fois que la dernière application y accédant a refermé la zone. Si aucun appel explicite à la fonction [fFerme](../WDLang1/3036027.md) n'est présent dans le code de l'application, la fermeture sera faite automatiquement à la terminaison de l'application.



<a name="XComposante"></a>

## Composante :
wd280std.dll


## AppelInterface (Fonction)

***En anglais : CallInterface***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Exécute une méthode d'une interface d'un objet implémenté dans une DLL externe au framework WINDEV. Cet objet peut être un objet C++ ou un objet COM. 


<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
nAllocateur est un entier système 
API("ole32", "CoGetMalloc", 1, &nAllocateur)
nMémoire est un entier système = AppelInterface(nAllocateur, 3, 1024)
```

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

### Utilisation du numéro de la méthode

`<Résultat> = AppelInterface(<Adresse de l'objet> , <Numéro de la méthode> [, <Paramètre 1> [... [, <Paramètre N>]]])`
---

**`<Résultat> : (Entier sur 4 en 32 bits, entier sur 8 en 64 bits)`**

Résultat de l'exécution de la méthode. Ce résultat peut être un code d'erreur. Le type de ce résultat dépend de la méthode exécutée. Consultez la documentation de la méthode pour obtenir plus de détails. 
Si le résultat de la méthode est d'une taille supérieure à la taille de l'entier de la plateforme, il ne pourra pas être récupéré.

**`<Adresse de l'objet> : (Entier système)`**

Adresse de l'objet sur lequel une méthode doit être appelée. Cette adresse est en général le résultat de l'appel précédent d'une API.

**`<Numéro de la méthode> : (Entier)`**

Numéro d'ordre de la méthode dans la table des méthodes virtuelles. 
ATTENTION : 


- le numéro d'ordre tient compte des classes de base

- le numéro d'ordre commence à 0.




**`<Paramètre 1> : (Type correspondant au paramètre)`**

Premier paramètre à passer à la méthode. Ces paramètres doivent être du même type que les paramètres attendus par la méthode. Sont utilisables : 

- les types "simples" (voir Notes),

- les structures (voir Notes),

- un nom de procédure WLangage. Cette procédure sera rappelée par la méthode (voir Notes).






**`<Paramètre N> : (Type correspondant au paramètre)`**

Nième paramètre à passer à la méthode. Ces paramètres doivent être du même type que les paramètres attendus par la méthode. Sont utilisables : 

- les types "simples" (voir Notes),

- les structures (voir Notes),

- un nom de procédure WLangage. Cette procédure sera rappelée par méthode (voir Notes).





<a name="SYNTAXE2"></a>

### Utilisation d'une variable de type Description d'API

`<Résultat> = AppelInterface(<Adresse de l'objet> , <API à exécuter> [, <Paramètre 1> [... [, <Paramètre N>]]])`
---

**`<Résultat> : (Entier sur 4 en 32 bits, entier sur 8 en 64 bits)`**

Résultat de l'exécution de la méthode. Ce résultat peut être un code d'erreur. Le type de ce résultat dépend de la méthode exécutée. Consultez la documentation de la méthode pour obtenir plus de détails. 
Si le résultat de la méthode est d'une taille supérieure à la taille de l'entier de la plateforme, il ne pourra pas être récupéré.

**`<Adresse de l'objet> : (Entier système)`**

Adresse de l'objet sur lequel une méthode doit être appelée. Cette adresse est en général le résultat de l'appel précédent d'une API.

**`<API à exécuter> : (Variable de type Description d'API)`**

Variable de type [Description d'API](../WDLang1/1000019149.md) contenant les caractéristiques de la méthode à exécuter. 

**`<Paramètre 1> : (Type correspondant au paramètre)`**

Premier paramètre à passer à la méthode. Ces paramètres doivent être du même type que les paramètres attendus par la méthode. Sont utilisables : 

- les types "simples" (voir Notes),

- les structures (voir Notes),

- un nom de procédure WLangage. Cette procédure sera rappelée par la méthode (voir Notes).






**`<Paramètre N> : (Type correspondant au paramètre)`**

Nième paramètre à passer à la méthode. Ces paramètres doivent être du même type que les paramètres attendus par la méthode. Sont utilisables : 

- les types "simples" (voir Notes),

- les structures (voir Notes),

- un nom de procédure WLangage. Cette procédure sera rappelée par méthode (voir Notes).






<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques




### Contrôles effectués
<a name="controles_effectues_ELTPARAGRAPHE000095"></a>La fonction **AppelInterface** est protégée contre les "Erreurs de protection générale" dans la méthode appelée. Néanmoins, si une erreur de ce type se produit, une erreur WLangage est déclenchée.


<a name="NOTE0_2"></a>




### Gestion des erreurs
<a name="gestion_des_erreurs_ELTPARAGRAPHE000107"></a>Lors de l'exécution de méthodes, si le résultat renvoyé correspond à une erreur, utilisez la fonction [ErreurInfo](../WDLang1/3013008.md) pour obtenir plus d'informations sur l'erreur (avec la constante *errCodeSystème* ou *errMessageSystème*).


<a name="NOTE0_3"></a>




### Paramètres à passer à la méthode de la DLL
<a name="parametres_passer_methode_dll_ELTPARAGRAPHE000119"></a>Ces paramètres doivent être du même type que les paramètres attendus par la méthode.

Les types utilisables sont les suivants :

- **Les types "simples"** (entier, réel, et booléen). L'utilisation d'un autre type WLangage provoque une erreur du WLangage. 
	Si la méthode à exécuter attend un pointeur ou un handle Windows, utilisez un [entier système](../Motscles/1514049.md). 
	Si la méthode à exécuter attend une adresse, utilisez [l'opérateur &](../Motscles/1512002.md).

- Les types "chaîne". 

- Les types structure.

- **Un nom de procédure WLangage**. Cette procédure sera rappelée par la méthode de la DLL (voir paragraphe ci-dessous). 
	Les paramètres dépendent de la méthode exécutée. Consultez la documentation de cette méthode pour obtenir plus de détails.





<a name="NOTE0_4"></a>




### Passer une chaîne à une DLL ou récupérer une chaîne en retour d'une DLL
<a name="passer_une_chaine_une_dll_recuperer_une_chaine_retour_une_dll_ELTPARAGRAPHE000147"></a>

1. En paramètre d'entrée, utilisez le type chaîne. Par exemple : 
	
	```txt
	sChaine est une chaîne 
	AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>, sChaîne)
	```


2. En paramètre de sortie, le C n'est pas capable de gérer des chaînes dynamiques de manière simple. Il est donc nécessaire :

	- soit de fixer une taille maximale, avec le type "Chaîne sur". Par exemple : 
			
		```txt
		sChaine est une chaîne sur 100
		AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>, sChaîne) 
		// dans Methode en C : 
		// STRNCPY(PointeurEnC, "Test", 100)
		```


	- soit de récupérer les adresses des chaînes en C (mais dans ce cas, la partie de code en C doit assurer la "survie" des chaînes renvoyées), puis de transférer la chaîne dans une variable de type chaîne grâce à la fonction [ChaîneRécupère](../WDLang1/3024005.md).  Par exemple :
			
		```txt
		nAdresseChaîne est un entier système
		API(<Adresse de l'objet>, <Numéro de la méthode>, &nAdresseChaîne)
		sChaine est une chaîne
		sChaine = ChaîneRécupère(nAdresseChaîne, crAdresseASCIIZ)
		// dans Méthode en C : *PointeurEnC = "Test"
		```





3. En valeur de retour, récupérer les adresses des chaînes en C (mais dans ce cas, la partie de code en C doit assurer la "survie" des chaînes renvoyées), puis transférer la chaîne dans une variable de type chaîne grâce à la fonction [ChaîneRécupère](../WDLang1/3024005.md).  Par exemple :
	
	```txt
	nAdresseChaîne est un entier système
	nAdresseChaîne = AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>)
	sChaine est une chaîne
	sChaine = ChaîneRécupère(nAdresseChaîne, crAdresseASCIIZ)
	// dans Méthode en C : Return PointeurEnC
	```




<a name="NOTE0_5"></a>


### Passer une structure contenant une chaîne à une DLL
<a name="passer_une_structure_contenant_une_chaine_une_dll_ELTPARAGRAPHE000173"></a>

1. En entrée, le code à utiliser est le suivant :
	
	```txt
	Struct est une structure
		sChaine est une chaîne
	FIN
	UneStruct est une Struct
	AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>, &UneStruct)
	```


2. En sortie, le C n'est pas capable de gérer des chaînes dynamiques de manière simple. Il est donc nécessaire de :

	- soit fixer une taille maximale et faire une copie dans la mémoire du WLangage. Par exemple :
			
		```txt
		sChaine est une chaîne sur 100
		Struct est une structure
			aChaine est un entier
		FIN
		UneStruct est une Struct
		UneStruct:aChaine = &sChaine
		AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>, &UneStruct) 
		// dans Methode en C : 
		// STRNCPY(StructEnC->PointeurEnC, "Test", 100)
		```


	- soit récupérer les adresses des chaînes en C (mais dans ce cas, la partie de code en C doit assurer la "survie" des chaînes renvoyées). Par exemple :
			
		```txt
		sChaine est une chaîne
		Struct est une structure
			aChaine est un entier
		FIN
		UneStruct est une Struct
		AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>, &UneStruct)
		sChaine = ChaîneRécupère(UneStruct:aChaine, crAdresseASCIIZ )
		// dans Methode en C : StructEnC->PointeurEnC = "Test"
		```







<a name="NOTE0_6"></a>




### Procédure appelée en CallBack 
<a name="procedure_appelee_callback_ELTPARAGRAPHE000191"></a>Certaines méthodes attendent en paramètre l'adresse d'une procédure "CallBack" : cette procédure sera rappelée par la méthode de la DLL.  

Pour utiliser une procédure callback en WLangage :

**1.** Créez la procédure callback dans votre projet
Pour récupérer les paramètres, il faut décrire exactement les paramètres attendus par la fonction "CallBack". Dans le cas contraire, des "erreurs de protection générale" peuvent survenir.

```txt
PROCEDURE <Nom de la procédure> (<Param1> est [un] <Type1>, ...
		<Param2> est [un] <Type2>)
```


**Remarques** :

- Les types doivent correspondre à ceux décrits dans la documentation de la DLL.

- Les paramètres sont obligatoirement passés par valeur. Pour récupérer un paramètre par référence :

	1. Utilisez un entier.

	2. Avec la fonction [Transfert](../WDLang1/3014015.md), récupérez ou affectez la véritable valeur.







**2.** Modifiez l'appel de la méthode en conséquence. Utilisez la syntaxe suivante :

```txt
AppelInterface(<Adresse de l'objet>, <Numéro de la méthode>, ...
			&<Nom de la procédure CallBack>)
```



<a name="NOTE0_7"></a>
![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) 

### Divers
<a name="divers_ELTPARAGRAPHE000224"></a>

- La fonction **AppelInterface** ne bloque pas les autres threads.

- Si la méthode de la DLL appelée modifie les paramètres systèmes régionaux, les paramètres régionaux précédents sont restaurés.


La fonction [APIParamètre](../WDLang1/3014026.md) permet de configurer le comportement par défaut de cette fonction.

<a name="XComposante"></a>

## Composante :
wd280vm.dll


## Gérer les sémaphores dans les threads : limiter l'exécution simultanée d'un code
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000212"></a>
Les sémaphores permettent de limiter l'exécution simultanée d'un code (procédure, ligne de code, ...) à un ou plusieurs threads à un instant donné. Un sémaphore peut être partagé par plusieurs applications.

Par exemple : Deux threads spécifiques sont utilisés dans une application bancaire :

- un thread pour créditer les comptes

- un thread pour débiter les comptes.


A un instant donné, il ne peut y avoir qu'un crédit de compte ou un débit de compte.



**Remarque** : D'autres systèmes permettent également de protéger une partie de code : 

- Les mutex permettent de limiter l'exécution simultanée d'un code (procédure, ligne de code, ...) **à un thread** à un instant donné. Un mutex peut être partagé par plusieurs applications. Pour plus de détails, consultez [Gérer les mutex dans les threads](../WDLang1/1000019475.md).

- Les sections critiques permettent de limiter l'exécution simultanée d'un code (procédure, ligne de code, ...) **à un thread** à un instant donné dans une seule application. Pour plus de détails, consultez [Gérer les sections critiques](../WDLang1/1000021292.md). 








<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principe
<a name="principe_ELTTEXTE000236"></a>
Le sémaphore a été créé avec la fonction [SémaphoreCrée](../WDLang1/3077012.md).

1. Le thread n°1 exécute la fonction [SémaphoreDébut](../WDLang1/3077008.md) : aucun thread n'est actuellement présent dans le sémaphore.

2. Le thread n°1 exécute la partie de code protégée par le sémaphore.

3. Pendant que le thread n°1 exécute le code protégé par le sémaphore, un thread n°2 exécute la fonction [SémaphoreDébut](../WDLang1/3077008.md) : le code protégé par le sémaphore étant déjà en cours d'exécution par le thread n°1, le thread n°2 attend le déblocage du sémaphore.

4. Le thread n°1 exécute la fonction [SémaphoreFin](../WDLang1/3077010.md) : plus aucun thread n'exécute le code du sémaphore.

5. Le thread n°2 peut exécuter le code protégé par le sémaphore.

6. Le thread n°2 exécute la fonction [SémaphoreFin](../WDLang1/3077010.md) : plus aucun thread n'exécute le code du sémaphore.




![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=semaphore.gif)




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Comment mettre en place un sémaphore ?
<a name="comment_mettre_place_semaphore_ELTTEXTE000260"></a>


### Les étapes :
<a name="les_etapes_ELTPARAGRAPHE000096"></a>Les différentes étapes de la mise en place d'un sémaphore sont les suivantes :

1. Création d'un sémaphore avec la fonction [SémaphoreCrée](../WDLang1/3077012.md). Le sémaphore est associé à un nom.

2. Appel de la fonction [SémaphoreDébut](../WDLang1/3077008.md) avant la portion de code à protéger.

3. Appel de la fonction [SémaphoreFin](../WDLang1/3077010.md) pour délimiter la portion de code à protéger. Les lignes de code situées après la fonction [SémaphoreFin](../WDLang1/3077010.md) ne seront plus protégées.

4. Destruction du sémaphore avec la fonction [SémaphoreDétruit](../WDLang1/3077011.md).





<a name="NOTE3_2"></a>


### Remarques
<a name="remarques_ELTPARAGRAPHE000124"></a>

- Les parties de code protégées par un sémaphore doivent être les plus courtes possibles, et concerner uniquement des traitements "critiques".

- Un sémaphore de même nom peut être utilisé pour protéger plusieurs zones de code différentes. Un seul thread pourra être à un instant donné dans une des zones protégées par le sémaphore.

- Lorsqu'un thread est en attente, les ressources du processeur ne sont pas utilisées.

- Les sémaphores s'appliquent aussi bien au thread principal qu'aux threads secondaires (créés avec la fonction [ThreadExécute](../WDLang1/3077024.md)). Il est nécessaire d'éviter le blocage du thread principal. En effet, si le thread principal est bloqué (en attente), l'application ne peut plus s'exécuter.

- Les fonctions [SémaphoreDébut](../WDLang1/3077008.md) et [SémaphoreFin](../WDLang1/3077010.md) doivent être utilisées dans le même traitement (par exemple dans une procédure).

- Les sémaphores peuvent être partagés ou non entre les différentes applications exécutées sur le poste. Il suffit d'indiquer le mode de partage des sémaphores lors de leur création (fonction [SémaphoreCrée](../WDLang1/3077012.md)).




![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) En Java, les sémaphores sont uniques pour l'application qui les a créés. Ils ne peuvent pas être partagés entre plusieurs applications.


<a name="NOTE3_3"></a>


### Les fonctions de gestion des sémaphores
<a name="les_fonctions_gestion_des_semaphores_ELTPARAGRAPHE000153"></a>Les fonctions du WLangage spécifiques à la gestion des sémaphores sont les suivantes :



|   |   |
| --- | --- |
| [SémaphoreCrée](../WDLang1/3077012.md) | Crée un sémaphore. |
| [SémaphoreDébut](../WDLang1/3077008.md) | Bloque le thread en cours en attendant que le sémaphore soit ouvert (c'est-à-dire qu'une place "libre" soit disponible dans la zone protégée). |
| [SémaphoreDétruit](../WDLang1/3077011.md) | Détruit explicitement un sémaphore. |
| [SémaphoreFin](../WDLang1/3077010.md) | Autorise un ou plusieurs threads de sortir de la zone protégée par le sémaphore. |






<a name="NOTE3_4"></a>


### Exemple
<a name="exemple_ELTPARAGRAPHE000162"></a>Pour réaliser une affectation partagée par plusieurs threads, il est nécessaire d'encapsuler dans un sémaphore aussi bien l'affectation des variables que la lecture de ces variables.





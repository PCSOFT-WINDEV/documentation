


## ThreadExécute (Fonction)

***En anglais : ThreadExecute***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Lance l'exécution d'un thread secondaire. L'instruction est non bloquante : les deux traitements s'exécutent en parallèle.

**Rappel** : Un thread est un processus lancé en parallèle de l'application en cours ("thread" principal). Il est par exemple possible de lancer l'exécution d'une tâche en traitement de fond (sauvegarde, ...).


<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
ThreadExécute("Thread1", threadNormal, ProcédureThread) 
...
// Appel d'une méthode globale d'une classe
ThreadExécute("Thread2", threadNormal, CClasse::MéthodeGlobale)
```
<a name="Exemple2"></a>

```wl
// Exécution d'un thread avec passage de paramètres 
sDate est une chaîne 
sDate = DateSys()
// Exécution du thread
ThreadExécute("THREADNAME", threadNormal, "pExecReq", sDate)
```

```wl
// Détail de la procédure "pExecReq" 
// Cette procédure attend une date en paramètre d'une requête 
PROCEDURE pExecReq(sDate)
SI HExécuteRequête(Sup_Date, hRequêteDéfaut, sDate) = Faux ALORS
	Erreur(HErreurInfo())
SINON
	HLitPremier(Sup_Date)
FIN
```

<a name="XSYNTAXE"></a>
<a name="SYNTAXE1"></a>

## Syntaxe

### Exécuter un thread en le nommant (Syntaxe compatible)

`ThreadExécute(<Nom du thread> , <Options> , <Procédure WLangage> [, <Paramètre 1> [... [, <Paramètre N>]]])`
---

**`<Nom du thread> : (Chaîne de caractères)`**

Nom qui sera attribué au thread. Ce nom sera utilisé dans toutes les fonctions de gestion des threads. Ce nom ne peut pas correspondre à une chaîne vide ("")

**`<Options> : (Constante)`**

Mode de lancement du thread.


|   |   |
| --- | --- |
| *threadAttendDémarrage* | Attend le démarrage effectif du thread avant de continuer l'exécution.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png)![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Cette constante n'est pas disponible. |
| *threadContexteGlobal* | Force l'utilisation du contexte global du projet si le thread est exécuté depuis une fenêtre. Le thread continuera donc de s'exécuter jusqu'à la fermeture de l'application.<br>Par défaut, le contexte de la fenêtre est utilisé, le thread est donc arrêté lors de la fermeture de la fenêtre.<br>**Remarque** : Si la fonction **ThreadExécute** est utilisée dans un code d'initialisation global (projet, classe ou collection)  ou depuis toute procédure ou méthode appelée depuis un code d'initialisation global, cette constante n'a aucun effet.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadCopieComplèteContexteHFSQL*<br>(Valeur par défaut) | Provoque la copie immédiate du contexte HFSQL courant.<br>Conseillé par exemple si le thread doit tenir compte des positions en cours dans les fichiers et requêtes du contexte de l'appelant.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadCopieLégèreContexteHFSQL* | Provoque la copie immédiate d'une partie du contexte HFSQL courant. <br>Seuls les répertoires où se trouvent les fichiers de données en HFSQL Classic et/ou les connexions en HFSQL Client/Serveur sont mémorisés.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadNormal* | Lance le thread en mode normal. Le contexte HFSQL est copié lors de la première utilisation d'une fonctionnalité HFSQL. |
| *threadSécurisé* | Lance un thread en mode sécurisé. Dans ce mode, une exception sera générée : <br><br>- si le thread accède aux champs en exécution, <br><br>- si la fonction [ThreadArrête](../WDLang1/3077019.md) est utilisée. <br><br><br>La fermeture de la fenêtre qui a lancé le thread provoque une demande d'arrêt (mais le thread peut continuer à s'exécuter après la fermeture de la fenêtre). |



**`<Procédure WLangage> : (Nom de procédure)`**

Nom de la procédure WLangage exécutée. Cette procédure est exécutée en parallèle de l'exécution de l'application.

**`<Paramètre 1> : (Optionnel)`**

Paramètres à passer à la procédure. Attention : ces paramètres sont passés par valeur (et non par référence).



**`<Paramètre N> : (Optionnel)`**

Paramètres à passer à la procédure. Attention : ces paramètres sont passés par valeur (et non par référence).


<a name="SYNTAXE2"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) 
### Déclarer et exécuter une variable de type Thread

`<Résultat> = ThreadExécute(<Procédure WLangage> [, <Paramètre 1> [... [, <Paramètre N>]]] [, <Options>])`
---

**`<Résultat> : (Variable de type Thread)`**

Variable de type [Thread](../WDLang1/1000024879.md) correspondant au thread exécuté.

**`<Procédure WLangage> : (Nom de procédure)`**

Nom de la procédure WLangage exécutée. Cette procédure est exécutée en parallèle de l'exécution de l'application.

**`<Paramètre 1> : (Optionnel)`**

Paramètres à passer à la procédure. Attention : ces paramètres sont passés par valeur (et non par référence).



**`<Paramètre N> : (Optionnel)`**

Paramètres à passer à la procédure. Attention : ces paramètres sont passés par valeur (et non par référence).

**`<Options> : (Constante optionnelle)`**

Mode de lancement du thread.


|   |   |
| --- | --- |
| *threadAttendDémarrage* | Attend le démarrage effectif du thread avant de continuer l'exécution.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadContexteGlobal* | Force l'utilisation du contexte global du projet si le thread est exécuté depuis une fenêtre. Le thread continuera donc de s'exécuter jusqu'à la fermeture de l'application.<br>Par défaut, le contexte de la fenêtre est utilisé, le thread est donc arrêté lors de la fermeture de la fenêtre.<br>**Remarque** : Si la fonction **ThreadExécute** est utilisée dans un code d'initialisation global (projet, classe ou collection)  ou depuis toute procédure ou méthode appelée depuis un code d'initialisation global, cette constante n'a aucun effet.<br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadCopieComplèteContexteHFSQL*<br>(Valeur par défaut) | Provoque la copie immédiate du contexte HFSQL courant.<br>Conseillé par exemple si le thread doit tenir compte des positions en cours dans les fichiers et requêtes du contexte de l'appelant.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadCopieLégèreContexteHFSQL* | Provoque la copie immédiate d'une partie du contexte HFSQL courant. <br>Seuls les répertoires où se trouvent les fichiers de données en HFSQL Classic et/ou les connexions en HFSQL Client/Serveur sont mémorisés.<br><br>![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Cette constante n'est pas disponible. |
| *threadNormal* | Lance le thread en mode normal. Le contexte HFSQL est copié lors de la première utilisation d'une fonctionnalité HFSQL. |
| *threadSécurisé* | Lance un thread en mode sécurisé. Dans ce mode, une exception sera générée : <br><br>- si le thread accède aux champs en exécution, <br><br>- si la fonction [ThreadArrête](../WDLang1/3077019.md) est utilisée. <br><br><br>La fermeture de la fenêtre qui a lancé le thread provoque une demande d'arrêt (mais le thread peut continuer à s'exécuter après la fermeture de la fenêtre). |




<a name="SYNTAXE3"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) 
### Exécuter un thread déjà décrit (variable de type Thread)

`<Résultat> = ThreadExécute(<Thread>)`
---

**`<Résultat> : (Variable de type Thread)`**

Variable de type [Thread](../WDLang1/1000024879.md) correspondant au thread exécuté.

**`<Thread> : (Variable de type Thread)`**

Nom de la variable de type [Thread](../WDLang1/1000024879.md) correspondant au thread à exécuter. 

Attention : Si le thread est déjà en cours d'exécution ou a déjà été exécuté, une erreur WLangage sera provoquée.



<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Caractéristique d'un thread créé en WLangage
<a name="caracteristique_thread_cree_wlangage_ELTPARAGRAPHE000257"></a>Un thread créé en WLangage ne peut être qu'une procédure ou une méthode de classe. Le thread ne peut pas correspondre à un traitement du WLangage (code d'un champ par exemple).

Si le thread est une méthode de classe, la fonction **ThreadExécute** doit être exécutée depuis un des traitements de la classe (constructeur ou méthode).
<a name="NOTE0_2"></a>


### Thread et HFSQL
<a name="thread_hfsql_ELTPARAGRAPHE000269"></a>Lors de l'exécution de la fonction **ThreadExécute**, les contextes HFSQL sont automatiquement dupliqués : il y a autant de contextes HFSQL que de threads en cours d'exécution. La totalité du contexte HFSQL est recopiée (filtre, condition de recherche, ...). Dans chaque thread, le contexte HFSQL évolue indépendamment.

Il est ainsi possible par exemple de réaliser deux parcours différents sur le même fichier de données dans deux threads différents. 

Il existe 2 méthodes pour copier les contextes HFSQL : 

- Copie de contexte complet (par défaut)

- Copie de contexte légère. 




Pour plus de détails sur la copie de contextes HFSQL et leurs limites (selon la base de données utilisée), consultez [Gestion des contextes HFSQL](../WDChamp/1010029.md).

**Exemple** : 

- Un filtre est créé sur le fichier de données Client. 

- La fonction [ThreadExécute](../WDLang1/3077024.md) est appelée pour créer le thread CTX2. 

- Dans chaque thread (thread principal et thread CTX2), le fichier de données client est filtré. Si dans le thread principal, le filtre est désactivé, le filtre sera toujours actif dans le thread CTX2.




**Cas particuliers** :

- **Gestion assistée des erreurs HFSQL** : Si plusieurs threads sont utilisés sur des fichiers de données, il est conseillé de personnaliser la gestion des erreurs HFSQL pour ne pas afficher les fenêtres par défaut. Pour cela, utilisez la fonction [HSurErreur](../WDLang4/3044017.md) pour désactiver la gestion automatique des erreurs ou pour rediriger la gestion des erreurs vers une procédure personnalisée (sans affichage de fenêtres). Pour plus de détails, consultez [Gestion assistée des erreurs HFSQL](../WDLang4/3044188.md).

- **Ecritures et affectations dans un thread** : Si des écritures ou des affectations sont effectuées dans un thread, les autres threads en cours d'exécution ne partagent pas ces informations. Certaines incohérences peuvent apparaître.





<a name="NOTE0_3"></a>




### Caractéristiques de la procédure WLangage
<a name="caracteristiques_procedure_wlangage_ELTPARAGRAPHE000298"></a>**Attention** : Les appels aux fonctions [Info](../WDLang1/3021011.md), [Erreur](../WDLang1/3021013.md), ... bloquent tous les threads en cours d'exécution.

![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png)![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Les appels aux fonctions [Info](../WDLang1/3021011.md), [Erreur](../WDLang1/3021013.md), ... ne bloquent pas les threads en cours d'exécution.

**Remarque** : Les paramètres passés à la procédure sont passés par valeur et non par référence.

![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Pour plus de détails sur les possibilités d'ouverture de fenêtres depuis un thread secondaire, consultez [Gérer l'ouverture d'une fenêtre dans un thread secondaire](../WDLang1/3077015.md).


<a name="NOTE0_4"></a>




### Durée de vie du thread
<a name="duree_vie_thread_ELTPARAGRAPHE000332"></a>Le thread est automatiquement arrêté à la fin de l'exécution de la procédure WLangage lancée par la fonction **ThreadExécute**. 

Le thread est également arrêté dans les cas suivants : 

- si la fonction **ThreadExécute** est appelée depuis le code d'une fenêtre, le thread sera arrêté à la fermeture de la fenêtre. 

- si la fonction **ThreadExécute** est appelée depuis un traitement global (initialisation, appel explicite dans le contexte principal), le thread sera arrêté à la fin de l'application. 

- si la fonction **ThreadExécute** est appelée dans une méthode de classe, le thread est arrêté à la destruction de l'objet. 




Il est possible de forcer l'exécution du thread dans le contexte principal en utilisant la constante *threadContexteGlobal*. 

Pour forcer l'arrêt du thread, utilisez la fonction [ThreadArrête](../WDLang1/3077019.md). Cette fonction peut être utilisée par exemple pour arrêter un thread depuis le thread principal.

**Remarque** : Il est conseillé de vérifier que les threads sont bien arrêtés (avec les fonctions [ThreadEtat](../WDLang1/3077016.md) ou [ThreadAttend](../WDLang1/3077020.md)) avant de fermer les fenêtres ou de détruire les objets.  


<a name="NOTE0_5"></a>




### Gestion des erreurs
<a name="gestion_des_erreurs_ELTPARAGRAPHE000374"></a>Une erreur fatale est générée dans les cas suivants :

- si la procédure n'existe pas.

- si un thread de même nom est déjà en cours d'exécution.



<a name="NOTE0_6"></a>


### Traitements interdits
<a name="traitements_interdits_ELTPARAGRAPHE000588"></a>Attention : Il n'est pas possible d'exécuter dans les threads les traitements suivants :

- ouverture de fenêtres avec les fonctions WLangage telles que [Ouvre](../WDLang1/3038035.md), [Utilise](../WDLang1/3038044.md), [Ferme](../WDLang1/3038018.md), ... Si des fenêtres doivent être manipulées dans des threads (cas rare), une gestion spécifique doit être mise en place. Pour plus de détails, consultez [Gérer l'ouverture d'une fenêtre dans un thread secondaire](../WDLang1/3077015.md).

- gestion d'événement.

- multitâche.

- gestion de timer.





|   |
| --- |
| **Attention : il est interdit de manipuler l'UI (fenêtres, champs, ...) dans un thread secondaire.**<br> Lorsqu'un thread secondaire doit interagir avec l'utilisateur ou mettre à jour l'UI, il doit utiliser un traitement lancé depuis le thread principal. Ce traitement peut correspondre à :<br><br>- une procédure globale du projet ou une procédure locale (d'une fenêtre, ...) appelée par la fonction [ExécuteThreadPrincipal](../WDLang1/1000019862.md),<br><br>- l'événement "Demande de mise à jour de l'affichage" d'une fenêtre exécuté grâce à la fonction [DemandeMiseAJourUI](../WDLang1/1000023899.md).<br><br><br> |






<a name="NOTE0_7"></a>

<a name="XComposante"></a>

## Classification Métier / UI :
Code neutre
## Composante :
wd280vm.dll

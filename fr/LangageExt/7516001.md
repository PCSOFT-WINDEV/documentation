
## Langage externe : Programmation en Pascal
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000190"></a>
Il s'agit ici d'appeler les éléments développés en WINDEV (projet, fenêtres, ... analyse) depuis le langage Pascal. Le code WLangage utilisé depuis le langage externe sera compilé dynamiquement et exécuté lors de son appel.

**Ce mode est illustré dans Ville.PAS**(au format Pascal) fourni dans le sous-répertoire "LangagesExternes\\Pascal" du répertoire d'installation de WINDEV.



<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Mise en place
<a name="mise_place_ELTTEXTE000214"></a>




### 1. Inclusion des fichiers de l'interface Pascal de WINDEV
<a name="1_inclusion_des_fichiers_interface_pascal_windev_ELTPARAGRAPHE000023"></a>Si vous utilisez une base de données dans votre application, la première étape consiste à générer votre analyse. Dans la description de cette analyse, précisez le langage de programmation utilisé ainsi que le répertoire qui contiendra les fichiers source.

Grâce à la génération, un squelette de programme (\*.pas) est généré. Cette opération créera de plus le fichier .h (voir plus bas) nécessaire à l'utilisation de vos fichiers de données.

Voici une liste des fichiers à inclure dans un projet Pascal pour faire appel à l'interface Pascal de WINDEV :

- Squelet.PAS (contient la description de l'analyse)

- &lt;NomAnalyse&gt;.H

- WDHF.PAS

- WinDev.PAS




Les fichiers .h et .pas décrivant la structure des fichiers de données seront générés automatiquement par WINDEV lors de la génération de l'analyse.


<a name="NOTE2_2"></a>


### 2. Inclusion des déclarations HFSQL
<a name="2_inclusion_des_declarations_hfsql_ELTPARAGRAPHE000042"></a>Les fichiers .h et .pas correspondant à la description des fichiers de l'analyse doivent être ajoutés au projet Pascal. Les déclarations des fichiers de données sont incluses dans le fichier d'extension .h.

Par exemple, dans le code Ville.pas (fourni avec WINDEV dans le répertoire "LangagesExternes\\Pascal"), il sagit des fichiers "VillePas.H" et "Squelet.PAS".



<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Déclaration et initialisation
<a name="declaration_initialisation_ELTTEXTE000244"></a>




### 1. Déclaration du contexte HFSQL et des contextes de travail de chaque fichier
<a name="1_declaration_contexte_hfsql_des_contextes_travail_chaque_fichier_ELTPARAGRAPHE000055"></a>Si l'application doit gérer des fichiers de données, il est nécessaire de déclarer un contexte de travail HFSQL, ainsi qu'un contexte de travail par fichier de données.

Ces déclarations sont effectuées par les lignes suivantes dans le projet Ville.pas :


```txt
{------------- include des descriptions des fichiers utilisés --------------}
{ pour chaque fichier mettre une ligne $I .WDR }
{$I VillePas.h}	(* record    *)
var DP:typeDP;
var VI:typeVI;
{$F+}			{ directive de compilation  $F+ obligatoire en debut }
procedure HDecritEnregistrement;
{Décrit chaque fichier de l'analyse}
VAR
lTabRubDP:array[0..1] of longint;
sTypeDP : String;
lTabRubVI:array[0..1] of longint;
sTypeVI : String;
begin
lTabRubDP[0] := 31; lTabRubDP[1] := 3;
sTypeDP := '11';
LE_HDecritEnregistrement(gCtx, stringtoptr('DEPART'), 34, 
longint(@lTabRubDP[0]), 2, stringtoptr(sTypeDP), @DP);
lTabRubVI[0] := 41; lTabRubVI[1] := 6;
sTypeVI := '11';
LE_HDecritEnregistrement(gCtx, stringtoptr('VILLE'), 47, 
longint(@lTabRubVI[0]), 2, stringtoptr(sTypeVI), @VI);
End;
procedure HInit;
VAR
{Creation du contexte}
sNomAnalyse :String;
sMotDePasse :String;
begin
gCtx := LE_CreateContexteHF(2);
sNomAnalyse := 'VILLEPAS.WDD';
sMotDePasse := ' ';
{Description de chaque enregistrement}
HDecritEnregistrement;
{Initialisation de HF}
	APPELWD('HFCTX');
If LE_Hinitpartage(gCtx,WDLong) = 0 Then
begin
APPELWD('Erreur,Erreur initialisation du contexte HF');
End
{ouverture de l'analyse}
else
begin
If HOuvreAnalyse(gCtx, sNomAnalyse, sMotDePasse, ' ', ' ', ' ') = 0 Then
begin
APPELWD('Erreur,Erreur ouverture de l' 'analyse');
End;
End;
End;
```



<a name="NOTE3_2"></a>




### 2. Initialisation des contextes HFSQL
<a name="2_initialisation_des_contextes_hfsql_ELTPARAGRAPHE000068"></a>Dans le cas où votre application fait appel à une base de données, l'accès à HFSQL doit ensuite être préparé. Le test ci-dessous permet de vérifier si cette initialisation se déroule normalement :


```txt
{Creation du contexte}
begin
HInit;
End;
```



<a name="NOTE3_3"></a>


### 3. Chargement de la bibliothèque WINDEV (WDL)
<a name="3_chargement_bibliotheque_windev_wdl_ELTPARAGRAPHE000078"></a>La bibliothèque WINDEV d'extension .WDL contient tous les éléments du projet (fenêtres, états, classes, requêtes, analyse, ...). Il faut donc la charger en mémoire pour faire appel aux composants qu'elle contient.

Le chargement est réalisé par la fonction APPELWD('BIBLI,disque ...') comme suit :

**Attention** : Si la bibliothèque à charger contient des fenêtres, le code de chacune de ces fenêtres doit être intégré dans le fichier ".WDW" correspondant (option "Intégrer le code compilé" cochée, dans l'onglet "Détail" de la description de chaque fenêtre).


```txt
begin{ Ouverture de la bibliotheque }
{ si WDEntier n'est pas nul, la bibliothèque n'a pas été trouvée! }
APPELWD('BIBLI,disque,ville.wdl');	{ Ouverture de la bibliotheque. }
if WDEntier0 then
begin
	{ Bibliothèque non trouvée }
	APPELWD('Erreur,La bibliothèque VILLE.WDL doit être présente dans le répertoire père.');
	{ on indique à WINDEV que le programme va se terminer }
	{ utilisez HFTermine uniquement si une base de données HFSQL est utilisée }
	HFTermine;
	WDTermine;
	Halt;
end;
...
end;
```




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Exécution de codes WINDEV depuis le langage externe
<a name="execution_codes_windev_depuis_langage_externe_ELTTEXTE000280"></a>


### 1. Appel d'un code WLangage
<a name="1_appel_code_wlangage_ELTPARAGRAPHE000094"></a>Toutes les fonctions WLangage peuvent être appelées depuis le langage externe. Leur comportement et les valeurs retournées par ces fonctions du WLangage sont exactement identiques qu'elles soient appelées :

- depuis WINDEV ou

- depuis l'interface langage externe




Pour connaître les paramètres et les valeur de retour d'une fonction du WLangage, il suffit donc de se reporter à l'aide en ligne ou la documentation papier habituelle relative au WLangage.

L'appel à une procédure du WLangage depuis l'interface externe se fait par la commande **AppelWD**. Par exemple :


```txt
ouverture de la première fenêtre du programme contenant le menu }
APPELWD('OUVRE,menu.wdw');
```


Il est à noter que le paramètre attendu par la fonction **AppelWD** est une chaîne de caractères contenant le code WLangage à exécuter.

Tout comme le WLangage codé dans WINDEV, cette chaîne n'est pas sensible à la casse (majuscules/minuscules). Donc par exemple la commande "Info" peut aussi être écrite "INFO".


<a name="NOTE4_2"></a>


### 2. Récupération des événements déclenchés dans les fenêtres WINDEV
<a name="2_recuperation_des_evenements_declenches_dans_les_fenetres_windev_ELTPARAGRAPHE000115"></a>La saisie dans les fenêtres WINDEV rend nécessaire la récupération des événements déclenchés dans ces fenêtres.

Afin de récupérer les événements (clic sur un menu, un bouton ...) de l'utilisateur, vous devez mettre en place une boucle dans votre programme Pascal. Cette boucle sera active tant que la fenêtre WINDEV sera ouverte et permettra d'intercepter chaque action de l'utilisateur.

Pour connaître le type d'action de l'utilisateur, vous disposez d'une variable de type chaîne de caractères (en WLangage) nommée **'WDTouche**'. Cette variable sera utilisée dans votre code WLangage pour signaler au programme Pascal quel bouton a par exemple été actionné.

Exemple : Code Pascal


```txt
{ ouverture de la première fenêtre du programme contenant le menu }
APPELWD('OUVRE,menu.wdw');
{ le programme boucle jusqu'à ce que le choix Fichier Quitte }
{ soit sélectionné }
while( WDTouche<>'ESC' ) do
begin
{ on effectue la saisie du menu }
APPELWD('ECRAN,saisie');
	{------------------------------------------------}
{ Décodage de l'option choisie.	  }
{ WDChaine contient la suite des lettres d'appel }
{ qui aboutissent au choix de menu sélectionné   }
{------------------------------------------------}
if( WDTouche='FQ' ) then WDTouche:='ESC';{ Sortie              }
if( WDTouche='RN' ) then RechVille;      { Recherche par Ville }
if( WDTouche='RD' ) then RechDepar;      { Recherche par Dépar }
if( WDTouche='DD' ) then LstDepart;      { Affichage liste.    }
if( WDTouche='DI' ) then LstImprime;     { Impression.         }
if( WDTouche='DC' ) then LstConfig;      { Configuration imp   }
end;
```


Code du menu "Fichier..Quitter" de la fenêtre WINDEV "Menu" (WLangage) :


```txt
if( WDTouche='FQ' ) then WDTouche:='ESC';{ Sortie de la boucle }
```


Lorsque l'utilisateur cliquera sur le choix de menu "Fichier..Quitter", **WDTouche** sera renvoyée dans le code Pascal pour entreprendre la prochaine action.



<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Mettre fin à l'application
<a name="mettre_fin_application_ELTTEXTE000310"></a>
Pour terminer l'utilisation de l'interface externe, il suffit d'appeler les commandes **HFTerminepartage** et **WDTermine** qui n'ont pas de paramètres. Par exemple :


```txt
{ Terminer... }
{ utilisez HFTerminepartage uniquement si une base de données HFSQL est utilisée }
HFTerminepartage;
WDTermine;
end.
```






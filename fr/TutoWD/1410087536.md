
## Leçon 4.5. Imprimer une commande
<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Ce que vous allez apprendre dans cette leçon
<a name="que_vous_allez_apprendre_dans_cette_lecon_ELTTEXTE000499"></a>


- Créer un état basé sur une requête.

- Lancer l'impression d'un état basé sur une requête paramétrée.





|   |   |
| --- | --- |
| <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=dur%E9e.png)<br> | <br>Durée estimée : 30 mn |

| [Leçon précédente](../TutoWD/1410087535.md) | [Sommaire](../TutoWD/1410087560.md) | [Leçon suivante](../TutoWD/1410087537.md) |
| --- | --- | --- |





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000546"></a>
Nous allons maintenant donner la possibilité à l'utilisateur d'imprimer directement le détail de la commande recherchée. L'état pourra être imprimé directement via le menu contextuel du champ Table.



- Ré-ouvrez si nécessaire le projet que vous avez manipulé dans la leçon précédente. 

	1. Affichez la page d'accueil de WINDEV (Ctrl + &lt;).

	2. Dans la page d'accueil, cliquez sur "Tutoriel" puis dans la zone "Partie 4 - Application complète avec données", double-cliquez sur "Application complète - Exercice".

	3. WINDEV vous propose d'ouvrir le projet que vous avez manipulé dans la leçon précédente. Vous pouvez ouvrir le projet présent sur votre poste ou ouvrir le projet original. Choisissez "Ouvrir la copie locale". 





|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=exemple-WD.png) | Corrigé | Un projet corrigé est disponible. Ce projet contient les différents états créés dans cette leçon. Pour ouvrir le projet corrigé, dans la page d'accueil, cliquez sur "Tutoriel" puis dans la zone "Partie 4 - Application complète avec données", double-cliquez sur "Application complète - Corrigé". |







<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Création de l'état "Bon de commande"
<a name="creation_etat_bon_commande_ELTTEXTE000588"></a>
Nous allons tout d'abord lister les informations qui doivent être affichées dans l'état :

- Les caractéristiques de la commande : date et numéro de commande.

- Les coordonnées du client : nom, adresse, code postal, ville et pays.

- Les caractéristiques des lignes de commande :

	- Quantité commandée,

	- Référence du produit,

	- Libellé du produit,

	- Total HT,

	- Total TTC.





Pour créer simplement cet état, nous allons rassembler toutes les données à imprimer dans une requête. Cette requête pourra être utilisée par l'état ou par tout autre élément du projet WINDEV (champ Table, champ Zone répétée, ...). |   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=note.png) | Note | WINDEV propose de créer des états à partir de nombreuses sources de données : fichiers de données, requêtes, champs, fichiers texte, ...<br><br>Dans la majorité des cas, il est conseillé de rassembler les données à imprimer via une requête, puis de créer un état sur cette requête. Si une information doit être ajoutée dans l'état, il suffira d'ajouter la rubrique correspondante dans la requête.<br><br>Les états réalisés directement sur les fichiers de données doivent être réservés à des états simples, c'est-à-dire affichant des données provenant d'un seul fichier de données. |




<a name="NOTE3_2"></a>


### Création de la requête
<a name="creation_requete_ELTPARAGRAPHE000065"></a>

- Pour créer la requête de base de l'état, nous allons utiliser l'éditeur de requêtes.

	1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ICO_Cr%E9er1_GAF.jpg) parmi les boutons d'accès rapide. La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Requête­". L'assistant de création de requêtes se lance.

	2. Sélectionnez l'option "Sélection (SELECT)".
			En effet, la requête que nous allons créer va nous permettre de sélectionner les enregistrements qui seront imprimés dans l'état. Passez à l'étape suivante.

	3. La fenêtre de description de la requête apparaît. Nous allons construire la requête en sélectionnant les éléments que nous voulons dans le résultat.

	4. Double-cliquez sur les rubriques présentes dans l'analyse à gauche de la fenêtre de description. Les rubriques prises en compte apparaissent alors au centre de l'écran.
			Nous voulons imprimer dans l'état :

		- les renseignements concernant le client. Dans le fichier de données "Client", double-cliquez sur les rubriques NomComplet, Adresse, CodePostal, Ville et Pays.

		- les renseignements concernant la commande. Dans le fichier de données "Commande", double-cliquez sur les rubriques IDCommande et Date.

		- les renseignements concernant le produit. Dans le fichier de données "Produit", double-cliquez sur les rubriques Référence, Libellé et PrixHT.

		- les renseignements concernant la ligne de commande. Dans le fichier de données "LigneCommande", double-cliquez sur les rubriques Quantité et TotalHT.

		- les renseignements sur le prix total de la commande. Dans le fichier de données "Commande", double-cliquez sur les rubriques TotalHT et TotalTTC.
						|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=note.png) | Note | L'ordre dans lequel les rubriques sont insérées dans la requête est important. En effet, cet ordre correspond à celui utilisé pour afficher les données dans l'état. Si cet ordre est correctement défini, la création de l'état correspondant sera d'autant plus simple. |









La fenêtre de description de la requête est la suivante : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%20Requ%EAte1.jpg&type=thumb)
A ce stade, cette requête permet de sélectionner toutes les commandes et les lignes de commande correspondantes.

Nous voulons sélectionner les données correspondant à une seule commande dont l'identifiant est connu. Nous allons donc définir en paramètre le numéro de commande. 



- Pour gérer le paramètre "Identifiant de la commande" :

	1. Sélectionnez au centre de l'écran la rubrique Commande.IDCommande.

	2. Déroulez le bouton "Condition de sélection" et sélectionnez "Nouvelle condition".

	3. Dans la fenêtre qui s'affiche, nous allons indiquer que la condition de sélection correspond à un paramètre : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%20Requ%EAte2.jpg)
Effectuez les opérations suivantes :

		- Sélectionnez "Est égal à".

		- Cochez "au paramètre".

		- Le nom du paramètre est automatiquement proposé : "ParamIDCommande".




4. Validez la fenêtre de description de la condition. Le chiffre "1" apparaît à droite de la rubrique Commande.IDCommande, indiquant qu'une condition de sélection a été définie.

5. Donnez un nom à la requête : saisissez "REQ_BonDeCommande" à la place de "REQ_SansNom1" dans la zone "Nom de la requête" : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%20Requ%EAte3.jpg)



<a name="NOTE3_3"></a>


### Création de l'état basé sur une requête
<a name="creation_etat_base_sur_une_requete_ELTPARAGRAPHE000120"></a>

- Pour créer un état :

	1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ICO_Cr%E9er1_GAF.jpg) parmi les boutons d'accès rapide.

	2. La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". L'assistant de création d'un état se lance.

	3. L'assistant de création d'un état propose plusieurs types d'états : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%202%20-%20Etat%20-%20HC%20N%B0001.jpg&type=thumb)


	4. Sélectionnez "Tableau". Passez à l'étape suivante.

5. Sélectionnez la source des données de l'état. L'état va être basé sur la requête que vous venez de créer. Sélectionnez "Un fichier de données ou une requête existante". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%202%20-%20Etat%20-%20HC%20N%B0002.jpg&type=thumb)
 Passez à l'étape suivante.

6. Dans la liste des fichiers de données et des requêtes, sélectionnez la requête "REQ_BonDeCommande". Passez à l'étape suivante.

7. L'assistant demande d'indiquer s'il y a une rupture. Dans cet état nous n'utilisons pas de rupture. Nous verrons ce concept un peu plus loin dans ce cours. Répondez "Je ne veux pas de rupture dans l'état". Passez à l'étape suivante.

8. Vous allez ensuite indiquer dans quel ordre sont imprimées les rubriques et leur répartition dans les différents blocs. Dans l'assistant, les rubriques sont listées dans l'ordre défini dans la requête :

	- Les rubriques concernant le client vont être affichées dans le bloc "Entête de page". En effet, ces informations ne doivent pas être répétées pour chaque ligne de la commande.
						Pour les rubriques NomComplet, Adresse, CodePostal, Ville et Pays, cliquez sur la ligne correspondant à la rubrique. Dans la colonne "Bloc", déroulez la combo et sélectionnez "Entête de page". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%202%20-%20Etat%20-%20HC%20N%B0003.jpg&type=thumb)




- Exécutez cet état en cliquant sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ICO_GO_Fenetre_WD_GAF.jpg) parmi les boutons d'accès rapide.

	1. L'éditeur d'états demande la destination de l'impression. La destination de l'impression peut être au choix : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%202%20-%20Etat%20-%20HC%20N%B0009.jpg)
Choisissez "Visualisateur de rapports" et validez.

	2. L'éditeur d'états demande les paramètres de la requête utilisée par l'état. Rappelez-vous, nous avons, en effet, utilisé un paramètre pour spécifier le numéro de la commande à imprimer. Pour l'exemple, saisissez la valeur de test "1". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%202%20-%20Etat%20-%20HC%20N%B0010.jpg)
Validez.

	3. L'état s'affiche comme nous l'avons demandé dans le visualisateur de rapports. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%202%20-%20Etat%20-%20HC%20N%B0011.jpg&type=thumb)
Vous pouvez :

		- Directement imprimer la page en cours ou la totalité du document en cliquant sur l'imprimante.

		- Créer un duplicata.

		- Sélectionner un niveau de zoom plus ou moins important.

		- Enregistrer l'état sous forme d'un document Word (au format RTF).

		- Enregistrer l'état au format HTML.

		- Enregistrer l'état au format PDF.

		- Enregistrer l'état au format XML.

		- Créer un e-mail avec l'état au format HTML en corps du message.

		- Créer un e-mail avec l'état au format PDF en document lié.

		- Annoter le document.

		- Effectuer une recherche dans le document.

		- Ajouter des filigranes.







- Fermez le visualisateur de rapports. 



<a name="NOTE3_4"></a>


### Modifications de l'état "Bon de commande"
<a name="modifications_etat_bon_commande_ELTPARAGRAPHE000290"></a>Nous allons effectuer quelques modifications de mise en page dans l'état que nous venons de créer.



- Supprimez le nombre de pages affiché dans l'état :

	1. Sélectionnez le champ [NUMPAGE]/[NBPAGES].

	2. Appuyez sur la touche Suppr du clavier.







- Nous allons maintenant positionner les informations concernant le client et la commande dans l'entête de page :

	1. Supprimez le libellé "Bon de commande" présent dans l'entête de page.

	2. Supprimez les libellés devant les informations client (Nom complet, ...). 

	3. Positionnez la rubrique contenant la ville à côté du code postal.

	4. Sélectionnez les informations concernant le client et déplacez-les à l'aide de la souris sur la droite de l'état.

	5. Remontez le numéro de commande et la date de la commande (en haut du bloc "Entête de page").







- Nous allons positionner les totaux correctement dans le pied de page :

	1. Sélectionnez les champs (libellés et rubriques) correspondant aux totaux présents dans le pied de page.

	2. Positionnez ces champs à l'aide de la souris en bas à droite du tableau.







- Modifiez les options d'impression du bloc "Pied de page" :

	1. Affichez la fenêtre de description du bloc "Pied de page" :

		- Cliquez dans le bloc "Pied de page".

		- Affichez le menu contextuel (clic droit) et sélectionnez "Description du bloc".




2. Dans l'onglet "Général", cochez les options suivantes :

	- Imprimer le bloc "Fin de document" APRES le bloc "Pied de page" sur la dernière page.

	- Le bloc "Pied de page" ne s'imprime pas en bas de la page, il se colle aux blocs précédents. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%203%20-%20Affichage%20-%20HC%20N%B0001.jpg&type=thumb)




Notre état est terminé.

<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Affichage de l'état imprimé depuis une option de menu
<a name="affichage_etat_imprime_depuis_une_option_menu_ELTTEXTE000702"></a>
Dans notre application, l'état "ETAT_Bon_de_commande" va être imprimé depuis une option du menu contextuel du champ Table listant les commandes recherchées.

Par défaut, nous l'avons déjà vu, le champ Table propose un menu automatique. Nous voulons conserver les options de ce menu automatique et ajouter une option qui permettra d'imprimer le bon de commande sélectionné.

Le principe utilisé est le suivant :

1. Nous allons créer un nouveau menu contextuel. Ce menu contiendra le code WLangage permettant de lancer l'impression de l'état.

2. Nous allons lier ce menu contextuel au champ Table et indiquer que le menu contextuel par défaut viendra à la suite du menu contextuel défini pour le champ Table.



<a name="NOTE4_2"></a>


### Création du menu contextuel
<a name="creation_menu_contextuel_ELTPARAGRAPHE000369"></a>

- Pour créer un menu contextuel dans la fenêtre "FEN_Menu" :

	1. Ouvrez si nécessaire la fenêtre "FEN_Menu" sous l'éditeur (double-cliquez sur son nom dans le volet "Explorateur de projet" par exemple).

	2. Sous le volet "Fenêtre", dans le groupe "Barres et menus", déroulez "Menus contextuels" et sélectionnez "Nouveau menu contextuel".

	3. Un nouveau menu contextuel apparaît sous l'éditeur. Ce menu possède une seule option "Option de menu". <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%203%20-%20Affichage%20-%20HC%20N%B0003.jpg)


	4. Affichez la description du menu contextuel :

	- Sélectionnez "Option de menu".

	- Affichez le menu contextuel (clic droit).

	- Sélectionnez l'option "Description du menu contextuel".






- Nous allons maintenant définir le libellé de l'option et saisir son code WLangage.

	1. Sélectionnez l'option "Option de menu".

	2. Appuyez sur la touche Espace du clavier : le libellé passe en édition. Saisissez le nouveau libellé "Imprimer le bon de commande" et validez.

	3. Affichez les événements WLangage associés à l'option :

		- Sélectionnez l'option.

		- Affichez le menu contextuel (clic droit) et sélectionnez l'option "Code".




4. Saisissez le code WLangage suivant :
			
		```wl
		// Impression dans le visualisateur de rapports
		iDestination(iVisualisateur) 
		// Initialise la requête de l'état
		ETAT_Bon_de_commande.InitRequête(TABLE_REQ_RechercheCommandes.COL_IDCommande)
		// Lance l'impression de l'état
		ETAT_Bon_de_commande.Imprime()
		```
Dans ce code :

	- La fonction [iDestination](../WDLang5/3046074.md) permet d'indiquer que l'impression de l'état sera effectuée dans le visualisateur de rapports.

	- La fonction [&lt;Etat&gt;.InitRequête](../WDLang5/1000025143.md) permet de spécifier les paramètres attendus par la requête associée à l'état. Dans notre cas, la requête attend en paramètre le numéro de commande. Ce numéro de commande est présent dans la colonne COL_IDCommande du champ Table TABLE_REQ_RechercheCommandes pour la ligne en cours.

	- La fonction [&lt;Etat&gt;.Imprime](../WDLang5/1000024554.md) permet de lancer l'impression de l'état spécifié (ici, l'état ETAT_Bon_de_commande).



<a name="NOTE4_3"></a>


### Association du menu contextuel au champ Table
<a name="association_menu_contextuel_champ_table_ELTPARAGRAPHE000434"></a>

- Dernière étape : nous allons lier le menu contextuel au champ Table.

	1. Dans la fenêtre "FEN_Menu", affichez l'onglet "Recherche de commandes".

	2. Sélectionnez le champ Table et affichez sa description (option "Description de la table" du menu contextuel du champ).

	3. Dans l'onglet "UI", déroulez la combo "Menu contextuel".

	4. Cochez l'option "Ajouter un menu contextuel", sélectionnez le menu "MENU_Commande" et sélectionnez l'option "Au début" pour indiquer que le menu est placé avant le menu système. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%203%20-%20Affichage%20-%20HC%20N%B0004.jpg)


	5. Cliquez dans la fenêtre pour valider le menu contextuel. 

6. Validez.



<a name="NOTE4_4"></a>


### Test de l'impression
<a name="test_impression_ELTPARAGRAPHE000458"></a>

- Il ne reste plus qu'à effectuer un test en réel :

	1. Lancez le test de la fenêtre "FEN_Menu".

	2. Sélectionnez le volet d'onglet "Recherche de commandes".

	3. Spécifiez les critères et lancez une recherche.

	4. Sélectionnez une des commandes affichée dans le champ Table.

	5. Imprimez la commande via le menu contextuel. <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=P4_Application%20compl%E8te%20-%20BDC%20-%203%20-%20Affichage%20-%20HC%20N%B0005.jpg&type=thumb)


	6. Fermez le visualisateur de rapports ainsi que la fenêtre de test.




| [Leçon précédente](../TutoWD/1410087535.md) | [Sommaire](../TutoWD/1410087560.md) | [Leçon suivante](../TutoWD/1410087537.md) |
| --- | --- | --- |








## Persistance des données
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000314"></a>
La persistance des données permet de conserver la valeur saisie par l'utilisateur.

Quand l'utilisateur saisit une valeur dans un champ d'une fenêtre, cette valeur sera de nouveau présente dans le champ lors de la prochaine ouverture de la fenêtre. Cette fonctionnalité sera appréciée dans le cas d'une saisie de login, de recherches, de paramètres quasi-constants, de choix par défaut, ...

Cette fonctionnalité est disponible sur tous les champs permettant une saisie. Cette fonctionnalité est également disponible pour une sélection de valeurs dans un champ Sélecteur ou Interrupteur.



![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png)![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png) La persistance des données est réalisée uniquement par programmation. Les informations sont sauvegardées dans un cookie navigateur. 

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Comment le faire ?
<a name="comment_faire_ELTTEXTE000338"></a>


### Activer ou désactiver la persistance d'un champ dans une fenêtre
<a name="activer_desactiver_persistance_champ_dans_une_fenetre_ELTPARAGRAPHE000068"></a>Pour activer ou désactiver la persistance d'un champ dans une fenêtre : 

1. Affichez la fenêtre de description du champ. 

2. Dans l'onglet "Détail", cochez (ou décochez) l'option "Mémoriser la valeur".




Par défaut, les valeurs des champs "persistants" sont stockées dans la base de registre (ou le fichier équivalent sur la plateforme d'exécution). Par exemple : 




![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) **Remarque** : Ce mécanisme peut être mis en place par l'utilisateur lui-même grâce à l'option ["Mémoriser" du menu contextuel des champs (FAA)](../WDChamp/9500128.md). 

<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Fonctionnement
<a name="fonctionnement_ELTTEXTE000362"></a>


### Analyse du fonctionnement
<a name="analyse_fonctionnement_ELTPARAGRAPHE000096"></a>**Lorsque le mécanisme de persistance d'un champ est activé** : 

- Le contenu du champ est mémorisé lors de la fermeture de l'application. 
	![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Ces informations sont stockées par défaut dans la base de registre dans la clé "HKEY_CURRENT_USER\\Software\\&lt;Société&gt;\\&lt;Nom du projet&gt;". Cette clé peut être connue par programmation grâce à la fonction [ProjetInfo](../WDLang1/3064004.md).

- Lors du lancement suivant de l'application, le mécanisme de persistance restaure les champs mémorisés dans leur état précédent. Cette restauration des valeurs est effectuée entre le code de déclaration de la fenêtre et le code d'initialisation de la fenêtre. 




L'affectation de la valeur d'un champ se fait donc suivant l'ordre d'affectation suivant :

1. Valeur définie dans l'onglet "Contenu" de la description du champ.

2. Exécution du code d'initialisation du champ. Ce code peut initialiser et modifier la valeur initiale du champ.

3. Valeur persistante (enregistrée dans la base de registre, dans un fichier de paramètre, ...). Si une valeur persistante a été définie pour le champ, c'est cette valeur qui est affectée au champ.

4. Exécution du code d'initialisation de la fenêtre. Ce code peut initialiser et modifier la valeur affectée au champ. 




De plus, afin de garder la compatibilité avec le fonctionnement existant de l'application : 

- les traitements de modification des champs affectés "automatiquement" sont exécutés.

- les codes de sélection des champs Liste et Combo sont exécutés.


Si le traitement de modification ou de sélection du champ ne doit pas être exécuté, il est possible de conditionner son exécution de la façon suivante : 

```wl
// Code de sélection d'une ligne d'un champ Combo 
// ou code de modification d'un champ
SI OUVERTURE ALORS RETOUR
```
Dans ce cas, la suite du traitement n'est pas exécutée si l'appel de ce code est provoqué dès l'ouverture de la fenêtre, lors de la restauration des valeurs mémorisées.
<a name="NOTE3_2"></a>


### Paramétrage
<a name="parametrage_ELTPARAGRAPHE000129"></a>Les informations de persistance sont stockées par défaut dans la base de registre (ou le fichier équivalent sur la plateforme d'exécution). Il est bien entendu possible de modifier la méthode et la localisation de ces informations grâce à la fonction [InitParamètre](../WDLang1/3025044.md).

Cette fonction accepte deux paramètres :

- La méthode de stockage des données :

	- Document au format XML (non disponible en version Mobile).

	- Fichier de configuration (.ini).

	- Base de registre.

	- Chaîne au format XML (par exemple pour être envoyée par Socket ou protocole HTTP).




- La localisation correspondant à la méthode spécifiée dans le premier paramètre (chemin du document XML, chemin dans la base de registre ou chemin du fichier de configuration).




Exemple : 

```wl
// Utilisation d'un fichier de configuration (.ini)
InitParamètre(paramIni, "C:\temp\MaConfig.ini")
```
La lecture et la sauvegarde des données de persistance restent identiques : seule la méthode de stockage (et la localisation) est modifiée.

<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Fonctionnement avancé
<a name="fonctionnement_avance_ELTTEXTE000392"></a>


### Mémorisation des variables globales d'un projet
<a name="memorisation_des_variables_globales_projet_ELTPARAGRAPHE000155"></a>Le mécanisme de persistance permet non seulement de mémoriser des champs, mais également des variables ou tout autre information nécessaire à une application.

Il devient alors inutile de gérer "à la main" un fichier de configuration pour mémoriser le contenu des variables globales d'un projet (chemin des données, date de dernière connexion, nom de l'utilisateur, mémorisation du mot de passe, ...).
<a name="NOTE4_2"></a>


### Mise en place
<a name="mise_place_ELTPARAGRAPHE000164"></a>Il est nécessaire d'utiliser les fonctions [ChargeParamètre](../WDLang1/3025047.md) et [SauveParamètre](../WDLang1/3025046.md).

La fonction [ChargeParamètre](../WDLang1/3025047.md) accepte deux paramètres :

- Le nom du paramètre à restaurer (nom logique), par exemple le nom de la variable correspondante.

- La valeur par défaut du paramètre (si ce paramètre n'a jamais été sauvegardé ou utilisé).



```wl
// Chargement d'un paramètre de type entier
gnNbLancement = ChargeParamètre(CS_NB_LANCEMENT)
// Chargement d'un paramètre de type date
gdDateDernierLancement = ChargeParamètre(CS_DATE_LANCEMENT)
// Chargement d'un paramètre de type heure
ghHeureDernierLancement = ChargeParamètre(CS_HEURE_LANCEMENT)
```
Il n'est pas nécessaire de gérer le type de paramètre : le type du paramètre est entièrement géré par le mécanisme de persistance (inutile, par exemple, d'utiliser la fonction [Val](../WDLang1/3024037.md) pour récupérer une valeur numérique).

La fonction [SauveParamètre](../WDLang1/3025046.md) accepte aussi deux paramètres :

- Le nom du paramètre à sauvegarder (nom logique). Ce nom est utilisé dans la fonction [ChargeParamètre](../WDLang1/3025047.md).

- La valeur du paramètre.



```wl
// Mémorisation d'un paramètre de type entier
SauveParamètre(CS_NB_LANCEMENT, gnNbLancement)
// Mémorisation d'un paramètre de type date
SauveParamètre(CS_DATE_LANCEMENT, gdDateDernierLancement)
// Mémorisation d'un paramètre de type heure
SauveParamètre(CS_HEURE_LANCEMENT, ghHeureDernierLancement)
```
Les informations stockées par la fonction [SauveParamètre](../WDLang1/3025046.md) sont stockées en utilisant la méthode et la localisation spécifiées par la fonction [InitParamètre](../WDLang1/3025044.md) (par défaut, ces informations sont donc stockées dans la base de registre).

Note : Bien entendu, il est possible d'utiliser plusieurs méthodes et/ou plusieurs fichiers de sauvegarde dans une même application.

<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Optimisation
<a name="optimisation_ELTTEXTE000422"></a>


### Mémorisation des variables globales d'un projet
<a name="memorisation_des_variables_globales_projet_ELTPARAGRAPHE000215"></a>Une optimisation peut parfois être nécessaire lorsque l'application effectue des traitements longs. En effet, les codes de modification des champs "restaurés" sont exécutés. Si un de ces champs contient un code potentiellement long, il peut être intéressant de ne pas exécuter tous les codes de modification pendant la phase de restauration des champs.

**Exemple : Cas d'une fenêtre de recherche multi-critères utilisant le mécanisme de persistance**

1. Au premier lancement, aucun champ n'a de valeur mémorisée, le fonctionnement est "classique".

2. A la fin de l'application, le mécanisme de persistance mémorise les critères de recherche sélectionnés par l'utilisateur.

3. Au lancement de l'application, les champs mémorisés sont restaurés et les codes de modification des champs sont exécutés.

4. Si ces codes de modification lancent une exécution de la recherche (cas courant pour un sélecteur), la recherche va être effectuée avec des critères différents pour chaque champ mémorisé ! Cette opération peut alors être très pénalisante selon les recherches réalisées.



<a name="NOTE5_2"></a>


### Optimisation
<a name="optimisation_ELTPARAGRAPHE000229"></a>Dans ces cas particuliers, il suffit de "désactiver" les traitements potentiellement longs pendant leur restauration automatique. Il est possible d'utiliser la méthode suivante : 

1. Déclaration d'une variable globale de fenêtre de type booléen dans la fenêtre concernée.
	
	```wl
	// Code de déclaration de la fenêtre
	GLOBAL
	gbRestaurationEnCours est un booléen
	```


2. Initialisation de cette variable à "Vrai" dans le code de déclaration de la fenêtre.
	
	```wl
	// Code de déclaration de la fenêtre
	gbRestaurationEnCours = Vrai
	```


3. Ajout d'un test sur cette variable dans les traitements potentiellement longs. Si cette variable est positionnée à la valeur "Vrai", le traitement n'est pas réalisé (restauration en cours des champs par le mécanisme de persistance).
	
	```wl
	// Traitement potentiellement long
	SI gbRestaurationEnCours = Vrai ALORS RETOUR
	...
	```


4. Affectation de cette variable à "Faux" dès le début du code d'initialisation de la fenêtre pour reprendre le fonctionnement normal de l'application.
	
	```wl
	// Code d'initialisation de la fenêtre
	gbRestaurationEnCours = Faux
	```





<a name="NOTE6"></a>
<a name="NOTE6_1"></a>


## Gestion de la persistance des données avec les fonctions du WLangage
<a name="gestion_persistance_des_donnees_avec_les_fonctions_wlangage_ELTTEXTE000452"></a>
La persistance des données peut également être gérée par programmation via les fonctions : 



|   |   |
| --- | --- |
| [ChargeParamètre](../WDLang1/3025047.md) | Lit une valeur persistante. |
| [InitParamètre](../WDLang1/3025044.md) | Initialise la gestion des valeurs persistantes. |
| [SauveParamètre](../WDLang1/3025046.md) | Sauve une valeur persistante dans la base de registre ou dans un autre fichier spécifié avec la fonction [InitParamètre](../WDLang1/3025044.md). |
| [SupprimeParamètre](../WDLang1/3025048.md) | Supprime un paramètre ou une série de paramètres sauvés soit avec la fonction [SauveParamètre](../WDLang1/3025046.md), soit automatiquement grâce à la persistance des données dans les champs. |





![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Remarques : 

- Il est possible de sauvegarder automatiquement tous les champs persistants d'une fenêtre grâce à la fonction [FAAExécute](../WDLang1/1000022099.md).

- La fonction [FAADésactive](../WDLang1/1000022018.md) permet de désactiver la persistance des champs.





- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDPersistance.gif) ***Exemples didactiques (WINDEV)*** : **WD Persistance** <br>Cet exemple montre l'utilisation des fonctions InitParamètre, ChargeParamètre, SauveParamètre.<br>Ces fonctions permettent de configurer la sauvegarde de champs, de variables et de tout autre paramètre.<br>Cet exemple est décomposé en trois parties :<br>	- La configuration<br>	- La gestion manuelle de variables (Fonctions SauveParamètre et ChargeParamètre)<br>	- L'optimisation<br>1°) Configuration<br>	<br>	La fenêtre de configuration vous permet de modifier l'emplacement de la sauvegarde des paramètres (Base de registre, fichier INI, fichier XML) ainsi que son chemin (clé de registre ou le chemin du fichier).<br>2°) Gestion Manuelle de variables<br>	La gestion manuelle vous permet de sauvegarder le contenu de variables grâce à la fonction SauveParamètre et de les restaurer grâce à la fonction ChargeParamètre. Chaque paramètre est identifié par un nom. Ces valeurs sont sauvegardées à l'emplacement défini dans la fenêtre de configuration.<br>3°) L'optimisation<br>	Cette fenêtre vous explique comment optimiser votre code pour éviter les lenteurs dues à la restauration des valeurs sauvegardées. En effet, lors de la restauration de la valeur d'un champ, son code de modification est exécuté. Si vous avez des traitements longs (Requêtes paramétrées ou autres), cette fenêtre vous montre comment accélérer le chargement de la fenêtre.



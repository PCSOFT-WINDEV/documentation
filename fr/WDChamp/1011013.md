


## Etat sur requête
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000608"></a>
Une requête permet de sélectionner simplement certains enregistrements d'un ou de plusieurs fichiers de données. Une requête permet aussi de réaliser des calculs sur les données sélectionnées. Il est ainsi possible, par exemple, de sélectionner toutes les commandes des clients habitant New York et de réaliser un total du montant des commandes par client.

L'utilisation de requêtes dans un état permet de réaliser rapidement des états complexes. La requête présélectionne les enregistrements et l'état organise toutes les données sélectionnées et réalise les différents calculs.

**Attention** : Pour optimiser l'état, il est recommandé de réaliser les différents calculs (totaux sur des rubriques par exemple) directement dans l'état et non dans la requête.



L'éditeur d'états offre la possibilité de créer un état basé sur une requête selon plusieurs modes :

- soit la requête est créée et enregistrée sous l'éditeur de requêtes. L'état est alors basé sur le fichier correspondant à la requête (fichier ".WDR"). La requête peut être réutilisée dans un autre état, une fenêtre, un champ, ... La requête peut être modifiée à tout moment sous l'éditeur de requêtes. ***La requête est dite indépendante***. 

- soit la requête est créée lors de la création de l'état. La requête est alors intégrée à l'état. Aucun fichier spécifique à la requête n'est créé. La requête peut uniquement être modifiée à partir de l'état qui l'a créée. Elle ne peut pas être réutilisée dans un autre état, une fenêtre, un champ, ... ***La requête est dite intégrée***. 

- soit ***la requête est basée sur des données provenant d'une connexion*** (non disponible sous WINDEV Mobile). 
	Remarque : Ce type d'état sur requête est disponible même si aucune analyse n'est associée au projet WINDEV ou WEBDEV.




**Astuce** : Il est possible de créer directement depuis l'éditeur de requêtes, un état basé sur la requête de sélection en cours. Pour cela, sous le volet "Requête", dans le groupe "Liaison Fichier", cliquez sur "Créer un état".

**Remarque** : Une requête (intégrée ou indépendante) peut être paramétrée. Pour plus de détails, consultez le paragraphe [Etat sur requête paramétrée](#NOTE4_1).

L'état pourra être alors imprimé très simplement depuis vos programmes WLangage. Pour plus de détails, consultez [Imprimer un état sur requête](#NOTE5_1).
Cette page d'aide présente : 

- [Comment créer un état sur une requête indépendante](#NOTE2_1).

- [Comment créer un état sur une requête intégrée](#NOTE3_1).

- [Comment créer un état sur une requête paramétrée](#NOTE4_1).

- [Comment imprimer un état sur une requête](#NOTE5_1).

	- [Cas général](#NOTE5_2).

	- [Cas d'une requête paramétrée](#NOTE5_3).







<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## État sur requête indépendante
<a name="etat_sur_requete_independante_ELTTEXTE000632"></a>


### Présentation
<a name="presentation_ELTPARAGRAPHE000115"></a>La requête doit être créée avant la création de l'état (pour plus de détails, consultez [Créer une requête](../Editeurs/2032059.md)). Lors de la création de l'état, il suffit de spécifier le nom de la requête utilisée.

Si la requête est modifiée sous l'éditeur de requêtes (suppression de rubriques résultat par exemple), un écran de synchronisation est affiché lors de la fermeture de la requête. Il est ainsi possible de reporter les modifications effectuées sur la requête dans tous les éléments utilisant cette requête (y compris les états).
<a name="NOTE2_2"></a>


### Créer un état sur requête indépendante
<a name="creer_etat_sur_requete_independante_ELTPARAGRAPHE000127"></a>Pour créer un état sur requête indépendante :

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif) parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". 

	- L'assistant de création d'un état s'affiche.




2. Choisissez la présentation de votre état (tableau, fiche, étiquette, ...). Pour plus de détails, consultez [Les différents types d'états](../WDChamp/1011054.md).

3. Sélectionnez si nécessaire le modèle d'états à utiliser. Un modèle d'états permet de respecter une mise en page spécifique. Pour plus de détails sur les modèles d'états, consultez [Les modèles d'états](../WDChamp/9000105.md). 

4. Sélectionnez la source de données de l'état (option "D'un fichier de données ou d'une requête existante").

5. Sélectionnez la requête sur laquelle est basé l'état. Seules les requêtes présentes dans l'application en cours sont proposées.

6. Pour grouper les enregistrements, il est possible de créer des ruptures sur les rubriques de tri. Pour créer des ruptures, répondez "Oui" à la question "Voulez-vous des ruptures dans l'état ?".
	L'étape suivante de l'assistant permet alors de sélectionner les rubriques de tri correspondant aux ruptures. Pour plus de détails sur les ruptures, consultez les [Ruptures dans un état](../WDChamp/1011028.md).

7. Pour chaque rubrique affichée dans l'état :

	- saisissez le libellé correspondant. Ce libellé sera affiché :

		- soit avant la rubrique. Par exemple :<br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleFiche.gif)


		- soit dans l'entête de la colonne (cas des états Tableau). Par exemple :<br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleTable.gif)
Ce libellé pourra être modifié directement sous l'éditeur d'états.

- sélectionnez le bloc dans lequel le champ associé à la rubrique doit être imprimé. La position des différents champs pourra être modifiée directement sous l'éditeur d'états. Pour plus de détails sur les différents blocs et sur leur position dans un état, consultez [Blocs d'un état](../WDChamp/1011040.md).

8. Modifiez si nécessaire l'ordre d'affichage des différents champs dans l'état à l'aide des boutons fléchés à droite du tableau.

9. Si la requête associée à l'état contient au moins une rubrique de type numérique, il est possible de réaliser des calculs sur ces rubriques. Spécifiez le calcul réalisé pour chaque rubrique (somme, moyenne, ...). Deux types de calculs sont possibles :

	- ***calcul général*** : un champ Calculé sera créé dans le bloc *Fin de document*.

	- ***calcul sur rupture*** : un champ Calculé sera créé dans le bloc *Bas de rupture*. Dans les calculs sur rupture, le résultat du calcul est réinitialisé à chaque rupture. Pour réaliser un calcul sur rupture, une rupture doit être présente dans l'état en cours de création.




10. Selon le type d'état en cours de création, indiquez les options spécifiques correspondantes.
	

| Type d'état | Options spécifiques |
| --- | --- |
| État sur formulaire | Image du formulaire, impression de l'image du formulaire, ...<br>Options détaillées dans la page [Etat sur formulaire](../WDChamp/1011067.md) |
| État Étiquette | Format des étiquettes, nombre d'exemplaires identiques, ...<br>Options détaillées dans la page [Etat Étiquette](../WDChamp/1011050.md) |



11. Spécifiez le format de la feuille sur laquelle l'état va être imprimé. Par défaut, l'état est imprimé sur une feuille au format A4.
	Remarque : Par défaut, les champs de l'état sont disposés sur une seule colonne. Pour réaliser un état multicolonne, il suffit de spécifier le nombre de colonnes voulues dans l'onglet "Format" de la fenêtre de description de l'état.

12. Sélectionnez le gabarit de l'état si nécessaire.

13. Saisissez le nom et le titre de l'état (nom du fichier ".WDE" correspondant à l'état). Ce nom permettra d'identifier l'état dans vos programmes.
	![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Il est également possible d'indiquer si l'état peut être modifié par l'utilisateur final sous le logiciel "Etats & Requêtes". 

14. Validez la création de l'état. 

15. L'éditeur d'états propose automatiquement de changer le format de l'état utilisé si les conditions suivantes sont réunies :

	- l'état en cours de création comporte un tableau.

	- le format de l'état ne permet pas d'afficher l'ensemble des colonnes du tableau.




16. Si nécessaire, indiquez le mode de réduction de l'état : 

	- Imprimer l'état sur plusieurs pages. Dans ce cas, l'utilisateur final devra assembler les pages. Pour plus de détails, consultez [Impression multipage](../WDChamp/1011065.md). 

	- Utiliser le mode paysage. 

	- Réduire l'état par rapport à l'original. Attention : selon le pourcentage de réduction choisi, l'état imprimé pourra devenir illisible. 




17. L'état en cours de création s'affiche sous l'éditeur d'états.




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## État sur requête intégrée
<a name="etat_sur_requete_integree_ELTTEXTE000662"></a>


### Présentation
<a name="presentation_ELTPARAGRAPHE000225"></a>La requête est créée directement lors de la création de l'état. Cette requête sera modifiée directement depuis l'éditeur d'états (option "Éditer la requête" du menu contextuel de l'état). Si des modifications sont réalisées dans la requête, l'éditeur d'états liste les modifications réalisées et les incidences sur l'état.

**Remarque** : Pour passer du mode intégré au mode indépendant (c'est-à-dire pour extraire une requête d'un état) :

1. Affichez l'état basé sur la requête intégrée (sous l'éditeur d'états). 

2. Sélectionnez l'option "Editer la requête" du menu contextuel de l'état. Autre solution : sous le volet "Modification", dans le groupe "Etat", cliquez sur "Éditer la requête". La requête s'affiche sous l'éditeur de requêtes.

3. Sous le volet "Accueil", dans le groupe "Général", déroulez "Enregistrer" et sélectionnez "Exporter .. Vers une requête indépendante".

4. Enregistrez la nouvelle requête.



<a name="NOTE3_2"></a>


### Créer un état sur requête intégrée
<a name="creer_etat_sur_requete_integree_ELTPARAGRAPHE000255"></a>Pour créer un état sur requête intégrée :

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif) parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". 

	- L'assistant de création d'un état s'affiche.




2. Choisissez la présentation de votre état (tableau, fiche, étiquette, ...). Pour plus de détails, consultez [Les différents types d'états](../WDChamp/1011054.md).

3. Sélectionnez si nécessaire le modèle d'états à utiliser. Un modèle d'états permet de respecter une mise en page spécifique. Pour plus de détails sur les modèles d'états, consultez [Les modèles d'états](../WDChamp/9000105.md). 

4. Sélectionnez la source de données de l'état (option "D'une nouvelle requête").

5. L'assistant de création de requêtes se lance. Sélectionnez les différentes rubriques utilisées par la requête.
	**Remarque** : Pour simplifier la sélection des rubriques, affichez ces rubriques par ordre alphabétique ou par fichier associé.

6. Définissez les caractéristiques de la requête (condition de sélection, groupe, tri, ...) en cliquant sur le bouton correspondant.
	Pour plus de détails, consultez :

	- les [conditions de sélection d'une requête](../Editeurs/2032019.md),

	- les [opérations possibles dans une requête](../Editeurs/2032020.md),

	- l'[ordre de tri des enregistrements d'une requête](../Editeurs/2032005.md) (ordre important pour les ruptures).




7. Passez à l'étape suivante.

8. Pour grouper les enregistrements, il est possible de créer des ruptures sur les rubriques de tri définies dans la requête. Pour créer des ruptures, répondez "Oui" à la question "Voulez-vous des ruptures dans l'état ?".
	L'étape suivante permet alors de sélectionner les rubriques de tri correspondant aux ruptures. Pour plus de détails sur les ruptures, consultez les [Ruptures dans un état](../WDChamp/1011028.md).

9. Pour chaque rubrique de la requête affichée dans l'état :

	- saisissez le libellé correspondant. Ce libellé sera affiché :

		- soit avant la rubrique. Par exemple :
						<br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleFiche.gif)


		- soit dans l'entête de la colonne (cas des états Tableau). Par exemple : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleTable.gif)
Ce libellé pourra être modifié directement sous l'éditeur d'états.

- sélectionnez le bloc dans lequel le champ associé à la rubrique doit être imprimé. La position des différents champs pourra être modifiée directement sous l'éditeur d'états. Pour plus de détails sur les différents blocs et sur leur position dans un état, consultez [Blocs d'un état](../WDChamp/1011040.md).

10. Modifiez si nécessaire l'ordre d'affichage des différents champs dans l'état à l'aide des boutons fléchés à droite du tableau.

11. Si la requête associée à l'état contient au moins une rubrique de type numérique, il est possible de réaliser des calculs sur ces rubriques. Spécifiez le calcul réalisé pour chaque rubrique (somme, moyenne, ...). Deux types de calculs sont possibles :

	- ***calcul général*** : un champ Calculé sera créé dans le bloc *Fin de document*.

	- ***calcul sur rupture*** : un champ Calculé sera créé dans le bloc *Bas de rupture*. Dans les calculs sur rupture, le résultat du calcul est réinitialisé à chaque rupture. Pour réaliser un calcul sur rupture, une rupture doit être présente dans l'état en cours de création.




12. Selon le type d'état en cours de création, indiquez les options spécifiques correspondantes.
	

| Type d'état | Options spécifiques |
| --- | --- |
| État sur formulaire | Image du formulaire, impression de l'image du formulaire, ...<br>Options détaillées dans la page [Etat sur formulaire](../WDChamp/1011067.md) |
| État Étiquette | Format des étiquettes, nombre d'exemplaires identiques, ...<br>Options détaillées dans la page [Etat Étiquette](../WDChamp/1011050.md) |



13. Spécifiez le format de la feuille sur laquelle l'état va être imprimé. Par défaut, l'état est imprimé sur une feuille au format A4.
	Remarque : Par défaut, les champs de l'état sont disposés sur une seule colonne. Pour réaliser un état multicolonne, il suffit de spécifier le nombre de colonnes voulues dans l'onglet "Format" de la fenêtre de description de l'état. 

14. Sélectionnez le gabarit de l'état si nécessaire.

15. Saisissez le nom et le titre de l'état (nom du fichier ".WDE" correspondant à l'état). Ce nom permettra d'identifier l'état dans vos programmes.
	![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Il est également possible d'indiquer si l'état peut être modifié par l'utilisateur final sous le logiciel "Etats & Requêtes". 

16. Validez la création de l'état. 

17. L'éditeur d'états propose automatiquement de changer le format de l'état utilisé si les conditions suivantes sont réunies :

	- l'état en cours de création comporte un tableau.

	- le format de l'état ne permet pas d'afficher l'ensemble des colonnes du tableau.




18. Si nécessaire, indiquez le mode de réduction de l'état : 

	- Imprimer l'état sur plusieurs pages. Dans ce cas, l'utilisateur final devra assembler les pages. Pour plus de détails, consultez [Impression multipage](../WDChamp/1011065.md). 

	- Utiliser le mode paysage. 

	- Réduire l'état par rapport à l'original. Attention : selon le pourcentage de réduction choisi, l'état imprimé pourra devenir illisible. 




19. L'état en cours de création s'affiche sous l'éditeur d'états.



<a name="NOTE3_3"></a>


### Manipuler une rubrique de la requête intégrée depuis un code de l'état
<a name="manipuler_une_rubrique_requete_integree_depuis_code_etat_ELTPARAGRAPHE000371"></a>Pour accéder à une rubrique de la requête intégrée depuis un des codes de l'état, de ses champs ou de ses blocs, utilisez la syntaxe :

```txt
MaSource.MaRubrique
```


<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## État basé sur une requête paramétrée
<a name="etat_base_sur_une_requete_parametree_ELTTEXTE000698"></a>
<a name="EtatReq_Param"></a>
Une requête (intégrée ou indépendante) peut être paramétrée. Dans ce cas, une ou plusieurs conditions de sélection dépendent d'un paramètre lors de l'exécution de la requête. Ce paramètre pourra par exemple correspondre à la valeur d'un champ de saisie dans une fenêtre.

Par exemple, pour imprimer la facture du client X, il suffit de créer un état basé sur une requête paramétrée. Dans cette requête, le paramètre sera par exemple le nom du client. Pour imprimer l'état, il faudra donc préciser la valeur du paramètre avant de lancer l'impression :

- lors du test de l'état basé sur une requête paramétrée, une fenêtre s'affiche permettant de saisir les paramètres de la requête.

- en exécution, les paramètres de la requête doivent être spécifiés à l'aide de la fonction [iInitRequêteEtat](../WDLang5/3046021.md) (avant l'utilisation de la fonction [iImprimeEtat](../WDLang5/3046032.md)).


|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ER.png) | Important | Si la requête est créée avec le logiciel Etats & Requêtes, il n'est pas nécessaire d'utiliser la fonction [iInitRequêteEtat](../WDLang5/3046021.md) pour spécifier les paramètres de la requête. En effet, lors de l'exécution d'un état sur une requête paramétrée depuis le logiciel Etats & Requêtes, une fenêtre s'affiche permettant de saisir les paramètres de la requête. |



**Remarque** : Pour plus de détails sur les requêtes paramétrées, consultez [Requête paramétrée](../Editeurs/2032045.md).

<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Imprimer un état basé sur une requête
<a name="imprimer_etat_base_sur_une_requete_ELTTEXTE000740"></a>
Pour imprimer un état basé sur une requête, il faut distinguer deux cas :

- État sur une requête sans paramètre.

- État sur une requête avec paramètres.




Remarques :

- Si des paramètres doivent être passés à ***l'état***, ces paramètres doivent être indiqués dans la fonction [iImprimeEtat](../WDLang5/3046032.md), après le nom de l'état à imprimer. Pour plus de détails, consultez [Etat paramétré](../WDChamp/1011008.md).

- La propriété [NomSource](../Proprietes/2511035.md) utilisée dans le code de l'état permet de connaître et de changer le nom de la requête associée à l'état.


|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ER.png) | Important | Sous [le logiciel Etats & Requêtes](../Presentation/3088004.md), il est possible d'imprimer un état :<br><br>- soit en lançant une impression (icône ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Ico_Imprimer.gif)). <br><br>- soit en testant l'état (icône ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Ico_Go_Fenetre_WD_bl.gif)). <br><br><br>Il n'est donc pas nécessaire de programmer l'impression de l'état.<br><br>Lors de l'impression d'un état sur une requête avec paramètre, une fenêtre s'affiche permettant de saisir les paramètres de la requête. |




<a name="NOTE5_2"></a>


### Imprimer un état basé sur une requête sans paramètre
<a name="imprimer_etat_base_sur_une_requete_sans_parametre_ELTPARAGRAPHE000450"></a>Pour imprimer une requête sans paramètre, il suffit de :

1. Paramétrer la destination de l'impression de l'état :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) En WINDEV, grâce à la fonction [iDestination](../WDLang5/3046074.md) (visualisateur de rapports, impression dans un fichier HTML, ...).


 Pour plus de détails, consultez [Modes d'impression d'un état](../WDChamp/1011031.md).

2. Préciser le nom de l'état à imprimer grâce à la fonction [iImprimeEtat](../WDLang5/3046032.md).
	Par exemple :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Sous WINDEV : pour imprimer l'état "ETAT_Requete" :
			
		```wl
		// Ouvrir le visualisateur de rapports
		iDestination(iVisualisateur)
		// Impression de l'état ETAT_Requete
		iImprimeEtat(ETAT_Requete)
		```







<a name="NOTE5_3"></a>


### Imprimer un état basé sur une requête avec paramètres
<a name="imprimer_etat_base_sur_une_requete_avec_parametres_ELTPARAGRAPHE000504"></a>Pour imprimer une requête avec paramètres, il suffit de :

1. Paramétrer la destination de l'impression de l'état :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) En WINDEV, grâce à la fonction [iDestination](../WDLang5/3046074.md) (visualisateur de rapports, impression dans un fichier HTML, ...).


 Pour plus de détails, consultez [Modes d'impression d'un état](../WDChamp/1011031.md).

2. Passer les paramètres à la requête grâce à la fonction [iInitRequêteEtat](../WDLang5/3046021.md).

3. Préciser le nom de l'état à imprimer grâce à la fonction [iImprimeEtat](../WDLang5/3046032.md).




**Par exemple** : L'état "ETAT_Requete" est basé sur une requête paramétrée. Les paramètres attendus par la requête sont le nom de la société et le type de la société. Ces paramètres ont été saisis dans la fenêtre de lancement de l'impression de l'état.

- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Code WINDEV :
	
	```wl
	// Ouvrir le visualisateur de rapports
	iDestination(iVisualisateur)
	// Passer les paramètres à la requête associée à l'état
	iInitRequêteEtat(ETAT_Requete, NomSociété, TypeSociété)
	// Imprimer la liste des sociétés
	iImprimeEtat(ETAT_Requete)
	```



**Remarque** : Si certains paramètres attendus par la requête ne sont pas précisés (valeur correspondant à NULL par exemple), les conditions de sélection correspondant à ces paramètres seront ignorées.


- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDEtats.gif) ***Exemples didactiques (WINDEV)*** : **WD Etats** <br>Cet exemple montre les différentes méthodes pour réaliser un état :<br> <br>- impressions basées sur différentes sources de données (requêtes, variables, ...)<br>- impressions basées sur des champs (Table, Tableur, TCD, ...)<br>- impression d'états composés<br>- impressions spécifiques (portrait / paysage, état avec filigrane, état avec code-barres, ...)



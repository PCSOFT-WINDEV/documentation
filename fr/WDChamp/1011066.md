
## Etat sur une requête SQL réalisée sur une connexion (ODBC, ...)
			

<DIV class="specObsolete">
	<IMG style="float:left;margin-right:10px;" src="https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=warning_big.png"><B>Avertissement</B><BR>
	A partir de la version <B>19</B>,  ce type d'état n'est plus disponible en création. Les états existants continuent à fonctionner et peuvent être modifiés. 
</DIV><a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000300"></a>
Un état sur une requête SQL via une connexion permet d'imprimer des enregistrements provenant d'une base de données accessible via un driver ODBC spécifique ou via un Connecteur Natif. Cette requête est définie lors de la création de l'état.

**Caractéristiques d'un état sur une requête SQL via une connexion :**

- les ***paramètres de la connexion*** (nom de la connexion, nom de l'utilisateur, ...). Ces paramètres permettent d'accéder aux enregistrements à imprimer dans l'état.
	Pour une connexion ODBC, ces paramètres sont définis dans l'administrateur ODBC (dans le panneau de configuration de Windows).
	Pour une connexion via Accès Natif, ces paramètres sont définis lors de configuration de la base de données.

- le ***code SQL de la requête*** associée à l'état. Ce code doit obligatoirement correspondre à une requête de sélection (ordre "SELECT"). Cette requête permet de spécifier les différentes rubriques pouvant être imprimées dans l'état.




**Attention** : Ce code SQL doit être reconnu par la base de données accédée.

La création d'un état sur une requête SQL via une connexion s'effectue grâce à l'assistant de création d'un état. 

Lorsque l'état sur une requête SQL via une connexion est créé, il est possible à tout moment de :

- modifier le code SQL de la requête (onglet "Données" de la description de l'état).

- modifier les paramètres de la connexion (onglet "Données" de la description de l'état).

- ajouter ou supprimer des champs Rubriques liés à la requête SQL associée à l'état.






<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Créer un état sur une requête SQL sur fichier via une connexion
<a name="creer_etat_sur_une_requete_sql_sur_fichier_via_une_connexion_ELTTEXTE000324"></a>
Pour créer un état sur une requête SQL sur fichier via une connexion :

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide.

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". 

	- L'assistant de création d'un état s'affiche.




2. Choisissez la présentation de votre état (tableau, fiche, étiquette, ...). Pour plus de détails, consultez [Les différents types d'états](../WDChamp/1011054.md).

3. Sélectionnez la source de données de l'état (option "D'une requête SQL par connexion").

4. Sélectionnez dans la liste le type de connexion à utiliser (ODBC ou Accès Natif)

5. Spécifiez les paramètres de la connexion :

	- le nom de la connexion.

	- le nom de l'utilisateur.

	- le mot de passe de l'utilisateur.

	- le nom de la base de données accédée (s'il en existe plusieurs).




6. Saisissez le code SQL de la requête associée à l'état. 
	**Attention** : Ce code SQL doit être reconnu par la base de données accédée.

7. Pour grouper les enregistrements, il est possible de créer des ruptures sur les rubriques de tri. Pour créer des ruptures, répondez "Oui" à la question "Voulez-vous des ruptures dans l'état".
	L'étape suivante permet alors de sélectionner les rubriques de tri correspondant aux ruptures. Pour plus de détails sur les ruptures, consultez les [Ruptures dans un état](../WDChamp/1011028.md).

8. Pour chaque rubrique de la requête affichée dans l'état :

	- saisissez le libellé correspondant. Ce libellé sera affiché :

		- soit avant la rubrique. Par exemple :![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleFiche.gif)


		- soit dans l'entête de la colonne (cas des états Tableau). Par exemple :![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleTable.gif)
Ce libellé pourra être modifié directement sous l'éditeur d'états.

- sélectionnez le bloc dans lequel le champ associé à la rubrique doit être imprimé. La position des différents champs pourra être modifiée directement sous l'éditeur d'états. Pour plus de détails sur les différents blocs et sur leur position dans un état, consultez [Blocs d'un état](../WDChamp/1011040.md).

9. Modifiez si nécessaire l'ordre d'affichage des différents champs dans l'état à l'aide des boutons fléchés à droite du tableau.

10. Selon le type d'état en cours de création, indiquez les options spécifiques correspondantes.
	

| Type d'état | Options spécifiques |
| --- | --- |
| État sur formulaire | Image du formulaire, impression de l'image du formulaire, ...<br>Options détaillées dans la page [Etat sur formulaire](../WDChamp/1011067.md) |
| État Étiquette | Format des étiquettes, nombre d'exemplaires identiques, ...<br>Options détaillées dans la page [Etat Étiquette](../WDChamp/1011050.md) |



11. Spécifiez le format de la feuille sur laquelle l'état va être imprimé. Par défaut, l'état est imprimé sur une feuille au format A4.

12. Sélectionnez le gabarit de l'état si nécessaire.

13. Saisissez le nom et le titre de l'état (nom du fichier ".WDE" correspondant à l'état). Ce nom permettra d'identifier l'état dans vos programmes.

14. Validez la création de l'état. 

15. L'éditeur d'états propose automatiquement de changer le format de l'état utilisé si les conditions suivantes sont réunies :

	- l'état en cours de création comporte un tableau.

	- le format de l'état ne permet pas d'afficher l'ensemble des colonnes du tableau.




16. Si nécessaire, indiquez le mode de réduction de l'état : 

	- Imprimer l'état sur plusieurs pages. Dans ce cas, l'utilisateur final devra assembler les pages. Pour plus de détails, consultez [Impression multipage](../WDChamp/1011065.md).

	- Utiliser le mode paysage. 

	- Réduire l'état par rapport à l'original. Attention : selon le pourcentage de réduction choisi, l'état imprimé pourra devenir illisible. 




17. L'état en cours de création s'affiche sous l'éditeur d'états.






<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Imprimer un état sur une requête SQL via une connexion
<a name="imprimer_etat_sur_une_requete_sql_via_une_connexion_ELTTEXTE000348"></a>
Pour imprimer un état sur une requête SQL via une connexion, il suffit de :

1. Paramétrer la destination de l'impression de l'état :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) En WINDEV, grâce à la fonction [iAperçu](../WDLang5/3046069.md) (aperçu avant impression, impression dans un fichier HTML, ...).

	- 
			Pour plus de détails, consultez [Modes d'impression d'un état](../WDChamp/1011031.md).




2. Préciser le nom de l'état à imprimer grâce à la fonction [iImprimeEtat](../WDLang5/3046032.md).




**Remarques** :

- Les propriétés [ODBCMotDePasse](../Proprietes/2511031.md), [ODBCNomBase](../Proprietes/2511034.md), [ODBCNomConnexion](../Proprietes/2511033.md), [ODBCNomUtilisateur](../Proprietes/2511019.md) utilisées dans le code de l'état permettent de connaître et de modifier les paramètres de la connexion.

- La propriété [ODBCCodeSQL](../Proprietes/2511028.md) utilisée dans le code de l'état permettent de connaître et de changer le code SQL de la requête SQL.


|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ER.png)<br> | Important | Sous [le logiciel Etats & Requêtes](../Presentation/3088004.md), il est possible d'imprimer un état :<br><br>- soit en lançant une impression (icône  ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Ico_Imprimer.gif)<br>). <br><br>- soit en testant l'état (icône ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Ico_Go_Fenetre_WD_bl.gif)<br>). <br><br><br>Il n'est donc pas nécessaire de programmer l'impression de l'état. |






<a name="NOTE3_2"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png) 

### Exemple WINDEV et WEBDEV
<a name="exemple_windev_webdev_ELTPARAGRAPHE000210"></a>L'état "ETAT_Client" est un état basé sur une requête SQL réalisée sur la base de données Access "Client". Cette base de données est accédée via le driver ODBC d'Access. Par défaut, cet état permet d'imprimer toutes les caractéristiques des clients.

L'utilisateur peut au choix :

- cliquer sur le bouton "BTN_CaractéristiquesClient" pour imprimer toutes les caractéristiques des clients. Le code SQL de la requête ne sera pas modifié.

- cliquer sur le bouton "BTN_NomPrénomClient" pour imprimer uniquement le nom et le prénom des clients. Le code SQL de la requête sera modifié.




Pour savoir si le code SQL de la requête doit être modifié ou non, un paramètre est passé à l'état :

- "Vrai" : pas de modification du code SQL.

- "Faux" : modification du code SQL.




**Dans cet exemple** :

- le code de clic du bouton "BTN_CaractéristiquesClient" est le suivant :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Code WINDEV :
			
		```wl
		// Ouvrir la fenêtre d'aperçu
		iAperçu()
		// Imprimer l'état avec le passage de paramètre
		iImprimeEtat(ETAT_Client, "Vrai")
		```





- le code de clic du bouton "BTN_NomPrénomClient" est le suivant :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Code WINDEV :
			
		```wl
		// Ouvrir la fenêtre d'aperçu
		iAperçu()
		// Imprimer l'état avec le passage de paramètre
		iImprimeEtat(ETAT_Client, "Faux")
		```





- le code de l'événement "Ouverture" de l'état "ETAT_Client" est le suivant :
	
	```wl
	// Récupérer le paramètre passé à l'état
	PROCEDURE ETAT_Client(Choix)
	SI Choix = "Faux" ALORS
		// Modifier le code SQL
		ETAT_Client..ODBCCodeSQL = "Select Nom, Prénom FROM Client"
	FIN
	```












## Etat sur un fichier texte
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000523"></a>
Dans un état sur un fichier texte, les informations à imprimer sont lues dans un fichier au format texte et sont directement affectées dans les champs de l'état.

Ce type d'état convient particulièrement lorsque les informations à imprimer sont présentes dans un fichier au format texte (exportation de données depuis Excel par exemple).

**Caractéristiques d'un état sur un fichier texte** : Chaque ligne du fichier texte doit correspondre à un enregistrement. Chaque ligne contient plusieurs informations, appelées rubriques. Chaque rubrique est séparée par un séparateur.
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=EtatFichierTexte.gif)
**Pour créer un état sur un fichier texte**, il est possible :

- soit d'utiliser ***l'assistant de création d'un état sur un fichier texte***. La création de l'état et la lecture des enregistrements sont automatiquement réalisées par l'éditeur d'états. Aucune programmation n'est nécessaire.

- soit de ***programmer entièrement la lecture des enregistrements***. La création de l'état est simplifiée grâce à l'assistant de création des états. Cependant, la lecture des enregistrements dans le fichier texte nécessite une programmation complète en WLangage.




Lorsque l'état sur un fichier texte est créé, il est possible à tout moment de :

- modifier la source de données de l'état (onglet "Données" de la description de l'état).

- modifier la méthode de lecture des enregistrements de l'état (lecture automatique ou programmée). Pour plus de détails, consultez Modifier la méthode de lecture des enregistrements d'un état sur un fichier texte.

- ajouter ou supprimer des champs Rubriques liés au fichier texte associé à l'état.




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Utiliser l'assistant de création d'un état sur un fichier texte
<a name="utiliser_assistant_creation_etat_sur_fichier_texte_ELTTEXTE000547"></a>


### Création d'un état sur un fichier texte avec lecture automatique des enregistrements
<a name="creation_etat_sur_fichier_texte_avec_lecture_automatique_des_enregistrements_ELTPARAGRAPHE000033"></a>Pour créer un état sur un fichier texte avec lecture automatique des enregistrements : 

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". 

	- L'assistant de création d'un état s'affiche.




2. Choisissez la présentation de votre état (tableau, fiche, étiquette, ...). Pour plus de détails, consultez [Les différents types d'états](../WDChamp/1011054.md).

3. Sélectionnez si nécessaire le modèle d'états à utiliser. Un modèle d'états permet de respecter une mise en page spécifique. Pour plus de détails sur les modèles d'états, consultez [Les modèles d'états](../WDChamp/9000105.md). 

4. Sélectionnez la source de données de l'état (option "Autre (programmation, fichier texte, zone mémoire, vue HFSQL, ...)"). 

5. Sélectionnez la source de données de l'état (option "D'un fichier texte").

6. Sélectionnez l'option "Je veux que tout soit automatique".

7. Spécifiez le nombre de rubriques contenues dans le fichier texte. Ce nombre correspond au nombre d'informations contenues dans chaque enregistrement.

8. Spécifiez le séparateur utilisé pour séparer les rubriques d'un enregistrement :

	- "TAB" si le séparateur correspond à une tabulation.

	- ";" si le séparateur correspond à un point-virgule.

	- ":" si le séparateur correspond à deux points.

	- ...




9. Sélectionnez le fichier texte contenant les enregistrements.
	Remarques :

	- Les libellés des rubriques ne doivent pas être spécifiés dans ce fichier texte. Par exemple :![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=EtatFichierTexte3.gif)


	- Lors du déploiement d'une application contenant un état sur un fichier texte avec lecture automatique des enregistrements, certaines règles doivent être respectées. Pour plus de détails, consultez le paragraphe Caractéristiques du fichier texte lors du déploiement de l'application.

10. Pour chaque rubrique du fichier texte affiché dans l'état :

	- saisissez le libellé correspondant. Ce libellé sera affiché :

		- soit avant la rubrique. Par exemple :![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleFiche.gif)


		- soit dans l'entête de la colonne (cas des états Tableau). Par exemple :![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=etatLibelleTable.gif)
Ce libellé pourra être modifié directement sous l'éditeur d'états.

- sélectionnez le bloc dans lequel le champ associé à la rubrique doit être imprimé. La position des différents champs pourra être modifiée directement sous l'éditeur d'états. Pour plus de détails sur les différents blocs et sur leur position dans un état, consultez [Blocs d'un état](../WDChamp/1011040.md).

11. Modifiez si nécessaire l'ordre d'affichage des différents champs dans l'état à l'aide des boutons fléchés à droite du tableau.

12. Selon le type d'état en cours de création, indiquez les options spécifiques correspondantes.
	

| Type d'état | Options spécifiques |
| --- | --- |
| État sur formulaire | Image du formulaire, impression de l'image du formulaire, ...<br>Options détaillées dans la page [Etat sur formulaire](../WDChamp/1011067.md) |
| État Étiquette | Format des étiquettes, nombre d'exemplaires identiques, ...<br>Options détaillées dans la page [Etat Étiquette](../WDChamp/1011050.md) |



13. Spécifiez le format de la feuille sur laquelle l'état va être imprimé. Par défaut, l'état est imprimé sur une feuille au format A4. 
	Remarque : Par défaut, les champs de l'état sont disposés sur une seule colonne. Pour réaliser un état multicolonne, il suffit de spécifier le nombre de colonnes voulues dans l'onglet "Format" de la fenêtre de description de l'état. 

14. Sélectionnez le gabarit de l'état si nécessaire.

15. Saisissez le nom et le titre de l'état (nom du fichier ".WDE" correspondant à l'état). Ce nom permettra d'identifier l'état dans vos programmes.
	![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Il est également possible d'indiquer si l'état peut être modifié par l'utilisateur final sous le logiciel "Etats & Requêtes". 

16. Validez la création de l'état. 

17. L'éditeur d'états propose automatiquement de changer le format de l'état utilisé si les conditions suivantes sont réunies :

	- l'état en cours de création comporte un tableau.

	- le format de l'état ne permet pas d'afficher l'ensemble des colonnes du tableau.




18. Si nécessaire, indiquez le mode de réduction de l'état : 

	- Imprimer l'état sur plusieurs pages. Dans ce cas, l'utilisateur final devra assembler les pages. Pour plus de détails, consultez [Impression multipage](../WDChamp/1011065.md). 

	- Utiliser le mode paysage. 

	- Réduire l'état par rapport à l'original. Attention : selon le pourcentage de réduction choisi, l'état imprimé pourra devenir illisible. 




19. L'état en cours de création s'affiche sous l'éditeur d'états.



<a name="NOTE2_2"></a>


### Caractéristiques du fichier texte lors du déploiement de l'application
<a name="caracteristiques_fichier_texte_lors_deploiement_application_ELTPARAGRAPHE000134"></a>Lors du déploiement d'une application contenant un état sur un fichier texte, les trois cas suivants peuvent se présenter :

- Si **le fichier texte est fourni avec l'application**, il est conseillé d'inclure ce fichier texte dans la bibliothèque de l'application.
	**Attention** : Le contenu de ce fichier ne pourra pas être modifié sur le poste de l'utilisateur final.

- Si **le contenu du fichier texte risque d'être modifié sur le poste de l'utilisateur final**, lors de l'impression de l'état, le fichier texte sera recherché sur le poste de l'utilisateur final dans l'ordre suivant :

	1. dans les bibliothèques associées à l'application et chargées en mémoire lors de l'impression de l'état.

	2. dans le répertoire spécifié lors de la création de l'état.

	3. dans le répertoire courant.

	4. dans le répertoire d'installation de l'application.




- Si **le fichier texte spécifié lors de la création de l'état est différent de celui utilisé par l'utilisateur final** (chemin et nom différent), l'utilisateur devra sélectionner le fichier grâce à un sélecteur de fichiers. Après sélection du fichier texte, il est par exemple possible d'effectuer les opérations suivantes :

	- récupérer le nom et le chemin du texte sélectionné par l'utilisateur dans une variable.

	- modifier la source de données de l'état grâce à la propriété [NomSource](../Proprietes/2511035.md).







<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Programmer entièrement la lecture des enregistrements
<a name="programmer_entierement_lecture_des_enregistrements_ELTTEXTE000577"></a>


### Présentation
<a name="presentation_ELTPARAGRAPHE000160"></a>Pour créer un état sur un fichier texte en programmant entièrement la lecture des enregistrements, deux étapes sont nécessaires :

1. Création de l'état à l'aide de l'assistant de création.

2. Programmation de la lecture des enregistrements.



<a name="NOTE3_2"></a>


### Créer un état sur un fichier texte avec lecture programmée des enregistrements
<a name="creer_etat_sur_fichier_texte_avec_lecture_programmee_des_enregistrements_ELTPARAGRAPHE000170"></a>Pour créer un état sur un fichier texte avec lecture programmée des enregistrements :

1. Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". 

	- L'assistant de création d'un état s'affiche.




2. Choisissez la présentation de votre état (tableau, fiche, étiquette, ...). Pour plus de détails, consultez [Les différents types d'états](../WDChamp/1011054.md).

3. Sélectionnez si nécessaire le modèle d'états à utiliser. Un modèle d'états permet de respecter une mise en page spécifique. Pour plus de détails sur les modèles d'états, consultez [Les modèles d'états](../WDChamp/9000105.md). 

4. Sélectionnez la source de données de l'état (option "Autre (programmation, fichier texte, zone mémoire, vue HFSQL, ...)"). 

5. Sélectionnez la source de données de l'état (option "D'un fichier texte").

6. Sélectionnez l'option "Je veux programmer la lecture de mon fichier".

7. Si l'état en cours de création :

	- comporte un **tableau** (état de type Tableau ou de type Tableau + Graphe) :

		- spécifiez le nombre de colonnes présentes dans le tableau.

		- pour chaque colonne, spécifiez le libellé et le type de la valeur imprimée.

		- modifiez si nécessaire l'ordre des différentes colonnes.




- est un **état sur formulaire**, il est nécessaire de spécifier des options spécifiques au formulaire (l'image du formulaire, l'impression de l'image du formulaire, ...). Ces options sont détaillées dans la page [Etat sur formulaire](../WDChamp/1011067.md).

- est un **état Étiquette**, il est nécessaire de spécifier des options spécifiques aux étiquettes (format des étiquettes, nombre d'exemplaires identiques, ...). Ces options sont détaillées dans la page [Etat Étiquette](../WDChamp/1011050.md).

8. Spécifiez le format de la feuille sur laquelle l'état va être imprimé. Par défaut, l'état est imprimé sur une feuille au format A4. 
	Remarque : Par défaut, les champs de l'état sont disposés sur une seule colonne. Pour réaliser un état multicolonne, il suffit de spécifier le nombre de colonnes voulues dans l'onglet "Format" de la fenêtre de description de l'état. 

9. Sélectionnez le gabarit de l'état si nécessaire.

10. Saisissez le nom et le titre de l'état (nom du fichier ".WDE" correspondant à l'état). Ce nom permettra d'identifier l'état dans vos programmes. 
	![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Il est également possible d'indiquer si l'état peut être modifié par l'utilisateur final sous le logiciel "Etats & Requêtes". 

11. Validez la création de l'état. 

12. L'éditeur d'états propose automatiquement de changer le format de l'état utilisé et/ou de réduire le tableau si les conditions suivantes sont réunies :

	- le format de l'état ne permet pas d'afficher l'ensemble des colonnes du tableau.

	- l'état en cours de création comporte un tableau.




13. Si nécessaire, indiquez le mode de réduction de l'état : 

	- Imprimer l'état sur plusieurs pages. Dans ce cas, l'utilisateur final devra assembler les pages. Pour plus de détails, consultez [Impression multipage](../WDChamp/1011065.md). 

	- Utiliser le mode paysage. 

	- Réduire l'état par rapport à l'original. Attention : selon le pourcentage de réduction choisi, l'état imprimé pourra devenir illisible. 




14. L'état en cours de création s'affiche sous l'éditeur d'états.



<a name="NOTE3_3"></a>


### Programmer la lecture des enregistrements
<a name="programmer_lecture_des_enregistrements_ELTPARAGRAPHE000235"></a>La programmation nécessaire à la lecture des enregistrements est illustrée par l'exemple suivant: 

L'ensemble des informations à imprimer est contenu dans le fichier Produit.TXT. Chaque ligne du fichier correspond à un enregistrement. Les données sont affichées dans des champs rubriques. Les différentes rubriques sont séparées par des tabulations ("TAB").


Pour programmer la lecture des enregistrements, la méthode est la suivante :

1. Ouverture du fichier texte dans l'événement "Ouverture" de l'état (fonction [fOuvre](../WDLang1/3036036.md)).
	**Remarque** : Les libellés des rubriques ne doivent pas être spécifiés dans ce fichier texte.
	
	```wl
	GLOBAL
		gfsLigne est une chaîne = ""
		gfnIDFichier est un entier = 0	   // Identifiant du fichier texte
	LOCAL
		sFichierTexte est une chaîne = fRepEnCours() + "\Etats\Produit.txt"
		gfnIDFichier = fOuvre(sFichierTexte, foLecture)	   // Ouvrir le fichier texte
	SI gfnIDFichier = -1 ALORS
		Erreur(ErreurInfo())
		iFermeEtat()	     // Arrêter le traitement de l'état
	FIN
	```


2. Dans l'événement "Lecture des données de l'état" :

	- Lecture de chaque ligne du fichier texte (fonction [fLitLigne](../WDLang1/3036031.md)).

	- Gestion de la fin du fichier texte. Selon le cas, les valeurs suivantes sont renvoyées :

		- <u><u><u><u>Vrai</u></u></u></u> : fin du fichier non atteinte (étape 3 exécutée).

		- <u><u><u><u>Faux</u></u></u></u> : fin du fichier atteinte (étape 4 exécutée).
						
			```wl
			// Extraire les données du fichier pour les afficher dans l'état 
			gfsLigne = fLitLigne(gfnIDFichier)
			// Fin du fichier atteinte ?
			SI gfsLigne = EOT OU gfsLigne = "" ALORS 
				RENVOYER Faux
			SINON 
				RENVOYER Vrai
			FIN
			```





3. L'événement "Avant impression" du bloc CORPS permet de gérer les enregistrements du fichier :

	- Extraction des différentes rubriques de l'enregistrement en cours (fonction [ExtraitChaîne](../WDLang1/3024017.md)).

	- Affectation des valeurs extraites dans les champs de l'état.
			
		```wl
		nPrix est un entier = 0
		nPrix = ExtraitChaîne(gfsLigne, 4, TAB) 
		// Initialiser les colonnes du tableau
		RUB_Référence = ExtraitChaîne(gfsLigne, 2, TAB)
		RUB_Description = ExtraitChaîne(gfsLigne, 3, TAB)
		RUB_Prix = nPrix
		RUB_Codebarre = ExtraitChaîne(gfsLigne, 5, TAB) 
		RUB_Famille = ExtraitChaîne(gfsLigne, 6, TAB)
		```





4. L'événement "Fermeture" de l'état permet de fermer le fichier texte lorsque la fin de ce fichier est atteinte (fonction [fFerme](../WDLang1/3036027.md)).
	
	```wl
	// Fermer le fichier 
	fFerme(gfnIDFichier)
	```




<a name="NOTE3_4"></a>


### Ordre d'exécution des différents événements WLangage
<a name="ordre_execution_des_differents_evenements_wlangage_ELTPARAGRAPHE000290"></a>L'ordre d'exécution des différents événements WLangage permettant de lire les enregistrements est présenté dans le tableau suivant :

| Ordre d'exécution des événements de l'état | Programmation nécessaire à la lecture du fichier texte |
| --- | --- |
| **1.** Ouverture de l'état | Ouverture du fichier texte (fonction [fOuvre](../WDLang1/3036036.md)). |
| **2.** Lecture des données de l'état | Lecture de chaque ligne du fichier texte (fonction [fLitLigne](../WDLang1/3036031.md)) et gestion de la fin du fichier texte. |
| **3.** Avant impression du bloc *Corps* | Extraction des différentes rubriques de l'enregistrement en cours (fonction [ExtraitChaîne](../WDLang1/3024017.md)) et affectation des valeurs extraites dans les champs de l'état. |
| **4.** Fermeture de l'état | Fermeture du fichier texte (fonction [fFerme](../WDLang1/3036027.md)). |



<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Modifier la méthode de lecture des enregistrements d'un état sur un fichier texte
<a name="modifier_methode_lecture_des_enregistrements_etat_sur_fichier_texte_ELTTEXTE000619"></a>
Lorsque l'état sur un fichier texte est créé, il est possible à tout moment de modifier la méthode de lecture des enregistrements (lecture automatique ou programmée).

Cette méthode est définie dans l'onglet "Données" de la description de l'état.

**Pour passer d'une lecture automatique à une lecture programmée** :

1. Affichez la fenêtre de description de l'état en utilisant une des méthodes suivantes : 

	- option "Description de l'état" du menu contextuel de l'état. 

	- sous le volet "Modification", cliquez sur l'icône de regroupement ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_regroup.gif)
 du groupe "Etat". 




2. Affichez l'onglet "Données" de la description de l'état.

3. Cochez l'option "Je veux programmer la lecture de mon fichier".

4. Programmez la lecture des enregistrements. Pour plus de détails, consultez le paragraphe [Programmer la lecture des enregistrements](#NOTE3_3).




**Pour passer d'une lecture programmée à une lecture automatique** :

1. Affichez la fenêtre de description de l'état en utilisant une des méthodes suivantes : 

	- option "Description de l'état" du menu contextuel de l'état. 

	- sous le volet "Modification", cliquez sur l'icône de regroupement ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_regroup.gif)
 du groupe "Etat". 




2. Affichez l'onglet "Données" de la description de l'état.

3. Cochez l'option "Tout automatique".

4. Spécifiez le nombre de rubriques contenues dans le fichier texte.

5. Spécifiez le séparateur utilisé pour séparer les différentes rubriques :

	- "TAB" si le séparateur correspond à une tabulation.

	- ";" si le séparateur correspond à un point-virgule.

	- ":" si le séparateur correspond à deux points.

	- ...




6. Sélectionnez le fichier texte contenant les enregistrements.
	Remarques :

	- Les libellés des rubriques ne doivent pas être spécifiés dans ce fichier texte. Par exemple :![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=EtatFichierTexte3.gif)


	- Lors du déploiement d'une application contenant un état sur un fichier texte avec lecture automatique des enregistrements, certaines règles doivent être respectées. Pour plus de détails, consultez le paragraphe [Caractéristiques du fichier texte lors du déploiement de l'application](#NOTE2_2).

7. Supprimez l'ensemble des lignes de codes spécifiques à la lecture des enregistrements.




<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Imprimer un état sur un fichier texte
<a name="imprimer_etat_sur_fichier_texte_ELTTEXTE000643"></a>
L'impression d'un état sur un fichier texte est identique quel que soit le type de lecture des enregistrements (automatique ou programmée). Il suffit de :

1. Paramétrer la destination de l'impression de l'état :

	- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) **En WINDEV**, grâce à la fonction [iDestination](../WDLang5/3046074.md) (visualisateur de rapports, impression dans un fichier HTML, ...).


 Pour plus de détails, consultez [Modes d'impression d'un état](../WDChamp/1011031.md).

2. Préciser le nom de l'état à imprimer grâce à la fonction [iImprimeEtat](../WDLang5/3046032.md).




Remarques :

- Si des paramètres supplémentaires doivent être passés à l'état, ces paramètres doivent être indiqués dans la fonction [iImprimeEtat](../WDLang5/3046032.md), après le nom de l'état à imprimer.

- La propriété [NomSource](../Proprietes/2511035.md) utilisée dans le code de l'état permet de connaître et de changer le nom du fichier texte associé à l'état (dans le cas où la lecture des enregistrements est automatique).


|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ER.png)<br> | Important | Sous [le logiciel Etats & Requêtes](../Presentation/3088004.md), il est possible d'imprimer un état :<br><br>- soit en lançant une impression (icône ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Ico_Imprimer.gif)<br>). <br><br>- soit en testant l'état (icône ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Ico_Go_Fenetre_WD_bl.gif)<br>). <br><br><br>Il n'est donc pas nécessaire de programmer l'impression de l'état. |




<a name="NOTE5_2"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png) 

### Exemple WINDEV et WINDEV Mobile
<a name="exemple_windev_windev_mobile_ELTPARAGRAPHE000449"></a>L'état "ETAT_Client" est un état basé sur le fichier texte "Client.TXT". Ce fichier texte contient les caractéristiques des clients.

L'état "ETAT_Client" s'imprime lors d'un clic sur le bouton "BTN_Client".

Dans cet exemple, le code de clic du bouton "BTN_Client" est le suivant :

![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) **Code WINDEV** :

```wl
// Ouvrir le visualisateur de rapports
iDestination(iVisualisateur)
// Imprimer l'état ETAT_Client
iImprimeEtat(ETAT_Client)
```

<a name="NOTE5_3"></a>


- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDEtats.gif) ***Exemples didactiques (WINDEV)*** : **WD Etats** <br>Cet exemple montre les différentes méthodes pour réaliser un état :<br> <br>- impressions basées sur différentes sources de données (requêtes, variables, ...)<br>- impressions basées sur des champs (Table, Tableur, TCD, ...)<br>- impression d'états composés<br>- impressions spécifiques (portrait / paysage, état avec filigrane, état avec code-barres, ...)






## Créer des états imbriqués
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Créer un état imbriqué
<a name="creer_etat_imbrique_ELTTEXTE000261"></a>


### Principe
<a name="principe_ELTPARAGRAPHE000011"></a>La création d'un état principal composé de plusieurs états secondaires est réalisée en plusieurs étapes :

1. Création d'un état principal.

2. Création du ou des états secondaires. Ces états peuvent avoir une orientation différente de l'état principal.

3. Impression des états secondaires dans l'état principal grâce à la fonction [iImprimeEtat](../WDLang5/3046032.md). Cette fonction doit être utilisée :

	- soit dans l'événement "**Avant** impression" d'un bloc : l'état secondaire sera imprimé **avant** ce bloc.

	- soit dans l'événement "**Après** impression" d'un bloc : l'état secondaire sera imprimé **après** ce bloc.
			**Attention** : ***Si les états imbriqués ont des orientations différentes***, il est nécessaire d'appeler la fonction [iParamètre](../WDLang5/3046008.md) afin de changer l'orientation de l'impression en conséquence.




4. Configuration de l'impression des hauts et bas de pages de l'état imbriqué (fonction [iHautBasPageImbriqué](../WDLang5/3046047.md)). Cette fonction peut être utilisée :

	- soit dans le code d'ouverture de l'état principal : elle sera prise en compte pour tous les états imbriqués qui seront imprimés depuis l'état principal.

	- soit directement avant l'impression de l'état imbriqué : elle sera prise en compte uniquement pour l'état imbriqué suivant.




5. Impression de l'état principal. Pour plus de détails, consultez [Imprimer un état principal composé de plusieurs états secondaires](../WDChamp/1011006.md).




**Remarque** : Pour effectuer des impressions utilisant des états avec des orientations différentes (portrait/paysage), il est conseillé d'utiliser l'enchaînement d'états. Cette méthode est très simple à mettre en oeuvre. Pour plus de détails, consultez [Enchaîner des états](../WDChamp/9000128.md). 

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Exemple 1 : Etats imbriqués simples
<a name="exemple_1_etats_imbriques_simples_ELTTEXTE000285"></a>


### Exemple à réaliser
<a name="exemple_realiser_ELTPARAGRAPHE000053"></a>L'état "ETAT_Commande" est un état basé sur le fichier de données "Commande". Cet état permet d'imprimer les caractéristiques de chaque commande (date de commande, numéro client, montant de la commande, ...). Une rupture sur la rubrique "NumCommande" permet de séparer les différentes commandes.

La requête "REQ_ProduitCommandé" sélectionne l'ensemble des produits d'une commande spécifiée. Cette requête attend en paramètre un numéro de commande.

L'état "ETAT_ProduitCommandé" est basé sur la requête "REQ_ProduitCommandé". Cet état imprime uniquement les produits sélectionnés par la requête "REQ_ProduitCommandé".

L'état "ETAT_ProduitCommandé" correspond à l'état secondaire. Cet état sera imprimé après chaque rupture.


### Manipulations à effectuer
<a name="manipulations_effectuer_ELTPARAGRAPHE000064"></a>

1. Créez l'état "ETAT_Commande" : cet état correspond à l'état principal. 

	- Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat".




2. Créez la requête "REQ_ProduitCommandé". Pour plus de détails, consultez [Créer une requête paramétrée](../Editeurs/2032045.md).

3. Créez l'état "ETAT_ProduitCommandé" : cet état correspond à l'état secondaire. 

	- Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat". 
			**Remarque** : Le bloc *Pied de page* de cet état ne sera pas imprimé. Pour plus de détails sur les blocs de l'état imbriqué imprimés, consultez le paragraphe [Blocs de l'état secondaire](#NOTE3_1).




4. Dans l'événement "Après impression" du bloc *Fin de rupture* de l'état "ETAT_Commande", saisissez le code suivant :
	
	```wl
	// Initialiser la requête et
	// passer en paramètre le numéro de commande en cours d'impression
	iInitRequêteEtat(ETAT_ProduitCommandé, MaSource.NumCommande)
	// Imprimer l'état imbriqué
	iImprimeEtat(ETAT_ProduitCommandé)
	```







## Exemple 2 : Etats imbriqués avec des orientations différentes (Paysage/Portrait)
<a name="exemple_2_etats_imbriques_avec_des_orientations_differentes_paysageportrait_ELTTEXTE000315"></a>


### Exemple à réaliser
<a name="exemple_realiser_ELTPARAGRAPHE000093"></a>L'état principal est en paysage "ETAT_PAYSAGE". Pour chaque élément imprimé, un sous-état en portrait "ETAT_PORTRAIT" soit être appelé. Dans le code "Après impression" du bloc corps de l'état principal, il est nécessaire de lancer l'état secondaire en changeant l'orientation. Ensuite, l'état secondaire doit rétablir l'orientation de l'état principal en fin d'impression. 


### Manipulations à effectuer
<a name="manipulations_effectuer_ELTPARAGRAPHE000098"></a>

1. Créez l'état "ETAT_PAYSAGE" : cet état correspond à l'état principal. 

	- Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat".

	- Choisissez une orientation en mode paysage.
			**Remarque** : Cet état peut être un état de n'importe quel type utilisant des données provenant de n'importe quelle source : fichier, requête, table, programmation, ...




2. Dans la description de l'état principal, dans l'onglet "Options", cochez "Imprimer l'état tel quel".

3. Dans l'onglet "Format", indiquez les marges et le retrait. Validez la fenêtre de description de l'état. 

4. Créez l'état "ETAT_PORTRAIT" : cet état correspond à l'état secondaire. 

	- Cliquez sur ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_nouveau.gif)
 parmi les boutons d'accès rapide. 

	- La fenêtre de création d'un nouvel élément s'affiche : cliquez sur "Etat" puis sur "Etat".

	- Choisissez une orientation en mode portrait.
			**Remarque** : Cet état peut être un état de n'importe quel type utilisant des données provenant de n'importe quelle source : fichier, requête, table, programmation, ...




5. Dans la description de l'état secondaire, dans l'onglet "Options", cochez "Imprimer l'état tel quel".

6. Dans l'onglet "Format", indiquez les mêmes marges et le même retrait que dans l'état principal. Validez la fenêtre de description de l'état. 

7. Dans l'événement "Après impression" du bloc *BAS DE PAGE* de l'état "ETAT_PAYSAGE" (état principal), saisissez le code suivant :
	
	```wl
	// Appel de l'état qui a une orientation différente (donc en portrait ici)
	iImprimeEtat(ETAT_PORTRAIT)
	// Note : Si cet état secondaire à un bas de page, ce bas de page ne sera pas imprimé.
	```





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Particularités des états secondaires
<a name="particularites_des_etats_secondaires_ELTTEXTE000345"></a>


### Blocs de l'état secondaire
<a name="blocs_etat_secondaire_ELTPARAGRAPHE000135"></a>Par défaut, lors de l'impression d'un état secondaire (grâce à la fonction [iImprimeEtat](../WDLang5/3046032.md)), tous les blocs de l'état secondaire sont imprimés sauf les blocs suivants :

- le bloc *En-tête de page*.

- le bloc *Pied de page*.




Pour forcer l'impression de ces blocs, utilisez la fonction [iHautBasPageImbriqué](../WDLang5/3046047.md).

**Remarque** : Si l'état secondaire contient un tableau dont l'entête est présent dans le bloc *En-tête de page*, seul le bloc *Pied de page* ne sera pas imprimé (tous les autres blocs seront imprimés). Dans ce cas, le bloc *En-tête de page* sera imprimé avant la première ligne du tableau (de l'état secondaire).
<a name="NOTE3_2"></a>


### Orientation de l'état secondaire
<a name="orientation_etat_secondaire_ELTPARAGRAPHE000155"></a>L'état secondaire et l'état principal peuvent avoir des orientations différentes. Il est cependant nécessaire dans ce cas d'appeler la fonction [iParamètre](../WDLang5/3046008.md) afin de modifier l'orientation de l'impression en conséquence.

**Remarque** : Pour effectuer des impressions utilisant des états avec des orientations différentes (portrait/paysage), il est conseillé d'utiliser l'enchaînement d'états. Cette méthode est très simple à mettre en oeuvre. Pour plus de détails, consultez [Enchaîner des états](../WDChamp/9000128.md).
<a name="NOTE3_3"></a>


### Saut de page de l'état secondaire
<a name="saut_page_etat_secondaire_ELTPARAGRAPHE000172"></a>Les sauts de page définis dans un état secondaire seront pris en compte lors de l'impression de l'état principal.
<a name="NOTE3_4"></a>


### État secondaire basé sur une requête paramétrée
<a name="etat_secondaire_base_sur_une_requete_parametree_ELTPARAGRAPHE000179"></a>Si l'état secondaire est basé sur une requête paramétrée, utilisez la fonction [iInitRequêteEtat](../WDLang5/3046021.md) pour passer les paramètres à la requête. Cette fonction doit être utilisée avant la fonction [iImprimeEtat](../WDLang5/3046032.md).
<a name="NOTE3_5"></a>


### État secondaire basé sur une requête utilisant une connexion spécifique
<a name="etat_secondaire_base_sur_une_requete_utilisant_une_connexion_specifique_ELTPARAGRAPHE000192"></a>Si l'état secondaire est basé sur une requête manipulant une connexion spécifique, utilisez la fonction [iInitRequêteEtatConnexion](../WDLang5/3046028.md) pour exécuter cette requête (et lui passer si nécessaire des paramètres). Cette fonction doit être utilisée avant la fonction [iImprimeEtat](../WDLang5/3046032.md).
<a name="NOTE3_6"></a>


### État secondaire imprimé depuis un bloc de bas de page
<a name="etat_secondaire_imprime_depuis_bloc_bas_page_ELTPARAGRAPHE000205"></a>Si l'état secondaire est imprimé depuis un bloc de bas de page, ses blocs de bas de page ne seront pas imprimés.
<a name="NOTE3_7"></a>


### Affichage du nombre de pages total de l'état secondaire
<a name="affichage_nombre_pages_total_etat_secondaire_ELTPARAGRAPHE000212"></a>Il faut ajouter un compteur de pages dans l'état principal pour que le compteur de pages de l'état imbriqué fonctionne. Il est cependant possible de rendre invisible le compteur de l'état principal si nécessaire.



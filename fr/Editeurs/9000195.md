
## Android 10 : Modification de comportement des applications
			

<DIV class="specObsolete">
	<IMG style="float:left;margin-right:10px;" src="https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=warning_big.png"><B>Avertissement</B><BR>
	A partir de la version <B>26 (93)</B>,  WINDEV Mobile gère Android 11. Pour plus de détails, consultez [Android 11&nbsp;: Modification de comportement des applications](../Editeurs/9000201.md). 
</DIV><a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000233"></a>
Après chaque déploiement d'une nouvelle version de Android, Google demande à relever le niveau d'API cible "TargetSdkVersion" des applications pour les déployer dans le Play Store. Avec la sortie de Android 10, le niveau d'API imposé pour que Google autorise le déploiement doit être à 29. Ce nouveau niveau d'API s'applique à partir du :

- 3 août 2020 pour les nouvelles applications,

- 2 novembre 2020 pour les applications mises à jour.




**Voici les changements qui s'appliquent aux applications** :

1. **Lorsque l'exécution se fait sous Android 10**

	- L'ouverture d'une fenêtre n'est plus autorisée lorsque l'application est en arrière-plan. Pour plus de détails, consultez le paragraphe [Comportement des applications en arrière-plan](#NOTE1_1b). 

	- Il n'est plus autorisé de récupérer un identifiant unique pour l'appareil avec les fonctions [SysIMEI](../WDLang1/3073029.md) et [SysNumSérie](../WDLang1/3073033.md). Les applications qui sont "device owner" ne sont pas concernées par cette limitation.

	- Il n'est plus autorisé de manipuler par programmation les paramètres de connexions en WiFi. Les fonctions [WiFiActive](../WDLang3/1000019350.md) (syntaxe pour modifier l'activation uniquement), [WiFiAjouteRéseau](../WDLang3/1000019351.md), [WifiSupprimeRéseau](../WDLang3/1000019357.md), [WiFiConnecte](../WDLang3/1000019352.md) et [WiFiListeRéseau](../WDLang3/1000019356.md) déclenchent une erreur fatale en cas d'utilisation sous Android 10 ou supérieur.
			Les applications qui sont "device owner" ne sont pas concernées par cette limitation.

	- Il n'est plus permis de récupérer le contenu du presse-papiers si l'application est en arrière-plan. Dans ce cas, la fonction [PressePapier](../WDLang1/3063004.md) retournera une chaîne vide.




2. **Lorsque l'exécution se fait sous Android 10 et que le niveau d'API cible est en 29** : 

	- Une application n'est plus autorisée à accéder à des fichiers situés sur le stockage externe, en dehors des répertoires spécifiques à cette application (fonction [SysRepStockageExterne](../WDLang1/1000021793.md) avec constantes sseApp\*).
			Les accès en lecture ou en écriture à ces fichiers échoueront. Les chemins de fichiers fixés "en dur" ou construits à partir des fonctions [SysRepCarteStockage](../WDLang1/3073034.md) ou [SysRepStockageExterne](../WDLang1/1000021793.md) avec les constantes ssePublicxxx ne doivent donc plus être utilisées. Cette limitation sera définitive à partir de Android 11 lorsque le niveau d'API sera relevé à 30. Avec Android 10 et le niveau d'API 29, il y a une tolérance pour l'accès à ces emplacements, ils restent donc utilisables avec cette version de WINDEV Mobile (pour cela l'attribut d'application *requestLegacyExternalStorage* est automatiquement ajouté), mais il est recommandé de prévoir les adaptations nécessaires dans les applications qui utiliseraient ces emplacements.

	- Une nouvelle permission a été mise en place dans Android 10 pour les fonctions qui permettent la localisation de l'appareil : la permission ACCESS_BACKGROUND_LOCATION. 
			Cette permission est automatiquement ajoutée lors de l'utilisation dans l'application d'une des fonctions suivantes afin de permettre son utilisation en arrière-plan : 
			


|   |   |
| --- | --- |
| [BeaconDétecteEnArrièrePlan](../WDLang3/1000023112.md) | Permet à l'application d'être notifiée lorsque l'appareil entre ou sort d'une zone correspondant au rayon d'émission d'un ensemble de balises Beacon. |
| [BeaconDétectePrécis](../WDLang3/1000023115.md) | Permet de trouver les balises Beacon à proximité de l'appareil. |
| [BTLEListePériphérique](../WDLang3/1000021882.md) | Liste les périphériques Bluetooth Low Energy actuellement accessibles. |
| [BTListePériphérique](../WDLang3/1000017132.md) | Liste les périphériques Bluetooth accessibles. |
| [CarteSuitDéplacement](../WDLang3/1000019953.md) | Affiche la position courante de l'appareil dans un champ Carte et met à jour cette position durant son déplacement. |
| [géoSuiviActive](../WDLang3/1000021583.md) | Active la gestion du suivi de position dans une application WINDEV Mobile. |
| [GPSArrêteDétection](../WDLang3/1000019240.md) | Arrête la détection de position déclenchée par la fonction [GPSDétectePosition](../WDLang3/1000019209.md). |
| [GPSDernièrePosition](../WDLang3/1000019239.md) | Récupère les informations sur la dernière position connue de l'appareil. |
| [GPSDétectePosition](../WDLang3/1000019209.md) | Demande à être notifié lorsque le périphérique arrive à proximité d'une position donnée. |
| [GPSEtat](../WDLang3/1000019207.md) | Récupère l'état d'activation du fournisseur de géolocalisation ou demande à être notifié lors du changement d'état. |
| [GPSInfo](../WDLang3/1000019208.md) | Renvoie les informations sur le fournisseur de localisation utilisé par l'application pour les fonctions de géolocalisation. |
| [GPSInitParamètre](../WDLang3/1000019204.md) | Initialise les paramètres des fonctions WLangage de géolocalisation et recherche un fournisseur de localisation. |
| [GPSRécupèrePosition](../WDLang3/1000019205.md) | Récupère les informations sur la position actuelle du périphérique. |
| [GPSSuitDéplacement](../WDLang3/1000019206.md) | Demande à être notifié périodiquement de la position courante du périphérique. |
| [RéseauMobileInfoConnexion](../WDLang3/1000020176.md) | Renvoie les informations demandées concernant la connexion actuelle aux données sur le réseau mobile. |
| [WiFiDétectePointAccès](../WDLang3/1000019353.md) | Lance la détection des points d'accès Wi-Fi actuellement accessibles depuis l'appareil. |




**Remarque** : Lors de la publication d'une application sur le Play Store, l'erreur suivante peut être affichée : "La clé privée n'a pas été correctement chiffrée, ou nous n'acceptons pas ce type de clé". Il est nécessaire de recréer le fichier de signature de l'application (ce fichier peut être recrée dans l'assistant de génération de l'application). 
**Attention** : Si des identifiants se basent sur le fichier de signature (par exemple identifiant Google Map), il est également nécessaire de re-générer ces identifiants avec la nouvelle clé. 


### Rappel : le niveau d'API cible "TargetSdkVersion"
<a name="rappel_niveau_api_cible_targetsdkversion_ELTPARAGRAPHE000084"></a>Lors de la compilation d'une application pour Android, l'APK généré inclus un niveau d'API cible "TargetSdkVersion" du SDK Android. Avec ce niveau d'API cible, le système Android détermine les fonctionnalités dont peut disposer l'application, et les règles de sécurité qui doivent lui être appliquées.

Le niveau d'API cible "TargetSdkVersion" attribué à une application est visible dans l'assistant de génération de l'APK à l'étape "Configuration" de l'assistant de génération : 

1. Cliquez sur "Configuration avancée",

2. Dans la fenêtre "Configuration avancée", cliquez sur "Editer le manifeste",

3. Déroulez le noeud "uses-sdk",

4. L'entrée "android:targetSdkVersion" permet de connaître le niveau d'API cible.


Ce niveau d'API est d'ailleurs modifiable. Il est donc possible dans une application WINDEV Mobile générée sans la mise à jour 118 661, d'indiquer le niveau d'API cible en 29. Mais dans ce cas l'application n'aura pas un framework adapté aux spécificités de ce niveau d'API. Il s'agit donc d'une solution fortement déconseillée, puisque que Android appliquera des règles de sécurité à l'application qui sont différentes de celles pour lesquelles elle a été testée.

Pour plus de détails, consultez [le site de Google](https://developer.android.com/studio/publish/versioning). 

<a name="NOTE1_1b"></a>


## Comportement des applications en arrière-plan
<a name="comportement_des_applications_arriereplan_ELTTEXTE000380"></a>


### Présentation
<a name="presentation_ELTPARAGRAPHE000106"></a>A partir de la version 10 de Android, Google supprime la possibilité pour une application en arrière-plan d'ouvrir une fenêtre (Activity) [https://developer.android.com/guide/components/activities/background-starts](https://developer.android.com/guide/components/activities/background-starts). C'est un changement très important qui concerne toutes les applications Android, donc également les applications générées avec WINDEV Mobile. Seules les applications "device owner" ne sont pas concernées, dans ce mode spécifique, l'ouverture reste autorisée.

Une application jusqu'alors fonctionnelle avec toutes les versions en Android antérieures à la 10, aura donc des limitations si elle est installée sous Android 10 :

- lorsque l'application est en arrière-plan, l'ouverture d'une fenêtre ([OuvreFenêtreMobile](../WDLang1/1000021018.md), [Info](../WDLang1/3021011.md), [Erreur](../WDLang1/3021013.md), [Dialogue](../WDLang1/3021015.md), ...) n'est plus autorisée,

- l'exécution d'une fonction WLangage qui conduit à l'ouverture d'une fenêtre n'est plus autorisée ([SMSLanceAppli](../WDLang3/1000020864.md), ...),

- le framework Android de l'application sera également bloqué et ne pourra ouvrir une fenêtre en arrière-plan. L'ouverture d'une fenêtre en arrière-plan par le framework est nécessaire à la gestion des fonctionnalités suivantes :

	- réception d'une notification push,

	- détection de l'entrée ou la sortie d'une région de balises beacon (fonction [BeaconDetecteEnArrierePlan](../WDLang3/1000023112.md)),

	- réception d'une nouvelle position lorsque le suivi (tracking) de la position est activé (fonction [géoSuiviProcédure](../WDLang3/1000021585.md)),

	- exécution de tâches en arrière-plan (fonctions [TacheEnArrièrePlanxxx](../WDLang3/1000023472.md)).

	- lancement de l'application au démarrage de l'appareil Android.







Ces limitations s'appliquent à toutes les applications générées avec WINDEV Mobile 25 "Update 2" et les versions antérieures.
<a name="NOTE2_1"></a>


### Modifications à partir de WINDEV Mobile 25 Update 3
<a name="modifications_partir_windev_mobile_25_update_3_ELTPARAGRAPHE000153"></a>Le framework Android des applications WINDEV Mobile a été modifié afin de tenir compte de cette exigence de Google. Toutes les adaptations nécessaires sont incluses à partir de WINDEV Mobile 25 Update 3. 

A partir de WINDEV Mobile 25 Update 3, les notifications push, le suivi de position, la détection beacon, ... sont rétablies. De plus le mécanisme de sécurité du WLangage est complété, afin de déclencher une erreur fatale si une fonction provoquant l'ouverture d'une fenêtre est appelée avec l'application en arrière-plan (voir la liste des fonctions concernées). 

Afin de s'assurer du bon fonctionnement d'une application sous Android 10, il faut donc :

- utiliser la version WINDEV Mobile 25 Update 3 minimum pour sa génération,

- vérifier tous les traitements pouvant être lancés depuis l'application en arrière-plan : ces traitements ne doivent pas entraîner l'ouverture d'une fenêtre. Pour optimiser votre code, vous pouvez : 

	- utiliser la fonction [EnModeArrièrePlan](../WDLang1/1000023457.md) qui permet de savoir si le traitement en cours s'exécute en arrière-plan ou non.

	- utiliser la fonction [ExeInfo](../WDLang1/3035001.md) qui permet de savoir si l'application est lancée au démarrage de l'appareil. Dans ce cas, cette fonction appelée avec la constante **exeLancement** en paramètre retournera la constante **exeDémarrage**.

	- si une application a besoin d'interagir avec l'utilisateur alors qu'elle se trouve en arrière-plan, la solution préconisée est d'afficher une notification. Lors du clic sur la notification, l'application sera remise au premier plan et sera donc autorisée à ouvrir une fenêtre depuis la procédure appelée grâce à la propriété **ActionClic**de la notification (la variable de type [Notification](../WDLang3/1000019441.md) doit avoir la propriété **ActiveApplication** à Vrai).




- en phase de mise au point de l'application sur un périphérique Android, utiliser le log Android afin de cerner l'origine d'un éventuel blocage durant l'exécution en arrière-plan. En effet, l'ouverture de fenêtre n'étant pas autorisée depuis l'arrière-plan, le mécanisme de sécurité du WLangage ne peut pas remonter d'information. Les erreurs sont donc consignées dans le [log Android](../Editeurs/9000108.md).





### Liste des fonctions concernées
<a name="liste_des_fonctions_concernees_ELTPARAGRAPHE000182"></a>Les fonctions suivantes déclenchent une erreur fatale en cas d'appel depuis un code lancé en arrière-plan : 



|   |   |
| --- | --- |
| [AlbumSélecteur](../WDLang3/1000020186.md) | Récupère une photo, une image ou une vidéo stockée dans l'album de photos de l'appareil mobile. |
| [AppliOuvreFiche](../WDLang1/1000020980.md) | Ouvre : <br><br>- la fiche d'une application sur le market Android (Play Store), iOS (App Store) ou Windows (Windows Store) pour que l'utilisateur puisse la noter et/ou la commenter.<br><br>- la fiche de paramétrage des achats In-App d'une application. <br><br><br> |
| [AuthIdentifie](../WDLang3/1000022219.md) | Effectue une authentification utilisant le protocole OAuth 2.0 sur un webservice quelconque. |
| [Avertissement](../WDLang1/3021009.md) | Affiche un message personnalisé dans une fenêtre d'avertissement système. |
| [AvertissementAsynchrone](../WDLang1/1000025270.md) | Affiche un message personnalisé dans une fenêtre d'avertissement système non bloquante. |
| [BTChangeVisibilité](../WDLang3/1000017129.md) | Change la visibilité d'une radio Bluetooth. |
| [CBCapture](../WDLang5/1000019456.md) | Décode les informations stockées dans un code-barres en utilisant la caméra de l'appareil (Android, iPhone, iPad). |
| [Confirmer](../WDLang1/3021007.md) | Affiche un message dans une boîte de dialogue standard proposant les réponses "Oui", "Non", "Annuler" et renvoie la réponse de l'utilisateur. |
| [ConfirmerAsynchrone](../WDLang1/1000025305.md) | Affiche un message non bloquant dans une boîte de dialogue standard proposant les réponses "Oui", "Non", "Annuler" et appelle une procédure WLangage avec la réponse de l'utilisateur. |
| [ContactAffiche](../WDLang3/1000019506.md) | Ouvre la fiche d'un contact dans l'application native de gestion des contacts de l'appareil (Android, iPhone ou iPad, Universal Windows). |
| [ContactCrée](../WDLang3/1000019556.md) | Affiche la fenêtre de création de contact de l'application native de gestion des contacts de l'appareil  (Android, iPhone ou iPad, Universal Windows). |
| [ContactEdite](../WDLang3/1000019507.md) | Ouvre en édition la fiche d'un contact en cours dans l'application native de gestion des contacts de l'appareil  (Android, iPhone ou iPad, Universal Windows). |
| [ContactSélectionne](../WDLang3/1000019508.md) | Affiche la liste des contacts de l'appareil (Android, iPhone ou iPad, Universal Windows). |
| [DateSélecteur](../WDLang1/1000020018.md) | Affiche le sélecteur de date du système. |
| [Dialogue](../WDLang1/3021015.md) | Affiche une boîte de message et renvoie la valeur du bouton cliqué par l'utilisateur. |
| [DialogueAsynchrone](../WDLang1/1000025310.md) | Affiche une boîte de message non bloquante et appelle une procédure WLangage avec la valeur du bouton cliqué par l'utilisateur. |
| [EmailLanceAppli](../WDLang3/1000019564.md) | Lance l'application native d'envoi d'emails du poste en cours : <br><br>- Poste sous Windows,<br><br>- Appareil mobile (Android, iPhone, iPad). <br><br><br> |
| [EmailOuvreMessagerie](../WDLang2/3032021.md) | Ouvre le logiciel de messagerie par défaut : <br><br>- de l'internaute sur le poste navigateur.<br><br>- de l'utilisateur sur le poste Windows en cours.<br><br>- sur le téléphone.  <br><br><br> |
| [Erreur](../WDLang1/3021013.md) | Affiche un message d'erreur personnalisé dans une fenêtre d'erreur système. |
| [ErreurAsynchrone](../WDLang1/1000025306.md) | Affiche un message d'erreur personnalisé dans une fenêtre d'erreur système non bloquante. |
| [ErreurConstruit](../WDLang1/1000018878.md) | Affiche un message d'erreur personnalisé dans une fenêtre d'erreur système. |
| [FBOuvreSession](../WDLang5/1000021835.md) | Permet l'authentification et la connexion à Facebook. |
| [géoLanceAppli](../WDLang3/1000019954.md) | Lance l'application de cartographie native de l'appareil pour afficher : <br><br>- une position géographique donnée, <br><br>- un itinéraire entre deux positions.<br><br><br> |
| [GglImprimeDocument](../WDLang5/1000020420.md) | Lance l'impression d'un document (fichier texte, pdf, images, document Word, Excel, ...) en utilisant le service Cloud Print de Google. |
| [gpwAuthLogin](../WDLang6/1000023597.md) | Permet de se connecter au Groupware Utilisateur en utilisant une authentification avec un compte de type Facebook, Google, Microsoft, etc. |
| [HeureSélecteur](../WDLang1/1000020019.md) | Affiche le sélecteur d'heure du système. |
| [inAppAchèteProduit](../WDLang3/1000020873.md) | Envoie une demande d'achat d'un produit "In-App" associé à l'application. |
| [Info](../WDLang1/3021011.md) | Affiche un message personnalisé dans une fenêtre d'information système. |
| [InfoAsynchrone](../WDLang1/1000025269.md) | Affiche un message personnalisé et non bloquant dans une fenêtre d'information système. |
| [InfoConstruit](../WDLang1/1000018879.md) | Affiche un message personnalisé dans une fenêtre d'information système. |
| [KiosqueActive](../WDLang3/1000024425.md) | Passe l'application Android en cours en mode kiosque. |
| [KiosqueDésactive](../WDLang3/1000024426.md) | Désactive le mode kiosque pour l'application en cours. |
| [LanceAppli](../WDLang1/3035006.md) | Lance l'exécution d'un programme (exécutable par exemple) depuis l'application en cours. |
| [LanceAppliAssociée](../WDLang1/3035007.md) | Ouvre directement un document dans son application associée. |
| [LancePartage](../WDLang1/1000020620.md) | Ouvre une popup permettant de sélectionner l'application à utiliser pour partager une ressource (texte ou document). |
| [NFCEcritTag](../WDLang3/1000020417.md) | Déclenche l'écriture de données sur un tag (ou puce) NFC. |
| [NFCEnvoieTag](../WDLang3/1000020418.md) | Envoie un tag NFC à un autre appareil. |
| [NFCLitTag](../WDLang3/1000020416.md) | Déclenche la lecture d'un tag (ou puce) NFC ou active la détection de tags NFC pour la fenêtre en cours. |
| [OKAnnuler](../WDLang1/3021004.md) | Affiche un message dans une boîte de dialogue standard proposant les réponses "OK" et "Annuler" et renvoie la réponse de l'utilisateur. |
| [OKAnnulerAsynchrone](../WDLang1/1000025308.md) | Affiche un message dans une boîte de dialogue standard non bloquante proposant les réponses "OK" et "Annuler" et appelle une procédure WLangage avec la réponse de l'utilisateur. |
| [OuiNon](../WDLang1/3021005.md) | Affiche un message dans une boîte de dialogue standard proposant les réponses "Oui" et "Non" et renvoie la réponse de l'utilisateur. |
| [OuiNonAsynchrone](../WDLang1/1000025272.md) | Affiche un message dans une boîte de dialogue standard non bloquante proposant les réponses "Oui" et "Non" et appelle une procédure WLangage avec la réponse de l'utilisateur. |
| [OuvreFenêtreMobile](../WDLang1/1000021018.md) | Ouvre une fenêtre dans une application mobile. |
| [ReconnaissanceVocaleDéclenche](../WDLang1/1000020013.md) | Déclenche le service de reconnaissance vocale de l'appareil. |
| [RendezVousAffiche](../WDLang3/1000020692.md) | Affiche un rendez-vous dans l'application native de gestion des rendez-vous de l'appareil mobile (Android ou iOS). |
| [RendezVousCrée](../WDLang3/1000020691.md) | Affiche la fenêtre de création de rendez-vous de l'application native de gestion des rendez-vous de l'appareil Android. |
| [Saisie](../WDLang1/3021016.md) | Affiche un message en permettant à l'utilisateur de saisir une information. |
| [SMSLanceAppli](../WDLang3/1000020864.md) | Lance l'application native d'envoi de SMS de l'appareil (Android ou iPhone/iPad). |
| [SynthèseVocaleInitialise](../WDLang3/1000020171.md) | Initialise les paramètres de la synthèse vocale pour l'application en cours. |
| [SynthèseVocaleLitFichier](../WDLang3/1000020172.md) | Lit le contenu du fichier spécifié en utilisant le moteur de synthèse vocale de l'appareil. |
| [SynthèseVocaleLitTexte](../WDLang3/1000019805.md) | Lit le texte spécifié en utilisant le moteur de synthèse vocale de l'appareil. |
| [SysOptimBatterieArrièrePlan](../WDLang1/1000026008.md) | Permet de gérer l'optimisation de la batterie : <br><br>- Récupère le mode de gestion de l'optimisation de la batterie pour l'application en cours. <br><br>- Demande à l'utilisateur de désactiver l'optimisation de la batterie de cette application sur l'appareil.<br><br><br>Cette fonction permet d'empêcher le système d'exploitation d'arrêter l'exécution de l'application lorsqu'elle est en arrière-plan. |
| [telDialerAffiche](../WDLang3/1000019236.md) | Ouvre l'application de téléphonie (dialer) par défaut et affiche le numéro spécifié. Aucun appel n'est déclenché. |
| [telDialerCompose](../WDLang3/1000019235.md) | Ouvre l'application de téléphonie (dialer) par défaut du téléphone et compose le numéro spécifié. |
| [URISélecteur](../WDLang3/1000024026.md) | Ouvre une fenêtre du système pour sélectionner une ressource provenant : <br><br>- du système de fichiers de l'appareil, <br><br>- du Cloud (Google Drive, Microsoft OneDrive, etc.) <br><br>- ou d'un des gestionnaires de contenu installés sur l'appareil.<br><br><br> |
| [VérifieIdentitéUtilisateur](../WDLang3/1000021348.md) | Permet de vérifier l'identité réelle de l'utilisateur en cours par vérification biométrique. |
| [VidéoLanceAppli](../WDLang1/1000019368.md) | Lance l'application caméra native de l'appareil afin d'enregistrer une vidéo ou de prendre une photo. |










## Notification Push
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000222"></a>
Un terminal mobile peut recevoir des notifications en push. Une notification est un message qui s'affiche (et est conservé) sur le terminal, dans le centre de notification du terminal. Une notification peut par exemple permettre de lancer un traitement.

Une notification est envoyée depuis une application distante, présente en général sur un serveur. 

L'application d'envoi de notifications peut être réalisée avec WINDEV ou WEBDEV, ou par des logiciels tiers. 

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principe
<a name="principe_ELTTEXTE000246"></a>
Afin de réaliser un système de notification push, quatre éléments sont nécessaires :

- Une application mobile (iOS ou Android) tournant sur le matériel approprié. 

- Un service de notification qui permet de distribuer les messages push aux téléphones ou tablettes. Ce service est fourni : 

	- soit par Google : Firebase
			Remarque : les application créées avant la version 22 utilisent le mécanisme Google Cloud Messaging (GCM). Ce mécanisme sera rendu obsolète par Google à partir d'Avril 2019.

	- soit par Apple (APM).




- Un serveur d'application (ou fournisseur) qui décide de l'envoi des messages et se charge de communiquer avec la base de données métier (ce serveur peut être un webservice ou une application WEBDEV ou WINDEV). 

- Une base de données, stockant les identifiants des différents devices recevant les messages push, ainsi que des données métier. 




Le schéma de fonctionnement global des messages push est alors le suivant : <br>![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Notifications-Push-Firebase.gif)


1. L'application s'enregistre auprès du service Apple ou Google en utilisant le "device id" et l' "application id". 

2. Si l'enregistrement est réussi, le service Apple ou Google renvoie un token (ou "registration id") à l'application. 

3. L'application transmet alors le token au serveur d'application (fournisseur). 

4. Le serveur stocke le token dans sa base de données. 




**Un message push est alors envoyé de la manière suivante** :
**a.** Le serveur d'application envoie un message (en utilisant une socket SSL (iOS) ou HTTPS (Android)) contenant le token au service Apple ou Google. 
Remarque : cet envoi peut être fait par une application tierce, du moment que celle-ci a accès à la base de données métier et au certificat utilisé pour la communication avec le service de notification. 
**b.** Le service Apple ou Google se charge alors de transmettre le message au device concerné. 





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Gestion des notifications dans l'application Mobile
<a name="gestion_des_notifications_dans_application_mobile_ELTTEXTE000270"></a>
Plusieurs fonctions sont disponibles pour gérer les notifications dans l'application Mobile : 



|   |   |
| --- | --- |
| [NotifPushActive](../WDLang3/1000020816.md) | Active la gestion des notifications push dans une application WINDEV Mobile (Android ou iOS). |
| [NotifPushDésactive](../WDLang3/1000020817.md) | Désactive la gestion des notifications push pour une application WINDEV Mobile (Android ou IOS). |
| [NotifPushProcédure](../WDLang3/1000020818.md) | Spécifie la procédure WLangage appelée lorsqu'une notification push est reçue par une application WINDEV Mobile (Android ou iOS). |





Attention : une configuration spécifique est nécessaire pour faire fonctionner les applications mobiles : 




Le comportement lors de la réception d'une notification est le suivant :

1. **Si l'application est fermée**, le système affiche la notification dans la barre de notification. L'utilisateur peut alors choisir de valider la notification. S'il le fait, l'application est lancée. 
	
	Une fois l'application lancée, il y a deux cas de figures :

	- Si la fonction [NotifPushProcédure](../WDLang3/1000020818.md) a été appelée dans le code d'initialisation du projet, la procédure globale passée en paramètre à cette fonction est appelée et la première fenêtre de l'application n'est pas ouverte. 
			Remarque : La fonction [OuvreFenêtreMobile](../WDLang1/1000021018.md) doit être appelée dans la procédure. 

	- Si la fonction [NotifPushProcédure](../WDLang3/1000020818.md) n'a pas été appelée, la première fenêtre de l'application est ouverte.  




2. **Si l'application est déjà lancée** :







Remarques :

- La constante *exeLancement* de la fonction [ExeInfo](../WDLang1/3035001.md) permet de savoir si l'application a été lancée automatiquement par le système suite à la réception d'une notification push : 
	
	```wl
	ExeInfo(exeLancement) = exeNotificationPush
	```


- La fonction [FenEtat](../WDLang1/3038030.md) permet de tester si besoin l'existence d'une fenêtre afin de l'ouvrir : 
	
	```wl
	// Résumé : Procédure appelée lors du clic sur une notification PUSH
	PROCÉDURE onPush(maNotif est un Notification)
	
	SI FenEtat("FEN_Main") <> Inexistant ALORS
		// FEN_Main est déjà ouverte ou affichée
		RéceptionNotifPush(maNotif, Vrai)
	SINON
		// On ouvre la fenêtre d'accueil
		OuvreFenêtreMobile(FEN_Main, maNotif)
	FIN
	```





<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Gestion des notifications dans le serveur d'application
<a name="gestion_des_notifications_dans_serveur_application_ELTTEXTE000317"></a>
Le serveur d'application est l'application WINDEV ou le site WEBDEV qui envoie les notifications Push. 

Ce serveur d'application envoie les notifications via la fonction [NotifPushEnvoie](../WDLang3/1000020819.md). 

**Attention** : la fonction [NotifPushEnvoie](../WDLang3/1000020819.md) doit connaître les identifiants (tokens) des téléphones concernés par la notification. Cette information doit être renvoyée par l'application mobile. 

WINDEV Mobile est livré avec les exemples suivants : 

- **Projet WD_Serveur_Push (Webservice)** : 

	1. Dans le code du projet, il est nécessaire de préciser :

		- La clé de l'API android

		- Le type de plateforme Android : utiliser les constantes *npeFirebase* ou *npeGCM* (constante *npeFirebase* par défaut). 

		- Le chemin du certificat qui enverra les notifications iOS (Certificat à déployer avec le Webservice aussi). 




2. Déployer le Webservice. 

3. Récupérer l'URL du WSDL déployé. 

- **Projet WM Push (Application mobile qui reçoit les notifications)** :

	1. Modifier l'URL du Webservice déjà importé dans le projet avec l'URL récupérée précédemment. 

	2. Déploiement Android :

		- Récupérer le fichier google-services.json pour une configuration avec Firebase sinon récupérer le numéro du projet dans Google Cloud Messaging.

		- Dans l'assistant de génération Android, faire attention à ce que le nom du package soit le même que celui définit auprès des services Google.




3. Déploiement iOS : Spécifier le même bundle que celui défini dans la console Apple

- **Projet Envoi Push (Application cliente pour envoyer des notifications via le Webservice)** : 

	1. Modifier l'URL du Webservice déjà importé dans le projet avec l'URL récupérée précédemment.

	2. Exécuter l'application pour envoyer des notifications.

	3. Pour iOS, ne pas oublier de spécifier le bundle de l'application visée par l'envoi des notifications, un champ de saisie est prévu à cet effet.







- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WMPush.gif) ***Exemples multiplateforme*** : **WM Push** <br>Cet exemple montre comment recevoir des notifications Push.<br>Il appelle la fonction NotifPushActive et envoie l'identifiant obtenu à l'exemple WINDEV "WD Serveur Push" afin qu'il le stocke.<br>Cet identifiant est ensuite lu par l'exemple WINDEV "Envoi Push" afin qu'il envoie les notifications en push à cet exemple.
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WD_Serveur_Push.gif) ***Exemples multiplateforme*** : **WD_Serveur_Push** <br>Cet exemple est un webservice servant à stocker les identifiants nécessaires au Push sur mobiles.<br>L'application WINDEV Mobile WM Push stockent les identifiants Push dans la base de cet exemple.<br>Ces identifiants sont ensuite lus par l'exemple "WD Envoi Push" afin qu'il envoie les notifications.
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=EnvoiPush.gif) ***Exemples multiplateforme*** : **Envoi Push** <br>Cet exemple permet d'envoyer des notifications en push sur des appareils Android et iOS.<br>Il récupère les identifiants des mobiles dans la base HFSQL de l'exemple "WD Serveur Push", et leur envoie ensuite les notifications grâce à la fonction NotifPushEnvoie.




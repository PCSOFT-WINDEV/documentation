


## EmailOuvreSession (Fonction)

***En anglais : EmailStartSession***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Ouvre une session de gestion des emails en fonction du mode de gestion choisi :

- emails gérés par le protocole POP3, SMTP ou IMAP : la fonction **EmailOuvreSession** permet d'ouvrir la session POP3, SMTP ou IMAP.

- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) emails gérés par l'intermédiaire du client MS Exchange : la fonction **EmailOuvreSession** permet d'ouvrir la session MS Exchange. Dans ce cas, lors de l'utilisation de la fonction **EmailOuvreSession**, le répertoire en cours est automatiquement modifié.


![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Seules les sessions POP3 et SMTP sont gérées.**Remarques** :

- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Pour ouvrir une session avec le logiciel de messagerie Lotus Notes, utilisez la fonction [EmailOuvreSessionNotes](../WDLang3/3032121.md).

- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Pour ouvrir une session avec le logiciel de messagerie Outlook, utilisez la fonction [EmailOuvreSessionOutlook](../WDLang3/3032128.md).

- Pour ouvrir une session de lecture des emails (protocole POP3 uniquement), utilisez la fonction [EmailOuvreSessionPOP3](../WDLang3/3032022.md).

- Pour ouvrir une session d'envoi des emails (protocole SMTP uniquement), utilisez la fonction [EmailOuvreSessionSMTP](../WDLang3/3032025.md). Cette fonction permet également d'ouvrir une session SMTP authentifiée.



<a name="sample_code"></a>

## Exemple
<a class="notetitle" target="_blank" href="$DOC$=1000003032028&name=emailouvresession_fonction&product=WD">Voir des exemples supplémentaires</a>
<a name="Exemple1"></a>

```wl
// Envoi d'un email par le protocole POP3 
SI EmailOuvreSession(USER, PASSWORD, ...
		"pop3.gmail.com", "smtp.gmail.com") = Vrai ALORS
	NomUser = USER
SINON
	NomUser = ""
	Erreur("Impossible d'établir la connexion")
FIN
```

<a name="XSYNTAXE"></a>

## Syntaxe
<a name="SYNTAXE1"></a>

### Ouvrir une session d'emails (POP3, SMTP, IMAP, Notes ou Outlook)

`<Résultat> = EmailOuvreSession(<Session>)`
---

**`<Résultat> : (Booléen)`**



- <u><u><u><u>Vrai</u></u></u></u> si la session a été ouverte, 

- <u><u><u><u>Faux</u></u></u></u> dans le cas contraire. En cas d'erreur, la variable [ErreurDétectée](../WDLang1/3087001.md) est à <u><u><u><u>Vrai</u></u></u></u>. 
	Pour connaître le libellé de l'erreur, utilisez la fonction [ErreurInfo](../WDLang1/3013008.md) avec la constante *errMessage*.




**`<Session> : (Variable de type emailSessionPOP3, emailSessionSMTP, emailSessionIMAP, emailSessionNotes ou emailSessionOutlook)`**

Nom de la variable contenant la description des paramètres de connexion au serveur de messagerie. Toutes les propriétés de la connexion sont spécifiées dans les propriétés de la variable. Pour plus de détails, consultez :

- variable de type [emailSessionPOP3](../WDLang3/1000018759.md) : pour ouvrir une session vers un serveur POP3 afin de lire les messages.

- variable de type [emailSessionIMAP](../WDLang3/1000018957.md) : pour ouvrir une session vers un serveur IMAP afin de lire les messages.

- variable de type [emailSessionSMTP](../WDLang3/1000018765.md) : pour ouvrir une session vers un serveur SMTP afin d'envoyer des messages.

- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) variable de type [emailSessionNotes](../WDLang3/1000018768.md) : pour ouvrir une session vers un serveur Lotus Domino afin de manipuler les messages.

- ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) variable de type [emailSessionOutlook](../WDLang3/1000018767.md) : pour ouvrir une session vers le logiciel de messagerie Outlook.








|   |
| --- |
| **Remarque** : Cette syntaxe est conservée pour compatibilité. Il est recommandé d'utiliser les variables de type [emailSessionOutlook](../WDLang3/1000018767.md) ou la fonction [EmailOuvreSessionOutlook](../WDLang3/3032128.md).<br><a name="SYNTAXE3"></a><br>![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) <br>### Ouvrir une session d'emails utilisant MS Exchange<br><br>`<Résultat> = EmailOuvreSession(<Profil> [, <Asynchrone>])`<br>---<br><br>**`<Résultat> : (Entier)`**<br><br><br><br>- Identifiant de la session email en cours. <br><br>- 0 (ou <u><u><u><u>Faux</u></u></u></u>) en cas d'erreur. La variable [ErreurDétectée](../WDLang1/3087001.md) est à <u><u><u><u>Vrai</u></u></u></u>. Pour connaître le libellé de l'erreur, utilisez la fonction [ErreurInfo](../WDLang1/3013008.md) avec la constante *errMessage*.<br><br><br><br><br>**`<Profil> : (Chaîne de caractères)`**<br><br>Identifie le profil de la connexion (voir Notes).<br><br>Si ce paramètre correspond à une chaîne vide ("") :<br><br>- si plusieurs profils sont définis sur le poste en cours, la fonction **EmailOuvreSession** affiche une fenêtre contenant tous les profils dans laquelle l'utilisateur peut choisir son profil.<br><br>- si un seul profil est défini sur le poste en cours, la fonction **EmailOuvreSession** sélectionne automatiquement ce profil.<br><br><br><br><br>**`<Asynchrone> : (Constante ou booléen optionnel)`**<br><br><br><br><br>\   \   \<br>\ --- \ --- \<br>\ *emailAsynchrone* ou <u><u><u><u>Vrai</u></u></u></u> \ Les emails envoyés lors de la session ouverte avec la fonction **EmailOuvreSession** doivent être transmis en mode asynchrone (voir les Notes). \<br>\ *emailSynchrone* ou <u><u><u><u>Faux</u></u></u></u><br>(Valeur par défaut) \ Les emails envoyés lors de la session ouverte avec la fonction **EmailOuvreSession** doivent être transmis en mode synchrone (voir les Notes). \<br><br>![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Ce paramètre doit correspondre à *emailSynchrone* ou <u><u><u><u>Faux</u></u></u></u>. <br><br><br> |




|   |
| --- |
| **Remarque** : Cette syntaxe est conservée pour compatibilité. Il est recommandé d'utiliser les variables de type [emailSessionPOP3](../WDLang3/1000018759.md), [emailSessionSMTP](../WDLang3/1000018765.md) ou les fonctions [EmailOuvreSessionPOP3](../WDLang3/3032022.md) et [EmailOuvreSessionSMTP](../WDLang3/3032025.md).<br><a name="SYNTAXE2"></a><br><br>### Ouvrir une session d'emails utilisant les protocoles POP3 et SMTP simultanément<br><br>`<Résultat> = EmailOuvreSession(<Nom utilisateur> , <Mot de passe> , <Adresse serveur POP3> [, <Adresse serveur SMTP> [, <Numéro port POP3> [, <Numéro port SMTP> [, <Asynchrone>]]]])`<br>---<br><br>**`<Résultat> : (Booléen)`**<br><br><br><br>- <u><u><u><u>Vrai</u></u></u></u> si la session a été ouverte, <br><br>- <u><u><u><u>Faux</u></u></u></u> dans le cas contraire. En cas d'erreur, la variable [ErreurDétectée](../WDLang1/3087001.md) est à <u><u><u><u>Vrai</u></u></u></u>. Pour connaître le libellé de l'erreur, utilisez la fonction [ErreurInfo](../WDLang1/3013008.md) avec la constante *errMessage*.<br><br><br><br><br>**`<Nom utilisateur> : (Chaîne de caractères)`**<br><br>Identifie l'utilisateur. Ce nom est fourni par le fournisseur de services ou par l'administrateur réseau. Ce nom permettra d'identifier la session d'emails dans les différentes fonctions de gestion des emails.<br><br>**`<Mot de passe> : (Chaîne de caractères)`**<br><br>Mot de passe de l'utilisateur. Ce mot de passe est fourni par le fournisseur de services ou par l'administrateur réseau.<br><br>**`<Adresse serveur POP3> : (Chaîne de caractères)`**<br><br>Adresse IP du serveur d'emails (protocole entrant). Cette adresse IP est fournie par le fournisseur de services ou par l'administrateur réseau. Cette adresse IP peut être donnée sous la forme :<br><br>- Adresse IP au format XXX.XXX.XXX.XXX ( par exemple, 125.5.110.100).<br><br>- Adresse IP contenant le nom du serveur (par exemple, pop3.freesbee.fr). Cette syntaxe est conseillée.<br><br>- Adresse IP obtenue par la fonction [NetAdresseIP](../WDLang3/3056023.md).<br><br><br><br><br>**`<Adresse serveur SMTP> : (Chaîne de caractères optionnelle)`**<br><br>Adresse IP du serveur d'emails (protocole sortant). Cette adresse IP est fournie par le fournisseur de services ou par l'administrateur réseau.<br>Cette adresse doit être précisée uniquement si le compte POP3 et le compte SMTP ne passent pas par le même poste.<br><br>**`<Numéro port POP3> : (Entier optionnel)`**<br><br>Identifie le port utilisé pour le protocole POP3 (110 par défaut).<br><br>**`<Numéro port SMTP> : (Entier optionnel)`**<br><br>Identifie le port utilisé pour le protocole SMTP (25 par défaut).<br><br>**`<Asynchrone> : (Constante ou booléen optionnel)`**<br><br><br><br><br>\   \   \<br>\ --- \ --- \<br>\ *emailAsynchrone* ou <u><u><u><u>Vrai</u></u></u></u> \ Les emails envoyés lors de la session ouverte avec la fonction **EmailOuvreSession** doivent être transmis en mode asynchrone (voir les Notes). \<br>\ *emailSynchrone* ou <u><u><u><u>Faux</u></u></u></u><br>(Valeur par défaut) \ Les emails envoyés lors de la session ouverte avec la fonction **EmailOuvreSession** doivent être transmis en mode synchrone (voir les Notes). \<br><br>![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Ce paramètre doit correspondre à *emailSynchrone* ou <u><u><u><u>Faux</u></u></u></u>. <br><br><br> |


<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Protocoles POP3 et SMTP
<a name="protocoles_pop3_smtp_ELTPARAGRAPHE000441"></a>Les différents paramètres passés à la fonction **EmailOuvreSession** sont fournis par le fournisseur de services ou par l'administrateur réseau.

Avant de pouvoir gérer les emails, il est nécessaire d'ouvrir une connexion Internet. Plusieurs cas peuvent se présenter :

- L'utilisateur utilise une connexion à Internet directe (cable ou ADSL) : aucune opération spécifique ne doit être faite.

- L'utilisateur utilise un modem pour se connecter à Internet : la fonction [NetOuvreAccèsDistant](../WDLang3/3056026.md) permet d'ouvrir la connexion à Internet.


Par défaut, si seule l'adresse IP du serveur POP3 est précisée, cette adresse sera utilisée par le serveur d'emails utilisant le protocole SMTP. Il est nécessaire de préciser l'adresse IP du protocole SMTP uniquement si le compte POP3 et le compte SMTP ne passent pas par le même poste.
<a name="NOTE0_2"></a>


### SMTP authentifié
<a name="smtp_authentifie_ELTPARAGRAPHE000463"></a>L'authentification SMTP ne peut pas être effectuée avec la fonction **EmailOuvreSession**. Pour ouvrir à la fois une session POP3 et une session SMTP authentifiée il est nécessaire d'utiliser les deux fonctions [EmailOuvreSessionPOP3](../WDLang3/3032022.md) et [EmailOuvreSessionSMTP](../WDLang3/3032025.md).




### Connexion avec double authentification
<a name="connexion_avec_double_authentification_ELTPARAGRAPHE000478"></a>De plus en plus de fournisseurs proposent l'utilisation de comptes email sécurisés (SMTP/IMAP) avec une double authentification.

Le principe est le suivant : 

- Connexion de type OAuth vers le fournisseur de la boîte mail : cette connexion fournit un token. 

- Utilisation du token qui devra être utilisé lors de la connexion aux boîtes IMAP ou SMTP.




Voici un exemple de code pouvant être utilisé :


```wl
// Exemple de connexion IMAP avec un compte Gmail
// et une double authentification
OAuthCnxGoogle est un OAuth2Paramètres
gMaSessionIMAP est un emailSessionIMAP

// Paramètres du serveur IMAP
gMaSessionIMAP.AdresseServeur = "imap.gmail.com"
gMaSessionIMAP.Option = optionSSL
gMaSessionIMAP.Port = "993"

// Paramètres de connexion OAuth
OAuthCnxGoogle.ClientID = "ID de l'application"
OAuthCnxGoogle.ClientSecret = "ID secret de lapplication"
OAuthCnxGoogle.URLAuth = "https://accounts.google.com/o/oauth2/auth"
OAuthCnxGoogle.URLToken = "https://accounts.google.com/o/oauth2/token"
OAuthCnxGoogle.Scope = "https://mail.google.com/"
OAuthCnxGoogle.URLRedirection = "http://localhost:9000"
OAuthCnxGoogle.TypeRéponse = "code"

// Identification OAuth

gMaSessionIMAP.AuthToken = AuthIdentifie(OAuthCnxGoogle)

// Si l'identification a réussi, il faut se connecter à la boîte email.
SI gMaSessionIMAP.AuthToken <> Null ALORS
	SI EmailOuvreSession(gMaSessionIMAP) ALORS
	// Session ouverte
	SINON
	// Erreur d'ouverture de la session.
	FIN
SINON
	// Erreur d'authentification.
FIN
```







<a name="NOTE0_3"></a>


### Délai de timeout
<a name="delai_timeout_ELTPARAGRAPHE000488"></a>Il est possible de paramétrer le délai de timeout avec la fonction [EmailChangeTimeOut](../WDLang3/3032001.md).
<a name="NOTE0_4"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) 

### Création d'un profil Outlook Exchange
<a name="creation_profil_outlook_exchange_ELTPARAGRAPHE000502"></a>Pour ouvrir une nouvelle session d'emails, il est nécessaire de définir un "profil". Ce "profil" est défini dans la configuration de la connexion Internet.

Pour créer un profil :

1. Ouvrez le panneau de configuration.

2. Double-cliquez sur l'option "Courrier".

3. Cliquez sur le bouton "Afficher les profils".

4. Dans la fenêtre "Choix d'un profil", cliquez sur le bouton "Ajouter".

5. Donnez un nom au profil. Ce nom sera utilisé dans les programmes WINDEV.

6. Sélectionnez l'option "Ajouter un nouveau compte de messagerie".

7. Sélectionnez le service "Microsoft Exchange Server".

8. Donnez le nom du serveur Microsoft Exchange.



<a name="NOTE0_6"></a>
<a name="NOTE0_7"></a>
![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) 

### Fonctionnalité d'application requise
<a name="fonctionnalite_application_requise_ELTPARAGRAPHE000568"></a>L'utilisation de cette fonction entraîne la déclaration d'une fonctionnalité d'application dans l'assistant de génération de l'application.

Fonctionnalité requise : Réseaux domestiques et professionnels

Cette fonctionnalité permet aux applications d'utiliser des accès entrants et sortants vers des réseaux domestiques et professionnels. 
<a name="NOTE0_8"></a>


### Gmail : Que faire si une connexion à Gmail (SMTP, IMAP, POP3) échoue avec une erreur de certificat ?
<a name="gmail_que_faire_une_connexion_gmail_smtp_imap_pop3_echoue_avec_une_erreur_certificat_ELTPARAGRAPHE000580"></a>Depuis fin août 2017, Google a déployé un nouveau certificat : Google Internet Authority G3. Malheureusement, l'API Windows utilisée pour la vérification des certificats ne valide pas ce certificat.

L'ouverture d'une session POP3, IMAP ou SMTP peut donc échouer avec le retour "La chaîne de certificats a été fournie par une autorité qui n'est pas approuvée".

Afin de permettre la validation du certificat, il est possible de modifier le mode de gestion des emails. La fonction WLangage [EmailParamètre](../WDLang3/1000022269.md) permet de changer ce mode et ainsi de ne plus utiliser l'API Windows qui bloque ce certificat. Voici le code à ajouter avant l'ouverture de la session par la fonction **EmailOuvreSession** :

```wl
// Activation de l'implémentation multiplateforme
EmailParamètre(emailParamètreMode, 1)
```


Remarque : À partir de la version 23 Update 1, l'appel à la fonction [EmailParamètre](../WDLang3/1000022269.md) n'est plus nécessaire : le WLangage utilise automatiquement le mode de gestion des emails adapté à la session.

<a name="XComposante"></a>

## Composante :
wd280com.dll

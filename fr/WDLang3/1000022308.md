


## &lt;EmailSessionIMAP&gt;.RécupèreTout (Fonction)

***En anglais : &lt;EmailIMAPSession&gt;.GetAll***



<a name="XUtilisation"></a>
<a name="Utilisation"></a>
<a name="description"></a>
Récupère tous les emails présents sur un serveur d'emails.


<a name="Exemple1"></a>
<a name="sample_code"></a>

## Exemple


```wl
// Récupération de tous les emails non lus de la boîte de réception.
SessionIMAP est une emailSessionIMAP
tabEmailNonLus est un tableau de Emails
// Ouverture de la session
SessionIMAP.OuvreSession()
// Récupération de tous les emails non lus
tabEmailNonLus = SessionIMAP.RécupèreTout(ertNonLus)
// Affichage des informations de chaque email
POUR TOUT MonEmail DE tabEmailNonLus
	ZR_EMAIL.AjouteLigne(MonEmail.Expéditeur, MonEmail.Message, MonEmail.Sujet)
FIN
```

<a name="XSYNTAXE"></a>

## Syntaxe

`<Résultat> = <Session>.RécupèreTout([<Options de lecture>])`
---

**`<Résultat> : (Tableau de variables de type Email)`**

Emails dans la boîte de réception (les éléments effectivement récupérés varient selon les paramètres).

**`<Session> : (Variable de type emailSessionIMAP)`**

Nom de la variable de type [emailSessionIMAP](../WDLang3/1000018957.md) correspondant à la session d'email à manipuler.

**`<Options de lecture> : (Constante optionnelle de type Entier)`**

Les valeurs possibles sont :


|   |   |
| --- | --- |
| *ertAsynchrone* | Les messages sont récupérés de façon asynchrone. La fonction retourne immédiatement un tableau de variables de type Email contenant autant d'éléments que nécessaire. La récupération effective des données se fait "à la demande" lors de l'accès aux éléments du tableau.<br><br>**Remarques** : <br><br>- Dans ce mode, les jauges et les callbacks définies par la fonction [EmailJauge](../WDLang3/3032017.md) ne sont pas prises en compte.<br><br>- Les emails les plus anciens sont traités en premier. <br><br><br> |
| *ertComplet* | Les messages sont lus entièrement depuis le serveur (entête, corps du message et pièces jointes). |
| *ertEntête*<br>(valeur par défaut) | Seuls les entêtes sont lus. La récupération effective des autres données (corps du message et pièces jointes) se fait "à la demande" lors de l'accès aux éléments du tableau. |
| *ertNonLus* | Seuls les messages marqués comme "non lus" sur le serveur sont récupérés.<br><br>**Remarque** : Cette valeur n'est pas disponible pour une connexion POP3. |





<a name="NOTE0"></a>
<a name="NOTE0_1"></a>

## Remarques


### Récupération des messages
<a name="recuperation_des_messages_ELTPARAGRAPHE000317"></a>Pour récupérer la totalité des messages ainsi que leurs pièces jointes, il est préférable d'employer la constante *ertComplet* pour minimiser le nombre d'appels au serveur.

Au contraire, si le but n'est de récupérer complètement que quelques emails, il vaut mieux employer la constante *ertEntete* (la valeur par défaut) et laisser la récupération automatique du corps du message se faire lorsqu'elle est nécessaire uniquement (c'est-à-dire au moment de l'accès à la propriété **Message** de la variable [Email](../WDLang3/1000018713.md)).

**Remarques** : 

- Si une propriété d'un email récupéré est modifiée avant que le corps du message ou les pièces jointes ne soient récupérés, cela annule la récupération du corps du message et des pièces jointes.

- **Récupération d'emails Outlook** : La propriété **ContentType** n'est pas disponible et la propriété **ContentID** est renseignée de manière optionnelle.





### Récupération asynchrone des messages (IMAP)
<a name="recuperation_asynchrone_des_messages_imap_ELTPARAGRAPHE000337"></a>La récupération asynchrone des emails avec la constante **ertAsynchrone** est réalisée dans un thread secondaire afin de ne pas être bloquante. Le tableau renvoyé par la fonction **&lt;EmailSessionIMAP&gt;.RécupèreTout** doit donc être intégralement parcouru avant tout appel d'une autre fonction EmailXXX nécessitant un échange avec le serveur IMAP.

Attention : l'accès à une information non récupérée peut entrainer une erreur lors de l'accès au tableau. 

Par exemple, il ne faut pas écrire le code suivant : 


```wl
tabEmailNonLus = SessionIMAP.RécupèreTout(ertAsynchrone)
POUR TOUT mail DE tabEmailNonLus
	SI mail.Sujet [~] "alerte" ALORS
		EmailChangeEtat(SessionIMAP, mail, emailEtatNonLu)
	FIN
FIN
```
En effet, il faut gérer le changement d'état après le parcours de tous les emails. Par exemple :

```wl
nIndice est un entier
tabIndiceEmailChangeEtat est un tableau d'entier
tabEmailNonLus = SessionIMAP.RécupèreTout(ertAsynchrone)
POUR TOUT mail DE tabEmailNonLus
	nIndice++
	SI mail.Sujet [~] "alerte" ALORS
		Ajoute(tabIndiceEmailChangeEtat, nIndice)
	FIN
FIN
POUR TOUT n DE tabIndiceEmailChangeEtat
	EmailChangeEtat(SessionIMAP, tabEmailNonLus[n], emailEtatNonLu)
FIN
```



### Consommation mémoire
<a name="consommation_memoire_ELTPARAGRAPHE000370"></a>La récupération des emails est faite en mémoire. Si la boite de réception contient de nombreux messages ou des pièces jointes de taille importante, la lecture peut consommer une grande quantité de mémoire.
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) 

### Gestion de la jauge
<a name="gestion_jauge_ELTPARAGRAPHE000382"></a>Pour connaître l'état d'avancement de la récupération, il est nécessaire de fixer une jauge ou une procédure à l'aide de la fonction [EmailJauge](../WDLang3/3032017.md).

Deux syntaxes de procédure sont supportées :

- Procédure recevant deux paramètres : la taille totale et l'état de progression en cours.

- Procédure recevant quatre paramètres : la taille totale, l'état de progression en cours, l'indice du message en cours de traitement et le nombre total de messages.





- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDMail.gif) ***Exemples complets (WINDEV)*** : **WD Mail** <br>Cette application est un client mail complet développé en WINDEV. Il s'appuie sur les objets Email.<br>Ce client mail permet de récupérer et d'envoyer des emails en utilisant les protocoles POP, IMAP et SMTP.<br>Il est possible d'appliquer des filtres sur le courrier entrant.<br>L'écriture d'un email s'appuie sur le champ Editeur HTML.<br>L'affichage des emails utilise le champ Affichage HTML.<br>L'application permet de gérer plusieurs comptes emails différents.



<a name="XComposante"></a>

## Composante :
wd280com.dll

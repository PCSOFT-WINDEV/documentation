


## Importation/consommation de Webservices
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000531"></a>
WINDEV, WEBDEV et WINDEV Mobile permettent d'importer directement des Webservices dans vos applications.

Un Webservice est un ensemble de points d'entrées mis à la disposition des utilisateurs afin d'effectuer différents traitements. Par exemple, un service d'accès distant met à votre disposition les traitements d'accès aux données. Les échanges d'informations avec un Webservice se font au format XML et utilisent les protocoles SOAP (Simple Object Access Protocol) et HTTP.

A partir de la description au format WSDL (Web Services Description Language) de ce service, WINDEV, WEBDEV ou WINDEV Mobile va générer automatiquement des types et des fonctions WLangage correspondants à l'interface de programmation du Webservice.

Pour utiliser le Webservice, il suffit d'utiliser les fonctions générées au moment de l'import.

Cette page d'aide présente : 

- [Comment importer un Webservice dans un projet](#NOTE2_1). 

- [Comment mettre à jour la description d'un Webservice dans un projet](#NOTE3_1). 

- [Comment utiliser un Webservice dans un projet](#NOTE4_1). 

- [Comment distribuer une application WINDEV qui utilise un Webservice](#NOTE5_1).




![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) L'utilisation d'un Webservice dans un projet Java nécessite une machine virtuelle Java (JRE) en version 6 (ou 1.6) ou supérieure.

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Importer un Webservice dans un projet
<a name="importer_webservice_dans_projet_ELTTEXTE000555"></a>


### Importation
<a name="importation_ELTPARAGRAPHE000066"></a>Pour importer un Webservice :

1. Sous le volet "Projet", dans le groupe "Projet", déroulez "Importer" et sélectionnez "Un Webservice". 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Importer_un_service_Web_XML%20-%20HC%20N%B0001.gif&type=thumb)
L'assistant d'importation d'un Webservice se lance.

2. Dans l'assistant, l'écran de présentation s'affiche. Passez à l'étape suivante. 

3. Indiquez la localisation du WSDL (prononcer wizdeul). Ce fichier correspond à la description du webservice. Il contient la description de chaque fonction contenue dans le Webservice ainsi que leurs paramètres. 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Importer_un_service_Web_XML%20-%20HC%20N%B0002.gif)
Deux méthodes peuvent être utilisées pour localiser le WSDL : 

	- soit à partir d'une URL, adresse HTTP où se trouve le WSDL.
			Remarques : 

		- Il est possible d'indiquer le nom d'utilisateur et le mot de passe si une authentification est nécessaire. 

		- Le bouton "Proxy" permet de configurer les options du proxy si nécessaire.




- soit depuis un fichier XML présent sur le poste en cours.

4. Validez l'assistant. Un message apparaît indiquant que l'importation est terminée. 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Importer_un_service_Web_XML%20-%20HC%20N%B0003.gif&type=thumb)


5. Le Webservice est automatiquement ajouté dans le volet "Explorateur de projet" (dans la branche "Webservices"). Il est prêt à être utilisé.



<a name="NOTE2_2"></a>


### Volet "Explorateur de projet" : visualiser un webservice
<a name="volet_explorateur_projet_visualiser_webservice_ELTPARAGRAPHE000113"></a>Le Webservice importé est présent dans le volet "Explorateur de projet", dossier "Webservices" : 
![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Importer_un_service_Web_XML%20-%20HC%20N%B0004.gif)


La structure est constituée de : 

- le nom du Webservice. 

- le nom de chaque fonction. 

- le nom d'une structure contenant soit les paramètres d'appel, soit les valeurs de retour. 

- le nom de chaque variable de la structure. 




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Description et propriétés d'un Webservice
<a name="description_proprietes_webservice_ELTTEXTE000585"></a>


### Mettre à jour la description d'un Webservice
<a name="mettre_jour_description_webservice_ELTPARAGRAPHE000130"></a>Lorsqu'un Webservice évolue (corrections, nouvelles versions, etc.), sa description peut également être amenée à évoluer.

Pour mettre à jour la description d'un Webservice dans votre projet :

1. Sélectionnez le Webservice dans le volet "Explorateur de projet".

2. Sélectionnez l'option "Mettre à jour" du menu contextuel.




**Remarque** : Les Webservices importés en utilisant le mécanisme de compatibilité avec les versions précédentes ne peuvent pas être mis à jour.
<a name="NOTE3_2"></a>


### Propriétés d'un Webservice modifiables dans l'éditeur
<a name="proprietes_webservice_modifiables_dans_editeur_ELTPARAGRAPHE000144"></a>Pour modifier les propriétés d'un Webservice dans l'éditeur :

1. Sélectionnez le Webservice dans le volet "Explorateur de projet".

2. Choisissez l'option "Description" du menu contextuel.

3. La fenêtre des propriétés s'ouvre. Dans cette fenêtre, il est possible de modifier les propriétés suivantes :

	- L'adresse d'importation du Webservice : il s'agit de l'URL permettant d'atteindre le WSDL décrivant le Webservice.

	- Le nom d'utilisateur et le mot de passe utilisés pour importer le WSDL. 







<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Utilisation d'un Webservice
<a name="utilisation_webservice_ELTTEXTE000615"></a>


### Principe
<a name="principe_ELTPARAGRAPHE000160"></a>Pour utiliser un Webservice, il faut : 

1. Déclarer 2 variables : une variable permettant de spécifier les paramètres d'appel, une variable permettant de récupérer la réponse. 

2. Initialiser chaque variable de la structure d'appel. 
	**Important :** l'ordre d'affectation des variables est repris dans le XML généré dans la requête SOAP. Il est donc nécessaire d'affecter les variables dans l'ordre indiqué dans la documentation de la fonction du webservice.

3. Appeler la fonction du Webservice en passant en paramètre la variable d'appel et récupérer en retour la variable de réponse. 




Exemple : 

```wl
trackingSearch est un trackSearch
trackingSearchRes est un resultTrackSearch
trackingSearch.accountNumber = 99999999
trackingSearch.consigneesCountry = "FR"
trackingSearch.consigneesZipCode = "37100"
trackingSearch.sendersRef = "111111"
trackingSearchRes = TrackingServiceWSService.trackSearch(trackingSearch)

SI ErreurDétectée() ALORS
	Trace("Echec de l'appel au service Web : " + ErreurInfo(errComplet))
SINON
	Trace("Webservice correctement exécuté")
FIN
```


Le résultat renvoyé par le Webservice est généralement au format XML. Il est donc nécessaire d'utiliser et de connaître les fonctions XML pour décoder la réponse.




### Comment écrire dans l'entête HTTP d'un appel à un Webservice SOAP ?
<a name="comment_ecrire_dans_entete_http_appel_webservice_soap_ELTPARAGRAPHE000177"></a>Pour écrire dans l'entête HTTP d'un appel à un Webservice SOAP : 

1. Déclarer une variable de type wsRequête. 

2. Utiliser la propriété EntêteHTTP pour définir les valeurs d'entête. 

3. Appeler la procédure du webservice en spécifiant en 1er paramètre le nom de la variable de type wsRequête. 




Exemple : 

```wl
C est un wsRequête
C.EntêteHTTP["cle"] = "Valeur"
// Appel de la procédure du Webservice 
// en lui passant l'entête puis les paramètres attendus
ProcWebService(C, param1_WS, param2_WS)
// Affiche la requête envoyée
Trace(C.SourceXML)
```


**Remarque** : Du côté serveur, il est possible de récupérer l'entête utilisant la fonction WebserviceLitEntêteHTTP. 


<a name="NOTE4_2b"></a>


### Appel asynchrone d'un Webservice
<a name="appel_asynchrone_webservice_ELTPARAGRAPHE000196"></a>Dans certains cas, le temps d'exécution de la demande au Webservice peut être long et bloquant. Il peut être nécessaire de faire un appel asynchrone au Webservice, en utilisant la syntaxe suivante : 

```txt
APRES <Résultat> = <Procédure d'appel au Webservice> FAIRE
	<Code exécuté uniquement lorsque le Webservice aura été exécuté et aura envoyé la réponse>
FIN
<Code exécuté directement après l'appel du Webservice>
```


Grâce à cette syntaxe, l'appel au Webservice n'est pas bloquant. Le programme continue de s'exécuter même si le Webservice n'a pas encore répondu. 

L'exemple précédent devient :

```wl
trackingSearch est un trackSearch
trackingSearchRes est un resultTrackSearch
trackingSearch.accountNumber = 99999999
trackingSearch.consigneesCountry = "FR"
trackingSearch.consigneesZipCode = "37100"
trackingSearch.sendersRef = "111111"

APRES trackingSearchRes = TrackingServiceWSService.trackSearch(trackingSearch) FAIRE
	SI ErreurDétectée() ALORS
		Trace("Echec de l'appel au service Web : " + ErreurInfo(errComplet))
	SINON
		Trace("Webservice correctement exécuté")
	FIN
FIN
```
Pour plus de détails, consultez [Instruction APRES](../Motscles/1510027.md). 




<a name="NOTE4_2"></a>


### Propriétés associées au Webservice
<a name="proprietes_associees_webservice_ELTPARAGRAPHE000216"></a>Pour manipuler un Webservice par programmation, il suffit d'utiliser le nom du Webservice (présent dans le volet "Explorateur de projet"). 

**Remarque** : Il est possible de faire un glisser-déposer directement depuis le volet "Explorateur de projet" vers l'éditeur de code pour insérer le nom du Webservice.

Les propriétés modifiables par programmation sont :

| Nom | Type manipulé | Effet |
| --- | --- | --- |
| Adresse | Chaîne de caractères | Permet de remplacer l'adresse d'appel du Webservice décrite dans le WSDL par une autre URL. Cette propriété est notamment utile si le Webservice est hébergé sur des serveurs différents.<br><br>Cette propriété est de la forme : "http://serveur:port/chemin_du_webservice".<br><br>Dans le cas d'un Webservice généré avec WINDEV et déployé sur un Serveur d'Application WEBDEV, il s'agit de l'URL du fichier d'extension "awws".<br><br>**Remarques** :<br><br>- La modification de cette propriété remplace toutes les URL décrites dans le WSDL.<br><br>- Si cette propriété correspond à une chaîne vide (""), les URL décrites dans le WSDL seront de nouveau utilisées.<br><br><br> |
| ![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) Authentification | Constante de type entier | Permet de forcer la méthode d'authentification HTTP : <br><br>- *auAutomatique* (valeur par défaut) : méthode d'authentification automatique. <br><br>- *auBasic* : méthode d'authentification Basic. <br><br>- *auNegotiate* : méthode d'authentification Negotiate.<br>	![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png) Attention : Cette méthode d'authentification n'est pas gérée par les exécutables Linux.<br><br><br> |
| IgnoreErreur | Combinaison de constantes | Permet d'ignorer les erreurs de certificat. les constantes utilisables sont les suivantes :<br><br>- *httpIgnoreCertificatInvalide* : Permet d'ignorer un certificat invalide ou ne provenant pas d'une société connue.<br><br>- *httpIgnoreNomCertificatInvalide* : Permet d'ignorer le nom du site figurant dans le certificat.<br><br>- *httpIgnoreCertificatExpiré* : Permet d'ignorer la date du certificat.<br><br>- *httpIgnoreRenvoiHTTP* : Permet le renvoi vers un serveur non sécurisé.<br><br>- *httpIgnoreRenvoiHTTPS* : Permet le renvoi vers un serveur sécurisé.<br><br>- *httpIgnoreRévocation* : Permet d'ignorer le contrôle dans la liste des certificats révoqués. <br><br><br><br><br>Remarques : <br><br>- ![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Les erreurs concernant la sécurité des transactions sont ignorées. La propriété **IgnoreErreur** n'est pas disponible.<br><br>- ![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Seules les erreurs suivantes sont gérées : *httpIgnoreCertificatExpiré*, *httpIgnoreCertificatInvalide*, *httpIgnoreNomCertificatInvalide*, *httpIgnoreRévocation*. Les autres erreurs sont ignorées. Par défaut, pour compatibilité, toutes les erreurs sont ignorées.<br><br><br> |
| MéthodeHTTP | Constante de type Entier | Méthode HTTP utilisée pour appeler le Webservice :<br><br>- *httpPost* (valeur par défaut) : Méthode POST<br><br>- *httpPut* : Méthode PUT<br>	![Universal Windows 10 App](https://doc.pcsoft.fr/ext/images/fr/UNIVERSALAPP.png) Non disponible.<br><br><br> |
| MotDePasse | Chaîne de caractères | Mot de passe utilisé pour réaliser l'authentification lors des requêtes HTTP au Webservice. Ce nom est utilisé uniquement dans le cas où une authentification est nécessaire pour accéder au serveur sur lequel est hébergé le Webservice. |
| Port | Chaîne de caractères | Nom du port défini dans le WSDL. Il s'agit du port utilisé pour communiquer avec le serveur hébergeant le Webservice. Consultez votre administrateur réseau ou le propriétaire du Webservice. |
| Utilisateur | Chaîne de caractères | Nom d'utilisateur utilisé pour réaliser l'authentification lors des requêtes HTTP au Webservice. Ce nom est utilisé uniquement dans le cas où une authentification est nécessaire pour accéder au serveur sur lequel est hébergé le Webservice.<br>Avec la  méthode d'authentification Negotiate, suivant la configuration il faut ajouter à l'utilisateur le domaine : <br><pre><code>monWebservice..Utilisateur = "DOMAINE\Utilisateur"</code></pre><br> ou <br><pre><code>monWebservice..Utilisateur = "Utilisateur@DOMAINE"</code></pre><br> |
| VersionHTTP | Constante de type Entier | Version du protocole HTTP utilisée par le serveur : <br><br>- *httpVersion2* : Protocole HTTP version 2.0. Si le serveur ne gère pas cette version, une version plus ancienne est utilisée. <br><br>- *httpVersion2Uniquement* : Protocole HTTP version 2.0 forcée : si le serveur ne gère pas cette version, une erreur fatale est affichée. <br><br>- *httpVersion1_1* : Protocole HTTP version 1.1.<br><br>- *httpVersion1_0* : Protocole HTTP Version 1.0. <br><br>- *httpVersionDéfaut* : Protocole HTTP Version 1.0. <br><br><br> |


**Remarque** :

- Si un nom d'utilisateur et un mot de passe sont spécifiés, l'authentification des requêtes HTTP se fera en utilisant le schéma d'authentification "Basic", dans lequel les paramètres sont en clair dans la requête HTTP. Il est préférable d'utiliser des requêtes HTTPS si l'authentification est nécessaire.

- Si le serveur qui héberge le Webservice nécessite une authentification Windows en HTTP, il faut utiliser la fonction [HTTPParamètre](../WDLang3/1000018985.md) avant de consommer le Webservice (afin d'utiliser Internet Explorer pour les requêtes HTTP).

- Le temps maximum d'attente de la réponse peut être précisé avec la fonction [HTTPTimeout](../WDLang3/3043008.md).




**Attention** : Les propriétés modifiables dans l'éditeur et les propriétés modifiables par programmation n'ont pas de lien.
<a name="NOTE4_3"></a>


### Propriétés disponibles sur les types de variables
<a name="proprietes_disponibles_sur_les_types_variables_ELTPARAGRAPHE000366"></a>Les types de variables déclarés automatiquement lors de l'importation du WSDL offrent un certain nombre de propriétés :

| Nom | Type manipulé | Effet |
| --- | --- | --- |
| Existe | Booléen | <br><br>- <u><u><u><u>Vrai</u></u></u></u> si le type de variable existe dans la réponse du Webservice,<br><br>- <u><u><u><u>Faux</u></u></u></u> dans le cas contraire.<br><br><br> |
| Occurrence | Entier | Nombre d'éléments de ce type dans la réponse du Webservice.<br><br>Un Webservice peut retourner des tableaux de variables. La propriété **Occurrence** permet de connaître la taille du tableau renvoyée et l'opérateur [ ] permet d'accéder aux éléments du tableau. |
| Type | Chaîne de caractères | Nom du type de la variable. Cette propriété est utilisée lorsqu'un Webservice est susceptible de retourner des réponses de différents types. |
| Valeur | Variant | Valeur de la variable.<br><br>**Remarque** : Cette propriété est accédée par défaut lorsque seul le nom de la variable est utilisé. Par exemple :<br><br><pre><code>monWebservice.VariableRequete = SAI_Valeur</code></pre><br>est équivalent à :<br><br><pre><code>monWebservice.VariableRequete..Valeur = SAI_Valeur</code></pre><br> |

![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) Il n'est pas possible d'utiliser une méthode gérant un contexte partagé.
<a name="NOTE4_4"></a>


### Manipulation avancée du flux XML du Webservice
<a name="manipulation_avancee_flux_xml_webservice_ELTPARAGRAPHE000425"></a>Dans certains cas, il est nécessaire de manipuler précisément le flux de données XML échangé avec le Webservice. Certains Webservices demandent par exemple d'ajouter des entêtes dans leur flux XML pour permettre l'authentification ou retournent des meta informations dans les entêtes de la réponse.

Pour répondre à ces demandes particulières, les fonctions suivantes peuvent être utilisées :


|   |   |
| --- | --- |
| [SOAPAjouteAttribut](../WDLang3/1000019241.md) | Déclare des attributs supplémentaires (non présent dans le WSDL) sur une variable de Webservice générée automatiquement. Elle est utilisée en programmation avancée dans les cas où le WSDL renvoyé par le Webservice ne correspond pas complètement au type attendu. |
| [SOAPAjouteEntête](../WDLang3/3069001.md) | Ajoute des entêtes personnalisés dans un appel de Webservice. |
| [SOAPPrépare](../WDLang3/1000019238.md) | Construit la requête au Webservice pour une fonction et des paramètres donnés mais n'envoie pas la requête. |
| [SOAPRécupèreEntête](../WDLang3/1000019237.md) | Relit les informations présentes dans l'entête de la réponse d'un Webservice. |


<a name="NOTE4_5"></a>


### Cas particulier : le Webservice renvoie un résultat dans un type non reconnu par WINDEV, WEBDEV et WINDEV Mobile
<a name="cas_particulier_webservice_renvoie_resultat_dans_type_non_reconnu_par_windev_webdev_windev_mobile_ELTPARAGRAPHE000455"></a>Les types de variables disponibles dans WINDEV et ceux disponibles dans un Webservice de type SOAP peuvent être différents.

Les types simples (booléen, entier, etc.) et complexes (dateheure, durée, structures, tableaux de types simples et de structures, structures imbriquées, etc.), utilisés dans le Webservice sont automatiquement convertis au format du WLangage (et inversement) lors de l'importation du service dans un projet. Les types Tableaux sont également gérés.

Les types plus évolués (classes, types avancés du WLangage, etc.) sont traités en tant que chaînes de caractères dans le code WLangage. Ces chaînes de caractères contiennent le code XML correspondant au type de variable renvoyé par le Webservice et à son contenu.

Ainsi, si un Webservice renvoie un résultat sous forme d'instance de classe, ce résultat sera traité dans la procédure comme une chaîne de caractères au format XML. Il sera ensuite nécessaire de traiter cette chaîne de caractères (en WLangage) pour en extraire les informations voulues. Pour plus de détails, consultez les [fonctions XML](../WDLang5/3081005.md).

**Remarques** : 

- Si le Webservice retourne une structure, le nom des membres de la structure de retour est sensible à la casse.

- Si vous utilisez une structure en paramètre d'une fonction d'un Webservice et si un membre de type DATE n'est pas affecté, l'erreur "La valeur 0000-00-00 ne respecte pas le schéma XSD" sera affichée. 




<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Distribuer une application WINDEV qui utilise un Webservice
<a name="distribuer_une_application_windev_qui_utilise_webservice_ELTTEXTE000677"></a>
Pour distribuer une application qui utilise un Webservice, il suffit d'intégrer le fichier décrivant le Webservice (fichier .wdsdl)  dans la bibliothèque de l'application.

Pour que l'application puisse exécuter le Webservice, le poste des utilisateurs finaux doit disposer d'un accès à Internet.

**Remarque** : Avant de distribuer une application qui utilise un Webservice, il est conseillé de vérifier la licence d'utilisation et les droits d'utilisation de ce service (cas des services payants).


- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDClientWebservice.gif) ***Exemples didactiques (WINDEV)*** : **WD Client Webservice** <br>Cet exemple illustre l'utilisation des WebServices.<br>Il montre comment récupérer, à partir d'un WebService, des images en fonction de mots clés.<br>Ce projet est le client qui se connecte au WebService "WD Serveur Webservice".
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDServeurWebservice.gif) ***Exemples didactiques (WINDEV)*** : **WD Serveur Webservice** <br>Cet exemple illustre l'utilisation des WebServices.<br>Il montre comment créer un WebService fournissant des images en fonction de mots clés.<br>Ce projet est le WebService qui est utilisé par le projet WD Client Webservice.



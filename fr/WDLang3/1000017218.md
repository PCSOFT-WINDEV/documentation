
## Utilisez les WebSockets grâce au serveur de WebSocket
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation
<a name="presentation_ELTTEXTE000256"></a>
Le protocole WebSocket vise à développer un canal de communication sur un socket TCP pour les navigateurs et les serveurs Web. Ainsi, il est possible depuis un code navigateur WEBDEV de communiquer et d'échanger des messages avec un serveur Web.

Le serveur de WebSocket fourni avec WEBDEV fonctionne sous Windows uniquement et avec IIS (version minimale IIS8).  



A partir de la version 27, il est possible de se connecter à un serveur de Websocket via une application WINDEV (Windows ou Linux) ou une application WINDEV Mobile (Android ou iOS). 





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principe du serveur de WebSocket
<a name="principe_serveur_websocket_ELTTEXTE000280"></a>
Dans une application ou un site Web, le client envoie une requête au serveur et le serveur lui renvoie la réponse, par exemple le contenu de la page demandée. 

L'utilisation d'un WebSocket permet la transmission en temps réel des données associées au site Web (par exemple, transmission des messages dans un site de messagerie instantanée). Avec le protocole WebSocket, il suffit au client d'établir la connexion avec un serveur Web. Une fois établi, le canal de communication reste ouvert. 
Le serveur peut transmettre au client, de sa propre initiative, toutes les informations qu'il estime utiles. Si de nouvelles informations sont disponibles sur le serveur, le client n'a pas à émettre de requête.



<a name="NOTE2b"></a>
<a name="NOTE2b_1"></a>


## Comment utiliser le serveur de WebSocket ?
<a name="comment_utiliser_serveur_websocket_ELTTEXTE000304"></a>
Pour utiliser le serveur de WebSocket, vous devez : 

1. Installer le Serveur d'application WEBDEV 28, qui permet d'administrer les serveurs de WebSocket (via l'onglet "WebSockets"). 
	Remarque : La version minimale requise est la version 26 du Serveur d'application WEBDEV.   

2. Créer un projet WEBDEV de type "Serveur de WebSocket". Ce projet est déployé sur le serveur Web (où le Serveur d'application WEBDEV a été installé). Il attend les connexions qui lui sont envoyées suivant le protocole WebSocket. Cette application tourne donc en tâche de fond sur le serveur.

3. Créer le projet qui va interroger le serveur de WebSocket. Ce projet permet d'envoyer des messages au serveur de WebSocket et si nécessaire de traiter les réponses, grâce aux fonctions [Socketxxx](../WDLang3/3070007.md). Ce projet peut être : 

	- Un projet WEBDEV. 

	- Un projet WINDEV.

	- Un projet WINDEV Mobile (Android ou iOS). 




4. La connexion au serveur de WebSocket pourra être effectuée depuis le projet "client" via les fonctions suivantes : 


|   |   |
| --- | --- |
| [WebSocketClientConnecte](../WDLang3/1410087751.md) | Permet d'établir une connexion avec un serveur de Websocket. |
| [WebSocketClientConnecteSSL](../WDLang3/1410087752.md) | Permet d'établir une connexion sécurisée SSL avec un serveur de Websocket. |




Remarque : Le Serveur de WebSocket WEBDEV peut être utilisé avec tout langage qui supporte ce protocole. 

<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Projet de type "Serveur de WebSocket"
<a name="projet_type_serveur_websocket_ELTTEXTE000344"></a>


### Création du projet de type "Serveur de WebSocket"
<a name="creation_projet_type_serveur_websocket_ELTPARAGRAPHE000074"></a>Pour créer un projet de type "Serveur de WebSocket" : 

1. Affichez la page d'accueil de WEBDEV (en utilisant par exemple le raccourci CTRL + &lt;). 

2. Cliquez sur le bouton "Créer un projet", puis cliquez sur "Serveur de WebSocket". 

3. L'assistant de création de projet se lance. 

4. Indiquez le nom du projet et suivez les différents étapes de la création du projet (pour plus de détails, consultez [Créer un projet WEBDEV](../Editeurs/2030042.md)). 

5. Terminez l'assistant : le projet est automatiquement créé. 




Attention : Ce projet ne doit pas utiliser de composants (ni internes ni externes), ni charger des bibliothèques (WDL). 




### Evénements WLangage spécifiques au projet de type "Serveur de WebSocket"
<a name="evenements_wlangage_specifiques_projet_type_serveur_websocket_ELTPARAGRAPHE000091"></a>Plusieurs événements WLangage spécifiques sont associés au projet : 

| Evénement | Conditions d'exécution |
| --- | --- |
| Service global (traitement en boucle) | Cet événement est l'événement principal du serveur de WebSocket. Il est appelé en boucle quand le serveur de WebSocket est démarré. <br><br>Cet événement permet par exemple d'envoyer un message à un ou plusieurs clients en fonction d'un paramètre lu dans un fichier de données. <br><br>Il est possible d'indiquer l'intervalle d'exécution de cet événement via la syntaxe suivante : <br><br><pre><code>PROCÉDURE ServiceGlobal()<intervalle=<Durée>></code></pre><br> où &lt;Durée&gt; est l'intervalle d'exécution de l'événement. Ce paramètre peut correspondre à un entier correspondant au nombre de millisecondes ou l'indication directe de la durée (par exemple '20 s' ou '10 ms'). Par défaut, cet événement est exécuté toutes les 10 secondes. <br><br>Dans cet événement, il est possible d'utiliser la fonction [WebSocketListeClientConnecté](../WDLang3/1000025956.md) pour connaître la liste des clients connectés au moment de l'exécution de la fonction (attention, cette liste peut être différente à chaque instant). |
| Nouvelle connexion | Exécuté lors de la demande de connexion d'un client (via la fonction [SocketConnecte](../WDLang3/3070016.md)). <br><br>Rappel : Le client est un site Web. La demande de connexion va s'effectuer depuis le code navigateur d'une page Web. <br><br>Cet événement est un événement acceptant des paramètres. Cet événement est de la forme : <br><pre><code>PROCÉDURE Connexion(Client est un websocketClient)</code></pre><br>où &lt;Client&gt; correspond à une variable de type websocketClient, contenant les caractéristiques du client. |
| Réception d'un message d'un client | Exécuté lors de l'envoi d'un message au serveur de WebSocket par le client (via la fonction [SocketEcrit](../WDLang3/3070002.md)). <br><br>Cet événement est un événement acceptant des paramètres. Cet événement est de la forme : <br><pre><code>PROCÉDURE ReceptionMessage(Client est un websocketClient, <br>	vMessage est un Variant)</code></pre><br>où : <br><br>- &lt;Client&gt; correspond à une variable de type [websocketClient](../WDLang3/1000025952.md), contenant les caractéristiques du client. <br><br>- &lt;vMessage&gt; correspond au message envoyé par le client. Le type réel de la valeur stockée est soit une chaîne Unicode, soit un Buffer (&lt;vMessage&gt;.Type). <br><br><br> |
| Déconnexion d'un client | Exécuté lors de la déconnexion du client (via la fonction [SocketFerme](../WDLang3/3070015.md)). <br><br>Cet événement est un événement acceptant des paramètres. Cet événement est de la forme : <br><pre><code>PROCÉDURE Deconnexion(Client est un websocketClient)</code></pre><br>où &lt;Client&gt; correspond à une variable de type [websocketClient](../WDLang3/1000025952.md), contenant les caractéristiques du client. |
| Arrêt du service global | Exécuté à l'arrêt du service global. |


**Remarque** : Pour éditer les événements spécifiques d'un projet : sous le volet "Accueil", dans le groupe "Général", déroulez ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=ico_code.gif) et sélectionnez "Code du projet".




### Contextes d'exécution
<a name="contextes_execution_ELTPARAGRAPHE000179"></a>Le service global du serveur de WebSocket et les clients connectés s'exécutent indépendamment. Chacun s'exécute dans son propre contexte avec :

- sa propre copie des variables globales.

- son propre contexte de base de données. 

- etc.


Il n'est donc pas possible de manipuler directement le contexte global ou le contexte d'un autre client depuis un autre contexte. 

La fonction [WebSocketExécute](../WDLang3/1000025961.md) permet d'exécuter une procédure globale dans le contexte d'un client connecté au Serveur de WebSocket. Dans ce cas-là, le contexte d'exécution est bien celui du client : pendant l'exécution de la procédure globale, les variables globales vues seront celles du client spécifié.

La fonction [WebSocketExécuteServiceGlobal](../WDLang3/1000026042.md) permet d'exécuter une procédure globale dans le contexte global du serveur de WebSocket. Pendant l'exécution de la procédure globale, les variables globales vues seront celles du service global. 
Attention : Il peut être nécessaire de paramétrer l'intervalle de temps entre deux appels du service global pour que la procédure puisse s'exécuter. 




### Fonctions WLangage spécifiques pouvant être utilisées dans le projet Serveur de WebSocket
<a name="fonctions_wlangage_specifiques_pouvant_etre_utilisees_dans_projet_serveur_websocket_ELTPARAGRAPHE000203"></a>Les fonctions spécifiques pouvant être utilisées dans le serveur de WebSocket sont les suivantes : 



|   |   |
| --- | --- |
| [WebSocketDéconnecte](../WDLang3/1000025960.md) | Déconnecte un client actuellement connecté sur un serveur de WebSocket. |
| [WebSocketEnvoie](../WDLang3/1000025957.md) | Envoie un message pour un client du serveur de WebSocket. |
| [WebSocketExécute](../WDLang3/1000025961.md) | Exécute une procédure dans le contexte d'un client connecté au serveur de WebSocket. |
| [WebSocketExécuteServiceGlobal](../WDLang3/1000026042.md) | Exécute une procédure globale dans le contexte du service global du serveur de WebSocket. |
| [WebSocketListeClientConnecté](../WDLang3/1000025956.md) | Liste les clients connectés au serveur de WebSocket. |













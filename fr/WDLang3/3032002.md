
## Écrire un email
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Principe
<a name="principe_ELTTEXTE000273"></a>
Il existe deux méthodes pour gérer les emails en WLangage : 

- la structure [Email](../WDLang3/3032029.md) qui permet de manipuler globalement un message de façon simple. 
	Dans ce cas, pour écrire un email, il est nécessaire d'utiliser les différentes variables de la structure Email. 

- le type avancé [Email](../WDLang3/1000018713.md) qui offre des fonctionnalités évoluées (data binding, sérialisation, instances multiples, etc.). 
	Dans ce cas, pour écrire un email, il est nécessaire de déclarer et initialiser une variable de type [Email](../WDLang3/1000018713.md). Les pièces jointes éventuelles seront déclarées dans des variables de type [emailAttache](../WDLang3/1000018752.md), puis ajoutées à la propriété **Attache** de la variable [Email](../WDLang3/1000018713.md).




Lors de l'envoi du message (utilisation de la fonction [EmailEnvoieMessage](../WDLang3/3032005.md)), les données présentes dans la variable ou structure email constitueront le message envoyé. 



<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Les différentes étapes
<a name="les_differentes_etapes_ELTTEXTE000297"></a>


### Ecrire un email avec une variable de type Email
<a name="ecrire_email_avec_une_variable_type_email_ELTPARAGRAPHE000072"></a>Pour écrire un email avec une variable de type Email : 

1. Déclarez et initialisez une variable de type [Email](../WDLang3/1000018713.md) en précisant par exemple les destinataires, le sujet, à l'aide des propriétés **Destinataire**, **Cc**, **Cci** et **Sujet**. 
	Pour gérer un suivi de conversation, renseignez également la propriété **MessageID**.

2. **Si l'email est au format texte** :

	- Initialisez la propriété **Message** avec le texte de l'email.

	- Précisez les fichiers attachés si nécessaire en déclarant des variables de type [emailAttache](../WDLang3/1000018752.md) et en les ajoutant à la propriété **Attache** de la variable représentant l'email.




3. **Si l'email est au format HTML** : Utilisez la fonction [EmailImporteHTML](../WDLang3/3032038.md) pour initialiser les différentes propriétés de l'email. Si l'email contient des images ou des fichiers multimédia, ils seront automatiquement ajoutés en pièces jointes à l'email et le contenu de l'email HTML sera modifié pour gérer les pièces jointes.
	![Java](https://doc.pcsoft.fr/ext/images/fr/JAVA.png) La fonction [EmailImporteHTML](../WDLang3/3032038.md) n'est pas disponible. Il est nécessaire d'utiliser la méthode utilisant la structure Email présentée ci-dessous.

4. Spécifiez si nécessaire des entêtes supplémentaires grâce à la propriété **Entête**. 

5. Envoyez l'email avec la fonction [EmailEnvoieMessage](../WDLang3/3032005.md). Si le sujet (ou un des éléments de l'email) contient des caractères spéciaux, des accents, utilisez la constante **emailOptionEncodeEntête** lors de l'envoi du message avec la fonction [EmailEnvoieMessage](../WDLang3/3032005.md). Le mail est alors envoyé au serveur. Le serveur conserve le mail jusqu'à la fermeture de la session. Lors de cette fermeture, le mail part effectivement vers le ou les destinataires.




![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png) **Remarque** : Il est possible de suivre la progression de l'envoi de l'email grâce à la fonction [EmailJauge](../WDLang3/3032017.md).
<a name="NOTE2_2"></a>


### Ecrire un email avec la structure Email
<a name="ecrire_email_avec_structure_email_ELTPARAGRAPHE000121"></a>Pour écrire un email avec la structure Email : 

1. Initialisez la structure [Email](../WDLang3/3032029.md) en précisant par exemple les destinataires, le sujet, à l'aide des variables Email.Destinataire, Email.NbDestinataire, Email.NbCc, Email.Cc et Email.Sujet. 
	Pour gérer un suivi de conversation, renseignez également Email.MessageID.

2. **Si l'email est au format HTML** :

	- **1er cas : la fonction EmailImporteHTML est disponible** : 

		- Utilisez la fonction [EmailImporteHTML](../WDLang3/3032038.md) pour initialiser les différentes variables de la structure Email. 




- **2nd cas : la fonction EmailImporteHTML n'est pas disponible** : 

	- Initialisez les variables Email.Message et Email.HTML. 
						Remarque : Il est conseillé de mettre un message au format texte pour les systèmes de messagerie ne permettant pas de lire des emails au format HTML.

	- Analysez le message HTML pour détecter tous les fichiers multimédia présents dans le message.

	- Pour chaque fichier multimédia trouvé :

		- Créez un fichier attaché. Ce fichier attaché correspond au fichier multimédia (variables Email.Attache et Email.NbAttache).

		- Créez un identifiant (Email.IdentifiantAttache). Cet identifiant doit être de la forme ***"wdcid"+numéro du fichier attaché***. Par exemple, WDCID5 si le fichier correspondant est le cinquième fichier attaché.

		- Recherchez le fichier multimédia dans le message HTML et remplacez son nom par la chaîne : ***"cid:"+Email.IdentifiantAttache***.
										Par exemple : 
										Code HTML original : &lt;IMG src="C:\\MesImages\\Image.gif"&gt;
										Code HTML remplacé : &lt;IMG src="cid:WDCID5"&gt;

3. Envoyez l'email avec la fonction [EmailEnvoieMessage](../WDLang3/3032005.md). 
	Remarque : Si le sujet (ou un des éléments de l'email) contient des caractères spéciaux ou des accents, utilisez la constante **emailOptionEncodeEntête** lors de l'envoi du message avec la fonction [EmailEnvoieMessage](../WDLang3/3032005.md).






<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Exemples
<a name="exemples_ELTTEXTE000327"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png)![Linux](https://doc.pcsoft.fr/ext/images/fr/LX.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) 

### Exemple utilisant la fonction EmailImporteHTML
<a name="exemple_utilisant_fonction_emailimportehtml_ELTPARAGRAPHE000178"></a>Cet exemple permet d'envoyer un email contenant des images :


```wl
// Ouverture d'une session SMTP
MaSession est une emailSessionSMTP
MaSession.AdresseServeur = "smtp.monentreprise.com"
EmailOuvreSession(MaSession)

// Construction du message
MonMessage est un Email
MonTexteHTML = fChargeTexte("C:\Email\MonCourrier.htm")

EmailImporteHTML(MonMessage, MonTexteHTML, "C:\Email")

MonMessage.Destinataire = "bob@masociete.net"
MonMessage.Sujet = "Test"

// Envoi du message
EmailEnvoieMessage(MaSession, MonMessage, emailOptionEncodeEntête)
```

<a name="NOTE3_2"></a>


### Exemple utilisant la structure Email
<a name="exemple_utilisant_structure_email_ELTPARAGRAPHE000187"></a>Cet exemple permet de remplacer les références aux fichiers multimédia (images, sons, ...) présents dans la variable Email.HTML par leurs identifiants de type "CID". Cette procédure est appelée pour chaque fichier trouvé.


```wl
PROCEDURE SetFichierAttache(NomFichier, Indice)
Email.Attache[Indice] = NomFichier
Email.NbAttache ++

// Remplacer dans Email.HTML toutes les références aux fichiers attachés 
// par l'identifiant cid
CID est une chaîne = "cid:wdcid" + Indice

// Le fichier html n'a pas forcément été créé dans le répertoire en cours
// Il peut référencer les fichiers attachés dans des chemins quelconques
// On extrait donc le nom du fichier sans chemin

NomSimple est une chaîne = fExtraitChemin(NomFichier, fFichier + fExtension)

// Rechercher le nom du fichier dans Email.HTML
Pos est un entier = 0
PosDébut, PosFin sont des entiers
SousChaîne est une chaîne
Pos = Position(Email.html, NomSimple, Pos)
SI Pos <> 0 ALORS
	PosFin = Pos + Taille(NomSimple)
	// Rechercher la position du début de la référence
	// Rechercher le délimiteur "
	Pos --
	SousChaîne = Email.HTML[[Pos]]
	TANTQUE Pos > 1 ET SousChaîne <> """"
	   Pos --
	   SousChaîne = Email.HTML[[Pos]]
	FIN
	PosDébut = Pos + 1
	// Remplacer
	SousChaîne = Milieu(Email.HTML, PosDébut, PosFin - PosDébut)
	Email.HTML = Remplace(Email.HTML, SousChaîne, CID)
FIN
```




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Utilisation du format EML pour personnaliser des emails
<a name="utilisation_format_eml_pour_personnaliser_des_emails_ELTTEXTE000357"></a>
![WINDEV](https://doc.pcsoft.fr/ext/images/fr/WD.png)![Windows](https://doc.pcsoft.fr/ext/images/fr/WINDOWS.png)![Code Utilisateur (MCU)](https://doc.pcsoft.fr/ext/images/fr/MCU.png) Dans certains cas particuliers, la structure des emails envoyés peut ne pas correspondre aux informations voulues.

Quelques exemples : 

- La communication avec certains organismes (emails pour SESAM-VITALE) peut imposer des structures bien spécifiques.

- Il est également possible de vouloir forcer un alphabet spécifique (pour une langue non latine).

- Il est possible de vouloir indiquer une adresse de retour d'erreur différente de l'adresse d'expéditeur.




Pour personnaliser ces emails, le WLangage permet de générer le buffer de l'email, de le modifier puis d'envoyer cet email.

Les fonctions utilisées sont les suivantes : 

- [EmailImporteSource](../WDLang3/1000017226.md) : Cette fonction permet de lire un fichier EML existant et de remplir automatiquement les variables de la structure Email.

- [EmailConstruitSource](../WDLang3/1000017225.md) : Cette fonction permet de générer le code source d'un email. Cette fonction permet de réaliser la définition complète du source de l'email en utilisant la souplesse de la structure Email.

- [EmailEnvoie](../WDLang3/3032003.md) : Cette fonction envoie un "buffer" au format EML contenant l'email structuré (créé par exemple avec la fonction [EmailConstruitSource](../WDLang3/1000017225.md)).





- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDMail.gif) ***Exemples complets (WINDEV)*** : **WD Mail** <br>Cette application est un client mail complet développé en WINDEV. Il s'appuie sur les objets Email.<br>Ce client mail permet de récupérer et d'envoyer des emails en utilisant les protocoles POP, IMAP et SMTP.<br>Il est possible d'appliquer des filtres sur le courrier entrant.<br>L'écriture d'un email s'appuie sur le champ Editeur HTML.<br>L'affichage des emails utilise le champ Affichage HTML.<br>L'application permet de gérer plusieurs comptes emails différents.
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDMailingparemails.gif) ***Exemples didactiques (WINDEV)*** : **WD Mailing par emails** <br>Cet exemple illustre la possibilité d'envoyer un mailing par eMails avec WINDEV.<br>	<br>Cet exemple permet de saisir l'objet du message, son contenu et ses pièces jointes. <br>L'utilisateur doit ensuite sélectionner les clients auxquels le message doit être envoyé.<br>La fonction WLangage EMailEnvoieMessage() permet ensuite d'envoyer tout simplement le message saisi à chacun des clients sélectionnés.<br>Mise en uvre technique :<br>Un serveur de mail compatible POP3/SMTP doit obligatoirement être accessible depuis le poste sur lequel s'exécute l'application.
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=Envoid'unemailauformatHTML.gif) ***Exemples unitaires (WINDEV)*** : **Envoi d'un email au format HTML** <br>Utilisation de la fonction WLangage "EmailImporteHTML".<br>Cette fonction permet d'importer un fichier HTML directement dans la structure email. Cela permet notamment d'ajouter des images simplement dans des emails.
- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WW_CMS.gif) ***Exemples complets (WEBDEV)*** : **WW_CMS** <br>Cet exemple est un exemple de CMS (Content Management System).<br>C'est un site de gestion de contenu, typiquement un site d'affichage d'articles.<br><br>Cet exemple est découpé en 2 parties :<br>- Une partie AWP pour la partie qui doit être référencée<br>- Une partie WEBDEV Classique pour la partie administration<br><br>Note :<br>Pour que certaines fonctionnalités de l'exemple fonctionnent (l'envoi d'emails par exemple) il est nécessaire de modifier les paramètres afin de les adapter à votre configuration.<br>Ces paramètres sont stockés sous forme de constantes définies dans le code du projet.



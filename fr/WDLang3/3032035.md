
## Gérez les emails avec "Simple MAPI" 
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Présentation de "Simple MAPI"
<a name="presentation_simple_mapi_ELTTEXTE000212"></a>
**Simple MAPI** permet de simplifier la gestion des emails reçus chez l'hébergeur. Lorsqu'un email est lu, il est automatiquement chargé dans la boîte de messages locale et supprimé du serveur (chez l'hébergeur).

Toutes les caractéristiques nécessaires à la gestion des emails (protocole POP3, protocole SMTP, accès distant, etc.) sont regroupées dans le "Profil utilisateur".

![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=SMAPI.gif)


Grâce aux fonctions email du WLangage, une application WINDEV ou un site WEBDEV peut manipuler directement les emails gérés dans une application utilisant "Simple MAPI".



<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principe d'utilisation
<a name="principe_utilisation_ELTTEXTE000236"></a>
Pour envoyer ou lire des messages grâce à **Simple MAPI**, il faut :

1. Décrire un profil utilisateur. Ce profil utilisateur doit être créé directement dans l'application Microsoft de gestion des emails (client MS Exchange par exemple).

2. Se connecter depuis l'application WINDEV (ou le site WEBDEV) à l'application de gestion des emails (client MS Exchange par exemple) grâce à la fonction [EmailOuvreSession](../WDLang3/3032028.md).

3. Envoyer et lire les messages.

4. Fermer la session avec l'application de gestion des emails (client MS Exchange par exemple) grâce à la fonction [EmailFermeSession](../WDLang3/3032006.md).






<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Détail des différentes étapes
<a name="detail_des_differentes_etapes_ELTTEXTE000260"></a>


### Étape 1 : Créer un profil utilisateur
<a name="etape_1_creer_profil_utilisateur_ELTPARAGRAPHE000044"></a>Le profil utilisateur permet de configurer l'application de gestion des emails (client MS Exchange par exemple).

Dans le profil utilisateur sont définis :

- le protocole SMTP utilisé,

- le protocole POP3 utilisé,

- les différents services de communication utilisés. Pour utiliser les fonctions "email" du WLangage, le profil utilisateur doit utiliser le service de communication ***Microsoft Exchange Server***.




**Remarque** : Il est nécessaire de créer autant de profils sur le poste qu'il y a d'utilisateurs ou de comptes emails différents. Le nom du profil sera ensuite utilisé pour ouvrir la session de messagerie grâce à la fonction [EmailOuvreSession](../WDLang3/3032028.md).

**Pour créer un profil :**

1. Ouvrez le panneau de configuration.

2. Double-cliquez sur l'option "Courrier".

3. Cliquez sur le bouton "Afficher les profils".

4. Dans la fenêtre "Choix d'un profil", cliquez sur le bouton "Ajouter".

5. Donnez un nom au profil. Ce nom sera utilisé dans les programmes WINDEV.

6. Sélectionnez l'option "Ajouter un nouveau compte de messagerie".

7. Sélectionnez le service "Microsoft Exchange Server".

8. Donnez le nom du serveur Microsoft Exchange.





<a name="NOTE3_2"></a>


### Étape 2 : Ouverture d'une session de messages
<a name="etape_2_ouverture_une_session_messages_ELTPARAGRAPHE000074"></a>L'ouverture d'une session de messages est réalisée grâce à la fonction [EmailOuvreSession](../WDLang3/3032028.md). Cette fonction doit être la première fonction "email" utilisée dans votre application WINDEV (ou votre site WEBDEV).

La fonction [EmailOuvreSession](../WDLang3/3032028.md) renvoie l'identifiant de la session. Cet identifiant sera utilisé dans toutes les fonctions de gestion des emails du WLangage.

**Exemple** : La procédure suivante permet d'ouvrir une session de messagerie à partir d'un profil. En cas d'erreur, la variable *Email.Erreur* permet d'identifier l'erreur survenue.


```wl
Fonction OuvertureSession(Profil)
// Ouverture de la session
NumSession est un entier
NumSession = EmailOuvreSession(Profil)
SI NumSession = 0 ALORS
	Erreur("La session n'a pas pu être ouverte. Erreur : " + Email.Erreur)
FIN
RENVOYER NumSession
```



<a name="NOTE3_3"></a>


### Étape 3 : Envoi d'emails
<a name="etape_3_envoi_emails_ELTPARAGRAPHE000094"></a>L'envoi d'emails par **Simple MAPI** est réalisé grâce aux fonctions :

- [EmailEnvoieMessage](../WDLang3/3032005.md) : cette fonction permet de placer le message dans la boîte d'envoi de l'application de gestion des emails (boîte d'envoi du client MS Exchange par exemple).

- [EmailMiseAJour](../WDLang3/3032036.md) : cette fonction permet de synchroniser le serveur d'emails et l'application de gestion des emails : les nouveaux emails reçus sont automatiquement transférés dans la boîte de réception, les emails présents dans la boîte d'envoi sont envoyés.  


Pour plus de détails sur la création des emails, consultez : [Préparer l'envoi d'un email](../WDLang3/3032002.md).

**Exemple** : Le code suivant permet d'envoyer tous les emails présents dans un champ Table par programmation (table "TABLE_AENVOYER") par l'intermédiaire du client MS Exchange. Chaque ligne de la table correspond à un email.

Pour chaque email, les informations présentes dans le champ Table par programmation sont transférées dans la structure email et l'email est envoyé. Le serveur d'emails est ensuite mis à jour.


```wl
I est un entier
POUR I = 1 _A_ TableOccurrence(TABLE_AENVOYER)
	// Le courrier n'est envoyé qu'à une seule personne
	Email.NbDestinataire = 1
	Email.Destinataire[1] = ExtraitChaîne(TABLE_AENVOYER[I], 1)
	// Sujet et message
	Email.Sujet = ExtraitChaîne(TABLE_AENVOYER[I], 2)
	Email.Message = ExtraitChaîne(TABLE_AENVOYER[I], 3)
	// Pas de fichier attaché
	Email.NbAttache = 0
	// Envoi du message à MS Exchange
	EmailEnvoieMessage(NumSession, Faux)
FIN
// Envoi des messages depuis MS Exchange vers le serveur d'emails
SI PAS EmailMiseAJour(NumSession) ALORS
	Erreur("Problème avec MS Exchange. Erreur :" + Email.Erreur)
FIN
```



<a name="NOTE3_4"></a>


### Étape 3 bis : Lecture des emails
<a name="etape_3_bis_lecture_des_emails_ELTPARAGRAPHE000120"></a>La lecture d'emails par **Simple MAPI** est réalisée grâce :

- à la fonction [EmailMiseAJour](../WDLang3/3032036.md) : cette fonction permet de synchroniser le serveur d'emails et le logiciel de gestion d'emails utilisé : les nouveaux emails reçus sont automatiquement transférés dans la boîte de réception, les emails présents dans la boîte d'envoi sont envoyés.

- aux fonctions de lecture des emails ([EmailLitPremier](../WDLang3/3032014.md), [EmailLitSuivant](../WDLang3/3032004.md), etc.) : ces fonctions permettent d'initialiser la structure email du WLangage avec les caractéristiques de l'email en cours de lecture (auteur de l'email, sujet, etc.).


Pour plus de détails sur la lecture d'emails, consultez : [Lire un email](../WDLang3/3032037.md).

**Exemple** : Le code suivant permet de lire des emails. Les emails reçus sont stockés dans un champ Table par programmation (table "TABLE_Messages"). La variable NumSession correspond à l'identifiant de la session. Dans cet exemple, les messages reçus sont supprimés de la boîte de réception et du serveur d'emails par la fonction [EmailSupprimeMessage](../WDLang3/3032027.md).


```wl
// Reçoit les messages en attente qui sont sur le serveur d'emails
SI PAS EmailMiseAJour(NumSession) ALORS
	Erreur("Problème avec MS Exchange. Erreur : " + Email.Erreur)
FIN

// Lecture du premier message non lu
SI PAS EmailLitPremier(NumSession,"NON LUS") ALORS
	Erreur("Erreur lors de la lecture du premier message")
FIN

// Parcours des messages non lus avec affichage dans un champ Table par programmation
TableSupprimeTout(TABLE_Messages)
TANTQUE PAS Email.EnDehors
	// La date de réception, l'adresse de l'expéditeur et le message
	// sont affectés dans la table
	TableAjoute(TABLE_Messages, Email.DateRéception + TAB +...
	Email.AdresseExpéditeur +TAB +Email.Message)

	// Suppression du message
	SI PAS EmailSupprimeMessage(NumSession) ALORS
		Erreur("Erreur lors de la suppression. Le message n'a pas été supprimé")
	FIN
	// Lecture du message suivant non lu
	SI PAS EmailLitSuivant(NumSession, "NON LUS") ALORS
		Erreur("Erreur lors de la lecture du message suivant")
	FIN
FIN
```



<a name="NOTE3_5"></a>


### Étape 4 : Fermeture de la session de messages
<a name="etape_4_fermeture_session_messages_ELTPARAGRAPHE000152"></a>Lorsque la gestion des emails reçus et/ou envoyés est terminée, la fermeture de la session est réalisée avec la fonction [EmailFermeSession](../WDLang3/3032006.md). Cette fonction doit être la dernière fonction "email" utilisée.

**Exemple** : Le code suivant est une procédure permettant de fermer une session de messagerie. Dans ce code, la variable **NumSession** correspond à l'identifiant de session renvoyé par la fonction [EmailOuvreSession](../WDLang3/3032028.md).


```wl
PRODEDURE FermetureSession(NumSession)
// Fermeture de la session
EmailFermeSession(NumSession)
```






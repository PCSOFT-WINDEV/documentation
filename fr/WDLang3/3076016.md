
## Téléphonie : Gérer les appels entrants
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Principe
<a name="principe_ELTTEXTE000136"></a>
										
La gestion des appels entrants est réalisée dans un "Thread" spécifique. Lorsque un appel entrant est détecté, la procédure associée au thread est exécutée. C'est dans cette procédure que la gestion de l'appel est réalisée.										




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Les différentes étapes
<a name="les_differentes_etapes_ELTTEXTE000160"></a>
Pour gérer les appels entrants dans une application WINDEV ou WINDEV Mobile : 

1. Déterminez si nécessaire le périphérique TAPI sur lequel la détection d'appels doit être effectuée. Utilisez les fonctions :
	


|   |   |
| --- | --- |
| [telCapacité](../WDLang3/3076014.md) | Renvoie les caractéristiques d'un périphérique de téléphonie. |
| [telListePériphérique](../WDLang3/3076024.md) | Liste les périphériques de téléphonie compatibles TAPI 2.0 et TAPI 3.1 installés sur le poste en cours. |
| [telPériphérique](../WDLang3/3076032.md) | Sélectionne le périphérique TAPI qui sera utilisé lors des opérations de téléphonie suivantes : <br><br>	- [telCompose](../WDLang3/3076013.md),<br><br>	- [telDémarreDétectionAppel](../WDLang3/3076029.md).<br><br><br> |

2. Démarrez la détection d'appels entrants grâce à la fonction [telDémarreDétectionAppel](../WDLang3/3076029.md). Cette fonction exécute une procédure WLangage spécifique. Cette procédure sera automatiquement exécutée lorsque un appel entrant sera détecté.

3. Dans cette procédure, il est possible de :

	- connaître l'état de l'appel grâce aux constantes suivantes :

		- *telLigneOccupée* : La ligne est actuellement occupée. 

		- *telLigneDécrochée* : La ligne est connectée. 

		- *telLigneNumérote* : Numérotation en cours. 

		- *telLigneTonalité* : La ligne reçoit la tonalité

		- *telLigneRaccrochée* : Le correspondant a raccroché

		- *telLigneAttendRéponse* : L'appel est composé : recherche du correspondant

		- *telLigneSonnerie* : Sonnerie en cours chez le correspondant

		- *telNouvelAppel* : Nouvel appel détecté en attente de réponse ou de rejet.

		- *telInformationAppel* : Les informations supplémentaires (présentation du numéro) sont disponibles. Ces informations ne sont généralement disponibles qu'après la première sonnerie.




- gérer complètement l'appel grâce aux fonctions suivantes :

	- obtenir les caractéristiques de l'appel entrant :
						

4. Pour terminer la session de détection d'appels entrants, utilisez la fonction [telFinDétectionAppel](../WDLang3/3076022.md). 






<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Exemple
<a name="exemple_ELTTEXTE000298"></a>


### Exemple permettant de gérer les appels entrants dans le thread principal
<a name="exemple_permettant_gerer_les_appels_entrants_dans_thread_principal_ELTPARAGRAPHE000070"></a>

- Code de déclaration des globales de la fenêtre réalisant la détection d'appels. Dans ce code sont déclarés les différents événements permettant de gérer les appels dans le thread principal de l'application.
	
	```wl
	GLOBAL 
	gnIDEvenement est un entier 
	// On met en place un événement pour gérer les appels entrant en popup 
	SI Evénement("AppelDetecté", "*.*", "AppelTel") = 0 ALORS 
		Erreur("Impossible de gérer la popup de détection d'appel", ErreurInfo()) 
	FIN 
	SI Evénement("FinAppelDetecté", "*.*", "AppelTelFin") = 0 ALORS 
		Erreur("Impossible de gérer la popup de détection d'appel", ErreurInfo()) 
	FIN 
	SI Evénement("IdentifiantAppelDetecté", "*.*", "AppelTelInfo") = 0 ALORS 
		Erreur("Impossible de gérer la popup de détection d'appel", ErreurInfo()) 
	FIN
	```


- Code d'initialisation de la fenêtre : ce code permet de démarrer la procédure de détection d'appels.
	
	```wl
	// On démarre le service de détection des appels 
	SI telDémarreDétectionAppel("AppelEntrant", telOptionTypeFax, "DetectionAppel") ALORS 
		// Le service de détection des appels a démarré 
		Message("Détection des appels activés") 
	SINON 
		// Le service de détection des appels n'a pas démarré 
		 Erreur("Impossible de démarrer la détection des appels" + RC + ...
				"Détail de l'erreur :" + RC + ErreurInfo(errMessage)) 
	FIN
	```


- Procédure de détection d'appels :
	Cette procédure permet de détecter les appels entrants. 
	Pour chaque appel entrant, les caractéristiques de l'appel sont transmises au thread principal grâce à la fonction [PostMessage](../WDLang1/3015001.md).
	
	```wl
	PROCEDURE DetectionAppel(nIDService, nIDAppel, nStatut) 
	// AVERTISSEMENT : 
	// Les traitements réalisés dans cette procédure sont appelés à partir d'un thread 
	// La gestion de l'affichage doit être réalisé à partir du thread principal
	// (d'où l'utilisation de PostMessage) 
	// Pour déboguer ce type de traitement, vous devez utiliser la fonction "Trace" 
	// détection des appels entrants 
	SELON nStatut 
		// Détection d'un nouvel appel : 
		// Note : On ne disposera de plus d'informations qu'après au moins une sonnerie 
		CAS telNouvelAppel : 
		  // On signale l'arrivée d'un nouvel appel à la fenêtre principale 
		  // pour ouvrir une Popup 
		  PostMessage(Handle(Fenêtre_Appel), "AppelTel", nIDAppel, nStatut) 
		  // On dispose d'informations sur l'appel 
		CAS telInformationAppel : 
		  // On signale l'arrivée d'un nouvel appel à la fenêtre principale 
		  // pour ouvrir une Popup 
		  PostMessage(Handle(Fenêtre_Appel), "AppelTelInfo", nIDAppel, nStatut) 
		  // La ligne a été raccrochée 
		CAS telLigneRaccrochée: 
		  // On signale l'arrivée d'un nouvel appel à la fenêtre principale 
		  // pour ouvrir une Popup 
		  PostMessage(Handle(Fenêtre_Appel), "AppelTelFin", nIDAppel, nStatut) 
	FIN
	```






- ![](https://doc.pcsoft.fr/fr-FR/images/image.awp?langid=5&name=WDTelephonie.gif) ***Exemples complets (WINDEV)*** : **WD Téléphonie** <br>Cet exemple illustre les fonctions téléphonie de WINDEV.<br>Dans cet exemple, nous abordons deux thèmes principaux :<br>1/ Comment composer un numéro de téléphone<br>2/ Détecter et identifier des appels entrants<br>Résumé de l'exemple livré avec WINDEV :	<br>Cet exemple présente les différentes fonctions de téléphonie fournies en standard avec WINDEV. Après avoir saisi quelques contacts dans la fenêtre principale (la table est en saisie), vous pourrez les appeler directement à partir de l'application (à condition que votre ordinateur soit équipé d'un modem correctement installé). Vous pourrez également avoir une notification des appels entrants et obtenir l'identité de l'appelant



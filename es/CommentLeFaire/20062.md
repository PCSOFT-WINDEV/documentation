
## ¿Cómo crear una consulta SQL con una fórmula de cálculo?
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>
Para realizar un cálculo sobre los datos procedentes de un archivo de datos, estos cálculos se pueden realizar mediante programación en WLanguage leyendo el contenido del fichero de datos.

El mejor método para realizar cálculos en datos de archivos consiste en utilizar una consulta SQL.

Veremos cómo realizar un cálculo utilizando: 

- [Método 1: una consulta SQL creada con el editor de consultas](#NOTE2_1).

- [Método 2: una consulta creada mediante programación](#NOTE3_1). 




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Consulta SQL con un cálculo
<a name="consulta_sql_con_calculo_ELTTEXTE000158"></a>
Esta consulta se utiliza para realizar un cálculo sobre los registros encontrados en un archivo de datos. 

En este ejemplo, vamos a calcular el valor de un pedido Line según un precio unitario, la cantidad pedida y un descuento.

Los diferentes pasos para crear esta consulta SQL con cálculo son los siguientes: 

1. Haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ico_nouveau.gif) en los botones de acceso rápido. 

	- En la ventana que se muestra, haga clic en "Consultas". 

	- El asistente de creación de consultas se abre.




2. Seleccione crear una consulta de selección (opción "Selección (SELECT)"). <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0001.gif&type=thumb)

	Pase a la etapa siguiente del asistente.

3. La ventana de descripción de la consulta se abre.

4. Dar un nombre y una leyenda a la consulta: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0002.gif&type=thumb)


5. En la sección izquierda de la ventana de description, elija los elementos de archivo que se utilizarán. En nuestro ejemplo, el archivo de datos es el archivo ORDLINE y los artículos son OrdLineNum y reference. 

6. Haga doble clic en los nombres de los elementos para añadirlos a la lista de elementos de consulta: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0003.gif)


7. Para realizar el cálculo, en la parte inferior izquierda del editor, haga clic en el botón "Elemento calculado" <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0004.gif)


8. En el menú que se muestra, seleccione "Nueva consulta calculada". Se visualiza la ventana para crear la posición calculada.. 

9. Dar un nombre y una leyenda a la posición calculada. <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0005.gif&type=thumb)


10. Escriba la fórmula. El código se puede escribir directamente en el área de código SQL. Para incluir un elemento, haga clic en su nombre en la lista de la izquierda: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0006.gif&type=thumb)


11. Validar. La ventana de consulta description se actualiza. La posición calculada se visualiza en la lista de posiciones que se tienen en cuenta: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0007.gif)


12. Valide la ventana de descripción de la consulta. La consulta se muestra en el editor: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0008.gif)


13. Guardar la consulta (Ctrl + S). 

14. Presione F2 para ver el código SQL: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Requ%EAte_Calcul%20-%20HC%20N%B0009.gif)


15. Ejecutar la prueba de consulta (GO en los botones de acceso rápido). 

16. La consulta se puede ejecutar en el programa por [HExecuteQuery](../WDLang4/3044080.md).




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Consulta SQL con cálculo mediante programación
<a name="consulta_sql_con_calculo_mediante_programacion_ELTTEXTE000182"></a>
Las consultas SQL pueden escribirse directamente mediante programación en el código WLanguage. Para ello, es necesario: 

1. Crear una Variable de tipo [Fuente de datos](../WDLang4/1514053.md) para representar la consulta en tiempo de ejecución. 

2. Crear una cadena de caracteres Variable para contener el código SQL de la consulta y escribir el código SQL en este Variable. 

3. Ejecute la consulta SQL con [HExecuteSQLQuery](../WDLang4/3044084.md).

4. Explore el resultado con las funciones HReadXXX.




Ejemplo de código


```wl
Src1 is Data Source
sSQLCode is string

// Products with the price IOT ...
sSQLCode = [
SELECT 
	PRODUCT.Reference AS Reference,	
	PRODUCT.ProdCap AS ProdCap,	
	PRODUCT.Pricebt AS Pricebt,	
	PRODUCT.Pricebt * (1 + PRODUCT.VATRate / 100) AS IOT
FROM 
	PRODUCT
]


HExecuteSQLQuery(Src1, hQueryDefault, sSQLCode)
FOR EACH Src1
	TRACE(Src1.Reference, Src1.ProdCap, Src1.IOT)

END
```





## ¿Cómo incluir el pago seguro en un sitio WEBDEV?


**Tabla de contenido**

[Importación de los elementos necesarios](#importacion_los_elementos_necesarios_ELTTEXTE000383)

[Modificar la página "backtostore](#modificar_pagina_backtostore_ELTTEXTE000407)

[Añadir código de ubicación](#anadir_codigo_ubicacion_ELTTEXTE000431)

[Personalización de la página de pago](#personalizacion_pagina_pago_ELTTEXTE000455)

[#El enlace "Pagar](#enlace_pagar_ELTPARAGRAPHE000139)

[#Los otros enlaces: ¿dónde colocar el código que guarda el pago?](#los_otros_enlaces_¿donde_colocar_codigo_que_guarda_pago_ELTPARAGRAPHE000213)

[Prueba de pago](#prueba_pago_ELTTEXTE000491)

[Los elementos a desplegar para el pago](#los_elementos_desplegar_para_pago_ELTTEXTE000515)

[Problemas comunes](#problemas_comunes_ELTTEXTE000539)

[#Error : La página de devolución no devuelve el resultado esperado](#error_pagina_devolucion_devuelve_resultado_esperado_ELTPARAGRAPHE000266)

[#Después de implementación, un mensaje indica : "Orden pendiente con intervención humana requerida"](#despues_implementacion_mensaje_indica_orden_pendiente_con_intervencion_humana_requerida_ELTPARAGRAPHE000302)

[#¿Cómo habilitar los registros (WLOG) y leerlos?](#¿como_habilitar_los_registros_wlog_leerlos_ELTPARAGRAPHE000331)

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Importación de los elementos necesarios
<a name="importacion_los_elementos_necesarios_ELTTEXTE000383"></a>


1. Abra su proyecto WEBDEV. 

2. Importar el "WW_SecurePayment" externo Component. 

	- En la pestaña "Proyecto", en el grupo "Proyecto", despliegue "Importar" y seleccione "Un componente externo .. Desde un archivo". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0001.gif&type=thumb)


	- Especifique la ruta del archivo WDI deseado. En nuestro caso, este archivo corresponde a "SecurePayment.wdi", ubicado en el subdirectorio WEBDEV: "\\Components\\Example components\\WW_SecurePayment\\Exe\\Component".  

- Se muestra la ventana del componente description. <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0002.gif)
 Cerrar esta ventana. 

3. A get una base de datos para incluir el pago seguro, le aconsejamos que importe 2 páginas específicas en su proyecto: 

	- En la pestaña "Proyecto", en el grupo "Proyecto", despliegue "Importar" y seleccione "Elementos WEBDEV y dependencias". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0003.gif&type=thumb)


	- Seleccione el directorio de importación. Este directorio corresponde al directorio de WW_Secure_payment Component que se encuentra en el subdirectorio WEBDEV: "Componentes\\Ejemplos de componentes\\WW_SecurePayment"

- Se muestra la lista de páginas. <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0004.gif)

4. Recompilar el proyecto para tener en cuenta estas páginas: en la pestaña "Proyecto", en el grupo "Proyecto", despliegue "Recompilar y sincronizar" y seleccione "Recompilar proyecto". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0005.gif&type=thumb)





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Modificar la página "backtostore
<a name="modificar_pagina_backtostore_ELTTEXTE000407"></a>


1. Abre la página de "backtostore" en el editor. 

2. Esta página contiene una página interna control llamada "iPage_RETURN". 

3. Mostrar la ventana de description de "iPage_RETURN" control. 

4. En la pestaña "General", modifica la página interna relacionado a la control: sustituir "iPage_Payback" por "SecurePayment.iPage_Payback". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0006.gif&type=thumb)


5. Guardar la página (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Enregistrer.gif)). 

6. Guarda una copy de esta página con un nombre personalizado: en la pestaña "Inicio", en el grupo "General", despliegue "Guardar" y seleccione "Guardar como". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0007.gif)


7. En la ventana que se muestra, especifique el nuevo nombre de página y valide. <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0008.gif)

	Observación: Personalizar esta página con un nombre específico aumenta la seguridad del pago. 

8. Asegúrese de que esta página no esté referenciada: 

	- Abra la ventana description de la página renombrada. 

	- En la pestaña "Detalles", seleccione la opción "No permitir SEO". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0009.gif&type=thumb)


	- Valide la ventana de descripción. 




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Añadir código de ubicación
<a name="anadir_codigo_ubicacion_ELTTEXTE000431"></a>
Debe añadir, **al principio del código del proyecto** (en el evento "Inicialización del proyecto tras la conexión al sitio", por ejemplo), el código que permite al Component localizar el fichero de pago y definir su contraseña. 

Este código es el siguiente: 


```wl
<BLOCK Location of file for the secure payment component>
	//To trace on the server if necessary
	//dbgEnableLog(fDataDir()+["\"]+"paymentlog_[%Date%]_[%Time%].wlog",LogAll)
		//Location of payment file
		DataParameters(fDataDir() + "\Payment", "file password to customize")
//		//or using a connection, for example:
//			gcntCSDatabase is connection
//			gcntCSDatabase..Provider=hAccessHFClientServer
//			gcntCSDatabase..User="admin"
//			gcntCSDatabase..server="127.0.0.1"
//			gcntCSDatabase..Database="mydatabase"
//                 DtaParameters("Payment","file password to customize", ...
//                          gcntCSDatabase, "PasswordDatabaseConnection")
<END>
```


<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Personalización de la página de pago
<a name="personalizacion_pagina_pago_ELTTEXTE000455"></a>


1. Abra la página "PAGE_Secure_Payment_xxx" donde xxx corresponde a la solución de pago que se utilizará. En este ejemplo, usaremos la página "PAGE_Secure_Payment_ATOS.wwh"

2. Suprimir el botón "Signo de interrogación" que hace referencia a una página de información que no fue importada en este proyecto. 

3. Sólo para ATOS: 

	- Suprima el "IMG_BANK" control Imagen cuyo Image no fue importado a este proyecto.

	- Eliminar el código que se refiere al "IMG_BANK" control en las declaraciones globales de la página. 




4. Ajuste el tipo de página según el tipo de página que se utilizará en su proyecto: Sesión, AWP, modo Zoning, modo Responsive, etc.<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0010.gif&type=thumb)


5. Para ATOS, asegúrese de que el objetivo del enlace "Pay" es el iFrame "IFRM_PAYMENT".. <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise%20-%20HC%20N%B0011.gif&type=thumb)






### El enlace "Pagar
<a name="enlace_pagar_ELTPARAGRAPHE000139"></a>

Este enlace contiene el código que activa el pago seguro. 

**1. Parámetros específicos de la cuenta bancaria**
Los parámetros específicos de la cuenta bancaria deben especificarse en este código. La información difiere según la solución de pago seleccionada. 

Su proyecto contiene una página específica correspondiente al pago deseado: en el código de este enlace, encontrará un código adaptado al tipo de pago seleccionado. Este código contiene comentarios explicativos específicos de los parámetros solicitados.

***ejemplo para ATOS***:

- Se debe especificar una "sociedad : 
	```txt
	MyPayment:CompanyCode
	```


- También debe reemplazar los archivos que se encuentran en el subdirectorio cuyo nombre se relaciona con la solución de pago seguro utilizada por los archivos suministrados por el banco. En este ejemplo, los archivos que se encuentran en el subdirectorio "Mercanet" : pathfile, parmcom.0825843414111111, parmcom.mercanet y certif.fr.08258434141411111




***Ejemplo para Lyra (Systempay, Cyberplus, Spplus, Payzen, etc.)***:
Debe especificar: 

- un "identificador de sitio" : MiPago:SiteIdentifier

- un número de Certificate MyPayment:Certificate. 


Esta información se encuentra en el sitio de back-office, en la configuración de la tienda, en la pestaña "Certificados".

**2. Nombre de la página de retorno de "servidor a servidor" (también llamado IPN : Pago instantáneo Notification)**
En este código, el nombre de la página IPN debe ser reemplazado por el nombre de la página personalizada. Por ejemplo: 

```txt
MyPayment:IPN Page="custompagenameforthereturns2s"
```
cambia a: 

```txt
MyPayment:IPNPage="RETURN_S2S_B6SH7ZEX"
```


Dependiendo de la solución de pago seleccionada, la URL en la que esta página será accesible debe indicarse en el back-office del banco. Esta URL tiene el siguiente formato : 

```txt
http://<domain>/<Site name>_WEB/<Language>/<Page name>.awp
```


Ejemplo: 

- Usando una página de retorno (llamada "RETURN_S2S_B6SH7ZEX") para un sitio WEBDEV que se llama "shop" y que se despliega en un servidor con el nombre de dominio "www.mydomain.eu" en inglés.: 
	
	```txt
	http://www.mydomain.eu/SHOP_WEB/EN/RETURN_S2S_B6SH7ZEX.awp
	```


- En el sitio de back-office para la solución de Lyra, debe entrar en el entorno de la tienda.. En la pestaña "Configuración", sección "URL de retorno", ACTIVE la opción "URL de notificación al final del pago". 




**Atención**: su código para la gestión de la finalización del pago no debe encontrarse en estas páginas. Su código para gestionar el fin del pago debe encontrarse en "el enlace para volver a la tienda" y en "el enlace de retorno de servidor a servidor" (este tema se explicará en el resto de esta Document). 

**3. Imágenes de tarjetas para ATOS**
Para ATOS, las imágenes de las tarjetas bancarias pueden no ser mostradas. En ese caso: 

1. Abra el código del enlace "Paga".. 

2. Añade el siguiente código después de la declaración de MyPayment Variable: 
	
	```wl
	MyPayment is SecurePayment(nBank) // Existing line
	MyPayment.FolderWebLogo = FolderWeb() + "/SecurePayment/EN/ATOS/"
	```





**'4. Otras personalizaciones**'
También tienes la posibilidad de personalizar varias informaciones, sigue las instrucciones dadas en el enlace de comment de "Paga".. 
Dependiendo de las soluciones de pago, usted puede: 

- especificar la facturación de Address.

- especificar la entrega Address.

- especifique el contenido de la cesta.

- especifique algunos tipos de tarjetas bancarias.

- realizar suscripciones.

- ...


El método "FormParameterAdd" se utiliza para modificar o añadir información en el formulario enviado al banco.

Para más detalles, consulte la documentación del pago seleccionado.


### Los otros enlaces: ¿dónde colocar el código que guarda el pago?
<a name="los_otros_enlaces_¿donde_colocar_codigo_que_guarda_pago_ELTPARAGRAPHE000213"></a>

Otros dos enlaces se encuentran en la página: 

- El enlace "Volver a la tienda: 
	El código de este enlace se ejecuta cuando el usuario de la Web finaliza su pago, independientemente de que se haya realizado con éxito o no, cuando vuelve al sitio web. 
	**Atención**: Algunos usuarios de la web nunca vuelven al sitio del comerciante, a causa de un error de funcionamiento o de un fallo de INTERNET por ejemplo. Sin embargo, en el modo de prueba, en un ordenador no accesible por el servidor del banco, es el único código que se ejecuta.

- El enlace "Retorno Servidor a Servidor" (también llamado "IPN": Pago instantáneo Notification)
	El código de este enlace se ejecuta cuando el usuario web valida su pago en el sitio del banco antes de que decida volver al sitio del comerciante o no..
	**Atención**: Este código se ejecuta a través de una llamada directa al servidor del banco, por lo tanto fuera de cualquier contexto, cookies, sesión, ... del usuario Web.
	En desarrollo, en modo de prueba, en un ordenador no accesible por el servidor del banco, este código no se ejecuta.




**¿En dónde se debe escribir el código que registra el pago?**
Una de las mejores soluciones es colocar el código que guarda el pago en el código associated con ambos enlaces "Back to store" y "IPN" pero con pequeñas variaciones.

- En el código del enlace "Enviar al servidor : en este código, debes guardar el pago, actualizar la base de datos y enviar un Email con la factura. Sin embargo, este código no se ejecuta en modo de test: la implementación es compleja. 

- En el código del enlace "Volver a la tienda: debe comprobar que la devolución de servidor a servidor ya se ha guardado, excepto en el modo de prueba. En caso contrario, el pago debe ser guardado como en anomalía y debe ser verificado.. 
	Si la información debe mostrarse al usuario Web después del pago, continúe ; o si desea solicitarle nueva información, puede hacerlo en este código.




<a name="NOTE6"></a>
<a name="NOTE6_1"></a>


## Prueba de pago
<a name="prueba_pago_ELTTEXTE000491"></a>
Para probar el pago, usted puede: 

- Inicie la página importada directamente,

- Añade un código que inicie la página importada y pase como parámetro los elementos necesarios a la página : cantidad adeudada, Email del comprador, prueba o pago real, etc.




**¿Qué cambia una vez desplegado el sitio?**
Una vez que el sitio se implementa en un servidor, la IPN debe ejecutarse además de la devolución a la tienda como se explicó anteriormente. Cuando las pruebas sean validadas, tendrá que cambiar la opción especificando que se trata de un pago de prueba e indicando que los pagos son ahora reales.

<a name="NOTE6B"></a>
<a name="NOTE6B_1"></a>


## Los elementos a desplegar para el pago
<a name="los_elementos_desplegar_para_pago_ELTTEXTE000515"></a>
Durante el implementación, debe **excluir el** de implementación los archivos de "Transacción" HFSQL que contienen las transacciones de prueba realizadas localmente : <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=CLF_Paiement_securise_Ato2.gif)


<a name="NOTE7"></a>
<a name="NOTE7_1"></a>


## Problemas comunes
<a name="problemas_comunes_ELTTEXTE000539"></a>


### Error : La página de devolución no devuelve el resultado esperado
<a name="error_pagina_devolucion_devuelve_resultado_esperado_ELTPARAGRAPHE000266"></a>

Este error puede ocurrir una vez que el sitio está desplegado. Significa que el Component ha intentado sin éxito acceder a la página de "vuelta a la tienda" o a la página de "IPN".

Las principales razones son:

- Caso 1: En el código de inicialización del proyecto, hay un código que fuerza la visualización de una página específica de otra página si no se reciben algunos parámetros. 

- Caso 2: El parámetro de red del servidor no le permite unirse a sí mismo. 




Para encontrar una solución: 

1. Compruebe esta URL en su navegador : 
	
	```txt
	http://www.mydomain.eu/MYSITE_WEB/EN/backtostore.awp?TEST=O
	```

	mediante la sustitución : 

	- "www.mydomaine.eu" por el nombre del sitio o IP Address,

	- "MYSITE" por el nombre del proyecto del sitio,

	- "backtostore" por el nombre de la página 'back to store' y luego por el nombre de la página IPN. 




2. **TEl test de esta URL debe mostrar OK**

	- **If la prueba muestra OK**: el problema puede ser relacionado a la configuración de la red del servidor (caso 2). Asegúrese de que el componente no ejecuta esta prueba habilitando la siguiente línea de código (que debe encontrarse ya pero en comment): 
			
		```wl
		MyPayment.IgnoreTestReturnPage = True
		```


	- **If la prueba muestra otra página**, usted probablemente está en el caso 1: compruebe el código del proyecto y asegúrese de que no se fuerza la visualización de la página ([PageDisplay](../WDLang2/3058008.md)). Y por ejemplo, no realice esta acción en modo AWP ([InAWPMode](../WDLang1/3014031.md)). 

	- Si la prueba muestra un error, debe encontrar el origen de este error.. 

	- Si ninguno de los casos anteriores coincide, habilite los registros (wlog) para entender lo que sucede. 








### Después de implementación, un mensaje indica : "Orden pendiente con intervención humana requerida"
<a name="despues_implementacion_mensaje_indica_orden_pendiente_con_intervencion_humana_requerida_ELTPARAGRAPHE000302"></a>

Este mensaje puede aparecer al volver al sitio después del pago cuando la información recibida indica que el pago fue validado pero que la IPN no fue guardada.. 

El IPN se realiza sólo en implementación, este mensaje no puede ser mostrado en el modo de prueba.

Para encontrar una solución: 

1. Compruebe esta URL en su navegador : 
	
	```txt
	http://www.mydomain.eu/MYSITE_WEB/EN/customipnpage.awp?TEST=O
	```
mediante la sustitución : 

	- "www.mydomaine.eu" por el nombre del sitio o IP Address,

	- "MYSITE" por el nombre del proyecto del sitio,

	- "customipnpage" por el nombre de la página de retorno y luego por el nombre de la página de IPN. 




2. Si la prueba muestra: 

	- otra página, compruebe el código del proyecto para ver si no se fuerza la visualización de una página en algunos casos ([PageDisplay](../WDLang2/3058008.md)). Y por ejemplo, no realice esta acción en modo AWP ([InAWPMode](../WDLang1/3014031.md)). 

	- un error, debe encontrar el origen de este error. 

	- OK o si ninguna de las opciones anteriores se aplica a su caso, consulte el registro de transacciones en la tabla "Transacciones", elemento "LogInfo". Este registro también puede ser recuperado por **TransactionLog**, **TransactionLogAccordingToID** mediante programación.








### ¿Cómo habilitar los registros (WLOG) y leerlos?
<a name="¿como_habilitar_los_registros_wlog_leerlos_ELTPARAGRAPHE000331"></a>

La creación de registros (WLog) es una característica de WLanguage que se utiliza para guardar en un archivo todas las líneas de código que se ejecutan en un archivo WLOG con más o menos detalles. Para ello, debe utilizar [dbgEnableLog](../WDLang1/1000017137.md). 

Si lees este Document cuidadosamente, en el código del proyecto, hay un Line para el que se pueden eliminar los comentarios: 

```wl
dbgEnableLog(fDataDir()+["\"]+"paymentlog_[%Date%]_[%Time%].wlog", LogAll)
```


En caso de dificultad, usted debe: 

1. Habilitar los registros. 

2. Despliegue el sitio (si el problema ocurre sólo en implementación). 

3. Vuelva a realizar la operación que desencadenó el problema.

4. get los archivos WLOG para abrirlos con WEBDEV.




**Atención**: WEBDEV no mostrará toda la información que se encuentra en los archivos WLOG: sólo mostrará la información relativa a la configuración del proyecto Active abierta en el editor.

- No se mostrará ninguna información si no se abre ningún proyecto. 

- Si su proyecto está abierto, verá las líneas de código ejecutadas por su proyecto. 

- Si se abre el proyecto de pago seguro Component con la configuración de Component habilitada , se verán las líneas de código ejecutadas por el Component.




Atención: Los registros no deben dejarse habilitados de forma permanente.: esto puede ralentizar el sitio y reducir el espacio en disco. Para evitar tener que recompilar el sitio para habilitar los registros, la activación puede activarse de acuerdo con la información de un archivo de configuración, por ejemplo. Por ejemplo: 

```wl
IF Val(INIRead("PARAMETER", "WLOG", "0" , fDataDir() + ["\"]  + "param.ini")) = 1 THEN
	dbgEnableLog(fDataDir() + ["\"] + "paymentlog_[%Date%]_[%Time%].wlog", LogAll)		
END
```




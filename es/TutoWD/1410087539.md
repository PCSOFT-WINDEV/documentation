
## Lección 4.8. Enviar un correo electrónico
<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Esta lección abarcará los siguientes temas
<a name="esta_leccion_abarcara_los_siguientes_temas_ELTTEXTE000561"></a>


- Cómo enviar un correo electrónico desde una aplicación WINDEV.

- Cómo incluir un supercontrol en una ventana.

- Cómo definir el orden de tabulación en una ventana.

- Cómo abrir una ventana no modal.





|   |   |
| --- | --- |
| <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=dur%E9e.png)<br> | <br>Tiempo estimado: 20 min |

| [Lección anterior](../TutoWD/1410087538.md) | [Tabla de contenido](../TutoWD/1410087560.md) | [Siguiente lección](../TutoWD/1410087524.md) |
| --- | --- | --- |





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000608"></a>
WLanguage incluye un gran número de funciones que permiten gestionar el envío y la recepción de correos electrónicos. También puede acceder a las características de un correo electrónico:

- remitente, destinatarios,

- fecha de envío, asunto, mensaje, 

- archivos adjuntos...




WINDEV incluye varios métodos para administrar correos electrónicos:

- A través de Lotus Notes, Outloook o MS Exchange:

	- **Lotus Notes o Outlook**: estos programas le permiten enviar y recibir correos electrónicos.

	- " **Simple Mail API**" (también llamado SMAPI o Simple MAPI): este modo de gestión de correos electrónicos es utilizado por la mayoría de las aplicaciones de Microsoft, especialmente por Microsoft Exchange.




- A través de los protocolos POP3, IMAP y SMTP:

	- Protocolo **POP3**: este protocolo de recepción de correos electrónicos es compatible con todos los proveedores de servicios. Permite comunicarse directamente con el servidor y está disponible en su proveedor de servicios de Internet (ISP). Además, permite ver la lista de mensajes entrantes y leerlos.

	- Protocolo **IMAP**: este protocolo de recepción de correos electrónicos permite dejar los correos en el servidor de manera que puedan ser leídos desde diferentes clientes de correo electrónico o webmails.

	- Protocolo **SMTP**: este protocolo de envío de correos electrónicos es compatible con todos los proveedores de servicios. 







En esta lección, vamos a crear una ventana para que el usuario envíe un correo electrónico desde la aplicación "WD Full Application". La ventana es la siguiente:  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P4_Application%20compl%E8te%20-%20Envoi%20email%20-%20HC%20N%B0004.jpg&type=thumb)


Vamos a usar el protocolo SMTP. Este es el modo de envío más utilizado. 

Para obtener más información sobre los otros métodos, consulte [Envío y recepción de correos electrónicos](../WDLang3/3032007.md).



- Abra de nuevo el proyecto en el que trabajó en la lección anterior. 

	1. Vaya a la página de inicio de WINDEV (Ctrl + &lt;).

	2. En la página de inicio, haga clic en "Tutorial", luego en "Part 4 - Full application with data" haga doble clic en "Full application - Exercise".

	3. Un cuadro de diálogo le pide que abra el proyecto en el que trabajó en la lección anterior. Puede abrir la copia local o el proyecto original. Seleccione "Abrir la copia local". 





|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=exemple-WD.png) | Corregido | Hay un proyecto completado disponible. Este proyecto contiene los diferentes elementos creados en esta lección. Para abrir el proyecto completado, vaya a la página de inicio y haga clic en "Tutorial", luego en "Part 4 - Full application with data", haga doble clic en "Full application - Answers". |





|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=exemple-WD.png) | Ejemplo | Para obtener más información sobre la gestión de correos electrónicos, consulte el ejemplo "WD Mail" (ejemplo completo proporcionado con WINDEV). Puede acceder a este ejemplo desde la página de inicio de WINDEV (Ctrl + &lt;). |





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Ventana para enviar correos electrónicos
<a name="ventana_para_enviar_correos_electronicos_ELTTEXTE000668"></a>
Esta ventana contendrá todos los controles que permiten al usuario escribir los diferentes elementos del correo electrónico. Un control Botón "Send" agrupará todos los procesos que permiten enviar el correo electrónico.
<a name="NOTE3_2"></a>


### Crear una ventana
<a name="crear_una_ventana_ELTPARAGRAPHE000078"></a>

- Cree una nueva ventana:

	1. Abra el proyecto "WD Full Application", si es necesario.

	2. Cree una nueva ventana en blanco.

		- Haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Cr%E9er1_GAF.jpg) en los botones de acceso rápido.

		- La ventana de creación de nuevos elementos se abre: haga clic en "Ventana", y luego en "Ventana".

		- El asistente de creación de ventanas se abre.

		- En la pestaña "Basado en un modelo", seleccione "Utilizar: WINTPL_Template" y valide el asistente.




3. La ventana para guardar el elemento se abre. Introduzca "Sending an email" en el título, el nombre se completa automáticamente: "WIN_Sending_an_email". Valide la información predeterminada.



<a name="NOTE3_3"></a>


### Crear controles para el envío de correos electrónicos
<a name="crear_controles_para_envio_correos_electronicos_ELTPARAGRAPHE000096"></a>

Primero, crearemos todos los controles para configurar el servidor SMTP utilizado para el envío de mensajes. Se necesitan cuatro controles Campo de entrada:

- Servidor SMTP,

- Puerto del servidor SMTP,

- Nombre de usuario,

- Contraseña del usuario.




- Para crear el control Campo de entrada que corresponde al nombre del servidor SMTP:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Saisie_GAF.jpg).

	2. La forma del control aparece bajo el cursor.

	3. Haga clic en el área superior izquierda de la ventana: el control Campo de entrada se crea automáticamente.

	4. Seleccione el control y presione la tecla Entrar. El texto pasa a modo de edición. Introduzca "SMTP server" y valide. El nombre del control cambia automáticamente a EDT_SMTP_Server. 







- Para crear el control Campo de entrada que corresponde al puerto:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", despliegue "Entrada".

	2. Seleccione un Campo de entrada predefinido de tipo Entero.

	3. La forma del control aparece bajo el cursor.

	4. Haga clic debajo del control "SMTP server": el control Campo de entrada se crea automáticamente.

	5. Seleccione el control y presione la tecla Entrar. El texto pasa a modo de edición. Introduzca "Port" y valide. El nombre del control cambia automáticamente a EDT_Port. 







- Para crear el control Campo de entrada que corresponde al nombre de usuario:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Saisie_GAF.jpg).

	2. La forma del control aparece bajo el cursor.

	3. Haga clic debajo del control "Port": el control Campo de entrada se crea automáticamente.

	4. Seleccione el control y presione la tecla Entrar. El texto pasa a modo de edición. Introduzca "User" y valide. El nombre del control cambia automáticamente a EDT_User. 







- Para crear el control Campo de entrada que corresponde a la contraseña del usuario:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", despliegue "Entrada".

	2. Seleccione el control Campo de entrada predefinido "Password".

	3. La forma del control aparece bajo el cursor.

	4. Haga clic debajo del control "User": el control Campo de entrada se crea automáticamente.
			|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=astuce.png) | Consejo | El control "Password" aparece en el editor con un punto y un ícono de "ojo".<br><br>En ejecución, cuando el usuario introduzca la contraseña, los caracteres serán reemplazados por puntos. Los usuarios podrán hacer clic en el ícono del ojo para cambiar la visibilidad de la contraseña: esto le permite a los usuarios comprobar sus contraseñas.<br><br> |











- Alinee los controles que acaba de crear:

	1. Seleccione los cuatro controles.

	2. En la pestaña "Alineación", en el grupo "Interno y externo", haga clic en "Justificar (Int. y Ext.)". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P4_Application%20compl%E8te%20-%202%20-%20Fiche%20produit%20-%20HC%20N%B0006.jpg&type=thumb)<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P4_Application%20compl%E8te%20-%20Envoi%20email%20-%20HC%20N%B0001.jpg)


	3. Guarde la ventana (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Enregistrer_GAF.jpg) o Ctrl + S).



<a name="NOTE3_4"></a>


### Crear los controles que permitirán introducir las características del correo electrónico
<a name="crear_los_controles_que_permitiran_introducir_las_caracteristicas_del_correo_electronico_ELTPARAGRAPHE000216"></a>

Para escribir un correo electrónico, el usuario necesita:

- Un control para introducir la dirección del remitente.

- Un control para introducir o seleccionar la dirección del destinatario.

- Un control para introducir el asunto del correo electrónico.

- Un control para introducir el texto del correo electrónico. El usuario debe tener la posibilidad de definir el formato del texto del correo electrónico.

- Un control para agregar archivos adjuntos.


Crearemos estos controles en nuestra ventana.



- Para crear el control Campo de entrada que corresponde a la dirección del remitente:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", despliegue "Entrada".

	2. Escriba "Correo" en el cuadro de búsqueda de la lista de controles predefinidos. Seleccione "Entrada correo electrónico".

	3. La forma del control aparece bajo el cursor.

	4. Haga clic debajo del control "Password": el control Campo de entrada se crea automáticamente.

	5. Seleccione el control y presione la tecla Entrar. El texto pasa a modo de edición. Introduzca "Sender" y valide.







- El control utilizado para escribir la dirección del destinatario debe contener la lista de direcciones de los clientes que se encuentran en la base de datos, pero también debe permitir al usuario escribir otra dirección. Para ello, utilizaremos un control "Combo Box con entrada" relacionado con el archivo de datos Customer.

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", haga clic en "Combo Box".

	2. La forma del control aparece bajo el cursor.

	3. Haga clic debajo del control "Sender": el asistente de creación del control Combo Box se abre automáticamente.

	4. Seleccione la opción "Mostrar datos de un archivo o una consulta existente". Pase a la etapa siguiente.

	5. Seleccione el archivo de datos Customer. Pase a la etapa siguiente.

	6. Las direcciones de correo electrónico de los clientes se mostrarán en el control:

		- Deseleccione el campo "CustomerID".

		- Seleccione el campo "Email".


 Pase a la etapa siguiente.

7. El criterio de ordenación es el campo "Email". Pase a la etapa siguiente.

8. El valor de retorno es el campo "Email". Pase a la etapa siguiente.

9. Conserve las opciones predeterminadas. Pase a la etapa siguiente.

10. En la etapa "Parámetros adicionales", seleccione la casilla "Permitir entrada". El usuario debe poder introducir una dirección de correo electrónico. Pase a la etapa siguiente.

11. Cambie el nombre y el título del control Combo Box:

	- Introduzca "COMBO_Recipient" en el campo del nombre.

	- Introduzca "Recipient" en el campo del título.




- Para crear el control Campo de entrada que corresponde al asunto del correo electrónico:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Saisie_GAF.jpg).

	2. La forma del control aparece bajo el cursor.

	3. Haga clic debajo del control "Recipient": el control Campo de entrada se crea automáticamente.

	4. Seleccione el control y presione la tecla Entrar. El texto pasa a modo de edición. Introduzca "Subject" y valide.







- Para el cuerpo del mensaje, utilizaremos un control Editor HTML para correos electrónicos: el usuario podrá definir fácilmente el formato del texto del correo electrónico mediante una cinta de opciones específica.

	1. En la pestaña "Creación", en el grupo "Otros controles", despliegue "HTML" y seleccione "Editor HTML para correos electrónicos".

	2. La forma del control aparece bajo el cursor.

	3. Haga clic debajo del control "Subject": El control Editor HTML se crea automáticamente.

	4. Agrande la ventana utilizando los controladores de tamaño, luego amplíe el control vertical y horizontalmente para que la cinta de opciones del control y algunas líneas de texto se muestren correctamente.

	5. Seleccione el control Editor HTML y abra la ventana de descripción (Alt + Enter). 

	6. Cambie el nombre del control. Defina "HTMEDT_Email" como nombre del control. 







- Vamos a crear un selector de archivos para que los usuarios puedan agregar archivos adjuntos. En lugar de crearlo desde cero, vamos a utilizar un control Campo de entrada predefinido de tipo archivo. El usuario podrá seleccionar el archivo a adjuntar haciendo clic en "Examinar" en el menú contextual del control. 

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", despliegue "Entrada". La lista de controles predefinidos se abre.

	2. Seleccione el control "Entrada ruta de archivo" y arrástrelo a la ventana "WIN_Sending_an_email": suelte el control debajo del control "Editor HTML". El selector de archivos se crea inmediatamente. 







- Alinee todos los controles de la ventana.  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P4_Application%20compl%E8te%20-%20Envoi%20email%20-%20HC%20N%B0002.jpg&type=thumb)



Vamos a crear el control Botón que nos permitirá enviar los correos electrónicos.
<a name="NOTE3_5"></a>


### Envío de correos electrónicos
<a name="envio_correos_electronicos_ELTPARAGRAPHE000347"></a>

- Amplíe la ventana para tener espacio suficiente para agregar un botón debajo del control Editor HTML: utilice el controlador de redimensionamiento de la esquina inferior derecha de la ventana. 




- Para crear el control Botón de envío de correos electrónicos:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Bouton_GAF.jpg).

	2. Haga clic en la ubicación en la que desea crear el control (por ejemplo, en la parte inferior de la ventana).

	3. Seleccione el control y cambie el texto (presione Entrar, por ejemplo). Introduzca "Send".

	4. Edite el código WLanguage del control Botón: haga clic derecho y seleccione "Código" en el menú contextual.

	5. Introduzca las siguientes líneas de código en el evento "Clic":

		- Código WLanguage para la conexión e inicio de sesión SMTP:
						
			```wl
			MySession is emailSMTPSession
			MySession.Name = EDT_User
			MySession.Password = EDT_Password
			MySession.ServerAddress = EDT_SMTP_Server
			MySession.Port = EDT_Port
			// Starts the SMTP session
			IF NOT MySession.StartSession() THEN
				Error("Unable to connect to the SMTP server.", ErrorInfo())
				RETURN
			END
			```
 Este código utiliza una variable avanzada de tipo [emailSMTPSession](../WDLang3/1000018765.md). Las diferentes propiedades de esta variable definen las características de la sesión SMTP. Luego, se utiliza la función [&lt;Sesión&gt;.StartSession](../WDLang3/1000022306.md) para iniciar la sesión.

		- código WLanguage para preparar el correo electrónico:
						
			```wl
			MyMessage is Email
			
			MyMessage.Sender = EDT_Sender
			MyMessage.Subject = EDT_Subject
			
			HTMEDT_Email.ToEmail(MyMessage)
			
			// Adds a recipient
			MyMessage.Recipient.Add(COMBO_Recipient.DisplayedValue)
			
			
			// Adds the attachment if necessary
			IF EDT_File <> "" THEN
				MyMessage.LoadAttachment(EDT_File)
			END
			```
 Este código utiliza una variable de tipo [Email](../WDLang3/1000018713.md). Las diferentes propiedades de esta variable definen las características del correo electrónico que se va a enviar. Este código asocia el contenido de los diferentes controles de la ventana a las propiedades de la variable Email.
						En este código: 

			- la función [&lt;Control Editor HTML&gt;.ToEmail](../WDLang1/1000026308.md) asocia directamente el contenido del correo electrónico con las propiedades correspondientes de la variable Email. Si se incluyen imágenes en el texto del correo electrónico, se añadirán automáticamente como archivos adjuntos.

			- la función [&lt;Correo&gt;.LoadAttachment](../WDLang3/1000022277.md) integra el archivo adjunto, si existe, en la variable [Email](../WDLang3/1000018713.md).   




- Código WLanguage para el envío del correo electrónico:
						
			```wl
			// Sends the email
			IF MySession.SendMessage(MyMessage) = False THEN
				Error("Message not sent.", ErrorInfo())
			ELSE
				// Message sent
				ToastDisplay("Message sent", toastShort, vaMiddle, haCenter)
			END
			```
El correo electrónico se envía con la función [&lt;Email&gt;.SendMessage](../WDLang3/1000022314.md). Simplemente pase como parámetros la variable que contiene las características de la sesión SMTP, y la variable que contiene las características del correo electrónico a enviar. 
						Si se envía el correo electrónico, se muestra un mensaje Toast indicando que el correo electrónico se ha enviado. Un Toast es un mensaje corto que aparece durante unos segundos.

- Código WLanguage para cerrar la sesión SMTP:
						
			```wl
			// Closes the SMTP session
			MySession.CloseSession()
			```
Este código cierra la sesión con la función [&lt;Sesión&gt;.CloseSession](../WDLang3/1000022286.md).




- Guarde la ventana y el código (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Enregistrer_GAF.jpg) o Ctrl + S).




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Mejoras en la ventana
<a name="mejoras_ventana_ELTTEXTE000734"></a>
Vamos a mejorar nuestra ventana:

- Agregar un control Botón para cerrar la ventana.

- Definir el formato de la ventana fijando los anclajes y el orden de tabulación.

- Abrir la ventana desde la ventana "WIN_Menu".



<a name="NOTE4_2"></a>


### Cerrar la ventana
<a name="cerrar_ventana_ELTPARAGRAPHE000435"></a>

- Para agregar un control Botón que permita cerrar la ventana:

	1. En la pestaña "Creación", en el grupo "Controles frecuentes", despliegue "Botón": la lista de botones predefinidos aparece.

	2. Haga clic en el botón "Cerrar".

	3. Haga clic en la ubicación en la que desea crear el control (por ejemplo, abajo, a la derecha del botón "Send").






<a name="NOTE4_3"></a>


### Formato
<a name="formato_ELTPARAGRAPHE000458"></a>

- Para definir los anclajes:

	- Seleccione los controles "Sender", "Recipient" y "Subject": ancle los controles horizontalmente.

	- Seleccione el control "Editor HTML": ancle el control vertical y horizontalmente.

	- Seleccione los controles Botón: ancle los controles a la derecha y abajo.

	- Seleccione el control de selección de archivos: ancle el control horizontalmente y hacia abajo.







- Para definir el orden de tabulación:
	|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=note.png) | Nota | El orden de tabulación de los controles es el orden en el que el usuario podrá introducir los valores en los diferentes controles de la ventana. En tiempo de ejecución, la tecla Tab permite cambiar de un control a otro.<br>El orden de tabulación predeterminado es el orden en el que se crearon los controles. Se puede modificar:<br><br>	- especificando un orden de tabulación automático: el primer control en el orden de tabulación será el que se encuentre en el área superior izquierda de la ventana, el segundo control será el que esté a su derecha o debajo, y así sucesivamente...<br><br>	- especificando un orden de tabulación mediante una selección.<br><br><br> |





	1. Pulse F5 para ver el orden de tabulación.

	2. Defina un orden de tabulación automático: en la pestaña "Ventana", en el grupo "Orden", despliegue "Orden tab." y seleccione "Definir automáticamente".

	3. Los números cambian y aparecen en orden.  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P4_Application%20compl%E8te%20-%20Envoi%20email%20-%20HC%20N%B0003.jpg&type=thumb)


	4. Presione F5 de nuevo para ocultar los números.

5. Guarde la ventana (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Enregistrer_GAF.jpg) o Ctrl + S).



<a name="NOTE4_4"></a>


### Apertura no modal de la ventana
<a name="apertura_modal_ventana_ELTPARAGRAPHE000501"></a>

La ventana de gestión de correos electrónicos se abrirá desde la ventana "WIN_Menu". Esta ventana se abrirá utilizando un modo específico, dado que no debe bloquear la información de la ventana "WIN_Menu".



- Para abrir la ventana "WIN_Sending_an_email" desde la ventana "WIN_MENU":

	1. Abra la ventana "WIN_Menu" en el editor (haga doble clic en ella en el panel "Explorador de proyectos").

	2. En el editor, despliegue la opción "Menu" y seleccione "Exit".

	3. Haga clic derecho para abrir el menú contextual de la opción "Exit" y seleccione "Agregar antes".

	4. Introduzca el texto "Send an email" y valide.

	5. Seleccione de nuevo la opción "Exit".

	6. Haga clic derecho para abrir el menú contextual de "Exit" y seleccione "Insertar un separador".

	7. Haga clic derecho para abrir el menú contextual de la opción "Send an email" y seleccione "Código".

	8. Introduzca el siguiente código WLanguage:
			
		```wl
		// Opens the window for sending emails
		WIN_Sending_an_email.OpenChild()
		```
En este código WLanguage, la función [&lt;Ventana&gt;.OpenChild](../WDLang1/3038021.md) abre la ventana en modo "no modal": el usuario podrá escribir un correo electrónico y ver la información de la ventana principal al mismo tiempo.







- Guarde la ventana y el código (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Enregistrer_GAF.jpg) o Ctrl + S).




- Ejecute la prueba del proyecto (haciendo clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_GO_Projet_WD_GAF.jpg) en los botones de acceso rápido) y abra la ventana de envío de correos electrónicos a través de la opción "Menu .. Send an email".  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P4_Application%20compl%E8te%20-%20Envoi%20email%20-%20HC%20N%B0004.jpg&type=thumb)





| [Lección anterior](../TutoWD/1410087538.md) | [Tabla de contenido](../TutoWD/1410087560.md) | [Siguiente lección](../TutoWD/1410087524.md) |
| --- | --- | --- |





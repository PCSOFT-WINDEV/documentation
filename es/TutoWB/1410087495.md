
## Lección 5.2. Imprimir una factura


<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Esta lección abarcará los siguientes temas
<a name="esta_leccion_abarcara_los_siguientes_temas_ELTTEXTE000578"></a>


- Crear un reporte basado en una consulta.

- Imprimir un reporte basado en una consulta con parámetros.





|   |   |
| --- | --- |
| <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=dur%E9e.png)<br> | <br>Tiempo estimado: 45 min |

| [Lección anterior](../TutoWB/1410087494.md) | [Tabla de contenido](../TutoWB/1410087510.md) | [Siguiente lección](../TutoWB/1410087496.md) |
| --- | --- | --- |





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000625"></a>
Los usuarios podrán imprimir directamente la factura del pedido buscado.



- Abra de nuevo el proyecto en el que trabajó en la lección anterior. 

	1. Vaya a la página de inicio de WEBDEV (Ctrl +&lt;).

	2. En la página de inicio, haga clic en "Tutorial", luego en "Parts 3 to 6", haga doble clic en "Full WEBDEV Site - Exercise".

	3. Un cuadro de diálogo le pide que abra el proyecto en el que trabajó en la lección anterior. Puede abrir la copia local o el proyecto original. Seleccione "Abrir la copia local". 





|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=exemple-WB.png) | Corregido | Hay un proyecto completado disponible. Este proyecto contiene los diferentes elementos creados en esta lección. Para abrir el proyecto completado, vaya a la página de inicio y haga clic en "Tutorial", luego en "Parts 3 to 6", haga doble clic en "Full WEBDEV Site - Answers". |





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Imprimir desde Internet
<a name="imprimir_desde_internet_ELTTEXTE000667"></a>
De hecho, no se debería hablar de "imprimir" desde Internet. Cuando hay que imprimir un documento, se genera un archivo HTML, PDF o XML que se envía al navegador. Una vez el archivo en el navegador, el usuario decide si desea imprimir el documento.

También es posible enviar un "trabajo de impresión" al servidor. Sin embargo, el usuario final no podrá acceder al documento impreso (en el servidor o en una red compartida).

El documento generado se prepara en el editor de reportes. Los datos del documento pueden provenir de una base de datos.

Existen dos tipos de trabajos de impresión:

- Impresión directa (en el servidor).

- Generación de varios documentos (HTML, PDF, etc.).



<a name="NOTE3_2"></a>


### Impresión directa
<a name="impresion_directa_ELTPARAGRAPHE000056"></a>

La impresión directa consiste en imprimir en una impresora directamente. La impresora está conectada al servidor o se puede acceder a ella desde la red.

La impresión directa con WEBDEV se recomienda solo para sitios de Intranet o Extranet. Este tipo de impresión permite imprimir los registros de conexiones de los clientes o imprimir directamente los pedidos en la impresora del departamento de ventas.
<a name="NOTE3_3"></a>


### Generar documentos HTML, PDF o XML
<a name="generar_documentos_html_pdf_xml_ELTPARAGRAPHE000065"></a>

La impresión a partir de documentos HTML, PDF o XML consiste en crear un documento que se mostrará en el navegador del usuario. Para crear este documento, puede utilizar el editor de reportes de WEBDEV. Así, su sitio WEBDEV puede generar un archivo con formato a partir de una fuente de datos. El archivo puede estar en formato HTML, PDF, RTF o XML.

La principal ventaja de este método es que el archivo puede ser enviado al navegador. El usuario puede imprimir el documento o guardarlo en el equipo.

La generación de un archivo puede utilizarse tanto para un sitio de Internet como de Intranet o Extranet (por ejemplo: si quiere enviar una orden de compra como PDF al usuario, etc.).

<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## ¿Qué es un reporte?
<a name="¿que_reporte_ELTTEXTE000703"></a>
En nuestro ejemplo, la factura a imprimir corresponde a un reporte. Un reporte es un elemento del proyecto que agrupa y da formato a los datos que se van imprimir.
WEBDEV incluye un editor de reportes específico para crear y editar reportes.

Un reporte incluye:

- diferentes bloques. Los bloques definen las áreas en las que se mostrarán los datos. Los bloques disponibles son los siguientes:

	- Inicio de documento: se muestra solo en la primera página.

	- Encabezado de página: aparece en la parte superior de cada página.

	- Cuerpo: contiene los datos. Este bloque aparece siempre que haya datos por imprimir.

	- Pie de página: aparece en la parte inferior de cada página.

	- Fin de documento: aparece solo en la última página.




- controles para mostrar los datos.


Veamos el reporte que vamos a crear:  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Requ%EAte%20-%20HC%20N%B0001.jpg&type=thumb)


<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Crear un reporte de factura
<a name="crear_reporte_factura_ELTTEXTE000727"></a>
Primero, vamos a definir los datos que se mostrarán en el reporte:

- Las características del pedido: fecha y número de pedido.

- Los datos personales del cliente: nombre, dirección, código postal, ciudad y país.

- Las características de las líneas de pedido:

	- Cantidad del pedido,

	- Referencia del producto,

	- Título del producto, 

	- Total sin impuestos,

	- Total con impuestos.





Para crear el reporte fácilmente, los datos a imprimir se agruparán en una consulta. Esta consulta puede ser utilizada por el reporte o por cualquier otro elemento del proyecto WEBDEV (control Tabla, Looper, etc.).|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=note.png) | Nota | WEBDEV permite crear reportes a partir de diferentes fuentes de datos: archivos de datos, consultas, controles, archivos de texto, etc.<br><br>En la mayoría de los casos, se recomienda agrupar los datos a imprimir en una consulta y luego, crear un reporte basado en dicha consulta. Para agregar datos al reporte, simplemente agregue el campo correspondiente a la consulta.<br><br>Los reportes basados en archivos de datos deben ser reportes simples, es decir, que muestren datos de un solo archivo de datos. |




<a name="NOTE5_2"></a>


### Crear una consulta
<a name="crear_una_consulta_ELTPARAGRAPHE000124"></a>

- Vamos a utilizar el editor de consultas para crear la consulta base del reporte.

	1. Haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Cr%E9er_WB_GAF.jpg) en los botones de acceso rápido. La ventana de creación de nuevos elementos se abre: haga clic en "Consulta­". El asistente de creación de consultas se abre.

	2. Elija la opción "Selección (SELECT)".
			Esta consulta nos permitirá seleccionar los registros que se imprimirán en el reporte. Pase a la etapa siguiente.

	3. La ventana de descripción de la consulta se abre.







- En primer lugar, defina el nombre de la consulta: cambie "QRY_NoName1" por "QRY_Invoice" en "Nombre de la consulta".




- Para construir la consulta, vamos a seleccionar los elementos que se mostrarán en el resultado. La consulta contendrá los datos de los archivos de datos Order, OrderLine y Customer.

	1. En la parte izquierda de la pantalla, seleccione el archivo de datos Order y haga clic en la flecha (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Recherche%20multi-crit%E8res%20-%20HC%20N%B0003%201.jpg)): los campos del archivo de datos Order aparecen en el centro de la pantalla.

	2. Repita esta acción para los archivos de datos OrderLine y Customer.





La ventana de descripción de la consulta es la siguiente: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Requ%EAte%20-%20HC%20N%B0004.jpg)
Hasta ahora, esta consulta permite seleccionar todos los pedidos y las líneas de pedido correspondientes.

Vamos a reorganizar los campos de la consulta. Este orden se utilizará para crear los diferentes controles del reporte basado en la consulta. El nombre del producto estará ubicado justo después de la referencia. 

- Para reorganizar los campos:

	1. Seleccione el campo ProductCaption del archivo de datos OrderLine.

	2. Haga clic en el botón ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Requ%EAte%20-%20HC%20N%B0004%201.jpg) a la derecha de la lista de campos. El campo se desplaza hacia arriba. 

	3. Posicione el campo justo después de la referencia del producto (OrderLine.Reference).







Vamos a seleccionar los datos de un solo pedido utilizando un identificador. Por lo tanto, vamos a definir el número de pedido como un parámetro.


- Para definir el parámetro "Order ID":

	1. Seleccione el campo Order.OrderID en el centro de la ventana.

	2. Haga clic en la cuarta columna (ver nota a continuación): en el menú que aparece, seleccione "Nueva condición".
			|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=note.png) | Nota | En la ventana de descripción de la consulta, la sección que muestra la lista de elementos de la consulta incluye 4 columnas:  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Recherche%20multi-crit%E8res%20-%20HC%20N%B0009.jpg)<br><br><br>		- Una columna con el nombre del campo<br><br>		- Una columna para mostrar u ocultar el campo en el resultado de la consulta<br><br>		- Una columna para establecer el orden de los campos<br><br>		- Una columna con el número de condiciones asociadas al campo.<br><br><br>Para acceder a una de estas opciones, simplemente haga clic en la columna correspondiente. |





	3. En la ventana que aparece, vamos a especificar que la condición de selección corresponde a un parámetro: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Requ%EAte%20-%20HC%20N%B0003.jpg)
Realice las siguientes operaciones:

		- Seleccione "Es igual a".

		- Seleccione "el parámetro".

		- Especifique el nombre del parámetro: "ParamOrderID".




4. Valide la ventana de descripción de la condición. El número "1" aparece a la derecha del campo Order.OrderID para indicar que se ha definido una condición de selección.

5. El identificador del pedido no se mostrará. Vamos a ocultarlo: haga clic en el ojo que se encuentra en la línea del campo y seleccione "No mostrar".

6. Del mismo modo, oculte los siguientes campos:

	- Order.Status,

	- Order.CustomerID,

	- Order.PaymentModeID,

	- OrderLine.OrderID,

	- Customer.CustomerID.



<a name="NOTE5_3"></a>


### Crear un reporte basado en una consulta
<a name="crear_reporte_basado_una_consulta_ELTPARAGRAPHE000206"></a>

- Para crear un reporte:

	1. Haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Cr%E9er_WB_GAF.jpg) en los botones de acceso rápido.

	2. La ventana de creación de nuevos elementos se abre: haga clic en "Reporte", y luego en "Reporte". El asistente de creación de reportes se abre.

	3. El asistente muestra varios tipos de reportes:  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Cr%E9ation%20Etat%20-%20HC%20N%B0001.jpg&type=thumb)


	4. Seleccione "Tabla". Pase a la etapa siguiente.

5. Seleccione la fuente de datos del reporte. El reporte se basará en la consulta que acabamos de crear. Seleccione "Un archivo de datos o una consulta existente". Pase a la etapa siguiente.  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Cr%E9ation%20Etat%20-%20HC%20N%B0002.jpg&type=thumb)




- Ejecute el reporte haciendo clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Go_Page_WB_GAF.jpg) en los botones de acceso rápido.

	1. El editor de reportes propone varios destinos de impresión. Puede seleccionar uno de los siguientes destinos:

		- Visor de reportes: el reporte se muestra en la pantalla en una ventana específica.
						|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=note.png) | Nota | El visor de reportes solo está disponible al desarrollar el sitio.<br><br>En tiempo de ejecución, el usuario no podrá utilizar el visor de reportes. La vista previa del archivo generado se mostrará en el navegador. |





		- Impresora: el reporte se imprime en la impresora predeterminada.

		- Archivo específico: el reporte se imprime en un archivo en el formato seleccionado.<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Cr%E9ation%20Etat%20-%20HC%20N%B0011.jpg)



 Seleccione "Visor de reportes" y valide.

2. El editor de reportes le pide que introduzca los parámetros de la consulta utilizada por el reporte. Anteriormente, utilizamos un parámetro para especificar el número del pedido que se va a imprimir. Para este ejemplo, introduzca el valor "5". <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Cr%E9ation%20Etat%20-%20HC%20N%B0012.jpg)
Valide.

3. El reporte se muestra en la pantalla.  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Cr%E9ation%20Etat%20-%20HC%20N%B0013.jpg&type=thumb)



<a name="NOTE5_4"></a>


### Modificar el reporte de factura
<a name="modificar_reporte_factura_ELTPARAGRAPHE000377"></a>

Vamos a realizar algunos cambios en el reporte creado anteriormente.

- Vamos a mover la información del cliente y del pedido a la parte superior de la página:

	1. Elimine el texto a la izquierda de los datos del cliente (Nombre, etc.). 

	2. Ubique el campo que contiene la ciudad junto al código postal.

	3. Utilice los controles de tamaño para agrandar el control que contiene el nombre de la empresa: el tamaño del control debe ser el mismo que el de los controles Zip Code y City.

	4. Alinee los controles:

		- Seleccione el control Company.

		- Presione Ctrl y seleccione los controles que contienen la dirección, el estado y el país.

		- En la pestaña "Alineación", haga clic en "Justificar (Int. y Ext.)".<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0001.jpg&type=thumb)







- Vamos a agregar un borde alrededor de los datos del cliente. Para ello, insertaremos un control Estático sobre los datos del cliente. Solo los bordes del control Estático serán visibles.

	1. Cree un control Estático: en la pestaña "Creación", en el grupo "Texto", haga clic en "Estático".

	2. Haga clic dentro del área "Inicio de documento", donde se muestran los datos del cliente.

	3. Presione Shift y amplíe el control Estático con los tiradores de tamaño para que se superponga a los datos del cliente. Esta operación permite ampliar el control Estático sin mover los controles que se encuentran debajo (con contienen los datos del cliente).

	4. En el menú contextual del control Estático, seleccione "Editar título" y borre el texto. Haga clic en cualquier lugar del reporte para confirmar los cambios.







- Para configurar los bordes:

	1. Seleccione el control Estático creado previamente.

	2. Presione R y haga clic en el ícono ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0003%201.jpg) en la esquina superior derecha del control. 

	3. Seleccione la opción "Editar bordes". Las opciones de configuración aparecen:  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0004.jpg&type=thumb)


	4. Seleccione:

	- el color "Azul" en los colores contextuales.

	- un borde simple (línea delgada).

	- un redondeo de 2 mm para el ancho y alto.




- Vamos a establecer la posición de los totales en el bloque "Fin de documento":

	1. Seleccione los controles del bloque "Fin de documento" que contienen los totales.

	2. Ubique los controles en la esquina inferior derecha de la tabla (arriba del texto "Developed with WEBDEV").

	3. El reporte se muestra en el editor de reportes:  <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0005.jpg&type=thumb)


	4. Hemos terminado el reporte de factura ("Invoice"). Guarde el reporte haciendo clic en el ícono ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Sauver_WB_GAF.jpg) en los botones de acceso rápido.

5. Verifique los cambios realizados abriendo el reporte en modo "Visor de reportes" (haga clic en ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Go%20Page.gif) en las opciones de acceso rápido).<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0006.jpg&type=thumb)



<a name="NOTE6"></a>
<a name="NOTE6_1"></a>


## Abrir la vista previa del reporte mediante un control Botón
<a name="abrir_vista_previa_del_reporte_mediante_control_boton_ELTTEXTE000841"></a>
Como vimos al principio de esta lección, dado que el sitio se ejecuta en un servidor, el documento se enviará a una impresora conectada al servidor (inaccesible para los usuarios).

El reporte se generará como un documento PDF en el servidor, y luego podrá descargarse o mostrarse en el equipo del usuario. Así, los usuarios podrán imprimir el documento en sus impresoras.

En nuestro sitio, el reporte "RPT_Invoice" se imprimirá mediante un control Botón ubicado en la página que permite buscar los pedidos. Este control Botón imprimirá la factura del pedido seleccionado.

Observación: Para completar esta parte del tutorial, se debe haber creado la página "PAGE_Multicriteria_Search" en la [Lección 5.1. Búsqueda con varios criterios](../TutoWB/1410087494.md).

<a name="NOTE6_2"></a>


### Implementar el proceso de impresión
<a name="implementar_proceso_impresion_ELTPARAGRAPHE000467"></a>

Para imprimir el reporte "RPT_Invoice":

1. Vaya a la página "PAGE_Multicriteria_Search": haga clic en "PAGE_Multicriteria_Search" en las pestañas de los documentos abiertos.

2. En la pestaña "Creación", en el grupo "Controles frecuentes", haga clic en "Botón".

3. Haga clic a la derecha del control Tabla para crear el control Botón.

4. Seleccione el control y presione la tecla Entrar. El texto pasa a modo de edición.

5. Reemplace "BOTÓN" por "PRINT" y valide los cambios.<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0007.jpg&type=thumb)


6. Abra el código del botón (F2) y escriba el siguiente código en el evento "Clic en xxx (servidor)":
	
	```wl
	iDestination(iGenericPDF)
	RPT_Invoice.InitQuery(TABLE_QRY_FindOrders.COL_OrderID[TABLE_QRY_FindOrders])
	RPT_Invoice.Print()
	FileDisplay(iLastFile(), "application/pdf")
	```

	Analicemos este código:

	- La función [iDestination](../WDLang5/3046074.md) define el formato de impresión (PDF en este caso).

	- Dado que el reporte "RPT_Invoice" se basa en una consulta con parámetros, se debe pasar el parámetro a la consulta antes de ejecutar el reporte. Esta operación se realiza con la función [&lt;Reporte&gt;.InitQuery](../WDLang5/1000025143.md). En nuestro caso, el parámetro corresponde al número del pedido actual, que aparece en el control Tabla.

	- La función [&lt;Reporte&gt;.Print](../WDLang5/1000024554.md) permite generar el reporte "Report_Invoice" en el formato especificado (PDF en este caso).

	- La función [FileDisplay](../WDLang2/3012005.md) muestra la factura al usuario:

		- La función [iLastFile](../WDLang5/3046068.md) devuelve la ruta del último archivo generado por un reporte. 

		- "application/pdf" es el tipo MIME del archivo devuelto. Cuando se especifica este tipo, el navegador muestra directamente el archivo o elige la aplicación que se utilizará para mostrar el archivo en el equipo del usuario final.




7. Cierre el editor de código.

8. Guarde la página (![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=ICO_Sauver_WB_GAF.jpg) o Ctrl + S).



<a name="NOTE6_3"></a>


### Prueba de la impresión
<a name="prueba_impresion_ELTPARAGRAPHE000525"></a>

- Ahora, solo tenemos que hacer una prueba real:

	1. Pruebe la página "PAGE_Multicriteria_Search".

	2. Especifique los criterios deseados e inicie la búsqueda.

	3. Seleccione uno de los pedidos que se muestran en el control Tabla.

	4. Imprima el pedido con el botón "PRINT".<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0008.jpg&type=thumb)


	5. El navegador abre el archivo PDF. El navegador cambió la página actual por el archivo PDF. Vamos a cambiar este comportamiento.

6. Cierre el navegador.




- Para abrir el archivo PDF en otra pestaña o navegador:

	1. Haga doble clic en el botón "Print" en la página "PAGE_Multicriteria_Search". La ventana de descripción se abre.

	2. En la pestaña "General", en "Destino", seleccione "Nueva pestaña del navegador".<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=P5_Impression%20-%20Modification%20Etat%20-%20HC%20N%B0009.jpg&type=thumb)


	3. Valide.


|   |   |   |
| --- | --- | --- |
| ![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=note.png) | Nota | **¿Nueva pestaña o nueva ventana?**<br><br>Ni el usuario ni el desarrollador del sitio pueden elegir si la vista previa de impresión se abrirá en una nueva pestaña o en una nueva ventana. Es el navegador el que determina cuál de las dos opciones se utiliza. Este comportamiento puede variar según el navegador utilizado. |





| [Lección anterior](../TutoWB/1410087494.md) | [Tabla de contenido](../TutoWB/1410087510.md) | [Siguiente lección](../TutoWB/1410087496.md) |
| --- | --- | --- |





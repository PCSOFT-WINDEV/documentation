
## Notificación Push
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000221"></a>
Un dispositivo móvil puede recibir notificaciones push. Un Notification es un mensaje que se muestra (y se almacena) en el dispositivo, en el centro del dispositivo Notification. Un Notification puede ser usado para iniciar un Process por ejemplo.

Un Notification se envía desde una aplicación remota, que normalmente se encuentra en un servidor. 

La aplicación para el envío de notificaciones puede ser desarrollada en WINDEV o WEBDEV, o a través de herramientas externas.. 

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principio
<a name="principio_ELTTEXTE000245"></a>
Se necesitan cuatro elementos para crear un sistema de empuje Notification:

- Una aplicación móvil (iOS o Android) que se ejecuta en el dispositivo adecuado. 

- Un servicio de Notification que se utiliza para distribuir los mensajes de empuje a los teléfonos o tabletas. Este servicio se presta: 

	- por Google: base de fuego
			Observación: la aplicación creada antes de la versión 22 utiliza el mecanismo de mensajería en nube de Google (GCM). Este mecanismo quedará obsoleto para Google a partir de abril de 2019.

	- por Apple (APM).




- Un servidor de aplicaciones (o proveedor) que decide enviar los mensajes y que establece la comunicación con la base de datos de la empresa (este servidor puede ser un servicio web o una aplicación WEBDEV o WINDEV). 

- Una base de datos, utilizada para almacenar los identificadores de los diferentes dispositivos que reciben los mensajes push, así como los datos de la empresa.. 




El modo de funcionamiento global de los mensajes push es el siguiente: <br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=Notifications-Push-Firebase.gif)


1. La aplicación se registra en el servicio de Apple o Google utilizando el "device id" y el "application id".. 

2. Si el registro es exitoso, el servicio de Apple o Google devuelve un Token (o "registration id") a la aplicación. 

3. La aplicación transmite el Token al servidor de aplicaciones (proveedor). 

4. El servidor almacena el Token en su base de datos. 




**Se envía un mensaje push de acuerdo con el siguiente método**:
**a.** El servidor de aplicaciones envía un mensaje (mediante un socket SSL (iOS) o un socket HTTPS (Android)) que contiene el Token al servicio de Apple o Google. 
Observación: este envío puede ser realizado por una aplicación externa, siempre y cuando ésta pueda acceder a la base de datos de la empresa y al certificado utilizado para la comunicación con el servicio Notification. 
**b.** El servicio de Apple o Google transmite el mensaje al dispositivo correspondiente. 





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Gestión de las notificaciones en la aplicación Móvil
<a name="gestion_las_notificaciones_aplicacion_movil_ELTTEXTE000269"></a>
Se pueden utilizar varias funciones para gestionar las notificaciones en la aplicación Móvil: 



|   |   |
| --- | --- |
| [NotifPushDisable](../WDLang3/1000020817.md) | Desactiva la gestión de las notificaciones push para una aplicación WINDEV Mobile (Android o IOS). |
| [NotifPushEnable](../WDLang3/1000020816.md) | Permite la gestión de las notificaciones push en una aplicación WINDEV Mobile (Android o iOS). |
| [NotifPushProcedure](../WDLang3/1000020818.md) | Especifica el procedimiento WLanguage llamado cuando una aplicación WINDEV Mobile (Android o iOS) recibe un push Notification. |





Atención: se requiere una configuración específica para que las aplicaciones móviles funcionen: 




El comportamiento cuando se recibe una Notification es el siguiente:

1. **Si la aplicación está cerrada**, el sistema muestra el Notification en la barra Notification. El usuario puede elegir validar el Notification. Si lo hace, se inicia la aplicación. 
	
	Una vez iniciada la aplicación, pueden darse dos casos:

	- Si se llamó a [NotifPushProcedure](../WDLang3/1000020818.md) en el código de inicialización del proyecto, se llama a la Procedure global que se pasa a esta función como parámetro y no se abre la primera ventana de la aplicación. 
			Observación: [OpenMobileWindow](../WDLang1/1000021018.md) debe ser llamada en el Procedure. 

	- Si no se ha llamado a [NotifPushProcedure](../WDLang3/1000020818.md), se abre la primera ventana de la aplicación.  




2. **Si la aplicación ya está iniciada**:







Observaciones:

- La constante *exeLaunch* de [ExeInfo](../WDLang1/3035001.md) permite saber si la aplicación fue iniciada automáticamente por el sistema tras la recepción de un push Notification: 
	
	```wl
	ExeInfo(exeLaunch) = exePushNotification
	```


- [WinStatus](../WDLang1/3038030.md) permite comprobar (si es necesario) la existencia de una ventana para abrirla: 
	
	```wl
	// Summary: Procedure called when clicking on a PUSH notification
	PROCEDURE onPush(MyNotif is Notification)
	
	IF WinStatus("WIN_Main") = NotFound THEN
		// WIN_Main is already open or displayed
		ReceivePushNotif(myNotif, True)
	ELSE
		// Open home window
		OpenMobileWindow(WIN_Main, MyNotif)
	END
	```





<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Gestionar las notificaciones en el servidor de aplicaciones
<a name="gestionar_las_notificaciones_servidor_aplicaciones_ELTTEXTE000316"></a>
El servidor de aplicaciones es la aplicación WINDEV o el sitio WEBDEV que envía las notificaciones Push. 

Esta servidor de aplicaciones envía las notificaciones a través de [NotifPushSend](../WDLang3/1000020819.md). 

**Atención**: [NotifPushSend](../WDLang3/1000020819.md) debe conocer los identificadores (tokens) de los teléfonos afectados por el Notification. Esta información debe ser devuelta por la aplicación móvil. 

WINDEV Mobile cuenta con los siguientes ejemplos: 

- **WD_Push_Server (Webservice)**: 

	1. En el código del proyecto, es necesario especificar:

		- La tecla Android API

		- El tipo de plataforma Android: utilizar las constantes *npeFirebase* o *npeGCM* (*npeFirebase* por Default). 

		- La ruta de la Certificate que enviará las notificaciones de iOS (Certificate que se desplegará con el Webservice). 




2. Despliegue del servicio web. 

3. Recuperar la URL del WSDL desplegado. 

- **WM Push (aplicación móvil que recibe notificaciones)**:

	1. Sustituir la URL del Webservice ya importado en el proyecto por la URL recuperada anteriormente. 

	2. Despliegue android:

		- Recupera el archivo de configuración de Firebase google-services.JSON, o bien recupera el número de proyecto en Google Cloud Messaging.

		- En la generación de Android asistente, asegúrese de que el nombre del paquete es el mismo que el definido en los servicios de Google.




3. iOS implementación: Especifique el mismo paquete que el definido en la consola de Apple

- **Send Push (aplicación cliente para enviar notificaciones a través del Webservice)**: 

	1. Sustituye la URL del Webservice ya importado en el proyecto por la URL recuperada anteriormente.

	2. Ejecute la aplicación para enviar notificaciones.

	3. En el caso de iOS, no olvide especificar el paquete de la aplicación a la que se enviarán las notificaciones.











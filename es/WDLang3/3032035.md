
## Gestión de correos electrónicos con "Simple MAPI"
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Resumen de "Simple MAPI"
<a name="resumen_simple_mapi_ELTTEXTE000204"></a>
**MAPI simple** se utiliza para simplificar la gestión de los correos electrónicos recibidos en la empresa de alojamiento. Cuando se lee un Email, se carga automáticamente en el buzón de mensajes local y se borra del servidor (en la empresa de alojamiento).

Todas las características necesarias para la gestión del correo electrónico (protocolo POP3, protocolo SMTP, acceso remoto, etc.) se agrupan en el "Perfil de usuario".
<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=SMAPI.gif)


Con las funciones Email de WLanguage, una aplicación WINDEV o un sitio WEBDEV puede manipular directamente los Email administrados en una aplicación que está usando "Simple MAPI".

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Principio
<a name="principio_ELTTEXTE000228"></a>
Para enviar o leer mensajes a través de **MAPI simple**debes hacerlo:

1. Describir un perfil de usuario. Este perfil de usuario debe ser creado en la aplicación de Microsoft para la gestión de Email (cliente de MS Exchange por ejemplo).

2. Desde la aplicación WINDEV (o desde el sitio WEBDEV), conéctese a la aplicación de gestión de Email (cliente MS Exchange, por ejemplo) con [EmailStartSession](../WDLang3/3032028.md).

3. Enviar y leer los mensajes.

4. Cierre la sesión a la aplicación para la gestión de Email (cliente MS Exchange por ejemplo) con [EmailCloseSession](../WDLang3/3032006.md).




<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Detalles de los diferentes pasos
<a name="detalles_los_diferentes_pasos_ELTTEXTE000252"></a>


### Etapa 1: Creación de un perfil de usuario
<a name="etapa_1_creacion_perfil_usuario_ELTPARAGRAPHE000042"></a>

El perfil de usuario se utiliza para configurar la aplicación para la gestión de Email (cliente de MS Exchange, por ejemplo).

Los siguientes elementos se definen en el perfil de usuario:

- el protocolo SMTP utilizado,

- el protocolo POP3 utilizado,

- los diferentes servicios de comunicación utilizados. Para utilizar las funciones de "email" del WLanguage, el perfil de usuario debe utilizar el servicio ***Microsoft Exchange Server***.




**Observación**: Se debe crear un perfil para cada usuario o cuenta de Email.. El nombre del perfil se utilizará para iniciar la sesión de Email con [EmailStartSession](../WDLang3/3032028.md).

**Para crear un perfil:**

1. Abre el panel de control.

2. Haga doble clic en la opción "Email".

3. Haga clic en el botón "Mostrar los perfiles".

4. En la ventana "Elegir un perfil", haga clic en el botón "Añadir".

5. Dar un nombre al perfil. Este nombre se utilizará en los programas WINDEV.

6. Selecciona "Añadir una nueva cuenta de Email".

7. Seleccione el servicio "Microsoft Exchange Server".

8. Introduzca el nombre del servidor Microsoft Exchange.



<a name="NOTE3_2"></a>


### Etapa 2: Iniciando una sesión de Email
<a name="etapa_2_iniciando_una_sesion_email_ELTPARAGRAPHE000071"></a>

Para iniciar una sesión de Email, utilice [EmailStartSession](../WDLang3/3032028.md). Esta función debe ser la primera función "Email" usada en su aplicación WINDEV (o en su sitio WEBDEV).

[EmailStartSession](../WDLang3/3032028.md) devuelve el identificador de sesión. Este identificador será utilizado por todas las funciones de WLanguage para la gestión de Email.

**Ejemplo**: El siguiente Procedure se utiliza para iniciar una sesión de Email a partir de un perfil. Si se produce un error, la variable *Email.Error* permite identificarlo.


```wl
Function StartSession(Profile)
// Start the session
SessionNum is int
SessionNum = EmailStartSession(Profile)
IF SessionNum = 0 THEN
	Error("The session cannot be started. Error: " + Email.Error)
END
RESULT SessionNum
```

<a name="NOTE3_3"></a>


### Etapa 3: Envío de correos electrónicos
<a name="etapa_3_envio_correos_electronicos_ELTPARAGRAPHE000089"></a>

Las siguientes funciones se utilizan para enviar mensajes de correo electrónico a través de **MAPI simple**:

- [EmailSendMessage](../WDLang3/3032005.md): esta función se utiliza para colocar el mensaje en la bandeja de salida de la aplicación de gestión de Email (bandeja de salida del cliente de MS Exchange, por ejemplo).

- [EmailUpdate](../WDLang3/3032036.md): esta función se utiliza para sincronizar el servidor de Email y la aplicación de gestión de Email: los nuevos correos electrónicos entrantes se transfieren automáticamente a la bandeja de entrada, los correos electrónicos encontrados en la bandeja de salida se envían.  


Para obtener más información, consulte: [Preparando el envío de un Email](../WDLang3/3032002.md).

**Ejemplo**: El siguiente código envía todos los correos electrónicos en una control Tabla poblada programáticamente ("TABLE_TOSEND") a través del cliente MS Exchange. Cada tabla fila corresponde a un Email.

Para cada Email, la información de la control Tabla se transfiere a la estructura Email, y la Email se envía. Entonces, el servidor de Email se actualiza.


```wl
I is int
FOR I = 1 _TO_ TableCount(TABLE_TOSEND)
	// The email is sent to a single person
	Email.NbRecipient = 1
	Email.Recipient[1] = ExtractString(TABLE_TOSEND[I], 1)
	// Subject and message
	Email.Subject = ExtractString(TABLE_TOSEND[I], 2)
	Email.Message = ExtractString(TABLE_TOSEND[I], 3)
	// No attached file
	Email.NbAttach = 0
	// Send the message to MS Exchange
	EmailSendMessage(SessionNum, False)
END
// Send the messages from MS Exchange to the email server
IF NOT EmailUpdate(SessionNum) THEN
	Error("Problem with MS Exchange. Error:" + Email.Error)
END
```

<a name="NOTE3_4"></a>


### Paso 3 bis: Lectura de los correos electrónicos
<a name="paso_3_bis_lectura_los_correos_electronicos_ELTPARAGRAPHE000114"></a>

Lectura de los correos electrónicos a través de **MAPI simple** es realizada por:

- la función [EmailUpdate](../WDLang3/3032036.md): esta función se utiliza para sincronizar el servidor de Email y el software para la gestión de Email: los nuevos correos electrónicos entrantes se transfieren automáticamente a la bandeja de entrada, los correos electrónicos encontrados en la bandeja de salida se envían.

- las funciones de lectura de correos electrónicos ([EmailReadFirst](../WDLang3/3032014.md), [EmailReadNext](../WDLang3/3032004.md), etc.): estas funciones se utilizan para inicializar la estructura de Email de WLanguage con las características del Email que se lee actualmente (remitente, asunto, etc.).


Para obtener más información, consulte: [Leyendo una Email](../WDLang3/3032037.md).

**Ejemplo**: El siguiente código se utiliza para leer los correos electrónicos. Los correos electrónicos entrantes se almacenan en una control Tabla que se rellena mediante programación ("TABLE_Messages"). El SessionNum Variable corresponde al identificador de la sesión. En este ejemplo, los mensajes entrantes son eliminados de la bandeja de entrada y del servidor Email por [EmailDeleteMessage](../WDLang3/3032027.md).


```wl
// Receives the pending messages found on the email server
IF NOT EmailUpdate(SessionNum) THEN
	Error("Problem with MS Exchange. Error: " + Email.Error)
END

// Read the first unread message
IF NOT EmailReadFirst(SessionNum, "NOT READ") THEN
	Error("Error while reading the first message")
END

// Loop through unread messages and display them in a Table control populated programmatically
TableDeleteAll(TABLE_Messages)
WHILE NOT Email.Out
	// The reception date, the address of the sender and the message
	// are assigned to the table
	TableAdd("TABLE_Messages", Email.ReceiveDate + TAB +...
	Email.SenderAddress + TAB + Email.Message)

	// Delete the message
	IF NOT EmailDeleteMessage(SessionNum) THEN
		Error("Error during the deletion. The message was not deleted")
	END
	// Read the next unread message
	IF NOT EmailReadNext(SessionNum, "NOT READ") THEN
		Error("Error while reading the next message")
	END
END
```

<a name="NOTE3_5"></a>


### Etapa 4: Clausura de la sesión de Email
<a name="etapa_4_clausura_sesion_email_ELTPARAGRAPHE000145"></a>

Una vez finalizada la gestión de los correos electrónicos entrantes y salientes, se cierra la sesión con [EmailCloseSession](../WDLang3/3032006.md). Esta función debe ser la última función "email" utilizada.

**Ejemplo**: El siguiente código es un Procedure usado para cerrar una sesión de Email. En este código, el **SessionNum** Variable corresponde al identificador de sesión devuelto por [EmailStartSession](../WDLang3/3032028.md).


```wl
PRODEDURE CloseSession(SessionNum)
// Close the session
EmailCloseSession(SessionNum)
```




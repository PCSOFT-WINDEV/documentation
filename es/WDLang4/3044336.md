
## Transacciones: Procesos secure en archivos de datos HFSQL
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000638"></a>
Este capítulo abarca los siguientes temas:

- [Resumen de las operaciones: Qué es una transacción, utilizando las transacciones de acuerdo a sus necesidades, etc.](../WDLang4/3044335.md)

- [Principio: gestión de las transacciones en archivos HFSQL y casos especiales.](../WDLang4/3044335.md)

- [Manejo de las transacciones por programación.](#NOTE2_1)

- [Gestión de los casos especiales (cortes de energía, restablecimiento de la consistencia de la base de datos, etc.).](#NOTE4_1)

- [Gestión avanzada: los ficheros creados durante una transacción, gestión del identificador informático.](#NOTE5_1)




![Java](https://doc.pcsoft.fr/ext/images/us/JAVA.png) La gestión de transacciones solo está disponible para bases de datos HFSQL Client/Server. 



<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Gestión de las transacciones mediante programación
<a name="gestion_las_transacciones_mediante_programacion_ELTTEXTE000668"></a>




### Implementación de la gestión de las transacciones
<a name="implementacion_gestion_las_transacciones_ELTPARAGRAPHE000043"></a>

1. Si sus archivos de datos están protegidos por una contraseña, abra todos los archivos de datos utilizados durante la transacción antes del inicio de la misma o especifique las diferentes contraseñas con [HPass](../WDLang4/3044108.md).
	Si sus archivos de datos no están protegidos por contraseña, los archivos de datos manejados después de [HTransactionStart](../WDLang4/3044002.md) (o [HTransaction](../WDLang4/1000023384.md)) se pondrán automáticamente en transacción.

2. Inicie la operación con [HTransactionStart](../WDLang4/3044002.md) o [HTransaction](../WDLang4/1000023384.md).

3. Realice sus operaciones. Todas las operaciones de escritura realizadas en los ficheros de datos de la transacción se graban automáticamente en el fichero de transacción.. Atención: los procesos realizados son más lentos (porque cada operación se guarda en un archivo de datos específico).

4. Cancel (si es necesario) las operaciones realizadas durante la transacción ([HTransactionCancel](../WDLang4/3044001.md).

5. Especifique el fin de la transacción con [HTransactionEnd](../WDLang4/3044032.md): se valida la transacción.




**Observaciones**: 

- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/us/HF.png) El modo de aislamiento de transacciones utilizado es "**READ UNCOMMITED**". 

- ![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) El modo de aislamiento de las transacciones se define con [HTransactionIsolation](../WDLang4/1000020926.md). El modo de aislamiento de Default es el modo "**READ UNCOMMITED**". 

- Las transacciones no están disponibles para los archivos de datos de Hyper File 5.5.



<a name="NOTE2_2"></a>




### Resumen tabla de las funciones WLanguage utilizadas (para una base de datos HFSQL ISAM o Cliente/Servidor)
<a name="resumen_tabla_las_funciones_wlanguage_utilizadas_para_una_base_datos_hfsql_isam_clienteservidor_ELTPARAGRAPHE000091"></a>

| Características | Función del lenguaje |
| --- | --- |
| Permitir (o no) la gestión de las transacciones <br>(la gestión de las transacciones está habilitada por Default). | [HSetTransaction](../WDLang4/3044066.md) |
| ![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) Definir el modo de aislamiento. | [HTransactionIsolation](../WDLang4/1000020926.md) |
| Inicie la transacción. | [HTransactionStart](../WDLang4/3044002.md) o [HTransaction](../WDLang4/1000023384.md) |
| Validar la transacción. | [HTransactionEnd](../WDLang4/3044032.md) |
| Cancel la transacción actual | [HTransactionCancel](../WDLang4/3044001.md) |
| Cancel una transacción que falló (corte de energía). | <br><br>- [HTransactionCancel](../WDLang4/3044001.md)<br><br>- [HTransactionStart](../WDLang4/3044002.md)/[HTransactionEnd](../WDLang4/3044032.md)<br><br>- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/us/HF.png) herramienta [WDTRANS](../WDTrans/3524005.md) (o [WDOptimizer](../WDOptimiseur/3519002.md)).<br><br>- ![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) Centro de Control HFSQL.<br><br><br> |
| Determinar si una transacción ha sido interrumpida (la transacción no ha sido comprometida o cancelada). Caso de apagón. | [HTransactionInterrupted](../WDLang4/3044026.md) |
| Si un Record encontrado en el archivo de datos especificado se considera que está en transacción pero no pertenece a una transacción en curso, se libera automáticamente. | [HTransactionFree](../WDLang4/3044016.md) |
| Determinar si una transacción está en curso. | [HTransactionInProgress](../WDLang4/1000025274.md) |



<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Manipular registros durante una transacción: las reglas a seguir
<a name="manipular_registros_durante_una_transaccion_las_reglas_seguir_ELTTEXTE000698"></a>


### Utilizando las transacciones cortas
<a name="utilizando_las_transacciones_cortas_ELTPARAGRAPHE000180"></a>

Los registros utilizados durante la transacción se bloquean automáticamente en modo de escritura para evitar que los otros ordenadores modifiquen los datos afectados y, por tanto, para secure la transacción.

En una aplicación de red, si otro usuario intenta modificar un Record en una transacción, la gestión de cerraduras de automatic permitirá a este usuario a Cancel o reintentar la operación.

Por lo tanto, la transacción debe ser lo más corta posible para evitar bloquear a los usuarios.
<a name="NOTE3_2"></a>




### Bloqueo de los registros en modo de lectura
<a name="bloqueo_los_registros_modo_lectura_ELTPARAGRAPHE000192"></a>

Todas las modificaciones realizadas durante una transacción son Visible de todos los ordenadores (en una red por ejemplo) antes del final de la transacción. Los otros ordenadores pueden leer los datos con una duración limitada (si la transacción es cancelada por [HTransactionCancel](../WDLang4/3044001.md), por ejemplo).

**Por lo tanto, le recomendamos encarecidamente que bloquee los registros relevantes en el modo de lectura.**
<a name="NOTE3_3"></a>


### Realizar una transacción a la vez
<a name="realizar_una_transaccion_vez_ELTPARAGRAPHE000204"></a>

Una aplicación debe realizar una sola transacción a la vez. No se debe realizar ninguna transacción en hilos simultáneos o en contextos HFSQL independientes.
<a name="NOTE3_4"></a>


### No se debe utilizar ninguna interfaz de usuario (ventana, reporte, página, ...) entre el inicio y el final de una transacción.
<a name="debe_utilizar_ninguna_interfaz_usuario_ventana_reporte_pagina_entre_inicio_final_una_transaccion_ELTPARAGRAPHE000211"></a>

Todas las operaciones de transacción deben realizarse en el mismo **in Process**: [HTransactionStart](../WDLang4/3044002.md) (o [HTransaction](../WDLang4/1000023384.md)) y [HTransactionCancel](../WDLang4/3044001.md) deben ser llamados desde el mismo process o event: código de clic de un control Botón, etc.

Para anular una operación mediante un botón, utilice una "validación de automatic" control Botón durante un corto período de tiempo. Esto le permite evitar posibles interacciones con los datos manejados desde otros ordenadores de la red.
<a name="NOTE3_5"></a>


### La cancelación de una transacción puede fallar ocasionalmente debido a violaciones de las restricciones de integridad y/o duplicar las violaciones de las restricciones.. 
<a name="cancelacion_una_transaccion_puede_fallar_ocasionalmente_debido_violaciones_las_restricciones_integridad_duplicar_las_violaciones_las_restricciones_ELTPARAGRAPHE000229"></a>

**Ejemplo 1: Violación de las restricciones duplicadas**

- El archivo de datos de *A manejado por una transacción contiene una clave única*.

- Un ordenador A realiza una transacción durante la cual se borra un Record de este archivo de datos.

- *Al mismo tiempo, un ordenador B añade un nuevo Record en el mismo fichero de datos con el mismo valor de clave única que el Record borrado por el equipo A.*

- **La cancelación de la transacción en este momento provocará un error duplicado en la clave única.**.




**Solución 1**: Intente Cancel la transacción de nuevo con [WDTrans](../WDTrans/3524005.md) (o [WDOptimizer](../WDOptimiseur/3519002.md)). Esta herramienta permite ignorar los errores de duplicación y/o los errores de integridad ("Desactivar la gestión de la integridad" y "Desactivar la gestión de los duplicados" en el asistente para cancelar las transacciones).

**Solución 2**: Utilice [HSetDuplicates](../WDLang4/3044057.md) antes de cancelar la transacción. Esta función permite ignorar temporalmente la gestión de duplicados.. En este caso, no olvide volver a activar la gestión de duplicados estableciendo el parámetro en <u><u><u><u>True</u></u></u></u> después de cancelar la transacción.
A continuación, debe verificar los registros incorrectos y modificarlos en consecuencia.

**Ejemplo 2: Violación de las restricciones de integridad**

- El archivo de datos del CLIENTE de *A es relacionado a un archivo de datos de PEDIDOS (relacionado en una llave)*

- El ordenador *A A realiza una transacción durante la cual un Record se añade al archivo del CLIENTE*.

- *Al mismo tiempo, un equipo B agrega un nuevo registro al archivo de datos ORDERS relacionado con el registro agregado al archivo de datos CUSTOMER.*

- La cancelación de la transacción en este preciso momento provocará un error de integridad porque el Record agregado al archivo de datos de PEDIDOS no tendrá ningún vínculo con el Record borrado del archivo de datos de CLIENTES (la adición al archivo de CLIENTES habrá sido cancelada).




**Solución 1**: Intente Cancel la transacción de nuevo con [WDTrans](../WDTrans/3524005.md) (o [WDOptimizer](../WDOptimiseur/3519002.md)). Esta herramienta permite ignorar los errores de duplicación y/o integridad (marque "Desactivar la gestión de la integridad" y "Desactivar la gestión de los duplicados" en el asistente para cancelar las transacciones).

**Solución 2**: Utilice [HSetIntegrity](../WDLang4/3044058.md) antes de cancelar la transacción. Esta función permite ignorar temporalmente los errores de integridad (estableciendo el parámetro en <u><u><u><u>False</u></u></u></u>). En este caso, no olvide volver a activar la gestión de la integridad estableciendo el parámetro en <u><u><u><u>True</u></u></u></u> después de cancelar la transacción.
A continuación, debe verificar los registros incorrectos y modificarlos en consecuencia.

**Consejo**: **Plan para este tipo de conflictos en sus programas y al crear archivos de datos en el editor de análisis**. 

- Los errores de duplicación no se producirán si se utilizan claves únicas cuyo tipo sea el identificador automatic.

- Si manipula las claves únicas manualmente (sin identificadores automáticos), debe establecer un valor **único** para todos los equipos al agregar o modificar registros (con las funciones [HAdd](../WDLang4/3044147.md) y [HModify](../WDLang4/3044042.md)).
	**Recordatorio**: Por defecto, para cada Record que presenta un problema, el motor HFSQL propone [la gestión asistida de los errores](../WDLang4/3044188.md): una ventana usada para arreglar los conflictos duplicados.



<a name="NOTE3_6"></a>




### Errores específicos de la gestión de las operaciones
<a name="errores_especificos_gestion_las_operaciones_ELTPARAGRAPHE000307"></a>

- **70031: Operación no permitida en la transacción**
	Está utilizando una función que no está permitida durante una operación.. Por ejemplo, [HTransactionStart](../WDLang4/3044002.md) (o [HTransaction](../WDLang4/1000023384.md)) se utiliza en medio de una transacción.

- **70034: La última transacción falló**
	Usted está tratando de utilizar un Record que pertenece a una transacción fallida (corte de energía, ...). El programa se reinicia pero la transacción no se cancela.. En este caso, le recomendamos que Cancel la transacción que falló (ver más abajo).

- **74020: La clave de acceso del fichero de transacción no corresponde a la clave de acceso del fichero fuente.**
	El archivo de datos (en modo HFSQL Client/Server) y el archivo de transacciones no utilizan la misma contraseña.

- **70032: Problema del modo de aislamiento**
	Este error puede ocurrir en los siguientes casos: 

	- Está intentando utilizar [HTransactionIsolation](../WDLang4/1000020926.md) en archivos de datos que no están en formato Cliente/Servidor. 

	- Está intentando utilizar un modo de aislamiento mientras la transacción no se realiza en una conexión.. 

	- Está intentando utilizar [HTransactionIsolation](../WDLang4/1000020926.md) cuando la transacción ya ha sido iniciada por [HTransactionStart](../WDLang4/3044002.md) (o [HTransaction](../WDLang4/1000023384.md)). 







<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Gestión de casos especiales
<a name="gestion_casos_especiales_ELTTEXTE000752"></a>




### Fallo de alimentación
<a name="fallo_alimentacion_ELTPARAGRAPHE000352"></a>

Si se produce una avería (corte de corriente, reinicio,...) durante una transacción, los archivos de datos pueden dañarse.: la transacción no fue ni validada ni cancelada. El archivo de la transacción se encuentra todavía en el equipo.

En este caso, se restaurará la consistencia de la base de datos:

- Durante la primera llamada a [HTransactionStart](../WDLang4/3044002.md) (o a [HTransaction](../WDLang4/1000023384.md)).

- Con la función [HTransactionCancel](../WDLang4/3044001.md).

- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/us/HF.png) Por [WDTrans](../WDTrans/3524005.md) (o [WDOptimizer](../WDOptimiseur/3519002.md)) para una base de datos ISAM.

- ![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) Por el Centro HFSQL control para una base de datos HFSQL Client/Server.




**Atención**: Restaurar la integridad de la base de datos puede llevar un tiempo.

Observación: Para saber si hay que restaurar la consistencia de la base de datos, compruebe el resultado de [HTransactionInterrupted](../WDLang4/3044026.md) en el código de inicialización del proyecto (por ejemplo).
<a name="NOTE4_2"></a>




### Consejo: restauración de la consistencia de la base de datos
<a name="consejo_restauracion_consistencia_base_datos_ELTPARAGRAPHE000393"></a>

Para restaurar la consistencia de la base de datos, le aconsejamos que realice las siguientes operaciones:

1. Comprueba el resultado de [HTransactionInterrupted](../WDLang4/3044026.md) en el código de inicialización del proyecto, por ejemplo.

2. Si la transacción se interrumpió, realice una de las siguientes operaciones para restaurar la consistencia de la base de datos:

	- Llama a [HTransactionCancel](../WDLang4/3044001.md).

	- Llamar a [HTransactionStart](../WDLang4/3044002.md)/[HTransactionEnd](../WDLang4/3044032.md).

	- ![HFSQL Classic](https://doc.pcsoft.fr/ext/images/us/HF.png) Iniciar [WDTrans](../WDTrans/3524005.md) (o [WDOptimizer](../WDOptimiseur/3519002.md)) para una base de datos ISAM. 

	- ![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) Inicie el HFSQL control Center para una base de datos HFSQL Client/Server.







Ejemplo:


```wl
IF HTransactionInterrupted() = True THEN 
	If Confirm("The transaction performed by computer " + h.trsPost + ...
		" was interrupted. " + ...
		 "Do you want to restore the consistency of data files?") = True THEN
		// Cancels the interrupted transactions
		 IF HTransactionCancel() = False THEN
			 Error("Unable to cancel the transaction")
		 END
	END
END
```


**Otra solución**: El error 70034 también puede ser tratado en la Event de "Inicialización" del proyecto utilizando la palabra clave WHEN EXCEPTION. Por lo tanto, cuando se produzca el error 70034, la consistencia de la base de datos será restaurada por [HTransactionCancel](../WDLang4/3044001.md), o por [HTransactionStart](../WDLang4/3044002.md)/[HTransactionEnd](../WDLang4/3044032.md).

**Observación**: Después de un corte de energía, le recomendamos que vuelva a indexar los archivos de la aplicación.
<a name="NOTE4_3"></a>




### Error durante el uso del programa
<a name="error_durante_uso_del_programa_ELTPARAGRAPHE000448"></a>

Cuando la aplicación se detiene debido a una división de programación Error( por cero, por ejemplo), la transacción actual se cancela automáticamente.
<a name="NOTE4_4"></a>




### Borrar el registro de transacciones
<a name="borrar_registro_transacciones_ELTPARAGRAPHE000456"></a>

El registro de transacciones es un archivo HFSQL creado y presente sólo durante el tiempo de la transacción. **No debe eliminar este archivo por temor a problemas de integridad de la base de datos.**. 
<a name="NOTE4_5"></a>




### Diferencias de comportamiento entre las transacciones ISAM y Cliente/Servidor
<a name="diferencias_comportamiento_entre_las_transacciones_isam_clienteservidor_ELTPARAGRAPHE000464"></a>

|   | Comportamiento en HFSQL Classic | Comportamiento en HFSQL Client/Server |
| --- | --- | --- |
| Creación de un archivo de datos durante una transacción ([HCreation](../WDLang4/3044255.md)). |   | Si se cancela la transacción, el archivo de datos vuelve a estar vacía. |
| Cierre de un archivo de datos durante una transacción ([HClose](../WDLang4/3044073.md)). | La transacción se interrumpe. | La transacción no se cancela. |
| Desbloquear un Record o un archivo de datos durante una transacción. | El bloqueo de las transacciones se cancela.<br>La transacción se interrumpe. | Desbloquear un Record o un archivo de datos<br>La transacción no se cancela. |
| Ejecutar una consulta INSERT/UPDATE. | La transacción se interrumpe. | La transacción no se cancela. |



<a name="NOTE5"></a>
<a name="NOTE5_1"></a>


## Gestión avanzada
<a name="gestion_avanzada_ELTTEXTE000800"></a>




### Transacción: Los archivos creados
<a name="transaccion_los_archivos_creados_ELTPARAGRAPHE000509"></a>

Se crean dos tipos de archivos de datos HFSQL al implementar las transacciones:

- **el registro de operaciones en transacción**: Fichero temporal en formato HFSQL que contiene las diferentes operaciones realizadas sobre los ficheros de aplicación que tiene en cuenta la transacción.. Este archivo se crea con [HTransactionStart](../WDLang4/3044002.md) (o con [HTransaction](../WDLang4/1000023384.md)). Por Default, se llama &lt;Nombre del proyecto&gt;_$TRS_OPERATION.TRS. Este nombre puede modificarse con [HTransactionStart](../WDLang4/3044002.md) (o [HTransaction](../WDLang4/1000023384.md)).
	![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) Este archivo se llama TRSOPERATION.TRS.

- **el registro de valores**: Archivo temporal associated con cada archivo de datos que se tiene en cuenta en la transacción. Este archivo se llama &lt;Nombre del archivo de datos&gt;_$$_TRSVAL.TRX. Para cada operación realizada en la transacción, este fichero contiene:

	- el contenido de la Record después de la operación (durante una supresión por ejemplo)

	- el contenido de la Record después de la operación (durante una adición por ejemplo)
			![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) Este archivo se llama &lt;Nombre del archivo de datos&gt;.TRX.





Estos archivos pueden ser tratados por [WDTRANS](../WDTrans/3524005.md) o [WDOptimizer](../WDOptimiseur/3519002.md).
![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) En **In HFSQL Client/Server, se crea un fichero adicional**: TRSOperationInfoClient.TRS. 
Este archivo contiene la información única que se utiliza para identificar la transacción (nombre del cliente, ordenador, ...).
<a name="NOTE5_2"></a>




### Identificador de el equipo que realiza la transacción
<a name="identificador_equipo_que_realiza_transaccion_ELTPARAGRAPHE000556"></a>

De forma predeterminada, el equipo está identificado con un número único y el nombre del equipo (definido en Windows).

Para identificar fácilmente a el equipo que realiza las operaciones en la transacción, se utiliza [HComputer](../WDLang4/3044111.md) para definir un identificador propio de el equipo. Este identificador sustituye al nombre de el equipo. Este identificador se guarda en el registro de operaciones en transacción y se puede consultar con [WDTRANS](../WDTrans/3524005.md).

![HFSQL Client/Server](https://doc.pcsoft.fr/ext/images/us/HFCS.png) El identificador de la computadora incluye:

- Nombre e IP Address de la computadora.

- Nombre de la aplicación, que significa ExecutableName(ProjectName). 



<a name="NOTE5_3"></a>




### Transacciones y contexto HFSQL independiente
<a name="transacciones_contexto_hfsql_independiente_ELTPARAGRAPHE000579"></a>

Al copiar un contexto, si una transacción está en curso en el primer contexto, el nuevo contexto no está en la transacción.. Debe llamar a [HTransactionStart](../WDLang4/3044002.md) (o [HTransaction](../WDLang4/1000023384.md)) para iniciar una transacción en el nuevo contexto.





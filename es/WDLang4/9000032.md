
## Replicación universal
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000357"></a>
El propósito de la replicación universal es mantener sincronizadas varias bases de datos. Estas bases de datos pueden tener diferentes tipos. Se puede realizar una replicación:

- entre una base de datos HFSQL y una base de datos Oracle.

- entre las bases de datos HFSQL Classic o HFSQL Client/Server.

- ...




La replicación universal utiliza un modelo centralizado: todas las bases de datos están sincronizadas con una base de datos maestra. Luego, la base de datos maestra aplica los cambios a las demás bases de datos.

Para implementar fácilmente la replicación universal, se recomienda utilizar [replicación universal asistida](../WDLang4/9000045.md).

Observación: La replicación universal está disponible para la replicación de datos móviles (Android o iOS). Para obtener más información, consulte [Replicación de datos móviles (Android o iOS)](../WDLang4/1000021071.md). 

La replicación universal utiliza varios tipos de archivos:

- **.RPM file**: archivo utilizado para describir una base de datos maestra así como sus bases de datos de suscriptores. Contiene el nombre del archivo.SYN para cada suscriptor. Este archivo es un archivo de texto. Se crea y se almacena en el equipo que se utilizará para conectarse a la base de datos maestra.

- **Archivo.RPL**: archivo que describe una base de datos de suscriptores. Se crea un archivo RPL para cada base de datos de suscriptores.. Este archivo se encuentra en el ordenador del abonado. Contiene el nombre del archivo.SYN del suscriptor. Este archivo es un archivo de texto. Se crea en el equipo maestro y luego se transfiere al equipo del suscriptor.

- **.RPA file**: archivo de registro que contiene la información de replicación. Este archivo se intercambia entre la base de datos maestra y la base de datos de suscriptores.. Este archivo es creado por [HCreateMoveableReplica](../WDLang4/3044209.md), y es leído y borrado por [HSynchronizeReplica](../WDLang4/3044014.md). El contenido se incrementa: si se realizan dos [HCreateMoveableReplica](../WDLang4/3044209.md) uno tras otro en la misma dirección, el primer archivo y el segundo tendrán el mismo contenido pero el segundo archivo contendrá también las modificaciones recientes. Si se "pierde" un archivo .RPA, basta con crearlo de nuevo: contendrá todas las modificaciones. Si hay varios archivos RPA en el suscriptor, simplemente ejecute el último. Este archivo está en formato binario.

- **.SYN archivo**: archivo que contiene información sobre la situación de la base de datos remota. Este archivo se utiliza para optimizar el tamaño de los archivos de sincronización.. Este archivo se encuentra en el ordenador principal y en cada uno de los ordenadores de los abonados.. Este archivo está en formato binario.




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Aplicación de la réplica universal
<a name="aplicacion_replica_universal_ELTTEXTE000381"></a>


### Modo de funcionamiento de la réplica
<a name="modo_funcionamiento_replica_ELTPARAGRAPHE000052"></a>
<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=Replication_universelle.gif)

<a name="NOTE2_2"></a>


### Estructura de la base de datos
<a name="estructura_base_datos_ELTPARAGRAPHE000059"></a>

La implementación de una replicación universal no requiere modificar la estructura de las bases de datos HFSQL (Classic o Client/Server).

Por el contrario, para implementar la replicación universal en bases de datos externas (Oracle, ...), se debe crear un elemento ***DateTime*** en cada archivo que se tenga en cuenta para la replicación. Este elemento deberá ser actualizado por la aplicación cuando se modifique o añada un Record.

Si las bases de datos utilizan zonas horarias diferentes, le recomendamos que utilice un formato universal (por ejemplo, fecha y hora GMT).

También pueden utilizarse varias funciones específicas al aplicar la replicación universal en bases de datos que no sean de HFSQL:


|   |   |
| --- | --- |
| [HRplDeclareLink](../WDLang4/3044299.md) | Se utiliza para indicar al motor de replicación que se ha encontrado un enlace entre dos archivos. El motor seguirá el enlace a get la lista de registros que deben ser replicados en el segundo archivo. |
| [HRplFilterProcedure](../WDLang4/3044300.md) | Se utiliza para especificar un filtro específico Procedure cuando se replica un archivo determinado. |
| [HRplManageFile](../WDLang4/1000017215.md) | Define las opciones utilizadas para la replicación universal de un archivo. |
| [HRplManageItem](../WDLang4/1000017216.md) | Define las opciones utilizadas para la replicación universal de un elemento. |

Para obtener más información, consulte [Funciones de replicación](../WDLang4/1000017222.md).
<a name="NOTE2_3"></a>


### Etapa 1: Implementación en el sitio maestro
<a name="etapa_1_implementacion_sitio_maestro_ELTPARAGRAPHE000098"></a>

Este paso se utiliza para crear la base de datos principal de la aplicación. Este paso debe realizarse durante la primera ejecución del programa (o a través de un programa específico dedicado al administrador).

1. **Para activar la replicación universal**, basta con utilizar [HSetReplication](../WDLang4/3044067.md) con la constante *rplReplicationUniversal*.
	
	```wl
	HSetReplication(rplReplicationUniversal)
	```

	Esta función se utiliza para desactivar el modo de replicación estándar (si estaba activado) y para activar la replicación universal.

2. **Creación del directorio de inicio de datos** (opcional)
	Usted tiene la capacidad de crear un directorio que recibirá los archivos de la base de datos. Este directorio será compartido en el servidor del sitio maestro para que los usuarios puedan acceder a los datos..
	
	```wl
	// Create the data directory
	fMakeDir(gsMasterDirectory)
	// Connect to this location
	HOpenConnection(MasterConnection)
	HChangeConnection(CLIENT, MasterConnection)
	```


3. **Creación de los ficheros de datos de la aplicación** (opcional)
	Si los archivos de datos no existen, tiene la posibilidad de crear archivos de datos vacíos ([HCreation](../WDLang4/3044255.md)). Estos datos serán tratados por los usuarios del sitio maestro.

4. **Creación de la réplica maestra**
	Para declarar la base de datos maestra, basta con utilizar [HCreateMasterReplica](../WDLang4/3044175.md).
	
	```wl
	HCreateMasterReplica(gsMasterDirectory)
	```

	Esta Line de código crea el archivo MasterReplica.RPM en el disco. Entonces, todo lo que tienes que hacer es escribir los suscriptores en este archivo. 



<a name="NOTE2_4"></a>


### Etapa 2: Preparación de los datos del sitio del suscriptor
<a name="etapa_2_preparacion_los_datos_del_sitio_del_suscriptor_ELTPARAGRAPHE000135"></a>

Este paso se utiliza para crear una segunda base de datos. Este paso se realiza en el sitio "maestro. Este paso debe realizarse a través de una opción específica de la aplicación (o a través de un programa específico dedicado al administrador).

1. **Creación de un directorio de inicio para los datos** (opcional)
	Usted tiene la capacidad de crear un directorio que recibirá los archivos de la base de datos.

2. **Creación de la réplica del suscriptor**
	Para crear un nuevo abonado, utilice [HCreateSubscriberReplica](../WDLang4/3044253.md). Esta función crea un suscriptor (archivo RPL) con el nombre especificado. Esta función también devuelve un número de abonado.
	Tan pronto como se crea, el suscriptor está listo para recibir los datos de la réplica maestra que se utilizó para inicializarla.. Esta primera sincronización se utiliza para asegurarse de que el contenido del suscriptor sea idéntico al contenido del master.
	
	```wl
	// Create the subscriber replica
	HCreateSubscriberReplica(gsMasterDirectory, gsSubscriberDirectory, ...
			"Subscriber1", 0, "Customer" + TAB + "DATETIMEID")
	```

	En este ejemplo, el elemento "DATETIMEID" corresponde a un elemento "DateTime" que debe estar disponible para la base de datos (para una base de datos que no esté en formato HFSQL Classic o Cliente/Servidor). Este elemento deberá ser actualizado por la aplicación cuando se modifique o añada un Record. Si las bases de datos utilizan zonas horarias diferentes, le recomendamos que utilice un formato universal (por ejemplo, fecha y hora GMT)..
	Este elemento no es necesario para una base de datos HFSQL Classic o Cliente/Servidor.
	Observación: Un parámetro de [HCreateSubscriberReplica](../WDLang4/3044253.md) indica si hay que tener en cuenta la modificación de los datos de automatic. Para obtener más información, consulte [Observaciones](#NOTE3_1).  




**Ejemplo: Gestión de un elemento específico para la replicación entre una base de datos HFSQL Classic y una base de datos MySQL:**

Se implementa un trigger para rellenar automáticamente el ítem "Itm_DateTime" que se encuentra en la base de datos MySQL:

- Código del trigger: 
	
	```wl
	TriggerResult is boolean
	TriggerResult = HDescribeTrigger("*", ...
			"HADD,HMODIFY,HDELETE,HCROSS,HWRITE", ...
			"AddDateTime",hTriggerBefore)
	IF TriggerResult = False THEN Error(HErrorInfo())
	```


- Procedure llamada por el gatillo: 
	
	```wl
	PROCEDURE AddDateTime()
	TestReplic.Itm_DateTime = DateSys()+TimeSys()
	```




<a name="NOTE2_5"></a>


### Etapa 3: Implementación en el sitio del suscriptor
<a name="etapa_3_implementacion_sitio_del_suscriptor_ELTPARAGRAPHE000181"></a>

1. Cuando los datos están "preparados" para el sitio de abonado (archivos .rpl, .syn), sólo hay que activar el mecanismo de replicación en el sitio de abonado ([HSetReplication](../WDLang4/3044067.md)).
	
	```wl
	HSetReplication(rplReplicationUniversal)
	```


2. El sitio de abonado debe crear su base de datos en blanco ([HCreation](../WDLang4/3044255.md)) antes de la primera sincronización:
	
	```wl
	HCreation(CUSTOMER)
	```

	Esta base de datos se inicializará durante la primera sincronización. 



<a name="NOTE2_6"></a>


### Etapa 4: Sincronización inicial entre el sitio maestro y el sitio del suscriptor
<a name="etapa_4_sincronizacion_inicial_entre_sitio_maestro_sitio_del_suscriptor_ELTPARAGRAPHE000201"></a>

Este paso es necesario para que la replicación universal funcione correctamente. Mediante la sincronización inicial, la base de datos de suscriptores debe contener toda o parte de la base de datos maestra (antes de que se pueda utilizar el suscriptor).

1. **Creación de una réplica móvil:**
	Se creará una réplica móvil a partir de la base de datos maestra. contendrá los datos de la base de datos a partir de la cual se creó la réplica maestra. Esta operación la realiza [HCreateMoveableReplica](../WDLang4/3044209.md). [HCreateMoveableReplica](../WDLang4/3044209.md) crea un archivo de registro (archivo RPA).
	
	```wl
	HCreateMovableReplica(sMasterReplica, "Master","")
	```


2. **Inclusión de la réplica maestra en la base de datos de suscriptores:**
	Los datos que se encuentran en la base de datos maestra son importados a la base de datos de los abonados por [HSynchronizeReplica](../WDLang4/3044014.md).
	
	```wl
	sMovableReplica= gsMasterDirectory +RPL.file
	
	HSynchronizeReplica(sMovableReplica, ...
		gsSubscriberDirectory + "Subscriber_Replica1.RPL", ...
		rplToSubscriber)
	fDelete(sMovableReplica)
	```


3. **Se ha creado el suscriptor.** Los archivos del suscriptor ahora pueden ser movidos al sitio del suscriptor. Esta operación se puede realizar a través de cualquier tipo de soporte (FTP, CD ROM,...), siendo el objetivo principal la creación de una base de datos vacía y la realización de una primera replicación en el sitio.




Atención: 

- Tan pronto como se inicialice una réplica de suscriptor, ya no debe reemplazar/restaurar uno de los archivos maestros (porque contienen información sobre los rangos de identificadores para las réplicas de suscriptor).. 

- Todos los archivos de la base de datos no necesariamente tienen que ser replicados. Replicar sólo los archivos de datos necesarios. 



<a name="NOTE2_7"></a>


### Paso 5: Sincronizaciones diarias
<a name="paso_5_sincronizaciones_diarias_ELTPARAGRAPHE000234"></a>

Una vez realizada la sincronización inicial, el mecanismo de replicación está listo para funcionar en modo "Estándar".

Para sincronizar una base de datos, debe hacerlo:

1. Generar una réplica móvil ([HCreateMoveableReplica](../WDLang4/3044209.md)).

2. Transmitir la réplica móvil al emplazamiento correspondiente (maestro o abonado).

3. Sincronizar la base de datos a través de la réplica móvil mediante [HSynchronizeReplica](../WDLang4/3044014.md).




Estas operaciones pueden iniciarse desde el sitio "Maestro" o desde los sitios "Suscriptor".

El tipo de replicación se puede configurar para definir el modo de funcionamiento de la replicación.. Los diferentes tipos de réplicas son los siguientes:

- **rplMasterFirst**: este modo de replicación es el modo Default. Se utiliza para proteger la base de datos del emplazamiento "maestro" de las modificaciones realizadas en el emplazamiento "abonado".. Las modificaciones realizadas en los sitios de suscriptores no se llevarán a cabo en este modo (excepto las adiciones).

- **rplSubscriberFirst**: en este modo de replicación, los sitios suscriptores tienen prioridad sobre el sitio maestro. En este modo, el sitio maestro es un copy de los diferentes suscriptores pero las modificaciones no se transfieren entre los diferentes suscriptores. 

- **rplMostRecentFirst**: este modo se utiliza para propagar todas las modificaciones realizadas en las bases de datos. Este modo de operación debe utilizarse cuando todas las bases de datos tienen la misma prioridad (las modificaciones se trasladan a todas las bases de datos).




También tiene la capacidad de definir una réplica personalizada Procedure: permite definir las prioridades utilizadas durante el mecanismo de sincronización.

<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Observaciones
<a name="observaciones_ELTTEXTE000441"></a>


- **Compruebe los archivos replicados. Todos los archivos de la base de datos no necesariamente tienen que ser replicados. Replicar sólo los archivos de datos necesarios.**

- Los intercambios de ficheros ".RPA" no son necesariamente simétricos: puede crear y ejecutar varios logs en una dirección sin crear y ejecutar un único log en la otra dirección. Sin embargo, para mejorar las prestaciones, debe evitar realizar intercambios siempre en la misma dirección.

- La replicación respeta los filtros aplicados a las tablas o a los archivos (excepto los enlaces, para respetar la integridad).

- Un filtro puede ser implementado en el lado maestro: los suscriptores recibirán una sub-set de datos de la base de datos principal. En este caso, no es necesario implementar un filtro para la base de datos de suscriptores..
	Si, debido al filtro, un registro ya no es "visible" en la base de datos maestro, este registro se considerará como eliminado. Se borrará automáticamente del ordenador del abonado.

- [HRecreateSubscriberReplica](../WDLang4/3044350.md) se utiliza para recrear una réplica de abonado a partir de la réplica maestra.

- **Tener en cuenta la modificación de los datos de automatic (HFSQL Classic o bases de datos Cliente/Servidor)**: 
	Al crear la réplica del suscriptor con [HCreateSubscriberReplica](../WDLang4/3044253.md), puede especificar si la modificación de los datos de automatic debe realizarse durante la replicación. En ese caso: 

	- Los cambios en la estructura de la base de datos principal se trasladarán a la base de datos de suscriptores. Esto se hará durante la replicación. 
			Atención: Esto puede aumentar significativamente el tiempo necesario para la replicación.

	- Los nuevos elementos serán tenidos en cuenta por la replicación.


Observaciones: 

- Este mecanismo no funciona si se añade o se elimina una clave única.. 

- En el caso de una réplica existente, es necesario recrear esta réplica (así como los suscriptores) para tener en cuenta esta funcionalidad. 




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Limitaciones
<a name="limitaciones_ELTTEXTE000465"></a>


- Cada archivo o tabla debe tener al menos una clave única.

- Debes tener la habilidad de asociar una cita con un Record. Si el elemento utilizado para asociar una fecha a la Record es rellenado automáticamente por un disparador, este disparador debe ser desactivado cuando se ejecute [HSynchronizeReplica](../WDLang4/3044014.md) (para evitar rellenar este elemento con la fecha de replicación). 
	**Observación**: Para las bases de datos HFSQL (Clásica o Cliente/Servidor), el elemento utilizado para asociar una fecha con el Record se gestiona automáticamente.

- La replicación no abre los archivos ni las tablas. El programa debe haber abierto los archivos o las tablas antes de iniciar la replicación.

- Durante la replicación, el consumo de memoria puede ser muy alto. Por lo tanto, sólo los registros necesarios deben ser replicados hacia una computadora del suscriptor.

- **Atención: caso especial: algunas de las tablas de relacionado no se replican.** En este caso, la replicación puede repetir algunas modificaciones como una pareja {adición, eliminación}.. Si un tabla no replicado es relacionado con modificaciones en cascada, los registros relacionado pueden borrarse erróneamente.

- La replicación no se realizará en el siguiente caso: uno de los archivos que se va a replicar está protegido por una contraseña y se utiliza en una relación con reglas de integridad. 











## Acceso a una base de datos en modo local (SQLite)
			



<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000212"></a>
WEBDEV permite a un sitio crear y acceder a una base de datos creada por el navegador en el equipo del usuario de la Web en código de navegador. 

Esta característica le da la capacidad de introducir datos en modo desconectado y de transmitirlos al servidor tan pronto como se restaure la conexión con INTERNET.. 

**Atención**: Esta función sólo está disponible para algunos navegadores: 

- Cromo,

- Safari, 

- Opera 11, ...




<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## ¿Cómo administrar una base de datos local?
<a name="¿como_administrar_una_base_datos_local_ELTTEXTE000236"></a>
Para administrar una base de datos local: 

1. Utilice [SQLConnect](../WDLang4/3072005.md) en el código del navegador para conectarse a la base de datos local. Por ejemplo: 
	
	```wl
	// Connection to a browser database named "LocalDatabase"
	// The database is created if it does not exist
	SQLConnect("LocalDatabase", "", "", "", "Web SQL database")
	```


2. Utilice [SQLExec](../WDLang4/3072007.md) para ejecutar consultas en la base de datos local. 
	**Atención**: Las consultas SQL se ejecutan de forma asíncrona. Por lo tanto, la sintaxis de [SQLExec](../WDLang4/3072007.md) utiliza un Procedure específico. Este Procedure se inicia al final de la ejecución de la consulta real (independientemente del resultado de la consulta). Este navegador Procedure se utiliza para:  

	- comprobar la correcta ejecución de la consulta. [SQLInfo](../WDLang4/3072028.md) se ejecuta automáticamente durante la llamada a Procedure. Por lo tanto, todas las variables SQL están posicionadas. Si se produce un error, el error SQL será distinto de "00000".. El mensaje de error es devuelto por el SQL.MesError Variable.

	- navegar por el resultado de la consulta.  


 Si se ejecutan nuevas consultas en este Procedure (para añadir registros por ejemplo), se puede: 

- usan la misma Procedure: el parámetro de este Procedure se utiliza para averiguar la consulta que se está ejecutando actualmente. 

- usar un navegador diferente Procedure para probar el resultado de estas nuevas consultas. 




**Observaciones**: 

- Durante la salida del navegador Procedure, se restauran los valores devueltos por [SQLInfo](../WDLang4/3072028.md). Si estos valores han sido modificados en el navegador Procedure, se sobrescriben. 

- Para conocer los comandos SQL que se pueden utilizar, consulte la documentación sobre las "Bases de datos Web SQL".. 





### Funciones SQL disponibles
<a name="funciones_sql_disponibles_ELTPARAGRAPHE000063"></a>Las siguientes funciones SQL están disponibles en el código del navegador: 



|   |   |
| --- | --- |
| [SQLChangeConnection](../WDLang4/3072016.md) | Modifica la conexión actual. |
| [SQLClose](../WDLang4/3072015.md) | Declara el final de la ejecución de la consulta y libera los recursos de memoria asignados durante la ejecución de la consulta. |
| [SQLColumn](../WDLang4/3072001.md) | Devuelve las características de todas las columnas (o posiciones):<br><br>- para una determinada tabla.<br><br>- para una consulta determinada.<br><br><br> |
| [SQLConnect](../WDLang4/3072005.md) | Conecta la aplicación actual a una base de datos que debe ser interrogada mediante SQL. |
| [SQLDisconnect](../WDLang4/3072008.md) | Cierra la conexión actual y libera la memoria utilizada por la conexión. |
| [SQLExec](../WDLang4/3072007.md) | Nombra y ejecuta una consulta SQL. |
| [SQLFetch](../WDLang4/3072011.md) | Va al siguiente fila (es decir, al siguiente Record) del resultado de la consulta. |
| [SQLGetCol](../WDLang4/3072019.md) | Recupera el contenido de la columna especificada del resultado de la consulta, para la actual Line. |
| [SQLInfo](../WDLang4/3072028.md) | Inicializa las diferentes variables SQL con información relativa a la última consulta ejecutada. |
| [SQLReqExists](../WDLang4/3072026.md) | Verifica la existencia de una consulta. |





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Ejemplo: Grabación local de los datos de un centro offline
<a name="ejemplo_grabacion_local_los_datos_centro_offline_ELTTEXTE000321"></a>
WEBDEV le permite implementar [sitios fuera de línea](../Editeurs/2030060.md). Si este tipo de sitio debe guardar datos durante el período de desconexión, puede utilizar una base de datos local.. 


### Etapas
<a name="etapas_ELTPARAGRAPHE000079"></a>

Los pasos son los siguientes: 

1. Conexión a la base de datos
	La conexión a la base de datos se establece con [SQLConnect](../WDLang4/3072005.md). Por ejemplo: 
	
	```wl
	SQLConnect("","","", "APTCustomers", "Web SQL database")
	```


2. Creación de la base de datos local
	La base de datos local debe crearse antes de que se pueda utilizar.. Para ello, todo lo que tiene que hacer es utilizar una consulta CREAR TABLA. Esta consulta debe ser realizada por SQLExec. Por ejemplo: 
	
	```wl
	sQuery is string
	// Code for creating the table
	sQuery = [
	CREATE TABLE IF NOT EXISTS "Appointments" 
	("AppointmentID"  INTEGER PRIMARY KEY , "StartDateTime" VARCHAR(16) , 
	"Customer" VARCHAR(100) , "Address" VARCHAR(200) , "Summary" LONGVARCHAR ); 
	]
	// Execute query 
	SQLExec(sQuery, "QRY_CREATION", _cbQuery)
	```

	Cuando la consulta "QRY_CREATION" se completa, se ejecuta el _cbQuery Procedure. 
	En este ejemplo, este procedimiento se utiliza para gestionar todas las consultas ejecutadas y para realizar una Process adecuada después de la consulta. 
	La consulta de creación debe utilizarse una vez, al principio del día, por ejemplo. Por ejemplo, la base de datos sólo se puede crear si no se pasa un parámetro específico (por ejemplo,"First") a las páginas.. 

3. Acceso a los datos locales o remotos
	En este ejemplo, el sitio puede ser utilizado en modo online o en modo offline. Debe poder acceder a la base de datos local (en modo offline) o a la base de datos remota (en modo online).. 
	Todos los accesos (creación, modificación, eliminación, ...) a la base de datos local deben realizarse a través del SQLExec Procedure. 
	Los accesos a la base de datos remota siempre se pueden realizar a través de las funciones Hxxx. Sin embargo, usted debe: 

	- ejecutar estas funciones en un código de navegador, por lo tanto en AJAX, a través de [AJAXExecute](../WDLang2/3055114.md). 

	- asegúrese de que el navegador está conectado ([NavegadorIsConnectado](../WDLang2/1000019392.md)). 


 Por ejemplo:  
	
	```wl
	sQuery is string 
	// The browser is connected 
	IF BrowserIsConnected() = True THEN 
		// Saves in the remote database (server) 
		AJAXExecute(SaveData, EDT_ID, EDT_SUMMARY) 
	END 
	sQuery = [
		UPDATE Appointment 
		SET Summary='%2' 
		WHERE AppointmentID=%1 
	]
	
	// In any case, save in the local database 
	SQLExec(StringBuild(sQuery, gnBrwAPTID, EDT_SUMMARY), "QRY_BACKUP", _cbQuery)
	```






### Recuperación de los registros encontrados en la base de datos remota
<a name="recuperacion_los_registros_encontrados_base_datos_remota_ELTPARAGRAPHE000123"></a>

Para recuperar registros de la base de datos remota (servidor) en la base de datos local (para inicializarla, por ejemplo), debe: 

1. Lee los registros y almacena los elementos como cadenas, en un servidor Procedure. 
	
	```wl
	PROCEDURE GetRec() 
	FOR EACH MyFile1 
		sList += [CR]+ MyFile1.Item1 + TAB + ...
			MyFile1.Item2 + TAB + MyFile1.Item3
	END 
	RESULT sList
	```


2. Recuperar esta lista en el código del navegador: 
	
	```wl
	// Retrieves the list 
	sList = AJAXExecute(GetRec)
	```


3. Examinar la cadena y extraer la información con [ExtractString](../WDLang1/3024017.md). Por lo tanto, los registros se pueden añadir fácilmente con una consulta de adición (INSERT).. 





### Recuperación de los datos locales para actualizar la base de datos remota
<a name="recuperacion_los_datos_locales_para_actualizar_base_datos_remota_ELTPARAGRAPHE000139"></a>

Del mismo modo, los datos pueden recuperarse de la base de datos local para actualizar la base de datos remota.. Para ello: 

1. Ejecute una consulta localmente para recuperar los registros. Por ejemplo, para recuperar las citas del día: 
	
	```wl
	// Runs the query that selects the appointments of the day
	sQuery is string
	sQuery = StringBuild("SELECT AppointmentID,Summary FROM APPOINTMENT " + ...
		"WHERE StartDateTime LIKE '%1%' ORDER BY StartDateTime ASC;", Today()) 
	// Starts the query
	SQLExec(sQuery, "QRY_SYNCHRONIZEAPT", _cbQuery)
	```


2. En la comprobación Procedure iniciada por [SQLExec](../WDLang4/3072007.md), basta con ejecutar un Procedure para actualizar la base de datos remota a través de [AjaxExecute](../WDLang2/3055114.md). En nuestro ejemplo, se inicia el navegador Procedure llamado __SynchonizeDatabase: 
	
	```wl
	PROCEDURE _SynchronizeDatabase(sQuery)
	
	// As long as there are appointments to synchronize
	WHILE SQLFetch(sQuery) = 0
		// Synchronizes the appointment
		AJAXExecute(_SynchronizeARemoteAppointment, SQLGetCol(sQuery, 1), SQLGetCol(sQuery, 2))
	END
	```
**Observación**: La actualización de la base de datos remota puede ser provocada durante la reconexión al servidor.. Durante la reconexión al servidor, se ejecuta el Event "Cambiar al modo en línea".. Esta Process es una Process opcional de la Page.


Para visualizarlo en el editor de código, debe: 

- Visualizar el código de la Page. 

- Haga clic en "Añadir otros Event s a xxx", en la parte inferior de la ventana de códigos, debajo del último Event.<br>![](https://doc.pcsoft.fr/en-US/images/image.awp?langid=7&name=Traitements_optionnels_WD_OK%20-%20HC%20N%B0001.gif)
 Aparecen todos los Event s opcionales disponibles para el Page. 

- Seleccione el "Cambiar a modo en línea" Event.

- Valide.

- Introduzca el código para actualizar la base de datos remota.






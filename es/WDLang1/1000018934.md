
## Zonas de memoria compartida
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000223"></a>
WINDEV, WEBDEV y WINDEV Mobile le permiten manipular áreas de memoria compartida.

Las zonas de memoria compartida son un mecanismo de comunicación entre varias aplicaciones de un mismo ordenador. Se utilizan para intercambiar fácilmente datos entre un servicio y la aplicación de configuración, por ejemplo. 

Las funciones de gestión de las áreas de memoria compartida utilizan las APIs estándar de los diferentes sistemas operativos (Windows o Linux) y permiten una mejor interoperabilidad no sólo entre las aplicaciones WINDEV, WEBDEV y WINDEV Mobile, sino también entre las aplicaciones externas.





<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## ¿Cómo proceder?
<a name="¿como_proceder_ELTTEXTE000247"></a>


### Creación de una zona de memoria compartida
<a name="creacion_una_zona_memoria_compartida_ELTPARAGRAPHE000022"></a>

Las zonas de memoria compartida son creadas y abiertas por [fMemOpen](../WDLang1/1000018917.md). 

La primera aplicación que acceda a la zona provocará su creación mientras que las demás aplicaciones realizarán una simple apertura.. 

La aplicación que crea la zona define su tamaño proporcionando un tamaño mínimo. El sistema operativo creará una zona cuyo tamaño es múltiplo del tamaño de las páginas de memoria (4 KB sous en Windows 32 bits por ejemplo).. El tamaño real de la zona de memoria es devuelto por [fSize](../WDLang1/3036055.md).


```wl
// Open the shared memory area
ZoneID is int
ZoneID = fMemOpen("MySharedZone", 50, shareGlobal)
IF ZoneID > 0 THEN
	ZoneSize is int
	ZoneSize = fSize(ZoneID)
	Info(StringBuild("The memory area %1 was opened. Its size is equal to %2 bytes.", ...
		ZoneID, ZoneSize))
END
...
// Close the shared memory area
fClose(ZoneID)
```

<a name="NOTE2_2"></a>


### Averiguar si una zona de memoria compartida ya existe
<a name="averiguar_una_zona_memoria_compartida_existe_ELTPARAGRAPHE000041"></a>

En algunos casos, puede ser useful para averiguar si una zona de memoria compartida ya existe. 

Por ejemplo, una aplicación utilizada para configurar un servicio puede comprobar si el servicio se ha iniciado correctamente.: todo lo que tiene que hacer es comprobar si una zona de memoria compartida específica fue creada por el servicio. Si la zona no existe, la aplicación puede mostrar un mensaje de error.. 

[fMemExiste](../WDLang1/1000018916.md) se utiliza para averiguar si una zona de memoria compartida ya fue creada por otra aplicación.


```wl
// Check the existence of the shared memory area
IF fMemExist("MySharedZone", shareGlobal) = False THEN
	Error("Check whether the XXX server was started.")
	RETURN
END
```

<a name="NOTE2_3"></a>


### Manejar el contenido de una zona de memoria compartida a través de la programación
<a name="manejar_contenido_una_zona_memoria_compartida_traves_programacion_ELTPARAGRAPHE000056"></a>

Para manipular el contenido de una zona de memoria compartida, puede: 

- utilizar las funciones de lectura y escritura de los archivos externos. Esta solución se recomienda para los casos simples (transmisión de una cadena por ejemplo). 

- utilizar la serialización automatic de WLanguage ([Serialize](../WDLang1/3013065.md) y [Deserialize](../WDLang1/3013066.md)), luego utilizar las funciones de lectura y escritura en los archivos externos para transmitir los elementos. Esta solución se recomienda cuando se transmiten clases cuyos miembros corresponden a los elementos a transmitir. 




Las siguientes funciones de gestión de ficheros externos pueden utilizarse con las zonas de memoria compartida: 



|   |   |
| --- | --- |
| [fReadLine](../WDLang1/3036031.md) | Lee una línea de un archivo externo (ANSI o UNICODE). |
| [fSeek](../WDLang1/3036039.md) | Devuelve y modifica la posición actual en un fichero externo. |
| [fWrite](../WDLang1/3036014.md) | Escribe:<br><br>- una cadena de caracteres en un fichero externo.<br><br>- una sección de memoria.<br><br><br> |
| [fWriteLine](../WDLang1/3036025.md) | Escribe una línea en un archivo de texto (ANSI o UNICODE). |
| [Lectura](../WDLang1/3036048.md) | Lee:<br><br>- un bloque de bytes (caracteres) en un archivo externo (ANSI o Unicode),<br><br>- el contenido de un archivo externo (ANSI o Unicode) y lo asigna a una zona de memoria.<br><br><br> |





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Diálogo entre varias aplicaciones
<a name="dialogo_entre_varias_aplicaciones_ELTTEXTE000316"></a>
Dos aplicaciones pueden compartir datos utilizando una zona de memoria compartida.

Se dispone de dos mecanismos de sincronización: 

- la Notification automática (usando las funciones de devolución de llamada)

- la sincronización manual a través de un semáforo.





### Notification automática de modificaciones
<a name="notification_automatica_modificaciones_ELTPARAGRAPHE000085"></a>

La Notification automática de las modificaciones puede implementarse en cuanto se abre una zona de memoria compartida. 

Para ello, cada aplicación que acceda a la zona de memoria debe pasar el nombre de un lenguaje WLanguage Procedure como último parámetro a [fMemOpen](../WDLang1/1000018917.md). Esta Procedure será llamada automáticamente cada vez que se modifique el contenido de la zona de memoria compartida. 

Para esperar a que la Notification sea procesada por las demás aplicaciones (antes de realizar una nueva modificación de la zona de memoria, por ejemplo), debe utilizar [fMemEspere](../WDLang1/1000018915.md).


```wl
// Open the memory area in the application 1
ZoneID is int
ZoneID = fMemOpen("SharedZone", 200, shareGlobal, "ModifMemory")
...
```

```wl
// -- Procedure used for callback (application 1)
PROCEDURE ModifMemory(ModifZoneName is string, ModifZoneID is int)
Info(StringBuild("The memory area %1 was modified.", ModifZoneName))
```



```wl
// Open the memory area in the application 2
ZoneID is int
ZoneID = fMemOpen("SharedZone", 200, shareGlobal, "ModifMemory")
// Write into the zone
fWrite(ZoneID, "Hello, I am the application 2.")
// Wait for the validation of "Info" of the "ModifMemory" procedure in the application 1
fMemWait(ZoneID)
// Second write operation into the zone
fWrite(ZoneID, "New information.")
...
```



### Sincronización manual
<a name="sincronizacion_manual_ELTPARAGRAPHE000105"></a>

La sincronización manual se puede realizar según el siguiente principio:

- Las aplicaciones abren la zona de memoria compartida y el semáforo de diálogo.

- La primera aplicación "toma" el semáforo ([SemaphoreStart](../WDLang1/3077008.md)).

- La primera aplicación escribe sus datos en la zona de memoria.

- La primera aplicación libera el semáforo ([SemaphoreEnd](../WDLang1/3077010.md)).

- La segunda aplicación "toma" el semáforo.

- La segunda aplicación lee los datos escritos por la primera aplicación.

- La segunda aplicación libera el semáforo.




Observación: Si las dos aplicaciones quieren intercambiar datos, se deben utilizar dos semáforos para asegurar la regulación.

**Consejo**: La sincronización manual se utilizará preferentemente cuando: 

- una de las dos aplicaciones no está escrita en WLanguage. 

- el mecanismo de modificaciones de Notification no está disponible.




<a name="NOTE4"></a>
<a name="NOTE4_1"></a>


## Nombrar las áreas de memoria compartida
<a name="nombrar_las_areas_memoria_compartida_ELTTEXTE000352"></a>
Las zonas de memoria compartida se identifican por su nombre.

Observación: Los nombres de las zonas de memoria compartida distinguen entre mayúsculas y minúsculas en Windows y en Linux.
<a name="NOTE4_2"></a>


### Gestión del modo compartido
<a name="gestion_del_modo_compartido_ELTPARAGRAPHE000142"></a>

El modo compartido difiere según las versiones de los sistemas operativos:

- Linux, Windows 2000 y versiones anteriores: hay un único espacio para crear la zona de memoria compartida. El parámetro &lt;Share&gt; de [fMemOpen](../WDLang1/1000018917.md) se ignora.

- Windows XP: el &lt;parámetro&gt; de [fMemOpen](../WDLang1/1000018917.md) tiene efecto si la función de cambio rápido de usuario está activada, de lo contrario se ignora.

- Windows Vista y posterior: el parámetro &lt;Share&gt; de [fMemOpen](../WDLang1/1000018917.md) es compatible. Los servicios y los usuarios están ubicados en un espacio diferente. Para compartir un área de memoria entre un servicio y una aplicación en la sesión de un usuario, debe utilizarse la constante *shareGlobal*.

- En Terminal Server: el parámetro &lt;Share&gt; de [fMemOpen](../WDLang1/1000018917.md) es compatible. Cada sesión abierta en el Terminal Server tiene un espacio de memoria diferente. Las aplicaciones que se inician en la misma sesión TSE pueden compartir un área de memoria creada con la constante *shareUser*. Las aplicaciones ubicadas en diferentes sesiones pueden compartir un área de memoria creada con la constante *shareGlobal*.



<a name="NOTE4_3"></a>
![Linux](https://doc.pcsoft.fr/ext/images/us/LX.png) 

### Correspondencia entre el nombre proporcionado a fMemOpen y la apertura en C
<a name="correspondencia_entre_nombre_proporcionado_fmemopen_apertura_ELTPARAGRAPHE000168"></a>

Los dos siguientes ejemplos de código presentan la apertura de una zona de memoria (denominada "myzone") en WLanguage y C).


```wl
// Code in WLanguage
ZoneID is int
ZoneID = fMemOpen("myzone", 1024, shareGlobal)
```



```txt
// Equivalent code in C
char * szZoneName = "myzone";
int nSize;
int nMem;
key_t nKey;
int nAccess = 0666;	// Open in read/write

nSize = 1024;
nKey = ftok(szZoneName+sizeof(char),(int) szZoneName[0]);
nMem = shmget(nKey, nSize , nAccess);
```







## Chorus Pro: Automatizar la presentación de facturas
			

<a name="NOTE1"></a>
<a name="NOTE1_1"></a>


## Presentación
<a name="presentacion_ELTTEXTE000323"></a>
En Francia, la facturación electrónica se ha convertido en obligatoria para facturar servicios del estado.
El gobierno francés ha establecido el sistema Chorus Pro para enviar y monitorear facturas. Es la herramienta para administrar los gastos y los ingresos no tributarios de los servicios del estado francés.
A partir del 01/01/2019, todas las empresas con más de 10 empleados deben facturar los servicios gubernamentales presentando una factura (en formato PDF) en Chorus Pro.
Y en 2020, todas las empresas deben utilizar Chorus Pro.

"Chorus Pro" es una plataforma que permite presentar facturas al gobierno francés. Es posible llevar a cabo estas operaciones manualmente en el portal, pero también es posible automatizar estas tareas a través de un set de APIs.

"Chorus Pro" permite dos tipos de integración:

- un modo EDI (intercambio XML),

- un modo API (API REST).




El modo EDI proporciona un subconjunto limitado de las características del modo API.

Esta página de ayuda presenta: 

- Una visión general de Chorus Pro (con las herramientas necesarias para utilizar las APIs). 

- Programación de las APIs de Chorus Pro en WLanguage. 




En el LST #115, encontrará un ejemplo de cómo utilizar las APIs para enviar facturas en PDF en Chorus Pro. 

<a name="NOTE2"></a>
<a name="NOTE2_1"></a>


## Descripción general de Chorus Pro
<a name="descripcion_general_chorus_pro_ELTTEXTE000347"></a>


### El portal
<a name="portal_ELTPARAGRAPHE000038"></a>

"Chorus Pro" y sus funcionalidades están dirigidas a dos tipos de usuarios:

- los servicios que reciben facturas: el gobierno,

- los servicios que presentan facturas al gobierno.


**Observación**: Toda la documentación sobre "Chorus Pro" y las APIs está disponible en el siguiente enlace: [https://communaute.chorus-pro.gouv.fr/?lang=es](https://communaute.chorus-pro.gouv.fr/?lang=en)

Chorus Pro ofrece: 

- ***Un entorno de pruebas***
	Este entorno se llama "Portal de cualificación"..
	Se puede acceder al portal de cualificación a través del siguiente enlace: [https://chorus-pro.gouv.fr/qualif](https://chorus-pro.gouv.fr/qualif). Se puede reconocer fácilmente por su verde Color.

- ***Un entorno de producción*** 
	El portal de producción está disponible a través de la siguiente Address: [https://chorus-pro.gouv.fr/](https://chorus-pro.gouv.fr/). Se puede reconocer fácilmente por su Color azul.




**Observación**: los entornos de prueba y producción pueden ser "relacionado" pero siguen siendo independientes. Se debe crear una cuenta para cada entorno.

En el resto de esta página, la operación se realiza en el entorno de prueba. 


### Creación de una cuenta y descarga de datos de prueba
<a name="creacion_una_cuenta_descarga_datos_prueba_ELTPARAGRAPHE000071"></a>

**Etapa 1: Creación de una cuenta de Chorus Pro**: 
Antes de cualquier operación, es necesario crear una cuenta Chrorus Pro (en el entorno de prueba y/o de producción, según sus necesidades).. 
**La creación de una cuenta de Chorus no es inmediata (hasta varios días), así que debe anticipar este paso si es necesario.** 
En efecto, para crear una cuenta Chorus, es necesario ser una organización (llamada "estructura" en la interfaz del Chorus) y especificar, junto con un correo electrónico Address, detalles específicos sobre la organización (como el SIRET, -Número de registro de la empresa francesa-, por ejemplo). Esta información se verifica antes de crear la cuenta. 
Observación: El Address associated a la cuenta debe ser un correo electrónico válido y regularmente revisado Address. Chorus utilizará esta dirección para informar sobre los cambios y períodos de mantenimiento de los diferentes entornos.

**Etapa 2: Entorno de prueba: Recuperación de datos de prueba**
Cuando la cuenta Chorus se crea en el entorno de prueba, es posible (tal vez indispensable) solicitar datos de prueba (llamados "Dataset" en el vocabulario Chorus Pro)..
Para ello: 

1. En el portal de cualificación, seleccione "Mi cuenta .... Mi conjunto de datos... Crear".. 

2. Comienza la generación del conjunto de datos. Tenga en cuenta que esta operación puede tardar más de 1 hora.

3. Al final de la generación, haga clic en "descargar archivos adjuntos".. 

4. El archivo resultante es un archivo ".csv" que contiene facturas, proveedores, etc.

5. Cerrar sesión en el portal de calificaciones. 

6. Inicie sesión en el portal de cualificación utilizando los identificadores proporcionados en el archivo descargado (Proveedor asociado: nombre de usuario y contraseña).

7. Se accede al entorno con los datos de prueba como "Gestor principal de la estructura".. Se habrá generado automáticamente una set de facturas para realizar sus pruebas. Puede tener facturas pendientes, rechazadas y de "producción".




Encontrará todos los pasos detallados sobre el portal de cualificación en la sección de ayuda "Chorus Pro: [https://communaute.chorus-pro.gouv.fr/documentation/chorus-pro-qualification-portal/?lang=es](https://communaute.chorus-pro.gouv.fr/documentation/chorus-pro-qualification-portal/?lang=en)


### Activación de APIs
<a name="activacion_apis_ELTPARAGRAPHE000102"></a>

Por Default, las API no son accesibles para una cuenta en los portales "Chorus Pro" (portales de prueba o de producción). En el vocabulario "Chorus Pro", el término utilizado es "conexión".

Conexión **API**
Es necesario autorizar explícitamente (conectar) el acceso a las APIs antes de realizar cualquier llamada a las APIs.. En el entorno de la prueba, la Procedure es la siguiente:

1. Seleccione "Gestionar actividades".

2. Desplácese hacia abajo hasta "Mis estructuras".

3. En la fila de la estructura, pulse el lápiz Icon de la columna "Acciones".. 

4. Haga clic en el botón "Agregar áreas" en la sección "Áreas".

5. Seleccione el servicio(s) y active la opción "Conexiones EDI y API".

6. Cerrar sesión en el portal. 

7. Inicie sesión en el portal utilizando los identificadores proporcionados en el archivo descargado (Proveedor asociado: nombre de usuario y contraseña).

8. En el menú aparece una nueva opción ("Conexiones EDI y API").

9. Seleccione esta opción y confirme. 

10. Ahora debes especificar el Certificate para usar los API s en la opción "Crear conexión API". Puede encontrar más detalles en la página: [https://communaute.chorus-pro.gouv.fr/documentation/connection-to-chorus-pro/?lang=en](https://communaute.chorus-pro.gouv.fr/documentation/connection-to-chorus-pro/?lang=en)




**Cuenta técnica**
Para utilizar las API, debe crear una cuenta "técnica" en Chorus Pro. En el portal de pruebas, esta cuenta técnica se crea a partir de la cuenta de administrador.
La identidad (Email y contraseña) de esta cuenta técnica se pasará "en parámetro" a los DESCANSOS DE API.
La creación de esta cuenta permite disociar un uso "por API" de un uso clásico de Chorus Pro a través de la cuenta de administrador, por ejemplo.
Nota: es posible crear varias cuentas técnicas y darles acceso limitado a determinadas API.

Para más detalles sobre cómo crear una cuenta técnica, consulte [https://communaute.chorus-pro.gouv.fr/documentation/creation-of-a-technical-account-for-an-API-access-in-production/?lang=en](https://communaute.chorus-pro.gouv.fr/documentation/creation-of-a-technical-account-for-an-api-access-in-production/?lang=en). 


### Necesidad de un Certificate
<a name="necesidad_certificate_ELTPARAGRAPHE000139"></a>

**Autenticación por Certificate**
Para autentificar las llamadas por la API, Chorus Pro requiere la autentificación por el cliente Certificate. Este tipo de identificación se presenta como un "documento de identidad digital" en la documentación de Chorus Pro.

Esta Certificate permitirá al portal identificar y autentificar cada llamada. Cada cliente (es decir, cada empresa que quiera conectarse a Chorus Pro por API) tendrá que comprar un Certificate a organismos reconocidos,

**Comprar un Certificate**
Chorus Pro requiere sólo un tipo de Certificate cuando se usan APIs (y no EDIs): una autenticación de cliente Certificate que cumpla con el estándar RGS\* por lo menos.
Para ello, en la documentación de Chorus Pro se incluye una lista de proveedores (asegúrese de elegir un sello que cumpla al menos con el estándar RGS\*).: [https://www.lsti-certification.fr/images/Trusted-List-RGS-eIDAS_LSTI_V6.4.pdf](https://www.lsti-certification.fr/images/Trusted-List-RGS-eIDAS_LSTI_V6.4.pdf)
Esta lista exhaustiva puede parecer compleja. Durante nuestras pruebas, pudimos encontrar información en las páginas web de "TBS-INTERNET" y "Certigna". El precio de un Certificate es de alrededor de 300 € / año.

- [https://www.tbs-certificats.com/comparatif_certificat_serveur_ssl_RGS.html.fr](https://www.tbs-certificats.com/comparatif_certificat_serveur_ssl_RGS.html.fr)

- [https://www.certigna.fr/description-ssl.xHTML](https://www.certigna.fr/description-ssl.xhtml)


La Certificate obtenida debe ser proporcionada al portal del Coro, en formato pkcs7, con toda la cadena de la Certificate. A partir de ese momento, las llamadas de API serán "autentificadas".

Puede encontrar más detalles sobre los certificados y sus validaciones para Chorus Pro en esta página: [https://communaute.chorus-pro.gouv.fr/documentation/certificates/?lang=es](https://communaute.chorus-pro.gouv.fr/documentation/certificates/?lang=en)

Nota: según ciertos documentos del Coro, es posible obtener un test Certificate para el portal de cualificación. Hasta el día de hoy, no hemos encontrado un proveedor que permita esto sin contactar directamente con ellos.. Sin embargo, es posible utilizar el mismo Certificate para el entorno de prueba y para el entorno de calificación.





<a name="NOTE3"></a>
<a name="NOTE3_1"></a>


## Programación de las APIs de Chorus Pro REST en WLanguage
<a name="programacion_las_apis_chorus_pro_rest_wlanguage_ELTTEXTE000389"></a>


### Presentación
<a name="presentacion_ELTPARAGRAPHE000176"></a>

Las APIs de Chorus Pro son APIs REST que gestionan parámetros JSON, por lo que simplemente debes utilizar las variables JSON, [restRequest](../WDLang3/1000021481.md) y [restResponse](../WDLang3/1000021477.md) WLanguage.


```wl
// Build the parameters
ParameterEntry is JSON
cRequest.Content = ParameterEntry
...
// Make the REST call
cResponse = RESTSend(cRequest)
```


Atención: Si utiliza un proxy, recuerde configurar el acceso al proxy en su código con [Proxy](../WDLang3/3043002.md). 

Observación: En el LST #115, encontrará un ejemplo de cómo utilizar las APIs para enviar facturas en PDF en Chorus Pro. 


### Construir el encabezado
<a name="construir_encabezado_ELTPARAGRAPHE000196"></a>

Todas las solicitudes REST del Chorus Pro API contienen datos de autenticación que le permiten proporcionar:

- Los identificadores (nombre de usuario y contraseña) de la cuenta técnica.
	
	```wl
	// Technical user
	cRequest.User = GetTechnicalUserName()
	cRequest.Password = GetTechnicalUserPassword()
	```


- La contraseña (formato.p12) y su contraseña.
	
	```wl
	// Signature by certificate
	cRequest.ClientCertificate = GetCertificate() 
	cRequest.ClientPassword = GetCertificatePassword()
	```





Nota: A partir de la versión 24, es posible utilizar un Certificate almacenado en la biblioteca de la aplicación (para evitar que sea compartido). Simplemente especifique su nombre en formato de cadena.

La autoridad de confianza Certificate para Chorus Pro no parece ser reconocida por todos los ordenadores que se ejecutan en Windows, por lo que fue autorizada explícitamente por [TrustedCertificateAdd](../WDLang1/1000024320.md). 


### Gestión de parámetros o resultados
<a name="gestion_parametros_resultados_ELTPARAGRAPHE000215"></a>

Chorus Pro REST APIs manipular y datos enviados en formato JSON. El formato de los datos JSON se especifica en el pie de página de la página associated a la API.

Consejo: es posible descargar un archivo zip con todos los formatos JSON utilizados por las APIs de Chorus PRO a través del siguiente enlace:
[https://communaute.chorus-pro.gouv.fr/documentation/chorus-pro-API/?lang=en](https://communaute.chorus-pro.gouv.fr/documentation/chorus-pro-api/?lang=en)

Cada archivo contiene un ejemplo de contenido de JSON, por ejemplo:


```txt
{
"idUtilisateurCourant": 331,
"fichierFacture": "JVB...G",
 "formatDepot": "PDF_NON_SIGNE",
"nomFichier": "facture_capgemini.pdf"
}
```


WINDEV 24 le permite no sólo importar datos de manipular JSON con la variable JSON, sino también importar su description utilizando un JSON existente..
Basta con utilizar la opción "Importar un XML o un JSON en este proyecto" en el menú contextual de "Descripciones externas" del explorador de proyectos.


```wl
// Build the parameters
ParameterEntry is JSON, description="DeposerPDFFacture_M8_V0_input"
ParameterEntry.FileName = fExtractPath(sInvoiceFile, fFile + fExtension)
```





### Ejecución de la solicitud REST
<a name="ejecucion_solicitud_rest_ELTPARAGRAPHE000235"></a>

Cuando se especifican los parámetros y la cabecera, todo lo que tiene que hacer es ejecutar la petición REST construida y gestionar el código de retorno (que es un código HTTP clásico).


```wl
// Send the request
cResponse is restResponse
cResponse = RESTSend(cRequest)
```





### Llamada de retorno para optimización
<a name="llamada_retorno_para_optimizacion_ELTPARAGRAPHE000243"></a>

Es posible mostrar las tramas enviadas cuando se llama a la función [RESTSend](../WDLang3/1000021476.md) usando la propiedad **ProcedureTrace** de la variable [httpRequest](../WDLang3/1000021158.md). 


```wl
cRequest..ProcedureTrace = CBDebug
```





### Navegar por los resultados de JSON
<a name="navegar_por_los_resultados_json_ELTPARAGRAPHE000257"></a>Los datos enviados por las APIs de Chorus Pro contienen a menudo datos arrays cuyo tipo "unitario" no se especifica.. Sin embargo, en WLanguage, es posible utilizar un subconjunto de un JSON description como description:


```wl
EngagementJSON is JSON 
	<description="RechercherEngagementJuridique_M8_V0_OutPut.listeEngagementJuridique">
```





### codificación PDF
<a name="codificacion_pdf_ELTPARAGRAPHE000265"></a>

Para enviar un archivo a Chorus Pro, es necesario codificarlo en base64 (con [Codifica](../WDLang1/1000022258.md)). 

Hasta la fecha, Chorus Pro no parece interpretar correctamente los datos codificados que contienen CR.. Deben borrarse en el siguiente código, por ejemplo: 


```wl
ParameterEntry.InvoiceFile = Replace(Encode(fChangeBuffer(sInvoiceFile), ...
  encodeBASE64),CR,"")
```





